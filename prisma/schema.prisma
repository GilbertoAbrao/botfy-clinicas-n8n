// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Supabase Auth users table (managed by Supabase Auth, reference only)
model User {
  id             String     @id @default(uuid()) @db.Uuid
  email          String     @unique
  role           Role       @default(ATENDENTE)
  ativo          Boolean    @default(true)
  createdAt      DateTime   @default(now()) @map("created_at")
  updatedAt      DateTime   @updatedAt @map("updated_at")
  auditLogs         AuditLog[]
  resolvedAlerts    Alert[]
  uploadedDocuments PatientDocument[]
  waitlistCreations Waitlist[] @relation("WaitlistCreator")

  @@map("users")
}

enum Role {
  ADMIN
  ATENDENTE
}

// Alert type enums
enum AlertType {
  conversas_travadas
  pre_checkins_pendentes
  agendamentos_nao_confirmados
  handoff_normal
  handoff_erro
}

enum AlertPriority {
  urgent
  high
  low
}

enum AlertStatus {
  new
  in_progress
  resolved
  dismissed
}

enum AppointmentStatus {
  confirmed
  tentative
  no_show
  cancelled
  completed
}


// HIPAA-compliant audit logging (6-year retention required)
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   // "VIEW_PATIENT", "UPDATE_APPOINTMENT", "DELETE_RECORD"
  resource   String   // "patients", "appointments", "chats"
  resourceId String?  @map("resource_id") // ID of the accessed resource
  details    Json?    // Additional context (what changed, etc.)
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([resource])
  @@map("audit_logs")
}

// Patient information (PHI - Protected Health Information)
model Patient {
  id                String         @id @default(uuid()) @db.Uuid
  nome              String
  telefone          String
  email             String?
  cpf               String?        @unique
  dataNascimento    DateTime?      @map("data_nascimento")
  endereco          String?
  convenio          String?
  numeroCarteirinha String?        @map("numero_carteirinha")
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  appointments      Appointment[]
  alerts            Alert[]
  documents         PatientDocument[]
  waitlistEntries   Waitlist[] @relation("WaitlistPatient")

  @@index([telefone])
  @@index([cpf])
  @@index([nome])
  @@map("patients")
}

// Provider/Professional information
model Provider {
  id               String   @id @default(uuid()) @db.Uuid
  nome             String
  especialidade    String?
  cor_calendario   String   @default("#8B5CF6") // Purple default
  ativo            Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  appointments Appointment[] @relation("ProviderAppointments")
  waitlistEntries Waitlist[] @relation("WaitlistProvider")

  @@map("providers")
}

// Appointment scheduling
model Appointment {
  id          String            @id @default(uuid()) @db.Uuid
  patientId   String            @map("patient_id") @db.Uuid
  providerId  String?           @map("provider_id") @db.Uuid
  serviceType String            @map("service_type")
  scheduledAt DateTime          @map("scheduled_at")
  duration    Int               // minutes
  status      AppointmentStatus @default(tentative)
  confirmedAt DateTime?         @map("confirmed_at")
  notes       String?
  createdAt   DateTime          @default(now()) @map("created_at")
  updatedAt   DateTime          @updatedAt @map("updated_at")

  patient     Patient           @relation(fields: [patientId], references: [id])
  provider    Provider?         @relation("ProviderAppointments", fields: [providerId], references: [id])
  alerts      Alert[]

  @@index([patientId])
  @@index([providerId])
  @@index([scheduledAt])
  @@index([status])
  @@map("appointments")
}

// N8N Chat History - WhatsApp conversation messages
// Each row is a single message in a conversation thread (identified by session_id)
model ChatHistory {
  id        Int      @id @default(autoincrement())
  sessionId String   @map("session_id") @db.VarChar(255)
  message   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([sessionId])
  @@index([createdAt])
  @@map("n8n_chat_histories")
}

// Alert system
model Alert {
  id             String        @id @default(uuid()) @db.Uuid
  type           AlertType
  priority       AlertPriority
  status         AlertStatus   @default(new)
  title          String
  description    String?
  patientId      String?       @map("patient_id") @db.Uuid
  appointmentId  String?       @map("appointment_id") @db.Uuid
  chatSessionId  String?       @map("chat_session_id") // n8n chat session_id
  metadata       Json?         // Additional context like error messages
  resolvedAt     DateTime?     @map("resolved_at")
  resolvedBy     String?       @map("resolved_by") @db.Uuid
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  patient        Patient?      @relation(fields: [patientId], references: [id])
  appointment    Appointment?  @relation(fields: [appointmentId], references: [id])
  resolver       User?         @relation(fields: [resolvedBy], references: [id])

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([patientId])
  @@map("alerts")
}

// Patient document storage (links to Supabase Storage)
model PatientDocument {
  id          String   @id @default(uuid()) @db.Uuid
  patientId   String   @map("patient_id") @db.Uuid
  filename    String
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  storagePath String   @map("storage_path")
  uploadedBy  String   @map("uploaded_by")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([uploadedAt])
  @@map("patient_documents")
}

// Clinic settings (singleton pattern - always id = 'default')
model ClinicSettings {
  id                      String   @id @default("default")
  businessHours           Json     @map("business_hours") // { monday: { open: "09:00", close: "18:00" }, ... }
  lunchBreak              Json     @map("lunch_break") // { start: "12:00", end: "13:00" }
  antecedenciaMinima      Int      @default(24) @map("antecedencia_minima") // Minimum hours before appointment
  notificationPreferences Json?    @map("notification_preferences") // Future flexibility
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("clinic_settings")
}

// Service catalog for appointments
model Service {
  id        String   @id @default(uuid()) @db.Uuid
  nome      String
  duracao   Int      // Duration in minutes
  preco     Decimal  @db.Decimal(10, 2)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([nome])
  @@index([ativo])
  @@map("services")
}

// Waitlist for appointment slots
model Waitlist {
  id            String   @id @default(uuid()) @db.Uuid
  paciente_id   String   @map("paciente_id") @db.Uuid
  servico_tipo  String   @map("servico_tipo")  // Service type (e.g., "Consulta", "Retorno")
  provider_id   String?  @map("provider_id") @db.Uuid  // Specific provider preference (optional)
  priority      String   @default("CONVENIENCE")  // URGENT or CONVENIENCE
  preferred_date DateTime? @map("preferred_date")  // Preferred date/time (optional)
  notes         String?
  status        String   @default("ACTIVE")  // ACTIVE, NOTIFIED, FILLED, EXPIRED
  created_at    DateTime @default(now()) @map("created_at")
  expires_at    DateTime  @map("expires_at")  // Auto-set to 7 days from creation
  created_by    String   @map("created_by")

  paciente Patient   @relation("WaitlistPatient", fields: [paciente_id], references: [id], onDelete: Cascade)
  provider Provider? @relation("WaitlistProvider", fields: [provider_id], references: [id])
  criador  User      @relation("WaitlistCreator", fields: [created_by], references: [id])

  @@index([status, priority, created_at])  // For priority queue queries
  @@index([paciente_id, servico_tipo])  // Prevent duplicates
  @@map("waitlist")
}
