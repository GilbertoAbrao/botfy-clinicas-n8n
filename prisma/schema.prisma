// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Console users table (separate from Supabase Auth)
model User {
  id             String     @id
  email          String     @unique
  role           Role       @default(ATENDENTE)
  ativo          Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  auditLogs         AuditLog[]
  resolvedAlerts    Alert[]
  uploadedDocuments PatientDocument[]
  waitlistCreations Waitlist[] @relation("WaitlistCreator")

  @@map("users")
}

enum Role {
  ADMIN
  ATENDENTE
}

// Alert type enums
enum AlertType {
  conversas_travadas
  pre_checkins_pendentes
  agendamentos_nao_confirmados
  handoff_normal
  handoff_erro
}

enum AlertPriority {
  urgent
  high
  low
}

enum AlertStatus {
  new
  in_progress
  resolved
  dismissed
}

// HIPAA-compliant audit logging (6-year retention required)
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   // "VIEW_PATIENT", "UPDATE_APPOINTMENT", "DELETE_RECORD"
  resource   String   // "patients", "appointments", "chats"
  resourceId String?  @map("resource_id") // ID of the accessed resource
  details    Json?    // Additional context (what changed, etc.)
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([createdAt])
  @@index([resource])
  @@map("audit_logs")
}

// Patient information (PHI - Protected Health Information)
// Maps to the 'pacientes' table used by N8N
model Patient {
  id                Int            @id @default(autoincrement())
  nome              String
  telefone          String         @unique
  email             String?
  cpf               String?
  dataNascimento    DateTime?      @map("data_nascimento") @db.Date
  convenio          String?
  observacoes       String?
  createdAt         DateTime?      @default(now()) @map("created_at")
  updatedAt         DateTime?      @updatedAt @map("updated_at")

  agendamentos      Appointment[]

  @@index([telefone])
  @@index([cpf])
  @@index([nome])
  @@map("pacientes")
}

// Provider/Professional information
model Provider {
  id               String   @id @default(uuid()) @db.Uuid
  nome             String
  especialidade    String?
  cor_calendario   String   @default("#8B5CF6") // Purple default
  ativo            Boolean  @default(true)
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  // Note: agendamentos uses 'profissional' as string name, not provider_id
  waitlistEntries Waitlist[] @relation("WaitlistProvider")

  @@map("providers")
}

// Appointment scheduling - maps to 'agendamentos' table used by N8N
model Appointment {
  id              Int       @id @default(autoincrement())
  pacienteId      Int       @map("paciente_id")
  tipoConsulta    String    @map("tipo_consulta")
  profissional    String?
  dataHora        DateTime  @map("data_hora") @db.Timestamptz
  duracaoMinutos  Int?      @default(30) @map("duracao_minutos")
  status          String?   @default("agendada")
  valor           Decimal?  @db.Decimal
  convenioUsado   String?   @map("convenio_usado")
  observacoes     String?
  googleEventId   String?   @map("google_event_id")
  createdAt       DateTime? @default(now()) @map("created_at")
  updatedAt       DateTime? @updatedAt @map("updated_at")
  servicoId       Int?      @map("servico_id")

  paciente        Patient   @relation(fields: [pacienteId], references: [id])

  @@index([pacienteId])
  @@index([dataHora])
  @@index([status])
  @@map("agendamentos")
}

// N8N Chat History - WhatsApp conversation messages
// Each row is a single message in a conversation thread (identified by session_id)
model ChatHistory {
  id        Int      @id @default(autoincrement())
  sessionId String   @map("session_id") @db.VarChar(255)
  message   Json     @db.JsonB
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  @@index([sessionId])
  @@index([createdAt])
  @@map("n8n_chat_histories")
}

// Alert system
model Alert {
  id             String        @id @default(uuid()) @db.Uuid
  type           AlertType
  priority       AlertPriority
  status         AlertStatus   @default(new)
  title          String
  description    String?
  patientId      String?       @map("patient_id") @db.Uuid
  appointmentId  String?       @map("appointment_id") @db.Uuid
  chatSessionId  String?       @map("chat_session_id") // n8n chat session_id
  metadata       Json?         // Additional context like error messages
  resolvedAt     DateTime?     @map("resolved_at")
  resolvedBy     String?       @map("resolved_by")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations temporarily disabled - alerts table uses UUID FKs pointing to legacy tables
  // patient        Patient?      @relation(fields: [patientId], references: [id])
  // appointment    Appointment?  @relation(fields: [appointmentId], references: [id])
  resolver       User?         @relation(fields: [resolvedBy], references: [id])

  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([patientId])
  @@map("alerts")
}

// Patient document storage (links to Supabase Storage)
// Note: This table uses UUID patient_id referencing the legacy 'patients' table
model PatientDocument {
  id          String   @id @default(uuid()) @db.Uuid
  patientId   String   @map("patient_id") @db.Uuid
  filename    String
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  storagePath String   @map("storage_path")
  uploadedBy  String   @map("uploaded_by")
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  uploader    User     @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([uploadedAt])
  @@map("patient_documents")
}

// Clinic settings (singleton pattern - always id = 'default')
model ClinicSettings {
  id                      String   @id @default("default")
  businessHours           Json     @map("business_hours") // { monday: { open: "09:00", close: "18:00" }, ... }
  lunchBreak              Json     @map("lunch_break") // { start: "12:00", end: "13:00" }
  antecedenciaMinima      Int      @default(24) @map("antecedencia_minima") // Minimum hours before appointment
  notificationPreferences Json?    @map("notification_preferences") // Future flexibility
  updatedAt               DateTime @updatedAt @map("updated_at")

  @@map("clinic_settings")
}

// Service catalog for appointments
model Service {
  id        String   @id @default(uuid()) @db.Uuid
  nome      String
  duracao   Int      // Duration in minutes
  preco     Decimal  @db.Decimal(10, 2)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([nome])
  @@index([ativo])
  @@map("services")
}

// Waitlist for appointment slots
// Note: This table uses UUID paciente_id - needs migration to use pacientes.id (Int)
model Waitlist {
  id            String    @id @default(uuid()) @db.Uuid
  paciente_id   String    @db.Uuid
  servico_tipo  String    // Service type (e.g., "Consulta", "Retorno")
  provider_id   String?   @db.Uuid  // Specific provider preference (optional)
  priority      String    @default("CONVENIENCE")  // URGENT or CONVENIENCE
  preferred_date DateTime? // Preferred date/time (optional)
  notes         String?
  status        String    @default("ACTIVE")  // ACTIVE, NOTIFIED, FILLED, EXPIRED
  created_at    DateTime  @default(now())
  expires_at    DateTime  // Auto-set to 7 days from creation
  created_by    String
  notificado_em DateTime? @db.Timestamptz

  provider Provider? @relation("WaitlistProvider", fields: [provider_id], references: [id])
  criador  User      @relation("WaitlistCreator", fields: [created_by], references: [id])

  @@index([status, priority, created_at])  // For priority queue queries
  @@index([paciente_id, servico_tipo])  // Prevent duplicates
  @@map("waitlist")
}
