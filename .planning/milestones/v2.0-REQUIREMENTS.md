# Requirements Archive: v2.0 Agent API Migration

**Archived:** 2026-01-25
**Status:** SHIPPED

This is the archived requirements specification for v2.0.
For current requirements, see `.planning/REQUIREMENTS.md` (created for next milestone).

---

## v2.0 Requirements

Requirements for migrating N8N AI Agent tools to Next.js APIs + MCP Server.

### API Foundation

- [x] **FOUND-01**: Agent authentication via API key (Bearer token) in middleware — VALIDATED
- [x] **FOUND-02**: Shared error handling utility returning `{success, error, details}` format — VALIDATED
- [x] **FOUND-03**: Agent audit logging with `agentId` and correlation ID for HIPAA compliance — VALIDATED
- [x] **FOUND-04**: Service layer extraction for business logic reuse across tools — DEFERRED (created fresh)
- [x] **FOUND-05**: Flexible input validation with Zod accepting multiple date formats — VALIDATED

### Query Tools (Read Operations)

- [x] **QUERY-01**: `GET /api/agent/slots` — Returns available appointment slots for date/period — VALIDATED
- [x] **QUERY-02**: `GET /api/agent/agendamentos` — Returns patient appointments with filters — VALIDATED
- [x] **QUERY-03**: `GET /api/agent/paciente` — Searches patient by phone or CPF — VALIDATED
- [x] **QUERY-04**: `GET /api/agent/pre-checkin/status` — Returns pre-checkin document status — VALIDATED
- [x] **QUERY-05**: `GET /api/agent/instrucoes` — Returns procedure instructions by service/type — VALIDATED

### Write Tools (Create/Update Operations)

- [x] **WRITE-01**: `POST /api/agent/agendamentos` — Creates appointment with conflict detection and idempotency — VALIDATED
- [x] **WRITE-02**: `PATCH /api/agent/agendamentos/:id` — Reschedules appointment with validation — VALIDATED
- [x] **WRITE-03**: `DELETE /api/agent/agendamentos/:id` — Cancels appointment with reason — VALIDATED
- [x] **WRITE-04**: `PATCH /api/agent/paciente/:id` — Updates patient data with partial update support — VALIDATED
- [x] **WRITE-05**: `POST /api/agent/agendamentos/:id/confirmar` — Confirms appointment attendance — VALIDATED

### Complex Tools (Specialized Operations)

- [x] **CMPLX-01**: `POST /api/agent/documentos/processar` — Processes uploaded document with validation — VALIDATED
- [x] **CMPLX-02**: Document type detection and field extraction from images — VALIDATED

### N8N Integration

- [x] **N8N-01**: HTTP Request node configured with Bearer token credentials — VALIDATED
- [x] **N8N-02**: N8N credential created and encrypted for API key storage — VALIDATED
- [x] **N8N-03**: Gradual rollout mechanism (10% → 50% → 100%) — VALIDATED
- [x] **N8N-04**: Sub-workflows archived (not deleted) after successful migration — VALIDATED
- [x] **N8N-05**: Rollback procedure documented and tested — VALIDATED

### MCP Server (Optional)

- [x] **MCP-01**: MCP Server wrapper with stdio transport exposing all 11 tools — VALIDATED
- [x] **MCP-02**: Claude Desktop configuration file for local testing — VALIDATED
- [x] **MCP-03**: Error handling and heartbeat logging for reliability — VALIDATED

## Traceability

| Requirement | Phase | Status |
|-------------|-------|--------|
| FOUND-01 | Phase 17 | Complete |
| FOUND-02 | Phase 17 | Complete |
| FOUND-03 | Phase 17 | Complete |
| FOUND-04 | Phase 18+ | Deferred |
| FOUND-05 | Phase 17 | Complete |
| QUERY-01 | Phase 18 | Complete |
| QUERY-02 | Phase 18 | Complete |
| QUERY-03 | Phase 18 | Complete |
| QUERY-04 | Phase 18 | Complete |
| QUERY-05 | Phase 18 | Complete |
| WRITE-01 | Phase 19 | Complete |
| WRITE-02 | Phase 19 | Complete |
| WRITE-03 | Phase 19 | Complete |
| WRITE-04 | Phase 19 | Complete |
| WRITE-05 | Phase 19 | Complete |
| CMPLX-01 | Phase 20 | Complete |
| CMPLX-02 | Phase 20 | Complete |
| N8N-01 | Phase 21 | Complete |
| N8N-02 | Phase 21 | Complete |
| N8N-03 | Phase 21 | Complete |
| N8N-04 | Phase 21 | Complete |
| N8N-05 | Phase 21 | Complete |
| MCP-01 | Phase 22 | Complete |
| MCP-02 | Phase 22 | Complete |
| MCP-03 | Phase 22 | Complete |

---

## Milestone Summary

**Shipped:** 23 of 24 v2.0 requirements (96%)

**Adjusted:**
- FOUND-04 (Service layer extraction): Created fresh services in Phase 18-20 instead of extracting from Console UI routes. Agent services work correctly; consolidation deferred to v2.1+.

**Dropped:** None

---
*Archived: 2026-01-25 as part of v2.0 milestone completion*
