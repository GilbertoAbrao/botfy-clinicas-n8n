# Milestone v1.1: Anti No-Show Intelligence

**Status:** ✅ SHIPPED 2026-01-21
**Phases:** 9-12
**Total Plans:** 9

## Overview

v1.1 extends the console with no-show risk visibility. The N8N Anti No-Show workflow was fixed to persist risk scores, and the console provides management UI for reminder configurations, sent reminder history, and risk analytics.

## Phases

### Phase 9: N8N Anti No-Show Fix

**Goal:** Fix N8N workflow to persist risk data to lembretes_enviados table
**Depends on:** Nothing (first phase of v1.1)
**Plans:** 1 plan

Plans:
- [x] 09-01: Fix N8N INSERT to include risco_noshow and mensagem_enviada

**Details:**
- Modified N8N workflow "Botfy - Anti No-Show" (ID: HTR3ITfFDrK6eP2R)
- Updated INSERT query in "Registra Lembrete Enviado" node
- Added risco_noshow (INTEGER 0-100) and mensagem_enviada (TEXT) columns
- Data sourced from Extrai Score Risco and Prepara Envio WhatsApp nodes

### Phase 10: Config Lembretes

**Goal:** Full CRUD interface for reminder configurations
**Depends on:** Phase 9 (data must be saved correctly before managing configs)
**Plans:** 3 plans

Plans:
- [x] 10-01: Config lembretes API routes (validation, CRUD endpoints)
- [x] 10-02: Config lembretes UI components (table, form, actions)
- [x] 10-03: Config lembretes page and navigation

**Details:**
- API routes: GET/POST /api/config-lembretes, GET/PUT/DELETE /api/config-lembretes/[id]
- Zod validation schema with duplicate name checks
- UI components: table, form modal, search, pagination, actions
- Page at /admin/lembretes with sidebar navigation (Bell icon)
- RBAC: MANAGE_SYSTEM_CONFIG permission required

### Phase 11: Lembretes Enviados

**Goal:** Read-only history panel showing sent reminders with filtering
**Depends on:** Phase 9 (risk score must be saved to display)
**Plans:** 3 plans

Plans:
- [x] 11-01: Lembretes enviados list page with table (HIST-01, HIST-05)
- [x] 11-02: Date, patient, and status filters (HIST-02, HIST-03, HIST-04)
- [x] 11-03: Reminder detail view modal (HIST-06)

**Details:**
- API routes: GET /api/lembretes-enviados, GET /api/lembretes-enviados/[id]
- Filters: status, tipo, date range, patient search, minimum risk score
- Quick filter presets: Hoje, Esta semana, Pendentes, Alto risco
- Risk score color badges: green (<40%), yellow (40-69%), red (≥70%)
- Phone masking for privacy
- Page at /admin/lembretes-enviados with sidebar navigation

### Phase 12: Analytics Risco No-Show

**Goal:** Analytics dashboard visualizing no-show risk data and patterns
**Depends on:** Phase 9, Phase 11 (needs historical risk data)
**Plans:** 2 plans

Plans:
- [x] 12-01: Backend risk analytics infrastructure (API + calculator)
- [x] 12-02: Risk analytics dashboard UI (charts)

**Details:**
- API route: GET /api/analytics/risco with period filtering
- Risk calculator: calculateRiskDistribution, calculatePredictedVsActual, calculateNoShowPatterns
- Charts: RiskDistributionChart, PredictedVsActualChart, NoShowPatternsCharts
- Patterns by: day of week (Domingo-Sabado), time slot (Manha/Tarde/Noite), service type
- Page at /admin/analytics/risco with sidebar navigation (TrendingDown icon)
- Uses recharts@3.6.0 for visualizations

---

## Milestone Summary

**Key Decisions:**
- Used Supabase admin client to bypass RLS for N8N-owned tables
- Risk levels: baixo (<40), medio (40-69), alto (≥70) matching existing UI patterns
- Portuguese labels for day names and time slots
- Mixed data sources: Supabase for lembretes_enviados, Prisma for appointments

**Issues Resolved:**
- Column name mismatch between database (data_envio) and API (enviado_em) — fixed with mapping
- RLS blocking N8N table queries — resolved with createAdminClient

**Technical Debt Incurred:**
- Missing VERIFICATION.md for phases 9 and 10 (documentation only)

---

*For current project status, see .planning/ROADMAP.md*
*Archived: 2026-01-21*
