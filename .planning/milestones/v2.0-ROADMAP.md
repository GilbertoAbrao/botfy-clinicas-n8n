# Milestone v2.0: Agent API Migration

**Status:** SHIPPED 2026-01-25
**Phases:** 17-22
**Total Plans:** 24

## Overview

Migrate 11 N8N AI Agent tools from sub-workflows to Next.js API routes with MCP Server wrapper, bringing business logic into codebase for type safety, testability, and maintainability.

**Architecture:**
```
WhatsApp → N8N Webhook → AI Agent → HTTP Request → Next.js APIs → Supabase
                                         ↓
                                    MCP Server (optional)
```

## Phases

### Phase 17: Agent API Foundation

**Goal**: Agent authentication, error handling, audit logging, and service layer infrastructure
**Depends on**: Phase 16 (v1.2 complete)
**Plans**: 4 plans

Plans:
- [x] 17-01-PLAN.md — Agent types and database schema (bcrypt, Agent model)
- [x] 17-02-PLAN.md — Error handling and audit logger extension
- [x] 17-03-PLAN.md — Flexible date validation schemas
- [x] 17-04-PLAN.md — Authentication middleware and API key generation

**Details:**
- Bearer token authentication with bcrypt-hashed API keys
- Consistent error response format: `{success, data?, error?, details?}`
- HIPAA-compliant audit logging with agentId and correlationId
- Flexible Zod schemas for ISO 8601 and Brazil locale dates

### Phase 18: Query Tools (Read Operations)

**Goal**: AI Agent can query available slots, appointments, patient data, pre-checkin status, and instructions
**Depends on**: Phase 17
**Plans**: 5 plans

Plans:
- [x] 18-01-PLAN.md — Slots API (slot-service.ts + GET /api/agent/slots)
- [x] 18-02-PLAN.md — Appointments API (appointment-service.ts + GET /api/agent/agendamentos)
- [x] 18-03-PLAN.md — Patient API (patient-service.ts + GET /api/agent/paciente)
- [x] 18-04-PLAN.md — Pre-checkin Status API (pre-checkin-service.ts + GET /api/agent/pre-checkin/status)
- [x] 18-05-PLAN.md — Instructions API (instruction-service.ts + GET /api/agent/instrucoes)

**Details:**
- Service layer pattern for business logic separation
- Page-based pagination with configurable limits
- Exact-first-partial-fallback search pattern
- Upcoming appointments context included in patient search

### Phase 19: Write Tools (Create/Update Operations)

**Goal**: AI Agent can create, reschedule, cancel appointments, update patient data, and confirm attendance
**Depends on**: Phase 18
**Plans**: 4 plans

Plans:
- [x] 19-01-PLAN.md — Create Appointment API (POST /api/agent/agendamentos with idempotency)
- [x] 19-02-PLAN.md — Reschedule and Cancel API (PATCH/DELETE /api/agent/agendamentos/:id)
- [x] 19-03-PLAN.md — Update Patient API (PATCH /api/agent/paciente/:id)
- [x] 19-04-PLAN.md — Confirm Attendance API (POST /api/agent/agendamentos/:id/confirmar)

**Details:**
- Idempotency key support for retry safety
- State machine validation for confirmado/presente transitions
- Partial update support for patient data
- Phone uniqueness validation across patients

### Phase 20: Complex Tools (Specialized Operations)

**Goal**: AI Agent can process uploaded documents and extract structured data from images
**Depends on**: Phase 19
**Plans**: 3 plans

Plans:
- [x] 20-01-PLAN.md — File validation with magic bytes and document type schemas
- [x] 20-02-PLAN.md — GPT-4o Vision extractor and Supabase Storage services
- [x] 20-03-PLAN.md — Document processing API (POST /api/agent/documentos/processar)

**Details:**
- Magic byte file validation (OWASP-compliant)
- GPT-4o Vision for Brazilian document extraction (RG, CPF, CNS, insurance cards)
- Supabase Storage for document persistence
- PHI-safe audit logging (document type, confidence only)

### Phase 21: N8N Integration (Production Migration)

**Goal**: N8N AI Agent workflows call Next.js APIs instead of sub-workflows, with gradual rollout
**Depends on**: Phase 20
**Plans**: 4 plans

Plans:
- [x] 21-01-PLAN.md — Credential setup and API endpoint reference
- [x] 21-02-PLAN.md — Response transformer templates and migration checklist
- [x] 21-03-PLAN.md — Gradual rollout implementation guide
- [x] 21-04-PLAN.md — Rollback runbook and archive procedure

**Details:**
- Header Auth credential (not Bearer Auth due to N8N issues)
- ROLLOUT_PERCENTAGE code node pattern
- 10% canary → 50% beta → 100% GA rollout
- Sub-5-minute rollback procedure
- Archive instead of delete policy

### Phase 22: MCP Server (Optional Enhancement)

**Goal**: Standalone MCP Server exposes all 11 tools for Claude Desktop integration
**Depends on**: Phase 21
**Plans**: 4 plans

Plans:
- [x] 22-01-PLAN.md — MCP Server foundation (config, http-client, logger, heartbeat, server entry point)
- [x] 22-02-PLAN.md — Query tool handlers (5 read-only tools)
- [x] 22-03-PLAN.md — Write tool handlers (5 create/update/delete tools)
- [x] 22-04-PLAN.md — Document tool, full server integration, and Claude Desktop config

**Details:**
- stdio transport for Claude Desktop
- All 11 tools registered with Zod input schemas
- Base64 document input with multipart FormData conversion
- Dual success checking (HTTP + API-level)
- Heartbeat monitoring with request/error counts

---

## Milestone Summary

**Key Decisions:**
- bcrypt for API key hashing (12 salt rounds)
- Bearer token authentication standard
- Service layer pattern for business logic
- Header Auth vs Bearer Auth in N8N (Header more reliable)
- Gradual rollout (10%→50%→100%) for safe migration
- GPT-4o Vision for high accuracy document extraction
- MCP stdio transport for native Claude Desktop integration
- Create services fresh vs extract from UI (tech debt accepted)

**Issues Resolved:**
- N8N AI Agent now has type-safe, testable APIs
- Document processing centralized with GPT-4o Vision
- MCP Server enables Claude Desktop integration

**Issues Deferred:**
- FOUND-04: Service layer extraction (created fresh instead)
- Production monitoring (console.error() → DataDog/Sentry)
- Screenshot placeholders in credential-setup.md

**Technical Debt Incurred:**
- Agent services created fresh instead of extracted from UI routes
- 3 N8N sub-workflows not yet exported to workflows-backup/
- Emergency contacts empty in rollback-runbook.md

---

*For current project status, see .planning/PROJECT.md*

---
*Archived: 2026-01-25 as part of v2.0 milestone completion*
