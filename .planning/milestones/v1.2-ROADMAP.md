# Milestone v1.2: Agenda List View + Pre-Checkin Management

**Status:** ✅ SHIPPED 2026-01-21
**Phases:** 13-16
**Total Plans:** 18

## Overview

Toggle entre calendário e lista na página de agenda, com filtros avançados e ações rápidas. Dashboard de gestão de pré-checkins com analytics. Interface ADMIN para instruções de procedimentos. Gestão de documentos de pacientes.

## Phases

### Phase 13: Agenda List View

**Goal**: Adicionar view de lista como alternativa ao calendário na página de agenda, com filtros avançados e ações rápidas.
**Depends on**: None - extends existing calendar page
**Plans**: 5 plans

Plans:
- [x] 13-01: Data layer - install TanStack Table, create API endpoint and hook
- [x] 13-02: Table columns and sorting with TanStack Table
- [x] 13-03: Filter controls and pagination
- [x] 13-04: Mobile card layout
- [x] 13-05: Wire up list view and page integration

**Requirements covered:** ALIST-01 to ALIST-12 (12 requirements)

| ID | Requirement |
|----|-------------|
| ALIST-01 | Toggle calendar/list via button |
| ALIST-02 | Table with Date/Time, Patient, Service, Provider, Status, Actions |
| ALIST-03 | Filter by date range |
| ALIST-04 | Filter by provider (multi-select) |
| ALIST-05 | Filter by service type |
| ALIST-06 | Filter by status |
| ALIST-07 | Sort by any column |
| ALIST-08 | Search by patient name/phone |
| ALIST-09 | Quick action buttons: Edit, Confirm, Cancel |
| ALIST-10 | No-show risk badge |
| ALIST-11 | Pagination (50 rows) |
| ALIST-12 | Mobile responsive (card layout) |

**Success Criteria:**
1. User toggles between calendar and list view; filter state persists across toggle
2. List displays appointments with all columns; data matches calendar view
3. All filters (date, provider, service, status) work correctly and can be combined
4. Sorting by column works in both directions (asc/desc)
5. Search finds appointments by patient name or phone number
6. Quick actions (edit, confirm, cancel) work from list view
7. Risk badge shows for future appointments with calculated risk
8. Pagination controls appear when >50 appointments
9. Mobile view shows card layout instead of table

**Technical Notes:**
- Installed @tanstack/react-table v8.21.3
- Reused existing useCalendarEvents hook for data
- View preference stored in URL query param (`?view=list`)
- Reused AppointmentModal for edit actions

---

### Phase 14: Pre-Checkin Dashboard

**Goal**: Dashboard para visualizar e gerenciar status de pré-checkins, com analytics e ações de intervenção.
**Depends on**: Phase 13 (list view patterns)
**Plans**: 5 plans

Plans:
- [x] 14-01: Data layer - types, hooks, API routes
- [x] 14-02: Analytics cards component
- [x] 14-03: Table, cards, filters, pagination components
- [x] 14-04: Detail modal with timeline and N8N reminder integration
- [x] 14-05: Page integration and navigation

**Requirements covered:** PCHK-01 to PCHK-13 (13 requirements)

| ID | Requirement |
|----|-------------|
| PCHK-01 | Dashboard page with pre-checkin table |
| PCHK-02 | Columns: Patient, Appointment, Service, Status, Progress, Actions |
| PCHK-03 | Status badges: Pendente, Em Andamento, Completo, Incompleto |
| PCHK-04 | Filter by status |
| PCHK-05 | Filter by appointment date range |
| PCHK-06 | Search by patient name |
| PCHK-07 | Click row opens detail modal |
| PCHK-08 | Detail modal shows checklist (dados, docs, instrucoes) |
| PCHK-09 | Mark complete/incomplete from modal |
| PCHK-10 | Send reminder action (N8N webhook) |
| PCHK-11 | Analytics cards: completion rate, pending, overdue |
| PCHK-12 | Timeline view of workflow progress |
| PCHK-13 | Mobile responsive |

**Success Criteria:**
1. Dashboard shows all pre-checkin records from `pre_checkin` table
2. Status badges use correct colors (blue=pending, yellow=in_progress, green=complete, red=incomplete)
3. All filters work and persist in URL
4. Detail modal shows full checklist with timestamps
5. Mark complete/incomplete updates database and refreshes list
6. Send reminder triggers N8N webhook and shows success toast
7. Analytics cards show accurate calculations from database
8. Timeline shows workflow progression with timestamps
9. Mobile layout is usable on 320px screens

**Technical Notes:**
- New page at `/admin/pre-checkin`
- API routes: GET/PUT `/api/pre-checkin`, POST `/api/pre-checkin/[id]/send-reminder`
- Used Supabase admin client to bypass RLS for N8N tables
- N8N webhook URL from environment variable

---

### Phase 15: Procedure Instructions CRUD

**Goal**: Interface ADMIN para gerenciar instruções de procedimentos que o N8N envia aos pacientes.
**Depends on**: None - standalone CRUD
**Plans**: 4 plans

Plans:
- [x] 15-01: Data layer - Prisma model, Zod schema, audit actions
- [x] 15-02: API routes - list, create, update, deactivate
- [x] 15-03: UI components - table, form modal, WhatsApp preview
- [x] 15-04: Page integration and navigation

**Requirements covered:** INST-01 to INST-09 (9 requirements)

| ID | Requirement |
|----|-------------|
| INST-01 | List all procedure instructions |
| INST-02 | Search by service name or title |
| INST-03 | Create new instruction form |
| INST-04 | Form fields: service, type, title, content, priority, active |
| INST-05 | Instruction types: preparo, jejum, medicamentos, vestuario, acompanhante, documentos, geral |
| INST-06 | Edit existing instruction |
| INST-07 | Deactivate (soft delete) instruction |
| INST-08 | Preview WhatsApp message format |
| INST-09 | ADMIN-only access |

**Success Criteria:**
1. List displays all instructions from `instrucoes_procedimentos` table
2. Search filters list by service name or instruction title
3. Create form validates all required fields and saves to database
4. Type dropdown shows all 7 instruction types
5. Edit form pre-fills with existing data and saves changes
6. Deactivate sets `ativo=false` instead of deleting
7. Preview shows instruction formatted as WhatsApp message
8. Non-ADMIN users see 403 error when accessing page

**Technical Notes:**
- New page at `/admin/pre-checkin/instrucoes`
- API routes: CRUD `/api/procedures/instructions`
- Zod validation for form fields
- WhatsApp preview: text formatting with template variable replacement

---

### Phase 16: Document Management

**Goal**: Interface para visualizar e validar documentos de pacientes enviados durante pre-checkin.
**Depends on**: Phase 14 (API patterns)
**Plans**: 4 plans

Plans:
- [x] 16-01: Data layer - types, validation schemas, audit actions, hook
- [x] 16-02: API routes - list, approve, reject, preview, bulk actions
- [x] 16-03: UI components - table with row selection, filters, modals, bulk actions bar
- [x] 16-04: Page integration and navigation

**Requirements covered:** DOCS-01 to DOCS-12 (12 requirements)

| ID | Requirement |
|----|-------------|
| DOCS-01 | List all patient documents |
| DOCS-02 | Columns: Patient, Type, Upload Date, Status, Actions |
| DOCS-03 | Filter by status (pendente, aprovado, rejeitado) |
| DOCS-04 | Filter by document type |
| DOCS-05 | Filter by date range |
| DOCS-06 | Search by patient name |
| DOCS-07 | Approve document with optional notes |
| DOCS-08 | Reject document with required reason |
| DOCS-09 | Preview document in modal |
| DOCS-10 | Download original file |
| DOCS-11 | Bulk approve multiple documents |
| DOCS-12 | Bulk reject multiple documents |

**Success Criteria:**
1. List displays all documents from `documentos_paciente` table
2. All columns show correct data with proper formatting
3. Status filter shows correct counts per status
4. Type filter dropdown shows all document types
5. Approve action updates status and logs audit event
6. Reject requires reason field and updates status
7. Preview modal shows image or iframe for PDF
8. Download triggers file download from Supabase Storage
9. Bulk select allows approving multiple documents at once
10. Bulk reject shows single reason input for all selected

**Technical Notes:**
- New page at `/admin/pre-checkin/documentos`
- API routes: GET `/api/patient-documents`, POST approve/reject/bulk endpoints
- Supabase Storage signed URLs for preview/download
- Bulk actions: checkbox column + floating action bar

---

## Milestone Summary

**Key Decisions:**

| Decision | Rationale |
|----------|-----------|
| TanStack Table for agenda list | Headless table with shadcn/ui integration |
| Default 50 items per page | Balance between data visibility and performance |
| Provider filter as comma-separated IDs | Multi-select without complex query params |
| 300ms debounce for search | Balance responsiveness and API calls |
| ViewToggle preserves search params | Seamless filter persistence across views |
| Rate limit 4 hours between reminders | Server-side enforcement with 429 status |
| Soft delete for instructions (PATCH) | Preserves data, INST-07 requirement |
| WhatsApp preview with Brazilian sample data | Realistic preview for content creators |
| Computed document status from validado field | null=pendente, true=aprovado, false=rejeitado |
| TanStack row selection for bulk actions | Controlled selection with floating action bar |

**Issues Resolved:**
- Zod v4 enum syntax (deprecated errorMap → message param)
- react-hook-form zodResolver type inference with .default()
- Supabase nested field filtering limitations (client-side workaround)

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- Phase 15 missing VERIFICATION.md and 15-04-SUMMARY.md (documentation gap)
- Missing VERIFICATION.md for phases 4, 5, 6, 9, 10 (carried from v1.0/v1.1)
- formatPhone/formatCPF utilities duplicated in components

---

_For current project status, see .planning/ROADMAP.md_

---
*Archived: 2026-01-21 as part of v1.2 milestone completion*
