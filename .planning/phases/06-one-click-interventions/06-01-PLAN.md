---
phase: 06-one-click-interventions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/interventions/reschedule-modal.tsx
  - src/components/interventions/send-message-modal.tsx
  - src/components/alerts/alert-detail.tsx
  - src/lib/api/alerts.ts
  - src/app/api/alerts/[id]/resolve/route.ts
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "User can reschedule appointment from alert detail without leaving the page"
    - "User can see pre-filled form with patient and appointment context"
    - "User can initiate WhatsApp message from alert detail"
    - "Alert auto-resolves after successful intervention"
    - "All interventions complete in <2 seconds with success feedback"
  artifacts:
    - path: "src/components/interventions/reschedule-modal.tsx"
      provides: "Reschedule modal with patient/appointment context pre-filled"
      min_lines: 80
    - path: "src/components/interventions/send-message-modal.tsx"
      provides: "Send message modal with WhatsApp deep link"
      min_lines: 60
    - path: "src/app/api/alerts/[id]/resolve/route.ts"
      provides: "Auto-resolve alert after intervention"
      exports: ["POST"]
  key_links:
    - from: "src/components/alerts/alert-detail.tsx"
      to: "RescheduleModal"
      via: "onClick handler opens modal with appointment context"
      pattern: "<RescheduleModal"
    - from: "src/components/alerts/alert-detail.tsx"
      to: "SendMessageModal"
      via: "onClick handler opens modal with patient phone"
      pattern: "<SendMessageModal"
    - from: "RescheduleModal"
      to: "/api/agendamentos/[id]"
      via: "PUT request to update appointment"
      pattern: "fetch.*api/agendamentos"
---

<objective>
Enable one-click interventions from alert detail view: reschedule appointments, send WhatsApp messages, and auto-resolve alerts after successful actions.

Purpose: This is the competitive differentiator — staff can fix issues directly from alerts without navigating away. Reduces mean time to resolution (MTTR) for operational issues.

Output: Working "Reagendar" and "Enviar Mensagem" buttons in alert detail that open pre-filled modals, perform actions, and auto-resolve alerts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key prior work that this plan builds on:
@.planning/phases/02-alert-dashboard/02-03-SUMMARY.md
@.planning/phases/04-calendar-scheduling/04-04-SUMMARY.md
@.planning/phases/05-conversation-monitoring/05-02-SUMMARY.md

# Source files to modify/reference:
@src/components/alerts/alert-detail.tsx
@src/components/calendar/appointment-modal.tsx
@src/components/conversations/clear-memory-button.tsx
@src/lib/calendar/n8n-sync.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RescheduleModal component</name>
  <files>src/components/interventions/reschedule-modal.tsx</files>
  <action>
    Create a modal specifically for rescheduling appointments from alert context.

    Pattern to follow: ClearMemoryButton (AlertDialog with confirmation) + AppointmentModal (form structure)

    Component props:
    - isOpen: boolean
    - onClose: () => void
    - appointmentId: string
    - patientName: string
    - serviceName: string
    - currentDateTime: string (ISO)
    - onSuccess: () => void (called after successful reschedule)

    Features:
    1. Header showing "Reagendar: {patientName}" for context
    2. Display current appointment info (service, date/time) as read-only
    3. datetime-local input for new date/time
    4. Textarea for optional notes
    5. Submit calls PUT /api/agendamentos/{id} with new dataHora
    6. Handle 409 conflict error with visible message (reuse pattern from AppointmentModal)
    7. On success: show toast, call onSuccess, close modal
    8. Loading state on submit button

    Use shadcn Dialog, Input, Button, Label, Textarea
    Mobile-friendly: large touch targets (44px min)
  </action>
  <verify>
    - File exists at src/components/interventions/reschedule-modal.tsx
    - npm run build passes
    - Component exports RescheduleModal
  </verify>
  <done>RescheduleModal component created with form, conflict handling, and success callback</done>
</task>

<task type="auto">
  <name>Task 2: Create SendMessageModal component</name>
  <files>src/components/interventions/send-message-modal.tsx</files>
  <action>
    Create a modal that prepares WhatsApp message and opens deep link.

    IMPORTANT: Per PROJECT.md, console does NOT send messages directly. Instead:
    - Show pre-composed message template
    - User can edit the message
    - "Abrir WhatsApp" button opens wa.me deep link with prefilled text
    - This respects the constraint "Envio direto de mensagens WhatsApp pelo console — apenas via IA existente ou manualmente pelo WhatsApp"

    Component props:
    - isOpen: boolean
    - onClose: () => void
    - patientName: string
    - patientPhone: string
    - alertType: string
    - appointmentInfo?: { serviceName: string, dateTime: string }
    - onSuccess: () => void

    Features:
    1. Header: "Enviar Mensagem: {patientName}"
    2. Display phone number with copy button
    3. Textarea with pre-filled message template based on alert type:
       - conversation_stuck: "Olá {patientName}, percebemos que você teve dificuldades com nosso atendimento automático. Como posso ajudar?"
       - no_show: "Olá {patientName}, sentimos sua falta na consulta de {serviceName}. Gostaria de reagendar?"
       - schedule_conflict: "Olá {patientName}, houve um conflito no seu agendamento. Vamos encontrar um novo horário?"
       - default: "Olá {patientName}, entrando em contato sobre seu atendimento na clínica."
    4. User can edit the message
    5. "Abrir WhatsApp" button constructs wa.me URL:
       - Format phone: remove non-digits, add 55 prefix if needed
       - URL: https://wa.me/{phone}?text={encodeURIComponent(message)}
       - window.open(url, '_blank')
    6. After opening WhatsApp, show "Marcar como Resolvido?" prompt
    7. If user confirms, call onSuccess (parent handles alert resolution)

    Use shadcn Dialog, Button, Textarea, AlertDialog for confirmation
  </action>
  <verify>
    - File exists at src/components/interventions/send-message-modal.tsx
    - npm run build passes
    - Component exports SendMessageModal
  </verify>
  <done>SendMessageModal component created with WhatsApp deep link and message templates</done>
</task>

<task type="auto">
  <name>Task 3: Create auto-resolve API endpoint</name>
  <files>src/app/api/alerts/[id]/resolve/route.ts</files>
  <action>
    Create API endpoint to mark alert as resolved with intervention details.

    POST /api/alerts/{id}/resolve
    Body: { interventionType: 'reschedule' | 'send_message' | 'clear_memory', notes?: string }

    Steps:
    1. Auth check: getCurrentUserWithRole(), require ADMIN or ATENDENTE
    2. Validate alertId exists
    3. Update alert:
       - status: 'resolved'
       - resolvedAt: new Date().toISOString()
       - resolvedBy: user.id
       - Add intervention type to metadata (JSON field if exists, or notes)
    4. Audit log: AuditAction.RESOLVE_ALERT with intervention details
    5. Return updated alert

    Pattern: Follow existing /api/alerts/[id]/route.ts for structure
  </action>
  <verify>
    - File exists at src/app/api/alerts/[id]/resolve/route.ts
    - npm run build passes
    - curl POST returns 200 with updated alert (manual test)
  </verify>
  <done>Auto-resolve endpoint created with audit logging</done>
</task>

<task type="auto">
  <name>Task 4: Integrate interventions into AlertDetail</name>
  <files>src/components/alerts/alert-detail.tsx</files>
  <action>
    Replace placeholder buttons with working intervention modals.

    Changes:
    1. Import RescheduleModal and SendMessageModal from '@/components/interventions'
    2. Add state for each modal: rescheduleOpen, sendMessageOpen
    3. Replace disabled "Reagendar" button:
       - Only show if alert.appointment exists
       - onClick opens RescheduleModal with:
         - appointmentId: alert.appointment.id
         - patientName: alert.patient?.nome
         - serviceName: alert.appointment.serviceType
         - currentDateTime: alert.appointment.scheduledAt
         - onSuccess: handleRescheduleSuccess
    4. Replace disabled "Enviar Mensagem" button:
       - Only show if alert.patient?.telefone exists
       - onClick opens SendMessageModal with:
         - patientName: alert.patient.nome
         - patientPhone: alert.patient.telefone
         - alertType: alert.type
         - appointmentInfo if alert.appointment exists
         - onSuccess: handleSendMessageSuccess
    5. Keep existing ClearMemoryButton (already working)
    6. Create handlers:
       - handleRescheduleSuccess: call POST /api/alerts/{id}/resolve with type 'reschedule', then onStatusChange
       - handleSendMessageSuccess: call POST /api/alerts/{id}/resolve with type 'send_message', then onStatusChange

    Remove "(Fase 6)" tooltips from buttons since they're now functional.
    Keep disabled state only when data is missing (no appointment, no phone).
  </action>
  <verify>
    - npm run build passes
    - Buttons appear enabled when data exists
    - Modals open with correct pre-filled data
  </verify>
  <done>AlertDetail has working Reagendar and Enviar Mensagem buttons</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] RescheduleModal opens with correct patient/appointment context
- [ ] SendMessageModal opens with correct phone and message template
- [ ] WhatsApp deep link opens correctly (wa.me format)
- [ ] Alert resolves after successful intervention
- [ ] Audit log captures intervention details
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- Interventions work end-to-end from alert detail
- Alert status updates after successful intervention
- Build passes with no TypeScript errors
  </success_criteria>

<output>
After completion, create `.planning/phases/06-one-click-interventions/06-01-SUMMARY.md`
</output>
