---
phase: 16-document-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/validations/patient-document.ts
  - src/lib/audit/logger.ts
  - src/hooks/use-patient-documents.ts
autonomous: true

must_haves:
  truths:
    - "Document types are validated against enum"
    - "Document status is computed from validado field"
    - "Hook fetches documents with patient data"
    - "Audit actions exist for document validation"
  artifacts:
    - path: "src/lib/validations/patient-document.ts"
      provides: "Zod schemas, types, status constants, document type enum"
      exports: ["patientDocumentFiltersSchema", "PatientDocument", "DOCUMENT_TYPES", "DOCUMENT_STATUS"]
    - path: "src/hooks/use-patient-documents.ts"
      provides: "React hook for document list fetching"
      exports: ["usePatientDocuments"]
    - path: "src/lib/audit/logger.ts"
      provides: "Audit actions for document validation"
      contains: "APPROVE_DOCUMENT"
  key_links:
    - from: "src/hooks/use-patient-documents.ts"
      to: "/api/patient-documents"
      via: "fetch in useCallback"
      pattern: "fetch.*api/patient-documents"
---

<objective>
Create data layer for document management: Zod validation schemas, TypeScript types, document type/status constants, audit actions, and React hook for fetching documents.

Purpose: Foundation layer that API routes and UI components will consume.
Output: Validation schemas, types, constants, and data fetching hook.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/validations/pre-checkin.ts
@src/hooks/use-pre-checkin.ts
@src/lib/audit/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas and types for patient documents</name>
  <files>src/lib/validations/patient-document.ts</files>
  <action>
Create new file with:

1. Document type enum (from research):
```typescript
export const DOCUMENT_TYPES = ['rg', 'cnh', 'carteirinha_convenio', 'guia_autorizacao', 'comprovante_residencia', 'outros'] as const
export type DocumentType = typeof DOCUMENT_TYPES[number]
```

2. Document type labels in Portuguese:
```typescript
export const DOCUMENT_TYPE_LABELS: Record<DocumentType, string> = {
  rg: 'RG',
  cnh: 'CNH',
  carteirinha_convenio: 'Carteirinha Convênio',
  guia_autorizacao: 'Guia de Autorização',
  comprovante_residencia: 'Comprovante de Residência',
  outros: 'Outros',
}
```

3. Document status (derived from validado boolean: null=pendente, true=aprovado, false=rejeitado):
```typescript
export const DOCUMENT_STATUS = ['pendente', 'aprovado', 'rejeitado'] as const
export type DocumentStatus = typeof DOCUMENT_STATUS[number]

export const DOCUMENT_STATUS_LABELS: Record<DocumentStatus, string> = {
  pendente: 'Pendente',
  aprovado: 'Aprovado',
  rejeitado: 'Rejeitado',
}

export const DOCUMENT_STATUS_COLORS: Record<DocumentStatus, string> = {
  pendente: 'yellow',
  aprovado: 'green',
  rejeitado: 'red',
}
```

4. Helper to compute status from validado field:
```typescript
export function getDocumentStatus(validado: boolean | null): DocumentStatus {
  if (validado === null) return 'pendente'
  return validado ? 'aprovado' : 'rejeitado'
}
```

5. PatientDocument interface (matching Supabase documentos_paciente table + joins):
```typescript
export interface PatientDocument {
  id: string
  pre_checkin_id: number | null
  paciente_id: number
  tipo: DocumentType
  arquivo_url: string | null
  arquivo_path: string
  dados_extraidos: Record<string, unknown> | null
  confianca_extracao: number | null
  validado: boolean | null
  validado_por: string | null
  observacoes: string | null
  created_at: string
  // Joined data
  paciente: {
    id: number
    nome: string
    telefone: string
  } | null
}
```

6. Filter schema matching pre-checkin pattern:
```typescript
export interface PatientDocumentFilters {
  status?: DocumentStatus
  tipo?: DocumentType
  dateStart?: string
  dateEnd?: string
  search?: string
  page?: number
  limit?: number
}

export const patientDocumentFiltersSchema = z.object({
  status: z.enum(DOCUMENT_STATUS).optional(),
  tipo: z.enum(DOCUMENT_TYPES).optional(),
  dateStart: z.string().optional(),
  dateEnd: z.string().optional(),
  search: z.string().optional(),
  page: z.coerce.number().int().min(1).optional().default(1),
  limit: z.coerce.number().int().min(1).max(100).optional().default(50),
})
```

7. Schemas for approve/reject actions:
```typescript
export const approveDocumentSchema = z.object({
  observacoes: z.string().optional(),
})

export const rejectDocumentSchema = z.object({
  observacoes: z.string().min(5, 'Motivo da rejeição é obrigatório (min 5 caracteres)'),
})

export const bulkDocumentActionSchema = z.object({
  documentIds: z.array(z.string().uuid()).min(1, 'Selecione pelo menos um documento'),
  observacoes: z.string().optional(),
})
```
  </action>
  <verify>Check TypeScript compiles: `npx tsc --noEmit src/lib/validations/patient-document.ts`</verify>
  <done>File exports DOCUMENT_TYPES, DOCUMENT_STATUS, PatientDocument interface, filter schema, action schemas, and getDocumentStatus helper</done>
</task>

<task type="auto">
  <name>Task 2: Add audit actions for document validation</name>
  <files>src/lib/audit/logger.ts</files>
  <action>
Add new audit actions to the AuditAction enum:

```typescript
// Document validation (PHI - separate from existing VIEW_DOCUMENT)
APPROVE_DOCUMENT = 'APPROVE_DOCUMENT',
REJECT_DOCUMENT = 'REJECT_DOCUMENT',
BULK_APPROVE_DOCUMENTS = 'BULK_APPROVE_DOCUMENTS',
BULK_REJECT_DOCUMENTS = 'BULK_REJECT_DOCUMENTS',
```

Place these after the existing document actions (VIEW_DOCUMENTS, VIEW_DOCUMENT, UPLOAD_DOCUMENT, DELETE_DOCUMENT).
  </action>
  <verify>Run `npx tsc --noEmit src/lib/audit/logger.ts` - no errors</verify>
  <done>AuditAction enum includes APPROVE_DOCUMENT, REJECT_DOCUMENT, BULK_APPROVE_DOCUMENTS, BULK_REJECT_DOCUMENTS</done>
</task>

<task type="auto">
  <name>Task 3: Create React hook for document list fetching</name>
  <files>src/hooks/use-patient-documents.ts</files>
  <action>
Create new hook following the usePreCheckin pattern:

```typescript
'use client'

import { useState, useEffect, useCallback } from 'react'
import { PatientDocument, PatientDocumentFilters } from '@/lib/validations/patient-document'

export interface PatientDocumentPagination {
  page: number
  limit: number
  total: number
  totalPages: number
}

export interface PatientDocumentCounts {
  pendente: number
  aprovado: number
  rejeitado: number
  total: number
}

export interface UsePatientDocumentsReturn {
  documents: PatientDocument[]
  pagination: PatientDocumentPagination
  counts: PatientDocumentCounts | null
  loading: boolean
  error: string | null
  refetch: () => void
}

export function usePatientDocuments(
  filters: PatientDocumentFilters = {}
): UsePatientDocumentsReturn {
  // State for documents, pagination, counts, loading, error
  // fetchDocuments callback that:
  //   - Builds URLSearchParams from filters
  //   - Fetches /api/patient-documents
  //   - Sets documents, pagination, counts from response
  // useEffect to trigger fetch on filter change
  // refetch function
  // Return object
}
```

Follow the exact pattern from use-pre-checkin.ts but:
- Use PatientDocument type instead of PreCheckin
- Add counts property for status filter badges (similar to analytics)
- API endpoint is /api/patient-documents
  </action>
  <verify>Run `npx tsc --noEmit src/hooks/use-patient-documents.ts` - no errors</verify>
  <done>Hook fetches documents from /api/patient-documents with filters, pagination, and status counts</done>
</task>

</tasks>

<verification>
1. All files compile: `npx tsc --noEmit`
2. Types are properly exported and can be imported
3. AuditAction enum is valid TypeScript
</verification>

<success_criteria>
- Zod schemas validate document type, status, filters, and action payloads
- PatientDocument interface matches Supabase table structure
- getDocumentStatus helper correctly maps validado boolean to status string
- Audit actions exist for all document validation operations
- usePatientDocuments hook follows established patterns
</success_criteria>

<output>
After completion, create `.planning/phases/16-document-management/16-01-SUMMARY.md`
</output>
