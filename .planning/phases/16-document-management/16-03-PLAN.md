---
phase: 16-document-management
plan: 03
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/documents/document-status-badge.tsx
  - src/components/documents/document-type-badge.tsx
  - src/components/documents/documents-table.tsx
  - src/components/documents/documents-filters.tsx
  - src/components/documents/documents-pagination.tsx
  - src/components/documents/document-preview-modal.tsx
  - src/components/documents/document-reject-modal.tsx
  - src/components/documents/documents-bulk-actions.tsx
autonomous: true

must_haves:
  truths:
    - "Table displays documents with row selection checkboxes"
    - "Status badge shows correct color for each status"
    - "Filters update URL params for status, type, date, search"
    - "Preview modal displays images directly and PDFs via iframe"
    - "Reject modal requires reason before submission"
    - "Bulk actions bar appears when documents are selected"
  artifacts:
    - path: "src/components/documents/documents-table.tsx"
      provides: "Table with TanStack row selection"
      min_lines: 100
    - path: "src/components/documents/document-preview-modal.tsx"
      provides: "Modal with image/PDF preview"
      min_lines: 50
    - path: "src/components/documents/document-reject-modal.tsx"
      provides: "Modal with required reason input"
      min_lines: 40
    - path: "src/components/documents/documents-bulk-actions.tsx"
      provides: "Bottom action bar for bulk operations"
      min_lines: 30
  key_links:
    - from: "src/components/documents/documents-table.tsx"
      to: "tanstack/react-table"
      via: "useReactTable"
      pattern: "useReactTable"
    - from: "src/components/documents/documents-filters.tsx"
      to: "URL params"
      via: "useSearchParams"
      pattern: "useSearchParams"
---

<objective>
Create UI components for document management: table with row selection, status/type badges, filter controls, preview modal, reject modal with reason, and bulk actions bar.

Purpose: All presentational components needed for the document dashboard.
Output: Complete component library for document management UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-document-management/16-01-SUMMARY.md
@src/components/pre-checkin/status-badge.tsx
@src/components/pre-checkin/pre-checkin-table.tsx
@src/components/pre-checkin/pre-checkin-filters.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create status badge, type badge, and pagination components</name>
  <files>
    src/components/documents/document-status-badge.tsx
    src/components/documents/document-type-badge.tsx
    src/components/documents/documents-pagination.tsx
  </files>
  <action>
Create three small components:

**document-status-badge.tsx:**
Follow pre-checkin/status-badge.tsx pattern:
```typescript
'use client'

import { Badge } from '@/components/ui/badge'
import { CheckCircle, XCircle, Clock } from 'lucide-react'
import {
  DocumentStatus,
  DOCUMENT_STATUS_LABELS,
  DOCUMENT_STATUS_COLORS,
} from '@/lib/validations/patient-document'

interface DocumentStatusBadgeProps {
  status: DocumentStatus
}

export function DocumentStatusBadge({ status }: DocumentStatusBadgeProps) {
  const label = DOCUMENT_STATUS_LABELS[status]
  const color = DOCUMENT_STATUS_COLORS[status]

  const icons = {
    pendente: Clock,
    aprovado: CheckCircle,
    rejeitado: XCircle,
  }
  const Icon = icons[status]

  // Use className override for consistent colors
  const colorClasses = {
    yellow: 'bg-yellow-100 text-yellow-800 border-yellow-200',
    green: 'bg-green-100 text-green-800 border-green-200',
    red: 'bg-red-100 text-red-800 border-red-200',
  }

  return (
    <Badge variant="outline" className={colorClasses[color]}>
      <Icon className="w-3 h-3 mr-1" />
      {label}
    </Badge>
  )
}
```

**document-type-badge.tsx:**
Simple badge showing document type:
```typescript
'use client'

import { Badge } from '@/components/ui/badge'
import { FileText } from 'lucide-react'
import {
  DocumentType,
  DOCUMENT_TYPE_LABELS,
} from '@/lib/validations/patient-document'

interface DocumentTypeBadgeProps {
  tipo: DocumentType
}

export function DocumentTypeBadge({ tipo }: DocumentTypeBadgeProps) {
  const label = DOCUMENT_TYPE_LABELS[tipo]

  return (
    <Badge variant="secondary" className="font-normal">
      <FileText className="w-3 h-3 mr-1" />
      {label}
    </Badge>
  )
}
```

**documents-pagination.tsx:**
Copy pre-checkin-pagination.tsx pattern exactly, just change component name and update path handling using usePathname().
  </action>
  <verify>Components render without errors in storybook or dev preview</verify>
  <done>Three badge/pagination components created following pre-checkin patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create documents table with row selection</name>
  <files>src/components/documents/documents-table.tsx</files>
  <action>
Create table component with TanStack row selection. Key features:
- Checkbox column for row selection
- Columns: Checkbox, Patient, Type, Upload Date, Status, Actions
- Row click opens preview (except checkbox click)
- stopPropagation on checkbox to prevent row click

```typescript
'use client'

import { useState } from 'react'
import {
  useReactTable,
  getCoreRowModel,
  flexRender,
  RowSelectionState,
} from '@tanstack/react-table'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Checkbox } from '@/components/ui/checkbox'
import { Button } from '@/components/ui/button'
import { Eye, Download, Check, X } from 'lucide-react'
import { PatientDocument, getDocumentStatus } from '@/lib/validations/patient-document'
import { DocumentStatusBadge } from './document-status-badge'
import { DocumentTypeBadge } from './document-type-badge'
import { format } from 'date-fns'
import { ptBR } from 'date-fns/locale'

interface DocumentsTableProps {
  documents: PatientDocument[]
  loading: boolean
  rowSelection: RowSelectionState
  onRowSelectionChange: (selection: RowSelectionState) => void
  onPreview: (doc: PatientDocument) => void
  onDownload: (doc: PatientDocument) => void
  onApprove: (doc: PatientDocument) => void
  onReject: (doc: PatientDocument) => void
}

export function DocumentsTable({
  documents,
  loading,
  rowSelection,
  onRowSelectionChange,
  onPreview,
  onDownload,
  onApprove,
  onReject,
}: DocumentsTableProps) {
  const columns = [
    // Checkbox column
    {
      id: 'select',
      header: ({ table }) => (
        <Checkbox
          checked={table.getIsAllPageRowsSelected()}
          onCheckedChange={(value) => table.toggleAllPageRowsSelected(!!value)}
          aria-label="Selecionar todos"
        />
      ),
      cell: ({ row }) => (
        <Checkbox
          checked={row.getIsSelected()}
          onCheckedChange={(value) => row.toggleSelected(!!value)}
          onClick={(e) => e.stopPropagation()}
          aria-label="Selecionar linha"
        />
      ),
    },
    // Patient column
    {
      id: 'paciente',
      header: 'Paciente',
      cell: ({ row }) => (
        <div>
          <div className="font-medium">{row.original.paciente?.nome || '-'}</div>
          <div className="text-sm text-muted-foreground">
            {row.original.paciente?.telefone || '-'}
          </div>
        </div>
      ),
    },
    // Type column
    {
      id: 'tipo',
      header: 'Tipo',
      cell: ({ row }) => <DocumentTypeBadge tipo={row.original.tipo} />,
    },
    // Upload date column
    {
      id: 'created_at',
      header: 'Data Upload',
      cell: ({ row }) => {
        const date = new Date(row.original.created_at)
        return format(date, 'dd/MM/yyyy HH:mm', { locale: ptBR })
      },
    },
    // Status column
    {
      id: 'status',
      header: 'Status',
      cell: ({ row }) => {
        const status = getDocumentStatus(row.original.validado)
        return <DocumentStatusBadge status={status} />
      },
    },
    // Actions column
    {
      id: 'actions',
      header: 'Acoes',
      cell: ({ row }) => {
        const status = getDocumentStatus(row.original.validado)
        return (
          <div className="flex gap-1" onClick={(e) => e.stopPropagation()}>
            <Button
              variant="ghost"
              size="icon"
              onClick={() => onPreview(row.original)}
              title="Visualizar"
            >
              <Eye className="h-4 w-4" />
            </Button>
            <Button
              variant="ghost"
              size="icon"
              onClick={() => onDownload(row.original)}
              title="Download"
            >
              <Download className="h-4 w-4" />
            </Button>
            {status === 'pendente' && (
              <>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => onApprove(row.original)}
                  title="Aprovar"
                  className="text-green-600 hover:text-green-700"
                >
                  <Check className="h-4 w-4" />
                </Button>
                <Button
                  variant="ghost"
                  size="icon"
                  onClick={() => onReject(row.original)}
                  title="Rejeitar"
                  className="text-red-600 hover:text-red-700"
                >
                  <X className="h-4 w-4" />
                </Button>
              </>
            )}
          </div>
        )
      },
    },
  ]

  const table = useReactTable({
    data: documents,
    columns,
    state: { rowSelection },
    onRowSelectionChange: (updater) => {
      const newSelection = typeof updater === 'function'
        ? updater(rowSelection)
        : updater
      onRowSelectionChange(newSelection)
    },
    getCoreRowModel: getCoreRowModel(),
    getRowId: (row) => row.id,
    enableRowSelection: true,
  })

  if (loading) {
    return <div className="text-center py-8">Carregando...</div>
  }

  if (documents.length === 0) {
    return (
      <div className="text-center py-8 text-muted-foreground">
        Nenhum documento encontrado
      </div>
    )
  }

  return (
    <div className="rounded-md border">
      <Table>
        <TableHeader>
          {table.getHeaderGroups().map((headerGroup) => (
            <TableRow key={headerGroup.id}>
              {headerGroup.headers.map((header) => (
                <TableHead key={header.id}>
                  {flexRender(
                    header.column.columnDef.header,
                    header.getContext()
                  )}
                </TableHead>
              ))}
            </TableRow>
          ))}
        </TableHeader>
        <TableBody>
          {table.getRowModel().rows.map((row) => (
            <TableRow
              key={row.id}
              className="cursor-pointer hover:bg-muted/50"
              onClick={() => onPreview(row.original)}
              data-state={row.getIsSelected() ? 'selected' : undefined}
            >
              {row.getVisibleCells().map((cell) => (
                <TableCell key={cell.id}>
                  {flexRender(cell.column.columnDef.cell, cell.getContext())}
                </TableCell>
              ))}
            </TableRow>
          ))}
        </TableBody>
      </Table>
    </div>
  )
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Table renders documents with checkbox selection, all columns, and action buttons</done>
</task>

<task type="auto">
  <name>Task 3: Create filters, preview modal, reject modal, and bulk actions components</name>
  <files>
    src/components/documents/documents-filters.tsx
    src/components/documents/document-preview-modal.tsx
    src/components/documents/document-reject-modal.tsx
    src/components/documents/documents-bulk-actions.tsx
  </files>
  <action>
Create four remaining components:

**documents-filters.tsx:**
Follow pre-checkin-filters.tsx pattern with:
- Status filter dropdown (pendente, aprovado, rejeitado) - show counts in badges
- Type filter dropdown (all document types)
- Date range filter with presets (today, week, month, custom)
- Search input with 300ms debounce
- Clear filters button
- Use usePathname + useSearchParams for URL state

**document-preview-modal.tsx:**
```typescript
'use client'

import { useState, useEffect } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Download, Loader2 } from 'lucide-react'
import { PatientDocument, getDocumentStatus, DOCUMENT_TYPE_LABELS } from '@/lib/validations/patient-document'
import { DocumentStatusBadge } from './document-status-badge'

interface DocumentPreviewModalProps {
  document: PatientDocument | null
  isOpen: boolean
  onClose: () => void
  onDownload: () => void
  onApprove: () => void
  onReject: () => void
}

export function DocumentPreviewModal({
  document,
  isOpen,
  onClose,
  onDownload,
  onApprove,
  onReject,
}: DocumentPreviewModalProps) {
  const [previewUrl, setPreviewUrl] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    if (isOpen && document) {
      fetchPreviewUrl()
    } else {
      setPreviewUrl(null)
    }
  }, [isOpen, document])

  const fetchPreviewUrl = async () => {
    if (!document) return
    setLoading(true)
    setError(null)

    try {
      const res = await fetch(`/api/patient-documents/${document.id}/preview`)
      if (!res.ok) throw new Error('Erro ao carregar preview')
      const data = await res.json()
      setPreviewUrl(data.url)
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erro')
    } finally {
      setLoading(false)
    }
  }

  if (!document) return null

  const status = getDocumentStatus(document.validado)
  const isImage = ['image/jpeg', 'image/png', 'image/jpg'].some(t =>
    document.arquivo_path.toLowerCase().includes(t.split('/')[1])
  ) || document.arquivo_path.match(/\.(jpg|jpeg|png)$/i)
  const isPdf = document.arquivo_path.toLowerCase().endsWith('.pdf')

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            {DOCUMENT_TYPE_LABELS[document.tipo]}
            <DocumentStatusBadge status={status} />
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4">
          {/* Patient info */}
          <div className="text-sm text-muted-foreground">
            Paciente: {document.paciente?.nome || 'N/A'}
          </div>

          {/* Preview area */}
          <div className="border rounded-lg min-h-[400px] flex items-center justify-center bg-muted/50">
            {loading && <Loader2 className="h-8 w-8 animate-spin" />}
            {error && <div className="text-red-500">{error}</div>}
            {previewUrl && !loading && (
              <>
                {isImage && (
                  <img
                    src={previewUrl}
                    alt="Document preview"
                    className="max-w-full max-h-[500px] object-contain"
                  />
                )}
                {isPdf && (
                  <iframe
                    src={previewUrl}
                    className="w-full h-[500px]"
                    title="PDF preview"
                  />
                )}
                {!isImage && !isPdf && (
                  <div className="text-muted-foreground">
                    Preview nao disponivel. Use o botao de download.
                  </div>
                )}
              </>
            )}
          </div>

          {/* Extracted data if available */}
          {document.dados_extraidos && (
            <div className="text-sm">
              <div className="font-medium mb-1">Dados extraidos:</div>
              <pre className="bg-muted p-2 rounded text-xs overflow-auto">
                {JSON.stringify(document.dados_extraidos, null, 2)}
              </pre>
            </div>
          )}

          {/* Actions */}
          <div className="flex justify-between pt-4 border-t">
            <Button variant="outline" onClick={onDownload}>
              <Download className="h-4 w-4 mr-2" />
              Download
            </Button>
            {status === 'pendente' && (
              <div className="flex gap-2">
                <Button variant="outline" onClick={onReject} className="text-red-600">
                  Rejeitar
                </Button>
                <Button onClick={onApprove} className="bg-green-600 hover:bg-green-700">
                  Aprovar
                </Button>
              </div>
            )}
          </div>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

**document-reject-modal.tsx:**
```typescript
'use client'

import { useState } from 'react'
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogFooter,
} from '@/components/ui/dialog'
import { Button } from '@/components/ui/button'
import { Textarea } from '@/components/ui/textarea'
import { Label } from '@/components/ui/label'
import { Loader2 } from 'lucide-react'

interface DocumentRejectModalProps {
  isOpen: boolean
  onClose: () => void
  onConfirm: (reason: string) => Promise<void>
  isBulk?: boolean
  count?: number
}

export function DocumentRejectModal({
  isOpen,
  onClose,
  onConfirm,
  isBulk = false,
  count = 1,
}: DocumentRejectModalProps) {
  const [reason, setReason] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)

  const handleSubmit = async () => {
    if (reason.length < 5) {
      setError('Motivo deve ter pelo menos 5 caracteres')
      return
    }

    setLoading(true)
    setError(null)

    try {
      await onConfirm(reason)
      setReason('')
      onClose()
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Erro ao rejeitar')
    } finally {
      setLoading(false)
    }
  }

  return (
    <Dialog open={isOpen} onOpenChange={onClose}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>
            {isBulk
              ? `Rejeitar ${count} documento${count > 1 ? 's' : ''}`
              : 'Rejeitar documento'}
          </DialogTitle>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label htmlFor="reason">Motivo da rejeicao *</Label>
            <Textarea
              id="reason"
              value={reason}
              onChange={(e) => setReason(e.target.value)}
              placeholder="Informe o motivo da rejeicao..."
              rows={4}
            />
            {error && <p className="text-sm text-red-500">{error}</p>}
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={onClose} disabled={loading}>
            Cancelar
          </Button>
          <Button
            onClick={handleSubmit}
            disabled={loading || reason.length < 5}
            variant="destructive"
          >
            {loading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Rejeitar
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  )
}
```

**documents-bulk-actions.tsx:**
```typescript
'use client'

import { Button } from '@/components/ui/button'
import { Check, X, Loader2 } from 'lucide-react'

interface DocumentsBulkActionsProps {
  selectedCount: number
  onApprove: () => void
  onReject: () => void
  onClear: () => void
  loading?: boolean
}

export function DocumentsBulkActions({
  selectedCount,
  onApprove,
  onReject,
  onClear,
  loading = false,
}: DocumentsBulkActionsProps) {
  if (selectedCount === 0) return null

  return (
    <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-background border rounded-lg shadow-lg p-4 flex items-center gap-4 z-50">
      <span className="text-sm font-medium">
        {selectedCount} documento{selectedCount > 1 ? 's' : ''} selecionado{selectedCount > 1 ? 's' : ''}
      </span>

      <div className="flex gap-2">
        <Button
          size="sm"
          onClick={onApprove}
          disabled={loading}
          className="bg-green-600 hover:bg-green-700"
        >
          {loading ? <Loader2 className="h-4 w-4 animate-spin" /> : <Check className="h-4 w-4 mr-1" />}
          Aprovar
        </Button>
        <Button
          size="sm"
          variant="destructive"
          onClick={onReject}
          disabled={loading}
        >
          {loading ? <Loader2 className="h-4 w-4 animate-spin" /> : <X className="h-4 w-4 mr-1" />}
          Rejeitar
        </Button>
        <Button
          size="sm"
          variant="outline"
          onClick={onClear}
          disabled={loading}
        >
          Limpar
        </Button>
      </div>
    </div>
  )
}
```
  </action>
  <verify>All components compile: `npx tsc --noEmit`</verify>
  <done>All UI components created: filters with URL sync, preview modal with image/PDF, reject modal with required reason, bulk actions bar</done>
</task>

</tasks>

<verification>
1. All components compile: `npx tsc --noEmit`
2. No import errors when files are referenced
3. Components follow established patterns from pre-checkin
</verification>

<success_criteria>
- DocumentStatusBadge shows correct colors (yellow/green/red)
- DocumentTypeBadge shows document type label
- DocumentsTable renders with checkbox selection column
- DocumentsFilters updates URL params on filter change
- DocumentPreviewModal loads signed URL and displays image or PDF
- DocumentRejectModal requires reason before submission
- DocumentsBulkActions appears at bottom when items selected
</success_criteria>

<output>
After completion, create `.planning/phases/16-document-management/16-03-SUMMARY.md`
</output>
