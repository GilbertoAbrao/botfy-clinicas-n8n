---
phase: 16-document-management
plan: 04
type: execute
wave: 3
depends_on: ["16-02", "16-03"]
files_modified:
  - src/components/documents/documents-dashboard.tsx
  - src/app/admin/pre-checkin/documentos/page.tsx
  - src/components/layout/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /admin/pre-checkin/documentos from sidebar"
    - "Page displays document list with all filters working"
    - "User can preview, approve, reject individual documents"
    - "User can bulk approve/reject selected documents"
    - "All actions show toast feedback"
  artifacts:
    - path: "src/app/admin/pre-checkin/documentos/page.tsx"
      provides: "Server component page entry point"
      min_lines: 20
    - path: "src/components/documents/documents-dashboard.tsx"
      provides: "Main client component orchestrating all document UI"
      min_lines: 150
    - path: "src/components/layout/sidebar.tsx"
      provides: "Navigation with Documentos link"
      contains: "/admin/pre-checkin/documentos"
  key_links:
    - from: "src/components/documents/documents-dashboard.tsx"
      to: "src/hooks/use-patient-documents.ts"
      via: "usePatientDocuments hook"
      pattern: "usePatientDocuments"
    - from: "src/components/documents/documents-dashboard.tsx"
      to: "/api/patient-documents"
      via: "fetch calls for actions"
      pattern: "fetch.*api/patient-documents"
---

<objective>
Wire up the document management page by creating the main dashboard component, server page, and adding navigation link to sidebar.

Purpose: Complete integration of all components into a working document management feature.
Output: Fully functional document management page accessible from sidebar.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-document-management/16-01-SUMMARY.md
@.planning/phases/16-document-management/16-02-SUMMARY.md
@.planning/phases/16-document-management/16-03-SUMMARY.md
@src/app/admin/pre-checkin/page.tsx
@src/components/pre-checkin/pre-checkin-dashboard.tsx
@src/components/layout/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create documents dashboard client component</name>
  <files>src/components/documents/documents-dashboard.tsx</files>
  <action>
Create main orchestrating component following pre-checkin-dashboard.tsx pattern:

```typescript
'use client'

import { useState, useCallback } from 'react'
import { useSearchParams, useRouter } from 'next/navigation'
import { RowSelectionState } from '@tanstack/react-table'
import { toast } from 'sonner'

import { usePatientDocuments } from '@/hooks/use-patient-documents'
import {
  PatientDocument,
  PatientDocumentFilters,
  DocumentStatus,
  DocumentType,
  getDocumentStatus,
} from '@/lib/validations/patient-document'

import { DocumentsTable } from './documents-table'
import { DocumentsFilters } from './documents-filters'
import { DocumentsPagination } from './documents-pagination'
import { DocumentPreviewModal } from './document-preview-modal'
import { DocumentRejectModal } from './document-reject-modal'
import { DocumentsBulkActions } from './documents-bulk-actions'

export function DocumentsDashboard() {
  const router = useRouter()
  const searchParams = useSearchParams()

  // Parse filters from URL
  const filters: PatientDocumentFilters = {
    status: (searchParams.get('status') as DocumentStatus) || undefined,
    tipo: (searchParams.get('tipo') as DocumentType) || undefined,
    dateStart: searchParams.get('dateStart') || undefined,
    dateEnd: searchParams.get('dateEnd') || undefined,
    search: searchParams.get('search') || undefined,
    page: parseInt(searchParams.get('page') || '1'),
    limit: parseInt(searchParams.get('limit') || '50'),
  }

  // Fetch data
  const { documents, pagination, counts, loading, error, refetch } = usePatientDocuments(filters)

  // Local state
  const [rowSelection, setRowSelection] = useState<RowSelectionState>({})
  const [previewDocument, setPreviewDocument] = useState<PatientDocument | null>(null)
  const [rejectDocument, setRejectDocument] = useState<PatientDocument | null>(null)
  const [bulkRejectOpen, setBulkRejectOpen] = useState(false)
  const [actionLoading, setActionLoading] = useState(false)

  // Selected document IDs (for bulk actions)
  const selectedIds = Object.keys(rowSelection).filter((id) => rowSelection[id])
  const selectedCount = selectedIds.length

  // Handlers
  const handlePreview = useCallback((doc: PatientDocument) => {
    setPreviewDocument(doc)
  }, [])

  const handleDownload = useCallback(async (doc: PatientDocument) => {
    try {
      const res = await fetch(`/api/patient-documents/${doc.id}/preview`)
      if (!res.ok) throw new Error('Erro ao obter URL')
      const data = await res.json()

      // Open in new tab for download
      window.open(data.url, '_blank')
    } catch (err) {
      toast.error('Erro ao baixar documento')
    }
  }, [])

  const handleApprove = useCallback(async (doc: PatientDocument) => {
    setActionLoading(true)
    try {
      const res = await fetch(`/api/patient-documents/${doc.id}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({}),
      })

      if (!res.ok) {
        const error = await res.json()
        throw new Error(error.error || 'Erro ao aprovar')
      }

      toast.success('Documento aprovado')
      setPreviewDocument(null)
      refetch()
    } catch (err) {
      toast.error(err instanceof Error ? err.message : 'Erro ao aprovar')
    } finally {
      setActionLoading(false)
    }
  }, [refetch])

  const handleRejectConfirm = useCallback(async (reason: string) => {
    if (!rejectDocument) return

    const res = await fetch(`/api/patient-documents/${rejectDocument.id}/reject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ observacoes: reason }),
    })

    if (!res.ok) {
      const error = await res.json()
      throw new Error(error.error || 'Erro ao rejeitar')
    }

    toast.success('Documento rejeitado')
    setRejectDocument(null)
    setPreviewDocument(null)
    refetch()
  }, [rejectDocument, refetch])

  const handleBulkApprove = useCallback(async () => {
    if (selectedCount === 0) return

    setActionLoading(true)
    try {
      const res = await fetch('/api/patient-documents/bulk', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          action: 'approve',
          documentIds: selectedIds,
        }),
      })

      if (!res.ok) {
        const error = await res.json()
        throw new Error(error.error || 'Erro ao aprovar')
      }

      const data = await res.json()
      toast.success(`${data.count} documento(s) aprovado(s)`)
      setRowSelection({})
      refetch()
    } catch (err) {
      toast.error(err instanceof Error ? err.message : 'Erro ao aprovar')
    } finally {
      setActionLoading(false)
    }
  }, [selectedIds, selectedCount, refetch])

  const handleBulkRejectConfirm = useCallback(async (reason: string) => {
    const res = await fetch('/api/patient-documents/bulk', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        action: 'reject',
        documentIds: selectedIds,
        observacoes: reason,
      }),
    })

    if (!res.ok) {
      const error = await res.json()
      throw new Error(error.error || 'Erro ao rejeitar')
    }

    const data = await res.json()
    toast.success(`${data.count} documento(s) rejeitado(s)`)
    setRowSelection({})
    setBulkRejectOpen(false)
    refetch()
  }, [selectedIds, refetch])

  const handleClearSelection = useCallback(() => {
    setRowSelection({})
  }, [])

  // Error state
  if (error) {
    return (
      <div className="p-4 text-red-500">
        Erro ao carregar documentos: {error}
      </div>
    )
  }

  return (
    <div className="space-y-4">
      {/* Filters */}
      <DocumentsFilters counts={counts} />

      {/* Table */}
      <DocumentsTable
        documents={documents}
        loading={loading}
        rowSelection={rowSelection}
        onRowSelectionChange={setRowSelection}
        onPreview={handlePreview}
        onDownload={handleDownload}
        onApprove={(doc) => handleApprove(doc)}
        onReject={(doc) => setRejectDocument(doc)}
      />

      {/* Pagination */}
      <DocumentsPagination
        page={pagination.page}
        totalPages={pagination.totalPages}
        total={pagination.total}
        limit={pagination.limit}
      />

      {/* Preview Modal */}
      <DocumentPreviewModal
        document={previewDocument}
        isOpen={!!previewDocument}
        onClose={() => setPreviewDocument(null)}
        onDownload={() => previewDocument && handleDownload(previewDocument)}
        onApprove={() => previewDocument && handleApprove(previewDocument)}
        onReject={() => {
          if (previewDocument) {
            setRejectDocument(previewDocument)
          }
        }}
      />

      {/* Reject Modal (single) */}
      <DocumentRejectModal
        isOpen={!!rejectDocument}
        onClose={() => setRejectDocument(null)}
        onConfirm={handleRejectConfirm}
      />

      {/* Bulk Reject Modal */}
      <DocumentRejectModal
        isOpen={bulkRejectOpen}
        onClose={() => setBulkRejectOpen(false)}
        onConfirm={handleBulkRejectConfirm}
        isBulk
        count={selectedCount}
      />

      {/* Bulk Actions Bar */}
      <DocumentsBulkActions
        selectedCount={selectedCount}
        onApprove={handleBulkApprove}
        onReject={() => setBulkRejectOpen(true)}
        onClear={handleClearSelection}
        loading={actionLoading}
      />
    </div>
  )
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Dashboard component orchestrates all document UI with state management, API calls, and toast feedback</done>
</task>

<task type="auto">
  <name>Task 2: Create server page and add navigation link</name>
  <files>
    src/app/admin/pre-checkin/documentos/page.tsx
    src/components/layout/sidebar.tsx
  </files>
  <action>
**Create page at src/app/admin/pre-checkin/documentos/page.tsx:**

```typescript
import { Suspense } from 'react'
import { redirect } from 'next/navigation'
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { DocumentsDashboard } from '@/components/documents/documents-dashboard'

export const metadata = {
  title: 'Documentos de Pacientes | Botfy ClinicOps',
}

export default async function DocumentsPage() {
  // Auth check
  const user = await getCurrentUserWithRole()
  if (!user) {
    redirect('/auth/login')
  }

  // RBAC check
  if (!['ADMIN', 'ATENDENTE'].includes(user.role)) {
    redirect('/dashboard')
  }

  return (
    <div className="container mx-auto py-6 space-y-6">
      <div>
        <h1 className="text-2xl font-bold">Documentos de Pacientes</h1>
        <p className="text-muted-foreground">
          Visualize e valide documentos enviados durante o pre-checkin
        </p>
      </div>

      <Suspense fallback={<div>Carregando...</div>}>
        <DocumentsDashboard />
      </Suspense>
    </div>
  )
}
```

**Update sidebar.tsx to add Documentos link:**

Find the pre-checkin section in the sidebar navigation (look for "Pre-Checkin" or similar). Add a new navigation item below it:

```typescript
{
  title: 'Documentos',
  href: '/admin/pre-checkin/documentos',
  icon: FileText, // import from lucide-react
}
```

OR if using a nested/grouped structure, add within the Pre-Checkin group.

Follow existing sidebar patterns for icon imports and link structure.
  </action>
  <verify>
1. Navigate to /admin/pre-checkin/documentos - page loads
2. Sidebar shows Documentos link
3. Click Documentos - navigates to page
  </verify>
  <done>Page accessible at /admin/pre-checkin/documentos with sidebar navigation</done>
</task>

<task type="auto">
  <name>Task 3: Test end-to-end functionality</name>
  <files></files>
  <action>
Verify the complete feature works:

1. **Navigation:**
   - Start dev server: `npm run dev`
   - Navigate to /admin/pre-checkin/documentos via sidebar

2. **Document List:**
   - Page loads without errors
   - Documents display in table (if data exists)
   - Status badges show correct colors

3. **Filtering:**
   - Status filter updates URL and filters list
   - Type filter works
   - Search filters by patient name
   - Date range filters work

4. **Row Selection:**
   - Clicking checkbox selects row
   - Header checkbox selects all
   - Selection count shows in bulk action bar

5. **Preview:**
   - Click row opens preview modal
   - Image documents show inline
   - PDF documents show in iframe

6. **Approve/Reject:**
   - Approve button updates document status
   - Reject opens modal requiring reason
   - Toast shows success/error feedback

7. **Bulk Actions:**
   - Select multiple documents
   - Bulk approve works
   - Bulk reject requires reason
   - Selection clears after action

If any step fails, fix the issue before proceeding.
  </action>
  <verify>All 7 verification steps pass in browser testing</verify>
  <done>Document management feature fully functional with all requirements met</done>
</task>

</tasks>

<verification>
1. Page loads at /admin/pre-checkin/documentos
2. Sidebar shows Documentos link
3. All filters work and update URL
4. Preview modal shows documents correctly
5. Approve/reject actions work with audit logging
6. Bulk actions work for multiple documents
7. Toast feedback shows for all actions
</verification>

<success_criteria>
- DOCS-01: List displays all documents (table renders)
- DOCS-02: Columns show Patient, Type, Upload Date, Status, Actions
- DOCS-03: Status filter works (pendente, aprovado, rejeitado)
- DOCS-04: Type filter works (all document types)
- DOCS-05: Date range filter works
- DOCS-06: Search by patient name works
- DOCS-07: Approve with optional notes works
- DOCS-08: Reject with required reason works
- DOCS-09: Preview modal shows image/PDF
- DOCS-10: Download triggers file download
- DOCS-11: Bulk approve works
- DOCS-12: Bulk reject with single reason works
</success_criteria>

<output>
After completion, create `.planning/phases/16-document-management/16-04-SUMMARY.md`
</output>
