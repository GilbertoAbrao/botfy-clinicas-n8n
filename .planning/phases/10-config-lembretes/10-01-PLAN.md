# Plan 10-01: Config Lembretes API Routes

**Phase:** 10 - Config Lembretes
**Requirements:** CONF-01 (list), CONF-02 (create), CONF-03 (edit), CONF-04 (delete), CONF-05 (toggle active)
**Status:** Not Started

## Objective

Create API routes for CRUD operations on reminder configurations (`config_lembretes` table).

## Context

**Table:** `config_lembretes`

| Column | Type | Description |
|--------|------|-------------|
| id | serial | Primary key |
| nome | text | Configuration name (e.g., "lembrete_48h") |
| horas_antes | integer | Hours before appointment to send |
| ativo | boolean | Whether config is active |
| template_tipo | text | Message template type |
| prioridade | integer | Priority order |
| created_at | timestamp | Creation timestamp |

**Existing Pattern:** Follow `src/app/api/servicos/` route structure.

## Tasks

### Task 1: Create validation schema

**File:** `src/lib/validations/config-lembrete.ts`

```typescript
import { z } from 'zod';

export const configLembreteSchema = z.object({
  nome: z
    .string()
    .min(3, 'Nome deve ter pelo menos 3 caracteres')
    .max(50, 'Nome nao pode ter mais de 50 caracteres'),
  horas_antes: z
    .number()
    .int()
    .min(1, 'Minimo 1 hora')
    .max(168, 'Maximo 168 horas (7 dias)'),
  ativo: z.boolean(),
  template_tipo: z
    .string()
    .min(1, 'Tipo de template obrigatorio'),
  prioridade: z
    .number()
    .int()
    .min(1)
    .max(100)
    .optional()
    .default(1),
});

export type ConfigLembreteInput = z.infer<typeof configLembreteSchema>;
```

### Task 2: Create GET and POST route

**File:** `src/app/api/config-lembretes/route.ts`

**GET:** List all configs with optional filters
- Query params: `ativo`, `page`, `limit`
- Auth: require authenticated user
- Permission: `PERMISSIONS.MANAGE_SYSTEM_CONFIG`
- Returns: `{ configs: ConfigLembrete[], pagination }`

**POST:** Create new config
- Body: `ConfigLembreteInput`
- Auth: require authenticated user
- Permission: `PERMISSIONS.MANAGE_SYSTEM_CONFIG`
- Audit log: `AuditAction.CREATE_CONFIG_LEMBRETE`
- Returns: created config

### Task 3: Create GET, PUT, DELETE route for single config

**File:** `src/app/api/config-lembretes/[id]/route.ts`

**GET:** Get single config by ID
- Auth: require authenticated user
- Permission: `PERMISSIONS.MANAGE_SYSTEM_CONFIG`

**PUT:** Update existing config
- Body: `ConfigLembreteInput`
- Auth: require authenticated user
- Permission: `PERMISSIONS.MANAGE_SYSTEM_CONFIG`
- Audit log: `AuditAction.UPDATE_CONFIG_LEMBRETE`
- Track changes for audit

**DELETE:** Delete config
- Auth: require authenticated user
- Permission: `PERMISSIONS.MANAGE_SYSTEM_CONFIG`
- Audit log: `AuditAction.DELETE_CONFIG_LEMBRETE`

### Task 4: Add audit action types

**File:** `src/lib/audit/logger.ts`

Add to `AuditAction` enum:
- `CREATE_CONFIG_LEMBRETE`
- `UPDATE_CONFIG_LEMBRETE`
- `DELETE_CONFIG_LEMBRETE`

## Success Criteria

- [ ] Validation schema created with Zod
- [ ] GET /api/config-lembretes returns paginated list
- [ ] POST /api/config-lembretes creates new config
- [ ] GET /api/config-lembretes/[id] returns single config
- [ ] PUT /api/config-lembretes/[id] updates config
- [ ] DELETE /api/config-lembretes/[id] removes config
- [ ] All routes require authentication
- [ ] All routes check MANAGE_SYSTEM_CONFIG permission
- [ ] All mutations create audit logs

## Notes

- Follow existing servicos API pattern exactly
- Use Supabase client for queries (not Prisma for this table)
- Config names should be unique (check on create/update)
