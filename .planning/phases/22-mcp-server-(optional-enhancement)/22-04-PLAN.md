---
phase: 22-mcp-server
plan: 04
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/mcp/tools/processar-documento.ts
  - src/mcp/tools/document.ts
  - src/mcp/server.ts
  - package.json
  - claude_desktop_config.example.json
autonomous: false

must_haves:
  truths:
    - "Document processing tool handles multipart form data correctly"
    - "MCP Server registers all 11 tools and starts successfully"
    - "Claude Desktop configuration file enables local testing"
    - "npm script available for running MCP server"
  artifacts:
    - path: "src/mcp/tools/processar-documento.ts"
      provides: "Tool handler for POST /api/agent/documentos/processar"
      exports: ["processarDocumentoTool"]
    - path: "src/mcp/tools/document.ts"
      provides: "Index file for document tool registration"
      exports: ["registerDocumentTool"]
    - path: "src/mcp/server.ts"
      provides: "Updated server with all 11 tools registered"
      min_lines: 50
    - path: "claude_desktop_config.example.json"
      provides: "Example Claude Desktop configuration"
      min_lines: 15
  key_links:
    - from: "src/mcp/server.ts"
      to: "src/mcp/tools/query.ts"
      via: "registerQueryTools import"
      pattern: "import.*registerQueryTools"
    - from: "src/mcp/server.ts"
      to: "src/mcp/tools/write.ts"
      via: "registerWriteTools import"
      pattern: "import.*registerWriteTools"
    - from: "src/mcp/server.ts"
      to: "src/mcp/tools/document.ts"
      via: "registerDocumentTool import"
      pattern: "import.*registerDocumentTool"
---

<objective>
Complete MCP Server with document processing tool, full tool registration, and Claude Desktop configuration.

Purpose: Finalize the MCP Server implementation by adding the document processing tool, updating the server to register all 11 tools, and providing configuration for Claude Desktop testing.

Output:
- `src/mcp/tools/processar-documento.ts` - Document processing tool handler
- `src/mcp/tools/document.ts` - Document tool registration index
- Updated `src/mcp/server.ts` - Server with all 11 tools
- `claude_desktop_config.example.json` - Example configuration file
- Updated `package.json` with MCP server scripts
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-mcp-server-(optional-enhancement)/22-RESEARCH.md

# Reference document processing API
@src/app/api/agent/documentos/processar/route.ts
@src/lib/document/types.ts

# Reference summaries from previous plans in this phase
# @.planning/phases/22-mcp-server-(optional-enhancement)/22-01-SUMMARY.md
# @.planning/phases/22-mcp-server-(optional-enhancement)/22-02-SUMMARY.md
# @.planning/phases/22-mcp-server-(optional-enhancement)/22-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create document processing tool handler</name>
  <files>
    src/mcp/tools/processar-documento.ts
    src/mcp/tools/document.ts
  </files>
  <action>
Create tool handler for document processing. Note: The document API uses multipart form data, but for MCP we'll accept base64-encoded file content:

**1. src/mcp/tools/processar-documento.ts:**
```typescript
import { z } from 'zod'
import { config } from '../config'
import { mcpLog } from '../logger'
import { recordRequest } from '../heartbeat'

// Input schema - accepts base64 file content
const inputSchema = z.object({
  pacienteId: z.number().describe('ID do paciente'),
  arquivo: z.string().describe('Conteúdo do arquivo em base64'),
  nomeArquivo: z.string().describe('Nome do arquivo com extensão (ex: documento.jpg)'),
  mimeType: z.string().optional().describe('MIME type do arquivo (ex: image/jpeg). Auto-detectado se não informado.'),
})

interface ProcessedDocument {
  documentType: string
  confidence: number
  extractedFields: Record<string, string | null>
  storageUrl: string
}

export const processarDocumentoTool = {
  name: 'processar_documento',
  title: 'Processar Documento',
  description: 'Processa documento enviado pelo paciente (RG, CPF, CNS, carteirinha). Extrai dados automaticamente usando visão computacional.',
  inputSchema,
  handler: async (input: z.infer<typeof inputSchema>) => {
    try {
      // Convert base64 to blob for multipart form data
      const base64Data = input.arquivo.replace(/^data:[^;]+;base64,/, '')
      const binaryData = Buffer.from(base64Data, 'base64')

      // Detect MIME type if not provided
      const mimeType = input.mimeType || detectMimeType(input.nomeArquivo)

      // Create FormData
      const formData = new FormData()
      formData.append('pacienteId', String(input.pacienteId))
      formData.append('arquivo', new Blob([binaryData], { type: mimeType }), input.nomeArquivo)

      // Make request with multipart form data (no JSON Content-Type)
      const url = `${config.baseUrl}/api/agent/documentos/processar`

      mcpLog.debug(`HTTP POST ${url} (multipart)`)

      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${config.apiKey}`,
          // Note: Do NOT set Content-Type for FormData - browser/node sets it with boundary
        },
        body: formData,
      })

      const json = await response.json()

      if (!response.ok || !json.success) {
        recordRequest(false)
        throw new Error(json.error || `HTTP ${response.status}`)
      }

      recordRequest(true)
      const result = json.data as ProcessedDocument

      const summary = `Documento processado: ${result.documentType} (confiança: ${(result.confidence * 100).toFixed(0)}%)`

      return {
        content: [{ type: 'text', text: summary }],
        structuredContent: result,
      }
    } catch (error) {
      recordRequest(false)
      const errorMsg = error instanceof Error ? error.message : 'Erro desconhecido'

      mcpLog.error(`Document processing error: ${errorMsg}`)

      return {
        content: [{
          type: 'text',
          text: `Erro ao processar documento: ${errorMsg}`,
        }],
        isError: true,
      }
    }
  },
}

// Helper to detect MIME type from filename
function detectMimeType(filename: string): string {
  const ext = filename.split('.').pop()?.toLowerCase()
  const mimeTypes: Record<string, string> = {
    jpg: 'image/jpeg',
    jpeg: 'image/jpeg',
    png: 'image/png',
    gif: 'image/gif',
    webp: 'image/webp',
    pdf: 'application/pdf',
  }
  return mimeTypes[ext || ''] || 'application/octet-stream'
}
```

**2. src/mcp/tools/document.ts:**
```typescript
// src/mcp/tools/document.ts
import type { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'
import { processarDocumentoTool } from './processar-documento'
import { mcpLog } from '../logger'

export function registerDocumentTool(server: McpServer): void {
  mcpLog.info('Registering document tools...')

  server.tool(
    processarDocumentoTool.name,
    processarDocumentoTool.description,
    processarDocumentoTool.inputSchema,
    processarDocumentoTool.handler
  )
  mcpLog.info(`  ✓ ${processarDocumentoTool.name}`)

  mcpLog.info('Document tools registered: 1')
}
```
  </action>
  <verify>
Files exist and compile:
```bash
ls src/mcp/tools/processar-documento.ts src/mcp/tools/document.ts
npx tsc --noEmit src/mcp/tools/processar-documento.ts src/mcp/tools/document.ts
```
  </verify>
  <done>Document processing tool created with base64 input and multipart form data output</done>
</task>

<task type="auto">
  <name>Task 2: Update MCP server to register all 11 tools</name>
  <files>src/mcp/server.ts</files>
  <action>
Update the MCP server entry point to register all tools from the three index files:

```typescript
#!/usr/bin/env node
// src/mcp/server.ts
import { McpServer } from '@modelcontextprotocol/sdk/server/mcp.js'
import { StdioServerTransport } from '@modelcontextprotocol/sdk/server/stdio.js'
import { validateConfig } from './config'
import { mcpLog } from './logger'
import { startHeartbeat } from './heartbeat'
import { registerQueryTools } from './tools/query'
import { registerWriteTools } from './tools/write'
import { registerDocumentTool } from './tools/document'

async function main(): Promise<void> {
  try {
    // 1. Validate configuration
    mcpLog.info('='.repeat(50))
    mcpLog.info('Botfy ClinicOps MCP Server v2.0.0')
    mcpLog.info('='.repeat(50))

    mcpLog.info('Validating configuration...')
    validateConfig()
    mcpLog.info('  ✓ Configuration valid')

    // 2. Create MCP server
    mcpLog.info('Creating MCP server...')
    const server = new McpServer({
      name: 'botfy-clinicops',
      version: '2.0.0',
    })
    mcpLog.info('  ✓ Server created')

    // 3. Register all 11 tools
    mcpLog.info('Registering tools...')

    // Query tools (5)
    registerQueryTools(server)

    // Write tools (5)
    registerWriteTools(server)

    // Document tool (1)
    registerDocumentTool(server)

    mcpLog.info('-'.repeat(50))
    mcpLog.info('Total tools registered: 11')
    mcpLog.info('-'.repeat(50))

    // 4. Start heartbeat monitoring
    startHeartbeat(60000) // Log stats every 60 seconds
    mcpLog.info('  ✓ Heartbeat monitoring started (60s interval)')

    // 5. Connect via stdio transport (required for Claude Desktop)
    mcpLog.info('Connecting to stdio transport...')
    const transport = new StdioServerTransport()
    await server.connect(transport)

    mcpLog.info('='.repeat(50))
    mcpLog.info('MCP Server ready and listening on stdio')
    mcpLog.info('='.repeat(50))
  } catch (error) {
    mcpLog.error(`Fatal error: ${error instanceof Error ? error.message : 'Unknown'}`)
    process.exit(1)
  }
}

// Handle graceful shutdown
process.on('SIGINT', () => {
  mcpLog.info('Received SIGINT, shutting down...')
  process.exit(0)
})

process.on('SIGTERM', () => {
  mcpLog.info('Received SIGTERM, shutting down...')
  process.exit(0)
})

// Handle uncaught errors
process.on('uncaughtException', (error) => {
  mcpLog.error(`Uncaught exception: ${error.message}`)
  process.exit(1)
})

process.on('unhandledRejection', (reason) => {
  mcpLog.error(`Unhandled rejection: ${reason}`)
  process.exit(1)
})

main()
```
  </action>
  <verify>
Server compiles and imports are correct:
```bash
npx tsc --noEmit src/mcp/server.ts
grep -c "register" src/mcp/server.ts  # Should find 3 register function calls
```
  </verify>
  <done>MCP server updated to register all 11 tools via query, write, and document index files</done>
</task>

<task type="auto">
  <name>Task 3: Create Claude Desktop config and npm scripts</name>
  <files>
    claude_desktop_config.example.json
    package.json
  </files>
  <action>
Create Claude Desktop configuration example and add npm scripts:

**1. Create claude_desktop_config.example.json:**
```json
{
  "mcpServers": {
    "botfy-clinicops": {
      "type": "stdio",
      "command": "npx",
      "args": [
        "tsx",
        "/REPLACE_WITH_FULL_PATH/src/mcp/server.ts"
      ],
      "env": {
        "AGENT_API_BASE_URL": "http://localhost:3051",
        "AGENT_API_KEY": "REPLACE_WITH_YOUR_API_KEY"
      }
    }
  }
}
```

Add a comment block at the top explaining setup:
```json
{
  "_comment": [
    "Copy this file to your Claude Desktop config location:",
    "- macOS: ~/Library/Application Support/Claude/claude_desktop_config.json",
    "- Windows: %APPDATA%\\Claude\\claude_desktop_config.json",
    "",
    "IMPORTANT:",
    "1. Replace /REPLACE_WITH_FULL_PATH/ with actual project path",
    "2. Replace AGENT_API_KEY with a valid API key from agents table",
    "3. Ensure Next.js dev server is running (./start-dev.sh)",
    "4. Completely quit and restart Claude Desktop (Cmd+Q on macOS)",
    "",
    "Alternative: Use compiled version for production:",
    "  \"command\": \"node\",",
    "  \"args\": [\"/path/to/dist/mcp/server.js\"]"
  ],
  "mcpServers": {
    "botfy-clinicops": {
      "type": "stdio",
      "command": "npx",
      "args": [
        "tsx",
        "/REPLACE_WITH_FULL_PATH/src/mcp/server.ts"
      ],
      "env": {
        "AGENT_API_BASE_URL": "http://localhost:3051",
        "AGENT_API_KEY": "REPLACE_WITH_YOUR_API_KEY"
      }
    }
  }
}
```

**2. Update package.json - add MCP script:**
Add this script to the "scripts" section:
```json
{
  "scripts": {
    "mcp": "tsx src/mcp/server.ts"
  }
}
```
  </action>
  <verify>
Files exist and are valid:
```bash
ls claude_desktop_config.example.json
cat claude_desktop_config.example.json | head -20
grep '"mcp"' package.json
```
  </verify>
  <done>Claude Desktop configuration example created and npm script added for running MCP server</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete MCP Server implementation with all 11 tools:
- 5 query tools (slots, agendamentos, paciente, pre-checkin, instrucoes)
- 5 write tools (criar, reagendar, cancelar, atualizar, confirmar)
- 1 document tool (processar documento)
- Claude Desktop configuration example
  </what-built>
  <how-to-verify>
1. Start the Next.js dev server:
   ```bash
   ./start-dev.sh
   ```

2. In a separate terminal, test MCP server starts without errors:
   ```bash
   AGENT_API_KEY=your-test-key npm run mcp
   ```
   Should see:
   - "Botfy ClinicOps MCP Server v2.0.0"
   - "Total tools registered: 11"
   - "MCP Server ready and listening on stdio"

3. Verify no stdout pollution (logs go to stderr):
   The server should not output anything to stdout except JSON-RPC protocol messages.

4. (Optional) Configure Claude Desktop:
   - Copy claude_desktop_config.example.json to Claude config location
   - Update paths and API key
   - Restart Claude Desktop
   - Check if "botfy-clinicops" appears in Claude's Tools menu
  </how-to-verify>
  <resume-signal>Type "approved" when MCP server starts successfully and registers 11 tools, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
After completing all tasks:

1. All MCP files exist:
```bash
ls -la src/mcp/
ls -la src/mcp/tools/
```

2. All files compile:
```bash
npx tsc --noEmit src/mcp/**/*.ts
```

3. MCP server starts:
```bash
AGENT_API_KEY=test npm run mcp 2>&1 | head -20
```

4. Tool count verification:
```bash
grep -r "name:" src/mcp/tools/*.ts | grep -v "//" | wc -l  # Should be 11
```

5. Claude Desktop config exists:
```bash
cat claude_desktop_config.example.json
```
</verification>

<success_criteria>
- Document processing tool handles base64 input and multipart form data to API
- MCP server registers all 11 tools (5 query + 5 write + 1 document)
- Server starts successfully with stdio transport
- All logging goes to stderr (not stdout)
- Claude Desktop configuration example is complete and documented
- npm script "mcp" available for running server
- Heartbeat monitoring active with 60s interval
</success_criteria>

<output>
After completion, create `.planning/phases/22-mcp-server-(optional-enhancement)/22-04-SUMMARY.md`
</output>
