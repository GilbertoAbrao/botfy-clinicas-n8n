---
phase: 13-agenda-list-view
plan: 02
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/components/agenda/agenda-list-columns.tsx
  - src/components/agenda/agenda-list-table.tsx
autonomous: true

must_haves:
  truths:
    - "Table displays all required columns: Date/Time, Patient, Service, Provider, Status, Actions"
    - "Columns are sortable via header click"
    - "Quick actions (Edit, Confirm, Cancel) appear in each row"
    - "No-show risk badge shows for future appointments"
  artifacts:
    - path: "src/components/agenda/agenda-list-columns.tsx"
      provides: "TanStack Table column definitions with sorting"
      exports: ["getColumns"]
    - path: "src/components/agenda/agenda-list-table.tsx"
      provides: "Data table component with TanStack Table"
      exports: ["AgendaListTable"]
  key_links:
    - from: "src/components/agenda/agenda-list-table.tsx"
      to: "src/components/agenda/agenda-list-columns.tsx"
      via: "import columns"
      pattern: "import.*getColumns.*from.*agenda-list-columns"
    - from: "src/components/agenda/agenda-list-columns.tsx"
      to: "@tanstack/react-table"
      via: "ColumnDef import"
      pattern: "import.*ColumnDef.*from.*@tanstack/react-table"
---

<objective>
Create the TanStack Table with column definitions, sorting, and quick action buttons.

Purpose: Implement core table display (ALIST-02, ALIST-07, ALIST-09, ALIST-10) with all required columns and interactive features.
Output: Reusable AgendaListTable component with sortable columns and action buttons.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-agenda-list-view/13-RESEARCH.md
@.planning/phases/13-agenda-list-view/13-01-SUMMARY.md

@src/lib/validations/appointment.ts
@src/components/ui/table.tsx
@src/components/ui/button.tsx
@src/components/ui/badge.tsx
@src/components/appointments/no-show-risk-badge.tsx
@src/components/lembretes-enviados/lembrete-enviado-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create column definitions</name>
  <files>src/components/agenda/agenda-list-columns.tsx</files>
  <action>
    Create column definitions for the agenda list table using TanStack Table:

    1. Export a `getColumns` function that accepts callbacks for actions:
       ```typescript
       export function getColumns(callbacks: {
         onEdit: (id: string) => void
         onConfirm: (id: string) => void
         onCancel: (id: string) => void
       }): ColumnDef<AppointmentListItem>[]
       ```

    2. Define columns (ALIST-02):

       **Column 1: Data/Hora (scheduledAt)**
       - Sortable header with ArrowUpDown icon
       - Format: "dd/MM/yyyy HH:mm" using date-fns with ptBR locale
       - Use `dbTimestampToTZDate` for timezone-aware display

       **Column 2: Paciente (patientName)**
       - Sortable header
       - Display patient name
       - Show phone below name in smaller text if available

       **Column 3: Servico (serviceType)**
       - Sortable header
       - Simple text display

       **Column 4: Profissional (providerName)**
       - Sortable header
       - Show colored dot using providerColor before name

       **Column 5: Status**
       - Sortable header
       - Display as Badge with variant based on status:
         - agendada: outline (gray)
         - confirmado: default (green-ish)
         - cancelada: destructive (red)
         - realizada: secondary (blue)
         - faltou: destructive (red)
       - Use STATUS_APPOINTMENT_LABELS for Portuguese text

       **Column 6: Risco (ALIST-10)**
       - No sorting
       - Show NoShowRiskBadge component for future appointments only
       - Check: `new Date(scheduledAt) > new Date()` and status not in [cancelada, realizada, faltou]

       **Column 7: Acoes (ALIST-09)**
       - No sorting
       - Three icon buttons:
         - Edit (Pencil icon): Always visible, calls onEdit(id)
         - Confirm (Check icon): Only for status=agendada, calls onConfirm(id)
         - Cancel (X icon): Only for status in [agendada, confirmado], calls onCancel(id)
       - Wrap in `onClick={(e) => e.stopPropagation()}` to prevent row click

    3. Import from:
       - `@tanstack/react-table`: ColumnDef
       - `lucide-react`: ArrowUpDown, Pencil, Check, X
       - `@/components/ui/button`: Button
       - `@/components/ui/badge`: Badge
       - `@/components/appointments/no-show-risk-badge`: NoShowRiskBadge
       - `date-fns`: format
       - `date-fns/locale`: ptBR
       - `@/lib/calendar/time-zone-utils`: dbTimestampToTZDate
       - `@/lib/validations/appointment`: AppointmentListItem, STATUS_APPOINTMENT_LABELS
  </action>
  <verify>
    TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Column definitions export correctly with all 7 columns; TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 2: Create AgendaListTable component</name>
  <files>src/components/agenda/agenda-list-table.tsx</files>
  <action>
    Create the main table component using TanStack Table with shadcn/ui:

    1. Props interface:
       ```typescript
       interface AgendaListTableProps {
         data: AppointmentListItem[]
         onEdit: (id: string) => void
         onConfirm: (id: string) => void
         onCancel: (id: string) => void
         onRowClick?: (id: string) => void
       }
       ```

    2. Use TanStack Table hooks (ALIST-07):
       ```typescript
       const [sorting, setSorting] = useState<SortingState>([])

       const columns = useMemo(() => getColumns({ onEdit, onConfirm, onCancel }), [onEdit, onConfirm, onCancel])

       const table = useReactTable({
         data,
         columns,
         getCoreRowModel: getCoreRowModel(),
         getSortedRowModel: getSortedRowModel(),
         onSortingChange: setSorting,
         state: { sorting },
       })
       ```

    3. Render table using shadcn/ui Table components:
       - Wrap in `<div className="hidden md:block bg-white rounded-lg border overflow-hidden">`
       - Use TableHeader with sortable headers from `table.getHeaderGroups()`
       - Use TableBody with rows from `table.getRowModel().rows`
       - Use flexRender for header and cell content
       - Add hover effect and cursor pointer on rows
       - Handle row click: `onClick={() => onRowClick?.(row.original.id)}`

    4. Empty state:
       - If no data, show centered message with Calendar icon
       - "Nenhum agendamento encontrado"
       - "Tente ajustar os filtros de busca."

    5. Note: This component does NOT handle mobile cards - that's separate.

    Follow pattern from TanStack docs and shadcn/ui Data Table guide.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Component exports correctly.
  </verify>
  <done>AgendaListTable renders with sortable columns, row click, and action buttons.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Column definitions include all 7 columns
3. Sorting state changes when clicking sortable headers
4. Action buttons render with correct visibility based on status
5. NoShowRiskBadge only shows for eligible appointments
6. Empty state shows when data is empty array
</verification>

<success_criteria>
- getColumns returns ColumnDef array with all required columns (ALIST-02)
- Columns are sortable via header click (ALIST-07)
- Quick actions show Edit/Confirm/Cancel with correct visibility (ALIST-09)
- No-show risk badge shows for future appointments (ALIST-10)
- Table renders correctly with shadcn/ui styling
</success_criteria>

<output>
After completion, create `.planning/phases/13-agenda-list-view/13-02-SUMMARY.md`
</output>
