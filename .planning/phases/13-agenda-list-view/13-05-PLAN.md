---
phase: 13-agenda-list-view
plan: 05
type: execute
wave: 3
depends_on: [13-02, 13-03, 13-04]
files_modified:
  - src/components/agenda/agenda-list-view.tsx
  - src/components/agenda/view-toggle.tsx
  - src/app/agenda/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can toggle between calendar and list view via button"
    - "Filter state persists across view toggle"
    - "List view integrates filters, table, cards, and pagination"
    - "Quick actions open AppointmentModal for edit/confirm/cancel"
  artifacts:
    - path: "src/components/agenda/agenda-list-view.tsx"
      provides: "Complete agenda list view with all sub-components"
      exports: ["AgendaListView"]
    - path: "src/components/agenda/view-toggle.tsx"
      provides: "Toggle button between calendar and list views"
      exports: ["ViewToggle"]
    - path: "src/app/agenda/page.tsx"
      provides: "Updated agenda page with view toggle"
      min_lines: 50
  key_links:
    - from: "src/app/agenda/page.tsx"
      to: "src/components/agenda/agenda-list-view.tsx"
      via: "conditional render based on view param"
      pattern: "view.*===.*'list'.*AgendaListView"
    - from: "src/components/agenda/agenda-list-view.tsx"
      to: "src/hooks/use-agenda-list.ts"
      via: "useAgendaList hook"
      pattern: "useAgendaList"
    - from: "src/components/agenda/agenda-list-view.tsx"
      to: "src/components/calendar/appointment-modal.tsx"
      via: "AppointmentModal for edit/confirm/cancel"
      pattern: "AppointmentModal"
---

<objective>
Wire up all components into the complete agenda list view and update the page.

Purpose: Integrate filters, table, cards, pagination, and view toggle to complete ALIST-01 through ALIST-12.
Output: Fully functional agenda list view accessible via `/agenda?view=list`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-agenda-list-view/13-RESEARCH.md
@.planning/phases/13-agenda-list-view/13-01-SUMMARY.md
@.planning/phases/13-agenda-list-view/13-02-SUMMARY.md
@.planning/phases/13-agenda-list-view/13-03-SUMMARY.md
@.planning/phases/13-agenda-list-view/13-04-SUMMARY.md

@src/app/agenda/page.tsx
@src/components/calendar/calendar-view.tsx
@src/components/calendar/appointment-modal.tsx
@src/hooks/use-agenda-list.ts
@src/components/agenda/agenda-list-table.tsx
@src/components/agenda/agenda-list-cards.tsx
@src/components/agenda/agenda-list-filters.tsx
@src/components/agenda/agenda-list-pagination.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ViewToggle component</name>
  <files>src/components/agenda/view-toggle.tsx</files>
  <action>
    Create toggle button component for switching between calendar and list views:

    1. Props interface:
       ```typescript
       interface ViewToggleProps {
         currentView: 'calendar' | 'list'
       }
       ```

    2. Use `useRouter` and `useSearchParams` to preserve filters when toggling

    3. Render two buttons side by side:
       ```tsx
       <div className="flex gap-2">
         <Link href={buildURL('calendar')}>
           <Button variant={currentView === 'calendar' ? 'default' : 'outline'}>
             <CalendarDays className="h-4 w-4 mr-2" />
             Calendario
           </Button>
         </Link>
         <Link href={buildURL('list')}>
           <Button variant={currentView === 'list' ? 'default' : 'outline'}>
             <List className="h-4 w-4 mr-2" />
             Lista
           </Button>
         </Link>
       </div>
       ```

    4. buildURL function preserves existing search params:
       ```typescript
       const buildURL = (view: string) => {
         const params = new URLSearchParams(searchParams.toString())
         params.set('view', view)
         return `/agenda?${params.toString()}`
       }
       ```

    5. Import icons from lucide-react: CalendarDays, List
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Toggle buttons switch URL param while preserving other params.
  </verify>
  <done>ViewToggle component switches view via URL param, preserves filters.</done>
</task>

<task type="auto">
  <name>Task 2: Create AgendaListView container component</name>
  <files>src/components/agenda/agenda-list-view.tsx</files>
  <action>
    Create main list view container that wires all components together:

    1. Mark as 'use client' since it uses hooks

    2. Use `useSearchParams` to read filter values from URL

    3. Call `useAgendaList` hook with filters:
       ```typescript
       const searchParams = useSearchParams()
       const filters = {
         dateStart: searchParams.get('dateStart') || undefined,
         dateEnd: searchParams.get('dateEnd') || undefined,
         providerId: searchParams.get('providerId') || undefined,
         serviceType: searchParams.get('serviceType') || undefined,
         status: searchParams.get('status') || undefined,
         search: searchParams.get('search') || undefined,
         page: parseInt(searchParams.get('page') || '1'),
         limit: parseInt(searchParams.get('limit') || '50'),
       }

       const { appointments, pagination, loading, error, refetch } = useAgendaList(filters)
       ```

    4. Manage modal state for appointment actions:
       ```typescript
       const [modalOpen, setModalOpen] = useState(false)
       const [selectedAppointment, setSelectedAppointment] = useState<string | undefined>()
       const [modalAction, setModalAction] = useState<'edit' | 'confirm' | 'cancel'>('edit')
       ```

    5. Action handlers:
       ```typescript
       const handleEdit = (id: string) => {
         setSelectedAppointment(id)
         setModalOpen(true)
       }

       const handleConfirm = async (id: string) => {
         // Quick confirm: update status via API, then refetch
         try {
           const res = await fetch(`/api/agendamentos/${id}`, {
             method: 'PUT',
             headers: { 'Content-Type': 'application/json' },
             body: JSON.stringify({ status: 'CONFIRMADO' }),
           })
           if (!res.ok) throw new Error('Failed to confirm')
           toast.success('Agendamento confirmado')
           refetch()
         } catch (error) {
           toast.error('Erro ao confirmar agendamento')
         }
       }

       const handleCancel = async (id: string) => {
         if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return
         try {
           const res = await fetch(`/api/agendamentos/${id}`, {
             method: 'DELETE',
           })
           if (!res.ok) throw new Error('Failed to cancel')
           toast.success('Agendamento cancelado')
           refetch()
         } catch (error) {
           toast.error('Erro ao cancelar agendamento')
         }
       }
       ```

    6. Render structure:
       ```tsx
       <div className="space-y-4">
         {/* Filters */}
         <AgendaListFilters />

         {/* Loading state */}
         {loading && <div className="text-center py-8">Carregando...</div>}

         {/* Error state */}
         {error && <div className="text-red-600 text-center py-8">{error}</div>}

         {/* Data display */}
         {!loading && !error && (
           <>
             {/* Desktop table */}
             <AgendaListTable
               data={appointments}
               onEdit={handleEdit}
               onConfirm={handleConfirm}
               onCancel={handleCancel}
               onRowClick={handleEdit}
             />

             {/* Mobile cards */}
             <AgendaListCards
               data={appointments}
               onEdit={handleEdit}
               onConfirm={handleConfirm}
               onCancel={handleCancel}
               onRowClick={handleEdit}
             />

             {/* Pagination */}
             {pagination.totalPages > 1 && (
               <AgendaListPagination
                 currentPage={pagination.page}
                 totalPages={pagination.totalPages}
                 totalItems={pagination.total}
                 itemsPerPage={pagination.limit}
               />
             )}

             {/* Item count */}
             <div className="text-sm text-gray-600 text-center">
               Mostrando {appointments.length} de {pagination.total} agendamentos
             </div>
           </>
         )}

         {/* Appointment modal */}
         <AppointmentModal
           isOpen={modalOpen}
           onClose={() => setModalOpen(false)}
           onSave={() => {
             setModalOpen(false)
             refetch()
           }}
           appointmentId={selectedAppointment}
         />
       </div>
       ```

    7. Import all sub-components and utilities (toast from sonner)
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Component renders with filters, table, cards, pagination, and modal.
  </verify>
  <done>AgendaListView integrates all sub-components and handles actions.</done>
</task>

<task type="auto">
  <name>Task 3: Update agenda page to support view toggle</name>
  <files>src/app/agenda/page.tsx</files>
  <action>
    Modify the agenda page to support both calendar and list views:

    1. Accept searchParams to read view preference:
       ```typescript
       export default async function AgendaPage({
         searchParams,
       }: {
         searchParams: Promise<{ view?: string }>
       }) {
         const params = await searchParams
         const view = params.view || 'calendar'
         // ...
       }
       ```

    2. Keep existing authentication check

    3. Update page header to include ViewToggle:
       ```tsx
       <div>
         <div className="flex items-center justify-between mb-2">
           <div className="flex items-center gap-3">
             <Calendar className="h-8 w-8 text-purple-500" />
             <h1 className="text-3xl font-bold text-gray-900">Agenda</h1>
           </div>
           <ViewToggle currentView={view as 'calendar' | 'list'} />
         </div>
         <p className="text-gray-600">
           Visualize e gerencie todos os agendamentos da cl√≠nica
         </p>
       </div>
       ```

    4. Conditionally render CalendarView or AgendaListView:
       ```tsx
       {view === 'list' ? (
         <Card>
           <CardHeader>
             <CardTitle>Lista de Agendamentos</CardTitle>
           </CardHeader>
           <CardContent>
             <Suspense fallback={<div>Carregando lista...</div>}>
               <AgendaListView />
             </Suspense>
           </CardContent>
         </Card>
       ) : (
         <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
           <div className="lg:col-span-2">
             <Card>
               <CardHeader>
                 <CardTitle>Calendario de Agendamentos</CardTitle>
               </CardHeader>
               <CardContent>
                 <Suspense fallback={<div>Carregando agenda...</div>}>
                   <CalendarView />
                 </Suspense>
               </CardContent>
             </Card>
           </div>
           <div>
             <WaitlistManager />
           </div>
         </div>
       )}
       ```

    5. Note: WaitlistManager only shows in calendar view (not relevant for list view)

    6. Import new components:
       - ViewToggle from '@/components/agenda/view-toggle'
       - AgendaListView from '@/components/agenda/agenda-list-view'
  </action>
  <verify>
    Start dev server and test:
    - Visit /agenda - shows calendar (default)
    - Visit /agenda?view=list - shows list view
    - Toggle button switches between views
    - Filters persist across toggle
  </verify>
  <done>Agenda page shows view toggle and conditionally renders calendar or list view.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. `npm run build` succeeds
3. Visit /agenda - calendar view shown by default
4. Click "Lista" button - redirects to /agenda?view=list
5. List view shows filters, table (desktop), cards (mobile), pagination
6. Apply filters - data updates, URL params update
7. Click "Calendario" - preserves filter params, shows calendar
8. Click row in table - opens AppointmentModal in edit mode
9. Click Confirm action - updates status to CONFIRMADO
10. Click Cancel action - shows confirmation, cancels appointment
11. Mobile view shows cards instead of table
</verification>

<success_criteria>
- View toggle switches between calendar and list (ALIST-01)
- List view displays all appointments with correct columns (ALIST-02)
- All filters work and update URL params (ALIST-03 through ALIST-08)
- Quick actions work from list view (ALIST-09)
- No-show risk badge shows where appropriate (ALIST-10)
- Pagination shows when >50 appointments (ALIST-11)
- Mobile shows card layout (ALIST-12)
- Filter state persists across view toggle
</success_criteria>

<output>
After completion, create `.planning/phases/13-agenda-list-view/13-05-SUMMARY.md`
</output>
