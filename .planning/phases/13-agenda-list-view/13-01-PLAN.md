---
phase: 13-agenda-list-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/hooks/use-agenda-list.ts
  - src/lib/validations/appointment.ts
  - src/app/api/agendamentos/list/route.ts
autonomous: true

must_haves:
  truths:
    - "API returns paginated appointments with all required fields"
    - "Hook fetches and transforms appointment data for list view"
    - "Types are properly defined for list view data"
  artifacts:
    - path: "src/hooks/use-agenda-list.ts"
      provides: "Data hook for agenda list view with filtering support"
      exports: ["useAgendaList", "AgendaListItem"]
    - path: "src/lib/validations/appointment.ts"
      provides: "Type definitions and validation for list view"
      exports: ["AppointmentListItem", "AppointmentFilters", "STATUS_APPOINTMENT"]
    - path: "src/app/api/agendamentos/list/route.ts"
      provides: "API endpoint for fetching paginated appointments with filters"
      exports: ["GET"]
  key_links:
    - from: "src/hooks/use-agenda-list.ts"
      to: "/api/agendamentos/list"
      via: "fetch in useEffect"
      pattern: "fetch.*api/agendamentos/list"
    - from: "src/app/api/agendamentos/list/route.ts"
      to: "supabase.from('appointments')"
      via: "database query"
      pattern: "from\\('appointments'\\)"
---

<objective>
Install @tanstack/react-table and create the data layer for agenda list view (API + hook + types).

Purpose: Establish foundation for list view - data fetching with pagination, filtering, and proper types.
Output: API endpoint `/api/agendamentos/list` and `useAgendaList` hook ready for UI consumption.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-agenda-list-view/13-RESEARCH.md

@src/hooks/use-calendar-events.ts
@src/app/api/agendamentos/route.ts
@src/lib/supabase/server.ts
@src/lib/validations/lembrete-enviado.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @tanstack/react-table</name>
  <files>package.json, package-lock.json</files>
  <action>
    Install the TanStack React Table library for headless table logic:
    ```bash
    npm install @tanstack/react-table
    ```
    This provides sorting, filtering, and pagination row models that integrate with shadcn/ui Table.
  </action>
  <verify>
    Run `npm ls @tanstack/react-table` - should show version ^8.x installed.
    Run `npm run build` - should succeed without errors.
  </verify>
  <done>@tanstack/react-table is listed in package.json dependencies and npm build succeeds.</done>
</task>

<task type="auto">
  <name>Task 2: Create appointment types and validation schemas</name>
  <files>src/lib/validations/appointment.ts</files>
  <action>
    Create type definitions for the agenda list view data:

    1. Define `AppointmentListItem` type with all fields needed for list display:
       - id: string
       - scheduledAt: string (ISO timestamp)
       - patientId: string
       - patientName: string
       - patientPhone: string | null
       - serviceType: string
       - providerId: string
       - providerName: string
       - providerColor: string
       - status: AppointmentStatus
       - duration: number

    2. Define `AppointmentStatus` type and `STATUS_APPOINTMENT` constants:
       - AGENDADO (scheduled)
       - CONFIRMADO (confirmed)
       - CANCELADA (cancelled)
       - REALIZADA (completed)
       - FALTOU (no-show)

    3. Define `AppointmentFilters` type:
       - dateStart?: string
       - dateEnd?: string
       - providerId?: string (comma-separated for multi-select)
       - serviceType?: string
       - status?: string
       - search?: string (patient name or phone)
       - page?: number
       - limit?: number

    4. Add label maps for status display in Portuguese:
       - STATUS_APPOINTMENT_LABELS: { agendada: 'Agendada', confirmado: 'Confirmado', ... }

    Follow pattern from `src/lib/validations/lembrete-enviado.ts`.
  </action>
  <verify>
    TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>Types exported from src/lib/validations/appointment.ts and TypeScript compiles.</done>
</task>

<task type="auto">
  <name>Task 3: Create API endpoint for paginated appointments</name>
  <files>src/app/api/agendamentos/list/route.ts</files>
  <action>
    Create GET endpoint at `/api/agendamentos/list` that returns paginated appointments with filters:

    1. Authentication: Use `getCurrentUserWithRole()`, return 401 if not authenticated

    2. Parse query parameters using AppointmentFilters type:
       - dateStart, dateEnd: ISO date strings
       - providerId: comma-separated list of provider IDs (ALIST-04 multi-select)
       - serviceType: exact match
       - status: exact match
       - search: partial match on patient name OR phone
       - page: default 1
       - limit: default 50 (ALIST-11)

    3. Build Supabase query:
       ```typescript
       let query = supabase
         .from('appointments')
         .select(`
           id,
           scheduled_at,
           service_type,
           status,
           duration,
           patient:patients!patient_id (id, nome, telefone),
           provider:providers!provider_id (id, nome, cor_calendario)
         `, { count: 'exact' })
       ```

    4. Apply filters:
       - Date range: `.gte('scheduled_at', dateStart).lte('scheduled_at', dateEnd)`
       - Provider: `.in('provider_id', providerIds)` (parse comma-separated)
       - Service: `.eq('service_type', serviceType)`
       - Status: `.eq('status', status.toLowerCase())`
       - Search: Use `.or()` with ilike on patient name/phone

    5. Apply pagination:
       - Order by scheduled_at descending (newest first)
       - `.range((page - 1) * limit, page * limit - 1)`

    6. Transform response to AppointmentListItem[] format

    7. Return JSON with shape:
       ```json
       {
         "appointments": AppointmentListItem[],
         "pagination": { page, limit, total, totalPages }
       }
       ```

    Follow pattern from existing API routes in the codebase.
  </action>
  <verify>
    Start dev server and test with curl:
    ```bash
    curl "http://localhost:3051/api/agendamentos/list?page=1&limit=10" -H "Cookie: [session]"
    ```
    Should return JSON with appointments array and pagination object.
  </verify>
  <done>API returns paginated appointments with all required fields; filters work correctly.</done>
</task>

<task type="auto">
  <name>Task 4: Create useAgendaList hook</name>
  <files>src/hooks/use-agenda-list.ts</files>
  <action>
    Create client-side hook for fetching agenda list data:

    1. Accept filters object matching AppointmentFilters type

    2. Fetch from `/api/agendamentos/list` with query params built from filters

    3. Return:
       - appointments: AppointmentListItem[]
       - pagination: { page, limit, total, totalPages }
       - loading: boolean
       - error: string | null
       - refetch: () => void

    4. Use useCallback for refetch to prevent unnecessary re-renders

    5. Re-fetch when filters change (use filters as dependency)

    6. Handle timezone conversion: Use `dbTimestampToTZDate` for scheduledAt display

    Follow pattern from `use-calendar-events.ts` but with filters support.

    Note: Do NOT memoize data array in hook - leave that to consumer (DataTable pattern requires it).
  </action>
  <verify>
    Import hook in a test component, verify data loads and pagination info is correct.
    TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Hook fetches data with filters, returns typed appointments and pagination.</done>
</task>

</tasks>

<verification>
1. `npm ls @tanstack/react-table` shows v8.x installed
2. TypeScript compiles without errors: `npx tsc --noEmit`
3. API endpoint responds with paginated data:
   - Test without filters: returns all appointments
   - Test with dateStart/dateEnd: returns filtered range
   - Test with status filter: returns only matching status
   - Test with search: finds by patient name
4. `npm run build` succeeds
</verification>

<success_criteria>
- @tanstack/react-table v8.x installed and working
- AppointmentListItem and AppointmentFilters types defined
- API endpoint /api/agendamentos/list returns paginated data
- useAgendaList hook fetches data with filter support
- All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-agenda-list-view/13-01-SUMMARY.md`
</output>
