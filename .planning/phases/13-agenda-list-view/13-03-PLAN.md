---
phase: 13-agenda-list-view
plan: 03
type: execute
wave: 2
depends_on: [13-01]
files_modified:
  - src/components/agenda/agenda-list-filters.tsx
  - src/components/agenda/agenda-list-pagination.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter by date range with quick presets (today, tomorrow, week, month)"
    - "User can filter by provider (multi-select)"
    - "User can filter by service type and status"
    - "User can search by patient name or phone"
    - "Pagination controls show page numbers and items per page"
  artifacts:
    - path: "src/components/agenda/agenda-list-filters.tsx"
      provides: "Filter controls for date range, provider, service, status, search"
      exports: ["AgendaListFilters"]
    - path: "src/components/agenda/agenda-list-pagination.tsx"
      provides: "Pagination controls with page navigation"
      exports: ["AgendaListPagination"]
  key_links:
    - from: "src/components/agenda/agenda-list-filters.tsx"
      to: "useRouter/useSearchParams"
      via: "URL state management"
      pattern: "useSearchParams|router\\.push"
    - from: "src/components/agenda/agenda-list-pagination.tsx"
      to: "useRouter"
      via: "page navigation"
      pattern: "router\\.push"
---

<objective>
Create filter controls and pagination for the agenda list view.

Purpose: Implement ALIST-03 (date filter), ALIST-04 (provider multi-select), ALIST-05 (service filter), ALIST-06 (status filter), ALIST-08 (search), and ALIST-11 (pagination).
Output: Filter and pagination components that update URL query params.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-agenda-list-view/13-RESEARCH.md
@.planning/phases/13-agenda-list-view/13-01-SUMMARY.md

@src/lib/validations/appointment.ts
@src/components/lembretes-enviados/lembrete-enviado-filters.tsx
@src/components/lembretes-enviados/lembrete-enviado-pagination.tsx
@src/components/calendar/resource-selector.tsx
@src/components/ui/select.tsx
@src/components/ui/calendar.tsx
@src/components/ui/popover.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgendaListFilters component</name>
  <files>src/components/agenda/agenda-list-filters.tsx</files>
  <action>
    Create filter controls component that updates URL search params:

    1. Use `useRouter` and `useSearchParams` for URL state management

    2. Read initial filter values from URL params:
       - dateStart, dateEnd (ISO strings)
       - providerId (comma-separated for multi-select)
       - serviceType
       - status
       - search (patient name/phone)

    3. **Quick date presets (ALIST-03):**
       - Row of buttons: "Hoje", "Amanha", "Esta semana", "Este mes", "Personalizado"
       - Use date-fns: startOfDay, endOfDay, addDays, startOfWeek, endOfWeek, startOfMonth, endOfMonth
       - Use ptBR locale for week start (Sunday)
       - Highlight active preset with blue border/background

    4. **Custom date range:**
       - Two Popover components with Calendar inside
       - Start date and End date
       - Show "Selecionar" when not set, formatted date when set
       - X button to clear each date

    5. **Provider multi-select (ALIST-04):**
       - Use Popover with Checkbox list pattern (shadcn/ui doesn't have native multi-select)
       - Fetch providers from `/api/providers` on mount
       - Show selected count: "3 profissionais" or "Todos os profissionais"
       - Each checkbox toggles provider in/out of comma-separated list

    6. **Service type filter (ALIST-05):**
       - Standard Select component
       - Fetch distinct service types from `/api/servicos`
       - "Todos os servicos" option clears filter

    7. **Status filter (ALIST-06):**
       - Standard Select component
       - Options: Todos, Agendada, Confirmado, Cancelada, Realizada, Faltou
       - Use STATUS_APPOINTMENT and STATUS_APPOINTMENT_LABELS

    8. **Patient search (ALIST-08):**
       - Input with Search icon prefix
       - Placeholder: "Buscar paciente ou telefone..."
       - Debounce 300ms before updating URL
       - X button to clear search

    9. **Clear all button:**
       - Show when any filter is active
       - Count of active filters in badge
       - Clears all URL params except 'view'

    10. **Mobile layout:**
        - Collapsible filter section with "Filtros avancados" button
        - Expand/collapse toggle for mobile screens
        - Use `md:hidden` and `hidden md:block` classes

    Follow pattern from `lembrete-enviado-filters.tsx` but with provider multi-select.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Filters render and update URL params correctly when changed.
  </verify>
  <done>All filter controls render, update URL params, and support mobile collapse.</done>
</task>

<task type="auto">
  <name>Task 2: Create AgendaListPagination component</name>
  <files>src/components/agenda/agenda-list-pagination.tsx</files>
  <action>
    Create pagination controls that update page in URL:

    1. Props interface:
       ```typescript
       interface AgendaListPaginationProps {
         currentPage: number
         totalPages: number
         totalItems: number
         itemsPerPage: number
       }
       ```

    2. Use `useRouter` and `useSearchParams` to preserve existing filters when navigating

    3. **Navigation buttons:**
       - First page (ChevronsLeft icon): disabled if page === 1
       - Previous page (ChevronLeft icon): disabled if page === 1
       - Next page (ChevronRight icon): disabled if page === totalPages
       - Last page (ChevronsRight icon): disabled if page === totalPages

    4. **Page info:**
       - "Pagina X de Y"
       - "Mostrando Z de N agendamentos"

    5. **Items per page selector (ALIST-11):**
       - Select with options: 20, 50, 100
       - Default: 50 (per requirements)
       - Changing resets to page 1

    6. **URL update:**
       - Preserve all existing filter params
       - Update only 'page' and 'limit' params
       - Navigate with router.push()

    7. **Responsive layout:**
       - Stack controls vertically on mobile
       - Horizontal on desktop with flex justify-between

    Follow pattern from `lembrete-enviado-pagination.tsx`.
  </action>
  <verify>
    TypeScript compiles: `npx tsc --noEmit`
    Pagination navigates correctly while preserving filters.
  </verify>
  <done>Pagination controls navigate pages, preserve filters, and allow page size change.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Quick date presets update URL with correct date range
3. Custom date picker updates dateStart/dateEnd params
4. Provider multi-select shows checkboxes and updates providerId as comma-separated
5. Service and status selects update respective URL params
6. Search input debounces and updates search param
7. Clear all button removes all filter params
8. Pagination preserves filter params when navigating
9. Items per page change resets to page 1
</verification>

<success_criteria>
- Date range filter works with presets and custom (ALIST-03)
- Provider multi-select allows selecting multiple providers (ALIST-04)
- Service type filter works (ALIST-05)
- Status filter works (ALIST-06)
- Search finds by patient name or phone with debounce (ALIST-08)
- Pagination with 50 items default, configurable (ALIST-11)
- Mobile filter collapse works
</success_criteria>

<output>
After completion, create `.planning/phases/13-agenda-list-view/13-03-SUMMARY.md`
</output>
