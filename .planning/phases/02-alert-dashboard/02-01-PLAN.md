---
plan_id: 02-01
phase: 2
wave: 1
title: Database Schema & Core Models
status: not_started
must_haves:
  truths:
    - Alert model captures all alert types (conversas travadas, pré check-ins, agendamentos não confirmados, handoffs)
    - Patient model includes contact info and links to appointments
    - Appointment model includes status tracking (confirmed, tentative, no-show, cancelled, completed)
    - Conversation model tracks WhatsApp threads with AI/human indicators
    - All PHI tables have RLS policies applied
    - Relations established: Alert → Patient, Alert → Appointment, Alert → Conversation
  artifacts:
    - prisma/schema.prisma (updated with new models)
    - SQL migration file generated
    - RLS policies SQL script
  key_links:
    - Prisma schema: prisma/schema.prisma
    - Phase 1 audit logging: src/lib/audit/audit.ts
---

# Plan 02-01: Database Schema & Core Models

## Objective

Create database schema for alerts, patients, appointments, and conversations. Establish relations, indexes, and Row Level Security policies. Seed test data for development.

## Execution Context

**Prerequisites:**
- Phase 1 complete (auth, users table, audit logs)
- Supabase credentials configured (.env.local)
- Prisma 7 installed

**Key Files:**
- prisma/schema.prisma
- .planning/REQUIREMENTS.md (ALERT-01 through ALERT-15)

**External Resources:**
- Prisma docs: https://www.prisma.io/docs/orm/prisma-schema
- Supabase RLS: https://supabase.com/docs/guides/auth/row-level-security

## Context

This plan establishes the data foundation for Phase 2. The alert system needs to track multiple alert types with priority levels, link to patients/appointments/conversations, and support status transitions (new → in-progress → resolved/dismissed).

**Alert Types:**
1. conversas_travadas (stuck conversations)
2. pre_checkins_pendentes (pending pre-check-ins)
3. agendamentos_nao_confirmados (unconfirmed appointments)
4. handoff_normal (normal human handoff)
5. handoff_erro (error handoff)

**Alert Priorities:**
- urgent (requires immediate attention)
- high (same-day resolution)
- low (routine follow-up)

**Alert Status Flow:**
new → in_progress → resolved | dismissed

## Tasks

### Task 1: Create Prisma models for alerts system
- [ ] Add AlertType enum (conversas_travadas, pre_checkins_pendentes, agendamentos_nao_confirmados, handoff_normal, handoff_erro)
- [ ] Add AlertPriority enum (urgent, high, low)
- [ ] Add AlertStatus enum (new, in_progress, resolved, dismissed)
- [ ] Add AppointmentStatus enum (confirmed, tentative, no_show, cancelled, completed)
- [ ] Add ConversationStatus enum (IA, HUMANO, FINALIZADO)
- [ ] Create Alert model with fields:
  - id (UUID, primary key)
  - type (AlertType enum)
  - priority (AlertPriority enum)
  - status (AlertStatus enum, default: new)
  - title (String, brief description)
  - description (String?, detailed context)
  - patientId (UUID?, nullable foreign key)
  - appointmentId (UUID?, nullable foreign key)
  - conversationId (UUID?, nullable foreign key)
  - metadata (Json?, additional context like error messages)
  - resolvedAt (DateTime?, when resolved/dismissed)
  - resolvedBy (UUID?, user who resolved)
  - createdAt (DateTime, default now)
  - updatedAt (DateTime, auto-update)
- [ ] Create Patient model with fields:
  - id (UUID, primary key)
  - nome (String)
  - telefone (String, indexed)
  - email (String?, optional)
  - cpf (String?, indexed, unique)
  - data_nascimento (DateTime?)
  - endereco (String?)
  - convenio (String?, health insurance)
  - numero_carteirinha (String?, insurance card number)
  - createdAt (DateTime)
  - updatedAt (DateTime)
- [ ] Create Appointment model with fields:
  - id (UUID, primary key)
  - patientId (UUID, foreign key)
  - providerId (UUID?, future use)
  - serviceType (String, e.g., "Limpeza de Pele")
  - scheduledAt (DateTime, appointment date/time)
  - duration (Int, minutes)
  - status (AppointmentStatus enum, default: tentative)
  - confirmedAt (DateTime?, when patient confirmed)
  - notes (String?, additional notes)
  - createdAt (DateTime)
  - updatedAt (DateTime)
- [ ] Create Conversation model with fields:
  - id (UUID, primary key)
  - patientId (UUID, foreign key)
  - whatsappId (String, Evolution API conversation ID)
  - status (ConversationStatus enum, default: IA)
  - messages (Json[], array of message objects with timestamp, sender, content)
  - lastMessageAt (DateTime, for sorting)
  - createdAt (DateTime)
  - updatedAt (DateTime)
- [ ] Add relations:
  - Alert → Patient (optional, many-to-one)
  - Alert → Appointment (optional, many-to-one)
  - Alert → Conversation (optional, many-to-one)
  - Alert → User (resolvedBy, optional, many-to-one)
  - Patient → Appointments (one-to-many)
  - Patient → Conversations (one-to-many)
  - Patient → Alerts (one-to-many)
- [ ] Add indexes for performance:
  - Alert: status, priority, createdAt, patientId
  - Patient: telefone, cpf, nome
  - Appointment: patientId, scheduledAt, status
  - Conversation: patientId, lastMessageAt, status

### Task 2: Generate and apply database migration
- [ ] Generate Prisma migration: `npx dotenv -e .env.local -- npx prisma migrate dev --name add_alert_system`
- [ ] Verify tables created in Supabase dashboard (alerts, patients, appointments, conversations)
- [ ] Check enum types created (AlertType, AlertPriority, AlertStatus, AppointmentStatus, ConversationStatus)

### Task 3: Create RLS policies for PHI tables
- [ ] Create SQL script: prisma/rls-policies-phase2.sql
- [ ] Add RLS policies for patients table:
  - Enable RLS: `ALTER TABLE patients ENABLE ROW LEVEL SECURITY;`
  - Policy: Authenticated users (ADMIN and ATENDENTE) can view all patients
  - Policy: Authenticated users (ADMIN and ATENDENTE) can insert/update patients
  - Policy: Only ADMIN can delete patients (via user role check)
- [ ] Add RLS policies for appointments table:
  - Enable RLS: `ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;`
  - Policy: Authenticated users can view all appointments
  - Policy: Authenticated users can insert/update appointments
  - Policy: Only ADMIN can delete appointments
- [ ] Add RLS policies for conversations table:
  - Enable RLS: `ALTER TABLE conversations ENABLE ROW LEVEL SECURITY;`
  - Policy: Authenticated users can view all conversations
  - Policy: Authenticated users can insert/update conversations (for status changes)
  - Policy: Only ADMIN can delete conversations
- [ ] Add RLS policies for alerts table:
  - Enable RLS: `ALTER TABLE alerts ENABLE ROW LEVEL SECURITY;`
  - Policy: Authenticated users can view all alerts
  - Policy: Authenticated users can update alert status
  - Policy: Only system can insert alerts (alerts are created by N8N webhooks, not users directly - defer to Phase 6)
- [ ] Document RLS policies in plan summary
- [ ] Test RLS: Verify Atendente can view but not delete, Admin has full access

### Task 4: Create seed data for development
- [ ] Create prisma/seed-phase2.ts script
- [ ] Seed 3 test patients with varied data:
  - Patient 1: João Silva (complete profile with CPF, convênio)
  - Patient 2: Maria Santos (minimal profile, phone only)
  - Patient 3: Carlos Oliveira (complete profile)
- [ ] Seed 5 test appointments across patients:
  - 2 confirmed appointments (today and tomorrow)
  - 2 tentative appointments (next week)
  - 1 no-show appointment (yesterday)
- [ ] Seed 3 test conversations:
  - Conversation 1: Patient 1, status IA, 5 messages (mix of AI and patient)
  - Conversation 2: Patient 2, status HUMANO, 3 messages (handoff occurred)
  - Conversation 3: Patient 3, status FINALIZADO, 10 messages (completed thread)
- [ ] Seed 8 test alerts covering all types and priorities:
  - Alert 1: conversas_travadas, urgent, linked to Conversation 1
  - Alert 2: pre_checkins_pendentes, high, linked to Appointment 1
  - Alert 3: agendamentos_nao_confirmados, high, linked to Appointment 2
  - Alert 4: handoff_normal, low, linked to Conversation 2
  - Alert 5: handoff_erro, urgent, linked to Conversation 1
  - Alert 6: conversas_travadas, high, no patient (edge case)
  - Alert 7: resolved alert (test resolved state)
  - Alert 8: dismissed alert (test dismissed state)
- [ ] Add seed script to package.json: `"seed:phase2": "tsx prisma/seed-phase2.ts"`
- [ ] Run seed script and verify data in Supabase dashboard
- [ ] Document seed data structure in plan summary

## Verification

**Must Pass:**
1. Run `npx prisma migrate dev` successfully without errors
2. All tables exist in Supabase: alerts, patients, appointments, conversations
3. All enums defined: AlertType, AlertPriority, AlertStatus, AppointmentStatus, ConversationStatus
4. RLS policies applied and verified (Atendente can view, Admin can delete)
5. Seed script runs successfully: `npm run seed:phase2`
6. Supabase dashboard shows 3 patients, 5 appointments, 3 conversations, 8 alerts
7. Relations intact: Alert → Patient/Appointment/Conversation links work

**Quality Checks:**
- Indexes created for performance-critical columns
- Enum values match requirements (alert types, priorities, statuses)
- RLS policies follow principle of least privilege
- Seed data covers edge cases (missing relations, resolved alerts)

## Success Criteria

- [x] Prisma schema updated with Alert, Patient, Appointment, Conversation models
- [x] Database migration applied successfully
- [x] RLS policies created and tested
- [x] Seed data loaded (3 patients, 5 appointments, 3 conversations, 8 alerts)
- [x] All relations working (Alert → Patient → Appointment → Conversation)
- [x] Build passes: `npm run build`

## Output

**Deliverables:**
1. Updated prisma/schema.prisma with new models
2. Migration file: prisma/migrations/{timestamp}_add_alert_system/migration.sql
3. RLS policies SQL: prisma/rls-policies-phase2.sql
4. Seed script: prisma/seed-phase2.ts
5. Documentation of seed data structure

**Next Steps:**
- Wave 2 can start: Plans 02-02 (Alert List UI) and 02-03 (Alert Detail View)
- Database ready for UI development
- Seed data available for testing

**User Actions Required:**
1. Apply RLS policies via Supabase SQL Editor (copy from prisma/rls-policies-phase2.sql)
2. Run seed script: `npm run seed:phase2`
3. Verify data in Supabase dashboard
