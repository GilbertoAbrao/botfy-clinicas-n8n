---
plan_id: 02-03
phase: 2
wave: 2
title: Alert Detail View
status: not_started
dependencies: [02-01]
must_haves:
  truths:
    - Alert detail shows patient contact information
    - Alert detail shows appointment details (date, time, service, status)
    - Alert detail shows conversation thread with AI/human indicators
    - Status update functionality works (new → in-progress → resolved/dismissed)
    - Action buttons present (placeholders for Phase 6 one-click interventions)
    - Mobile-responsive modal or full-page view
  artifacts:
    - src/app/dashboard/alerts/[id]/page.tsx (alert detail page)
    - src/components/alerts/alert-detail.tsx (detail component)
    - src/components/alerts/alert-status-updater.tsx (status update component)
    - src/components/conversations/conversation-thread.tsx (conversation viewer)
  key_links:
    - Alert detail page: src/app/dashboard/alerts/[id]/page.tsx
    - Phase 5 conversation monitoring (full implementation deferred)
---

# Plan 02-03: Alert Detail View

## Objective

Create alert detail view showing full context: patient contact info, appointment details, conversation thread, and status update controls. Enable users to understand alert cause and mark progress.

## Execution Context

**Prerequisites:**
- Plan 02-01 complete (database schema with relations)
- Plan 02-02 in progress or complete (alert list navigation)
- shadcn/ui components available (Card, Badge, Button, Textarea, Select)

**Key Files:**
- src/lib/api/alerts.ts (getAlertById function from Plan 02-02)
- src/app/dashboard/alerts/page.tsx (alert list with navigation)

**External Resources:**
- shadcn/ui Card: https://ui.shadcn.com/docs/components/card
- shadcn/ui Textarea: https://ui.shadcn.com/docs/components/textarea
- shadcn/ui Dialog: https://ui.shadcn.com/docs/components/dialog (for confirmation)

## Context

Alert detail view is where staff understand **why** an alert occurred and **what to do**. Must show:
1. Patient context (name, phone, email - quick contact access)
2. Appointment context (when, what service, current status)
3. Conversation context (what was said, where it broke down)
4. Action controls (status update, intervention buttons)

**Requirements Covered:**
- ALERT-08: Click alert to see detail view
- ALERT-12: Alert detail shows appointment info
- ALERT-13: Alert detail shows patient contact
- ALERT-14: Alert detail shows conversation thread
- ALERT-15: Alert detail shows action buttons (placeholders)
- ALERT-07: Update alert status

**Deferred to Phase 5:**
- Full conversation viewer with pagination
- Message status indicators (sent/delivered/read)
- Real-time message updates

## Tasks

### Task 1: Create conversation thread component
- [ ] Create src/components/conversations/conversation-thread.tsx
- [ ] Build ConversationThread component:
  - Accept props: messages (array from conversation.messages JSON), compact (boolean for alert view)
  - Display messages in chat bubble format (left for patient, right for AI/system)
  - Show sender label: "Paciente", "I.A", "Sistema"
  - Show timestamp for each message (relative time, e.g., "2h atrás")
  - Highlight AI messages with subtle background color
  - Limit to last 10 messages in compact mode (full view in Phase 5)
  - Show "Ver conversa completa" link if messages > 10 (navigate to Phase 5 page)
- [ ] Add message formatting:
  - Wrap long text (word-break)
  - Preserve line breaks in messages
  - Support basic formatting (bold, italic via markdown? - optional)
- [ ] Add empty state: "Nenhuma mensagem disponível" if no messages
- [ ] Mobile-friendly: Touch-scrollable, large text for readability
- [ ] Style with Botfy brand colors (subtle background for AI messages)

### Task 2: Create alert status updater component
- [ ] Create src/components/alerts/alert-status-updater.tsx
- [ ] Build AlertStatusUpdater component:
  - Accept props: currentStatus, alertId, onStatusChange (callback)
  - Show current status as colored badge
  - Show status transition buttons based on current state:
    - If status=new: Show "Iniciar" button (→ in_progress)
    - If status=in_progress: Show "Resolver" and "Descartar" buttons (→ resolved/dismissed)
    - If status=resolved/dismissed: Show status badge only (no actions)
  - On button click:
    - Show confirmation dialog (shadcn/ui Dialog) for resolve/dismiss actions
    - Call updateAlertStatus(alertId, newStatus) API function
    - Show loading state during update
    - On success: Call onStatusChange callback, show success toast
    - On error: Show error message with retry button
  - Add optional note field for resolved/dismissed (why was it resolved? - store in metadata)
- [ ] Add audit logging: Log ALERT_STATUS_UPDATE action with old/new status
- [ ] Style buttons with appropriate colors (green for resolve, gray for dismiss)
- [ ] Mobile-friendly: Large buttons (44px height), full-width on mobile

### Task 3: Create alert detail component
- [ ] Create src/components/alerts/alert-detail.tsx
- [ ] Build AlertDetail component:
  - Accept props: alert (AlertWithRelations), onStatusChange (callback)
  - Layout structure (use shadcn/ui Card for sections):
    1. **Header Section:**
       - Alert title (large, bold)
       - Alert type badge (readable label)
       - Priority badge (urgent/high/low with color)
       - Created timestamp (relative time)
    2. **Status Section:**
       - AlertStatusUpdater component
       - Show resolvedBy user email if resolved/dismissed
       - Show resolvedAt timestamp if resolved/dismissed
    3. **Patient Section** (if patient linked):
       - Patient name (header)
       - Phone number with click-to-call link (tel:+55...)
       - Email with click-to-email link (mailto:...)
       - CPF (if available)
       - "Ver perfil completo" link (Phase 3 - placeholder)
    4. **Appointment Section** (if appointment linked):
       - Service type (header)
       - Scheduled date/time (formatted, e.g., "15 Jan 2026, 14:30")
       - Status badge (confirmed/tentative/no-show/etc)
       - Duration (e.g., "60 minutos")
       - "Ver agendamento completo" link (Phase 4 - placeholder)
    5. **Conversation Section** (if conversation linked):
       - Conversation status badge (IA/HUMANO/FINALIZADO)
       - Last message timestamp
       - ConversationThread component (compact mode, last 10 messages)
       - "Ver conversa completa" link (Phase 5 - placeholder)
    6. **Action Section:**
       - Placeholder buttons for Phase 6 interventions:
         - "Reagendar" button (disabled, tooltip: "Disponível na Fase 6")
         - "Enviar Mensagem" button (disabled)
         - "Limpar Memória" button (disabled)
       - Show tooltip explaining placeholders
  - Handle missing relations gracefully:
    - If no patient: Show "Paciente não vinculado" with icon
    - If no appointment: Hide appointment section
    - If no conversation: Hide conversation section
- [ ] Add copy-to-clipboard for phone/email (icon button)
- [ ] Add loading skeleton while data fetches
- [ ] Mobile-responsive: Stack sections vertically, full-width cards
- [ ] Style with Botfy brand colors

### Task 4: Create alert detail page
- [ ] Create src/app/dashboard/alerts/[id]/page.tsx
- [ ] Implement page logic:
  - Get alert ID from URL params: `params.id`
  - Fetch alert with getAlertById(id) on page load
  - Handle not found: Redirect to /dashboard/alerts with error message
  - Handle loading state: Show full-page skeleton
  - Handle error state: Show error message with "Voltar" button
  - Pass alert to AlertDetail component
  - Implement onStatusChange callback:
    - Refetch alert data after status update
    - Show success toast notification
    - Optionally redirect to alert list after resolve/dismiss (configurable)
- [ ] Add page header:
  - Back button: Navigate to /dashboard/alerts (preserve filters in URL)
  - Page title: Alert type as readable label
  - Breadcrumb: "Alertas / [Alert Type]"
- [ ] Add RBAC check: Require 'view_alerts' permission
- [ ] Add audit logging: Log VIEW_ALERT_DETAIL action on page load
- [ ] Test with seed data: Navigate to alert detail, verify all sections show
- [ ] Test status update: Click "Iniciar", verify status changes to in_progress
- [ ] Test mobile: Verify layout on small screens (375px width)

### Task 5: Connect alert list to detail page
- [ ] Edit src/components/alerts/alert-list.tsx (from Plan 02-02)
- [ ] Update "Ver Detalhes" button to navigate to /dashboard/alerts/[id]
- [ ] Pass alert.id to Link component
- [ ] Add hover effect (cursor pointer, underline)
- [ ] On mobile: Make entire card tappable (not just button)
- [ ] Test navigation: Click alert in list, verify detail page loads

### Task 6: Install missing shadcn/ui components
- [ ] Check if Dialog component installed: `ls src/components/ui/dialog.tsx`
- [ ] Install if missing: `npx shadcn@latest add dialog`
- [ ] Check if Textarea component installed: `ls src/components/ui/textarea.tsx`
- [ ] Install if missing: `npx shadcn@latest add textarea`
- [ ] Verify components build successfully

## Verification

**Must Pass:**
1. Navigate to /dashboard/alerts, click "Ver Detalhes" on any alert - detail page loads
2. Alert detail shows patient name, phone, email (for alerts with patient linked)
3. Alert detail shows appointment date, service, status (for alerts with appointment linked)
4. Alert detail shows last 10 conversation messages (for alerts with conversation linked)
5. Alert detail handles missing relations gracefully (shows "não vinculado" message)
6. Click "Iniciar" button - status updates to in_progress, button changes to "Resolver/Descartar"
7. Click "Resolver" button - confirmation dialog appears
8. Confirm resolve - status updates to resolved, buttons disappear, resolvedAt timestamp shows
9. Mobile responsive: Detail page works on 375px width (sections stack vertically)
10. Back button navigates to /dashboard/alerts with filters preserved
11. Build passes: `npm run build`

**Quality Checks:**
- All sections have clear headers and visual separation (use Cards)
- Click-to-call and click-to-email links work (test on mobile)
- Copy-to-clipboard icons work for phone/email
- Placeholder buttons have tooltips explaining "Disponível na Fase 6"
- Status update provides feedback (loading state, success toast, error message)

## Success Criteria

- [x] Alert detail page created at /dashboard/alerts/[id]
- [x] Patient contact information displayed (name, phone, email)
- [x] Appointment details displayed (date, service, status)
- [x] Conversation thread displayed (last 10 messages with AI/human labels)
- [x] Status update functionality works (new → in-progress → resolved/dismissed)
- [x] Action button placeholders present (disabled, with tooltips)
- [x] Mobile-responsive layout
- [x] Build passes: `npm run build`

## Output

**Deliverables:**
1. Alert detail page: src/app/dashboard/alerts/[id]/page.tsx
2. Alert detail component: src/components/alerts/alert-detail.tsx
3. Status updater component: src/components/alerts/alert-status-updater.tsx
4. Conversation thread component: src/components/conversations/conversation-thread.tsx
5. Updated alert list with navigation to detail page

**Next Steps:**
- Plan 02-04: Add real-time updates to alert list and detail view
- Phase 6: Implement one-click interventions (enable placeholder buttons)

**User Actions Required:**
None - page is ready to use with seed data
