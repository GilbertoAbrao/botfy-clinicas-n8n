---
phase: 21-n8n-integration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/n8n/response-transformers.md
  - docs/n8n/migration-checklist.md
autonomous: true

must_haves:
  truths:
    - "Response transformation templates exist for all 11 tools"
    - "Migration checklist tracks progress for each tool"
    - "Code node templates are copy-paste ready for N8N"
  artifacts:
    - path: "docs/n8n/response-transformers.md"
      provides: "Code node JavaScript templates for response transformation"
      min_lines: 150
    - path: "docs/n8n/migration-checklist.md"
      provides: "Tool-by-tool migration tracking checklist"
      min_lines: 80
  key_links:
    - from: "HTTP Request node output"
      to: "AI Agent tool response"
      via: "Set/Edit Fields or Code node"
      pattern: "response\\.data"
---

<objective>
Create response transformation templates and migration checklist for N8N tool migration.

Purpose: Provide copy-paste ready code for transforming API responses to AI Agent expected format, and track migration progress.
Output: Response transformer templates (docs/n8n/response-transformers.md) and migration checklist (docs/n8n/migration-checklist.md)
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-n8n-integration/21-RESEARCH.md

# API response patterns
@src/lib/agent/error-handler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Response Transformer Templates</name>
  <files>docs/n8n/response-transformers.md</files>
  <action>
Create JavaScript code templates for N8N Code nodes that transform API responses to AI Agent expected format.

The AI Agent tools expect STRING output, but HTTP Request returns JSON. Each tool needs a transformer.

Structure for each tool:
1. **Tool name**
2. **API Response Format** (what the API returns)
3. **Expected AI Agent Format** (what the tool should output)
4. **Code Node JavaScript** (transformation logic)

Templates for all 11 tools:

**buscar_slots_disponiveis:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { date, slots, provider } = response.data;
  if (!slots || slots.length === 0) {
    return [{ json: { response: `Nao ha horarios disponiveis para ${date}${provider ? ` com ${provider}` : ''}.` } }];
  }
  const slotList = slots.slice(0, 8).join(', ');
  return [{ json: { response: `Horarios disponiveis para ${date}${provider ? ` com ${provider}` : ''}: ${slotList}. Qual horario o paciente prefere?` } }];
}
return [{ json: { response: `Erro ao buscar horarios: ${response.error}` } }];
```

**buscar_agendamentos:**
```javascript
const response = $input.first().json;
if (response.success) {
  const appointments = response.data.appointments || [];
  if (appointments.length === 0) {
    return [{ json: { response: 'Nenhum agendamento encontrado para os criterios informados.' } }];
  }
  const formatted = appointments.map(a =>
    `- ${a.date} ${a.time}: ${a.service} com ${a.provider} (${a.status})`
  ).join('\\n');
  return [{ json: { response: `Agendamentos encontrados:\\n${formatted}` } }];
}
return [{ json: { response: `Erro ao buscar agendamentos: ${response.error}` } }];
```

**criar_agendamento:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { id, date, time, service, provider } = response.data;
  return [{ json: { response: `Agendamento criado com sucesso! Consulta de ${service} agendada para ${date} as ${time} com ${provider}. Numero do agendamento: ${id}` } }];
}
if (response.error === 'CONFLICT') {
  return [{ json: { response: `Esse horario ja esta ocupado. Por favor, escolha outro horario.` } }];
}
return [{ json: { response: `Erro ao criar agendamento: ${response.error}` } }];
```

**reagendar_agendamento:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { id, newDate, newTime, service, provider } = response.data;
  return [{ json: { response: `Reagendamento realizado com sucesso! Nova data: ${newDate} as ${newTime} com ${provider}.` } }];
}
return [{ json: { response: `Erro ao reagendar: ${response.error}` } }];
```

**cancelar_agendamento:**
```javascript
const response = $input.first().json;
if (response.success) {
  return [{ json: { response: `Agendamento cancelado com sucesso. O paciente sera informado.` } }];
}
return [{ json: { response: `Erro ao cancelar: ${response.error}` } }];
```

**buscar_paciente:**
```javascript
const response = $input.first().json;
if (response.success) {
  const patient = response.data;
  return [{ json: { response: `Paciente encontrado: ${patient.nome}. Telefone: ${patient.telefone}. ${patient.email ? `Email: ${patient.email}.` : ''} ${patient.cpf ? `CPF: ${patient.cpf}.` : ''}` } }];
}
if (response.error === 'NOT_FOUND') {
  return [{ json: { response: 'Paciente nao encontrado no sistema.' } }];
}
return [{ json: { response: `Erro ao buscar paciente: ${response.error}` } }];
```

**atualizar_dados_paciente:**
```javascript
const response = $input.first().json;
if (response.success) {
  return [{ json: { response: `Dados do paciente atualizados com sucesso!` } }];
}
return [{ json: { response: `Erro ao atualizar dados: ${response.error}` } }];
```

**confirmar_presenca:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { status } = response.data;
  if (status === 'confirmado') {
    return [{ json: { response: 'Presenca confirmada com sucesso! Lembre o paciente de chegar 15 minutos antes.' } }];
  }
  if (status === 'presente') {
    return [{ json: { response: 'Paciente marcado como presente na clinica.' } }];
  }
}
return [{ json: { response: `Erro ao confirmar presenca: ${response.error}` } }];
```

**status_pre_checkin:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { status, documents, pendingItems } = response.data;
  if (status === 'complete') {
    return [{ json: { response: 'Pre-checkin completo! Todos os documentos foram enviados e aprovados.' } }];
  }
  if (status === 'pending') {
    const pending = pendingItems.join(', ');
    return [{ json: { response: `Pre-checkin pendente. Documentos faltando: ${pending}` } }];
  }
  return [{ json: { response: `Status do pre-checkin: ${status}` } }];
}
return [{ json: { response: `Erro ao verificar pre-checkin: ${response.error}` } }];
```

**buscar_instrucoes:**
```javascript
const response = $input.first().json;
if (response.success) {
  const instructions = response.data.instructions || [];
  if (instructions.length === 0) {
    return [{ json: { response: 'Nao ha instrucoes especiais para este procedimento.' } }];
  }
  const formatted = instructions.map(i => `- ${i.tipo}: ${i.texto}`).join('\\n');
  return [{ json: { response: `Instrucoes para o procedimento:\\n${formatted}` } }];
}
return [{ json: { response: `Erro ao buscar instrucoes: ${response.error}` } }];
```

**processar_documento:**
```javascript
const response = $input.first().json;
if (response.success) {
  const { documentType, extractedFields, confidence } = response.data;
  const fields = Object.entries(extractedFields)
    .filter(([k, v]) => v)
    .map(([k, v]) => `${k}: ${v}`)
    .join(', ');
  return [{ json: { response: `Documento ${documentType} processado com sucesso (confianca: ${Math.round(confidence * 100)}%). Dados extraidos: ${fields}` } }];
}
return [{ json: { response: `Erro ao processar documento: ${response.error}` } }];
```

Include:
- Header with usage instructions
- Note about $input.first().json pattern
- Warning about special characters in responses (Portuguese accents)
  </action>
  <verify>
File exists at docs/n8n/response-transformers.md.
Contains code templates for all 11 tools.
Each template handles success and error cases.
  </verify>
  <done>
Complete response transformer templates exist for all 11 AI Agent tools with Portuguese-ready output.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Migration Checklist</name>
  <files>docs/n8n/migration-checklist.md</files>
  <action>
Create detailed migration checklist for tracking tool-by-tool migration progress.

Structure:

# N8N Tool Migration Checklist

## Pre-Migration Verification
- [ ] Next.js app deployed and accessible from N8N
- [ ] API key generated and agent record in database
- [ ] N8N Header Auth credential created ("Botfy Agent API Key")
- [ ] NEXTJS_API_URL environment variable set in N8N
- [ ] Test HTTP Request to /api/agent/test returns 200

## Tool Migration Status

For each tool, track:
1. HTTP Request node created
2. Response transformer node added
3. Rollout routing nodes added (optional for gradual rollout)
4. Tested with manual execution
5. Tested in AI Agent context

### Tool 1: buscar_slots_disponiveis
- [ ] HTTP Request node: GET {{ $env.NEXTJS_API_URL }}/api/agent/slots
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Returns available slots
- [ ] AI Agent test: Tool works in conversation

### Tool 2: buscar_agendamentos
- [ ] HTTP Request node: GET {{ $env.NEXTJS_API_URL }}/api/agent/agendamentos
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Returns appointments
- [ ] AI Agent test: Tool works in conversation

### Tool 3: criar_agendamento
- [ ] HTTP Request node: POST {{ $env.NEXTJS_API_URL }}/api/agent/agendamentos
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Creates appointment
- [ ] AI Agent test: Tool works in conversation

### Tool 4: reagendar_agendamento
- [ ] HTTP Request node: PATCH {{ $env.NEXTJS_API_URL }}/api/agent/agendamentos/{{ $fromAI('id') }}
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Reschedules appointment
- [ ] AI Agent test: Tool works in conversation

### Tool 5: cancelar_agendamento
- [ ] HTTP Request node: DELETE {{ $env.NEXTJS_API_URL }}/api/agent/agendamentos/{{ $fromAI('id') }}
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Cancels appointment
- [ ] AI Agent test: Tool works in conversation

### Tool 6: buscar_paciente
- [ ] HTTP Request node: GET {{ $env.NEXTJS_API_URL }}/api/agent/paciente
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Returns patient data
- [ ] AI Agent test: Tool works in conversation

### Tool 7: atualizar_dados_paciente
- [ ] HTTP Request node: PATCH {{ $env.NEXTJS_API_URL }}/api/agent/paciente/{{ $fromAI('id') }}
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Updates patient
- [ ] AI Agent test: Tool works in conversation

### Tool 8: confirmar_presenca
- [ ] HTTP Request node: POST {{ $env.NEXTJS_API_URL }}/api/agent/agendamentos/{{ $fromAI('id') }}/confirmar
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Confirms attendance
- [ ] AI Agent test: Tool works in conversation

### Tool 9: status_pre_checkin
- [ ] HTTP Request node: GET {{ $env.NEXTJS_API_URL }}/api/agent/pre-checkin/status
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Returns pre-checkin status
- [ ] AI Agent test: Tool works in conversation

### Tool 10: buscar_instrucoes
- [ ] HTTP Request node: GET {{ $env.NEXTJS_API_URL }}/api/agent/instrucoes
- [ ] Credential attached: Botfy Agent API Key
- [ ] Response transformer: Code node added
- [ ] Manual test: Returns instructions
- [ ] AI Agent test: Tool works in conversation

### Tool 11: processar_documento
- [ ] HTTP Request node: POST {{ $env.NEXTJS_API_URL }}/api/agent/documentos/processar
- [ ] Credential attached: Botfy Agent API Key
- [ ] Content-Type: multipart/form-data configured
- [ ] Response transformer: Code node added
- [ ] Manual test: Processes document
- [ ] AI Agent test: Tool works in conversation

## Post-Migration Verification
- [ ] All 11 tools migrated
- [ ] No errors in N8N execution logs for 24 hours
- [ ] AI Agent conversations working normally
- [ ] Sub-workflows ready for archive (do not delete)

## Rollout Progress (if using gradual rollout)
- [ ] 10% rollout enabled (Day 1-2)
- [ ] No errors at 10%
- [ ] 50% rollout enabled (Day 3-4)
- [ ] No errors at 50%
- [ ] 100% rollout enabled (Day 5-7)
- [ ] Stable at 100% for 1 week
- [ ] Sub-workflows archived
  </action>
  <verify>
File exists at docs/n8n/migration-checklist.md.
Contains checkboxes for all 11 tools.
Contains pre-migration and post-migration sections.
  </verify>
  <done>
Complete migration checklist exists with tracking for all 11 tools and rollout phases.
  </done>
</task>

</tasks>

<verification>
1. docs/n8n/response-transformers.md exists with templates for all 11 tools
2. docs/n8n/migration-checklist.md exists with complete tracking structure
3. Templates handle both success and error cases with Portuguese output
</verification>

<success_criteria>
- Response transformer templates are copy-paste ready for N8N Code nodes
- Migration checklist tracks all 11 tools individually
- Documentation enables structured migration progress tracking
</success_criteria>

<output>
After completion, create `.planning/phases/21-n8n-integration/21-02-SUMMARY.md`
</output>
