---
phase: 21-n8n-integration
plan: 03
type: execute
wave: 2
depends_on: ["21-01", "21-02"]
files_modified:
  - docs/n8n/gradual-rollout.md
  - docs/n8n/workflow-structure.md
autonomous: false
user_setup:
  - service: n8n
    why: "N8N workflow modification requires UI access"
    dashboard_config:
      - task: "Add rollout decision nodes to AI Agent workflow"
        location: "N8N -> Workflows -> AI Agent workflow"

must_haves:
  truths:
    - "Gradual rollout documentation explains percentage-based routing"
    - "Workflow structure diagram shows old/new path routing"
    - "Rollout can be adjusted from 0% to 100% by changing single value"
    - "User has implemented at least one tool with rollout routing"
  artifacts:
    - path: "docs/n8n/gradual-rollout.md"
      provides: "Gradual rollout implementation guide with code templates"
      min_lines: 100
    - path: "docs/n8n/workflow-structure.md"
      provides: "Workflow architecture diagram and node structure"
      min_lines: 50
  key_links:
    - from: "Rollout Decision Code node"
      to: "Switch node"
      via: "useNewPath boolean"
      pattern: "Math.random"
---

<objective>
Create gradual rollout implementation guide and workflow structure documentation for safe N8N migration.

Purpose: Enable percentage-based traffic routing between old sub-workflows and new HTTP Request nodes for safe rollout.
Output: Gradual rollout guide (docs/n8n/gradual-rollout.md) and workflow structure documentation (docs/n8n/workflow-structure.md)
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-n8n-integration/21-RESEARCH.md
@.planning/phases/21-n8n-integration/21-01-PLAN.md
@.planning/phases/21-n8n-integration/21-02-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gradual Rollout Implementation Guide</name>
  <files>docs/n8n/gradual-rollout.md</files>
  <action>
Create comprehensive guide for implementing gradual rollout in N8N AI Agent workflow.

Structure:

# Gradual Rollout Implementation Guide

## Overview
Gradual rollout routes a percentage of traffic to new HTTP Request nodes while keeping sub-workflows as fallback. This enables safe migration with instant rollback capability.

## Rollout Phases
| Phase | Percentage | Duration | Monitoring |
|-------|------------|----------|------------|
| Phase 1 | 10% | 2 days | Hourly log check |
| Phase 2 | 50% | 2 days | Daily log check |
| Phase 3 | 100% | 1 week | Normal monitoring |
| Archive | N/A | After 1 week stable | Sub-workflows archived |

## Node Structure

For each AI Agent tool, add these nodes:

```
[AI Agent Tool Input]
        |
        v
[Rollout Decision] (Code node)
        |
        v
[Switch Node] ----------------+
    |                         |
    v (Output 0: new)         v (Output 1: old)
[HTTP Request]          [Execute Workflow]
    |                         |
    v                         |
[Transform Response]          |
    |                         |
    +----------+-------------+
               |
               v
         [Merge Node]
               |
               v
    [Return to AI Agent]
```

## Rollout Decision Code Node

```javascript
// Rollout Decision for [Tool Name]
// Adjust ROLLOUT_PERCENTAGE for each rollout phase:
// Phase 1: 0.10 (10%)
// Phase 2: 0.50 (50%)
// Phase 3: 1.00 (100%)

const ROLLOUT_PERCENTAGE = 0.10;

const random = Math.random();
const useNewPath = random < ROLLOUT_PERCENTAGE;

// Logging for monitoring
console.log(`[ROLLOUT] Tool: [tool-name], Path: ${useNewPath ? 'HTTP_REQUEST' : 'SUB_WORKFLOW'}, Random: ${random.toFixed(3)}, Threshold: ${ROLLOUT_PERCENTAGE}`);

return [{
  json: {
    ...($input.first().json),
    _rollout: {
      useNewPath,
      percentage: ROLLOUT_PERCENTAGE,
      random: random.toFixed(3),
      timestamp: new Date().toISOString()
    }
  }
}];
```

## Switch Node Configuration

```json
{
  "type": "n8n-nodes-base.switch",
  "parameters": {
    "dataType": "boolean",
    "value1": "={{ $json._rollout.useNewPath }}",
    "rules": {
      "rules": [
        {
          "operation": "equal",
          "value2": true,
          "output": 0
        },
        {
          "operation": "equal",
          "value2": false,
          "output": 1
        }
      ]
    }
  }
}
```

## Merge Node Configuration

```json
{
  "type": "n8n-nodes-base.merge",
  "parameters": {
    "mode": "chooseBranch",
    "output": "input1"
  }
}
```
Note: Both paths converge to same output format for AI Agent.

## Implementation Steps

### Step 1: Identify Tool Location
1. Open AI Agent workflow in N8N
2. Find the tool definition (usually in AI Agent node configuration)
3. Locate the Execute Workflow node that calls the sub-workflow

### Step 2: Add Rollout Decision Node
1. Add Code node between AI Agent output and Execute Workflow
2. Paste Rollout Decision code
3. Set ROLLOUT_PERCENTAGE = 0.10 (start at 10%)
4. Update [Tool Name] and [tool-name] placeholders

### Step 3: Add Switch Node
1. Add Switch node after Code node
2. Configure with boolean check on _rollout.useNewPath
3. Output 0 (true): Connect to new HTTP Request path
4. Output 1 (false): Connect to existing Execute Workflow

### Step 4: Create HTTP Request Path
1. Add HTTP Request node (from 21-01 documentation)
2. Add Code node for response transformation (from 21-02 templates)
3. Connect to Merge node

### Step 5: Create Merge Point
1. Add Merge node
2. Connect HTTP Request path to input 1
3. Connect Execute Workflow path to input 2
4. Merge output returns to AI Agent

### Step 6: Test
1. Execute workflow manually with test data
2. Check logs for ROLLOUT entries
3. Verify ~10% of executions use new path
4. Verify both paths produce valid output

## Adjusting Rollout Percentage

To change rollout percentage:
1. Open AI Agent workflow
2. Find Rollout Decision Code nodes (one per tool)
3. Change ROLLOUT_PERCENTAGE value:
   - 0.10 for 10%
   - 0.50 for 50%
   - 1.00 for 100%
   - 0.00 for immediate rollback
4. Save workflow
5. Changes take effect immediately (no restart needed)

## Monitoring During Rollout

### Check N8N Execution Logs
1. Go to N8N -> Executions
2. Filter by AI Agent workflow
3. Check for errors on HTTP Request nodes
4. Compare success rates between old and new paths

### Log Analysis
```
// Good log pattern
[ROLLOUT] Tool: buscar_slots, Path: HTTP_REQUEST, Random: 0.082, Threshold: 0.10
[ROLLOUT] Tool: buscar_slots, Path: SUB_WORKFLOW, Random: 0.534, Threshold: 0.10

// Problem indicators
- Repeated HTTP Request failures
- 401/403 errors (auth issue)
- Timeout errors (API performance)
```

## Instant Rollback

If issues arise:
1. Open AI Agent workflow
2. Change ALL Rollout Decision nodes to ROLLOUT_PERCENTAGE = 0.00
3. Save workflow
4. All traffic immediately routes to sub-workflows
5. Total time: < 30 seconds
  </action>
  <verify>
File exists at docs/n8n/gradual-rollout.md with at least 100 lines.
Contains Code node template with Math.random() routing.
Contains Switch node configuration.
Contains rollback instructions.
  </verify>
  <done>
Complete gradual rollout guide exists with percentage-based routing implementation and instant rollback procedure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Workflow Structure Documentation</name>
  <files>docs/n8n/workflow-structure.md</files>
  <action>
Create workflow architecture documentation showing before/after structure and node relationships.

Structure:

# N8N Workflow Structure

## Current Architecture (Before Migration)

```
┌─────────────────────────────────────────────────────┐
│                   AI Agent Workflow                  │
├─────────────────────────────────────────────────────┤
│                                                      │
│   WhatsApp Webhook                                   │
│         │                                            │
│         v                                            │
│   ┌───────────┐                                      │
│   │ AI Agent  │──► Tool: buscar_slots ──► Execute Workflow ──► Sub-workflow 8Bke6sYr...
│   │           │──► Tool: criar_agendamento ──► Execute Workflow ──► Sub-workflow eEx2enJk...
│   │           │──► Tool: buscar_paciente ──► Execute Workflow ──► Sub-workflow igG6sZsS...
│   │           │──► ... (11 tools total)                │
│   └───────────┘                                      │
│         │                                            │
│         v                                            │
│   WhatsApp Send                                      │
│                                                      │
└─────────────────────────────────────────────────────┘

External Sub-workflows (11 total):
- 8Bke6sYr7r51aeEq: buscar_slots_disponiveis
- 8Ug0F3KuLov6EeCQ: buscar_agendamentos
- eEx2enJk3YpreNUm: criar_agendamento
- 21EHe24mkMmfBhK6: reagendar_agendamento
- gE2rpbLVUlnA5yMk: cancelar_agendamento
- igG6sZsStxiDzNRY: buscar_paciente
- 4DNyXp5fPPfsFOnR: atualizar_dados_paciente
- holwGQuksZPsSb19: status_pre_checkin
- NUZv1Gt15LKyiiKz: buscar_instrucoes
- Pc0PyATrZaGefiSJ: processar_documento
- (confirmar_presenca inline in main workflow)
```

## Target Architecture (After Migration)

```
┌─────────────────────────────────────────────────────┐
│                   AI Agent Workflow                  │
├─────────────────────────────────────────────────────┤
│                                                      │
│   WhatsApp Webhook                                   │
│         │                                            │
│         v                                            │
│   ┌───────────┐                                      │
│   │ AI Agent  │──► Tool: buscar_slots ──► HTTP Request ──► /api/agent/slots
│   │           │──► Tool: criar_agendamento ──► HTTP Request ──► /api/agent/agendamentos
│   │           │──► Tool: buscar_paciente ──► HTTP Request ──► /api/agent/paciente
│   │           │──► ... (11 tools total)                │
│   └───────────┘                                      │
│         │                                            │
│         v                                            │
│   WhatsApp Send                                      │
│                                                      │
└─────────────────────────────────────────────────────┘

External Dependency:
- Next.js APIs at NEXTJS_API_URL
- Single Header Auth credential for all tools
```

## Transition Architecture (During Rollout)

```
┌─────────────────────────────────────────────────────────────────┐
│                       AI Agent Workflow                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   Tool: buscar_slots                                             │
│         │                                                        │
│         v                                                        │
│   ┌──────────────────┐                                           │
│   │ Rollout Decision │  (ROLLOUT_PERCENTAGE = 0.50)              │
│   │   Code Node      │                                           │
│   └────────┬─────────┘                                           │
│            │                                                     │
│            v                                                     │
│   ┌─────────────────┐                                            │
│   │   Switch Node   │                                            │
│   │ useNewPath?     │                                            │
│   └────────┬────────┘                                            │
│       ┌────┴────┐                                                │
│       │         │                                                │
│   (50%)     (50%)                                                │
│       v         v                                                │
│ ┌──────────┐ ┌────────────────┐                                  │
│ │  HTTP    │ │ Execute        │                                  │
│ │ Request  │ │ Workflow       │                                  │
│ └────┬─────┘ └───────┬────────┘                                  │
│      v               │                                           │
│ ┌──────────┐         │                                           │
│ │Transform │         │                                           │
│ │ Response │         │                                           │
│ └────┬─────┘         │                                           │
│      │               │                                           │
│      └───────┬───────┘                                           │
│              v                                                   │
│       ┌────────────┐                                             │
│       │   Merge    │                                             │
│       │    Node    │                                             │
│       └─────┬──────┘                                             │
│             │                                                    │
│             v                                                    │
│       Return to AI Agent                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

## Node Count Comparison

| Architecture | Nodes per Tool | Total for 11 Tools |
|--------------|----------------|-------------------|
| Current (sub-workflow) | 1 | 11 |
| Target (HTTP Request) | 2-3 | 22-33 |
| Transition (rollout) | 5-6 | 55-66 |

Note: Transition architecture adds overhead but enables safe rollback.

## Credential Flow

```
┌─────────────────────────────────────────────────────┐
│                 Credential: Botfy Agent API Key      │
│                 Type: Header Auth                    │
│                 Header: Authorization               │
│                 Value: Bearer bfk_xxx...            │
├─────────────────────────────────────────────────────┤
│                       │                              │
│        Used by all HTTP Request nodes                │
│                       │                              │
│  ┌────────────────┬───┴───┬────────────────┐        │
│  v                v       v                v        │
│  /api/agent/   /api/agent/ /api/agent/   ...        │
│  slots         agendamentos paciente                │
└─────────────────────────────────────────────────────┘
```
  </action>
  <verify>
File exists at docs/n8n/workflow-structure.md with at least 50 lines.
Contains before/after architecture diagrams.
Contains transition architecture with rollout nodes.
  </verify>
  <done>
Complete workflow structure documentation exists with architecture diagrams for current, target, and transition states.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Implement First Tool with Rollout</name>
  <action>User implements gradual rollout for first tool (buscar_slots_disponiveis)</action>
  <instructions>
Implement gradual rollout for the first tool to validate the pattern.

**Tool:** buscar_slots_disponiveis (simplest GET endpoint)

1. Open AI Agent workflow in N8N

2. Find the buscar_slots_disponiveis tool definition

3. Add Rollout Decision Code node:
   - Add Code node after AI Agent tool output
   - Paste code from docs/n8n/gradual-rollout.md
   - Set ROLLOUT_PERCENTAGE = 0.10
   - Update tool name in log message

4. Add Switch node:
   - Connect from Code node
   - Configure boolean check on _rollout.useNewPath
   - Output 0: new path (HTTP Request)
   - Output 1: old path (Execute Workflow)

5. Create HTTP Request node (Output 0):
   - Method: GET
   - URL: {{ $env.NEXTJS_API_URL }}/api/agent/slots
   - Add query parameters (from docs/n8n/api-endpoints.md)
   - Attach "Botfy Agent API Key" credential

6. Add Response Transform Code node:
   - Connect from HTTP Request
   - Paste buscar_slots transformer from docs/n8n/response-transformers.md

7. Connect existing Execute Workflow to Output 1

8. Add Merge node:
   - Connect HTTP path to input 1
   - Connect Execute Workflow path to input 2
   - Output returns to AI Agent

9. Test:
   - Execute workflow manually 10 times
   - Check logs - should see ~1 HTTP_REQUEST, ~9 SUB_WORKFLOW
   - Verify both paths produce valid responses

10. When working, type "first tool implemented" to continue

**Troubleshooting:**
- 401 error: Check credential is attached to HTTP Request
- Timeout: Verify NEXTJS_API_URL is correct
- Invalid output: Check Response Transform code node
  </instructions>
  <resume-signal>Type "first tool implemented" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. docs/n8n/gradual-rollout.md exists with rollout implementation guide
2. docs/n8n/workflow-structure.md exists with architecture diagrams
3. First tool (buscar_slots_disponiveis) working with 10% rollout (confirmed by user)
</verification>

<success_criteria>
- Gradual rollout pattern documented with copy-paste ready templates
- Workflow architecture clearly documented for current, target, and transition states
- At least one tool is working with percentage-based rollout routing
- N8N-03 requirement addressed (gradual rollout mechanism)
</success_criteria>

<output>
After completion, create `.planning/phases/21-n8n-integration/21-03-SUMMARY.md`
</output>
