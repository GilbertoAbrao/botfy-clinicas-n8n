---
phase: 21-n8n-integration
plan: 04
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - docs/n8n/rollback-runbook.md
  - docs/n8n/archive-procedure.md
  - workflows-backup/README.md
autonomous: true

must_haves:
  truths:
    - "Rollback can be performed in under 5 minutes"
    - "Sub-workflow archive procedure is documented"
    - "Backup directory structure is documented"
    - "Rollback has been tested on paper (dry run documented)"
  artifacts:
    - path: "docs/n8n/rollback-runbook.md"
      provides: "Step-by-step rollback procedure with time estimates"
      min_lines: 60
    - path: "docs/n8n/archive-procedure.md"
      provides: "Sub-workflow archive procedure after stable rollout"
      min_lines: 40
    - path: "workflows-backup/README.md"
      provides: "Backup directory documentation"
      min_lines: 30
  key_links:
    - from: "ROLLOUT_PERCENTAGE = 0.00"
      to: "All traffic to sub-workflows"
      via: "Code node change + save"
      pattern: "ROLLOUT_PERCENTAGE"
---

<objective>
Create rollback runbook, archive procedure, and backup documentation for N8N migration safety.

Purpose: Enable instant rollback during migration issues and safe archival of sub-workflows after successful migration.
Output: Rollback runbook (docs/n8n/rollback-runbook.md), archive procedure (docs/n8n/archive-procedure.md), and backup README (workflows-backup/README.md)
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-n8n-integration/21-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rollback Runbook</name>
  <files>docs/n8n/rollback-runbook.md</files>
  <action>
Create step-by-step rollback runbook for reverting to sub-workflows during migration issues.

Structure:

# N8N Migration Rollback Runbook

## When to Rollback

Trigger rollback if ANY of these occur:
- [ ] Repeated HTTP Request failures (>5 in 1 hour)
- [ ] 401/403 authentication errors
- [ ] Patients reporting bot not responding correctly
- [ ] Timeout errors (API not responding)
- [ ] Unexpected AI Agent behavior changes

## Rollback Time Objective

**Target: Under 5 minutes**

| Step | Action | Time |
|------|--------|------|
| 1 | Open N8N workflow | 30 sec |
| 2 | Find Code nodes | 30 sec |
| 3 | Change percentages | 1 min |
| 4 | Save workflow | 30 sec |
| 5 | Verify rollback | 2 min |
| **Total** | | **< 5 min** |

## Rollback Procedure

### Step 1: Access N8N Workflow
1. Open N8N web interface
2. Go to Workflows
3. Find "AI Agent" workflow (or main workflow name)
4. Click to open editor

### Step 2: Locate Rollout Decision Nodes
1. Search for "Rollout Decision" Code nodes
2. There should be one per migrated tool
3. List of tool names:
   - buscar_slots_disponiveis
   - buscar_agendamentos
   - criar_agendamento
   - reagendar_agendamento
   - cancelar_agendamento
   - buscar_paciente
   - atualizar_dados_paciente
   - confirmar_presenca
   - status_pre_checkin
   - buscar_instrucoes
   - processar_documento

### Step 3: Change Rollout Percentage to Zero
For EACH Rollout Decision Code node:
1. Double-click to open
2. Find line: `const ROLLOUT_PERCENTAGE = 0.XX;`
3. Change to: `const ROLLOUT_PERCENTAGE = 0.00;`
4. Close node

**Quick Find-Replace:**
- Search: `ROLLOUT_PERCENTAGE = 0.` (note the trailing dot)
- Replace value after `=` with `0.00`

### Step 4: Save Workflow
1. Click Save button (or Ctrl+S)
2. Confirm save
3. Wait for confirmation message

### Step 5: Verify Rollback
1. Send test message via WhatsApp to bot
2. Check N8N execution log
3. Verify logs show "SUB_WORKFLOW" path, not "HTTP_REQUEST"
4. Confirm bot responds correctly

**Verification Command (in N8N execution log):**
```
[ROLLOUT] Tool: [any], Path: SUB_WORKFLOW
```
All executions should show SUB_WORKFLOW after rollback.

## Post-Rollback Actions

### Immediate (within 1 hour)
- [ ] Document incident: What triggered rollback?
- [ ] Check API logs: Any errors in Next.js logs?
- [ ] Check N8N logs: What errors before rollback?

### Investigation (within 24 hours)
- [ ] Root cause analysis
- [ ] Fix identified issues
- [ ] Test fix in development
- [ ] Plan re-rollout

### Re-Rollout (when ready)
1. Fix root cause
2. Test in development
3. Start at 10% rollout again
4. Monitor closely

## Rollback Verification Checklist

After completing rollback:
- [ ] All Code nodes show ROLLOUT_PERCENTAGE = 0.00
- [ ] Workflow is saved
- [ ] Test message shows SUB_WORKFLOW in logs
- [ ] Bot responds correctly to test messages
- [ ] Incident documented

## Rollback Without Gradual Rollout

If migrated directly (no rollout routing):
1. In each tool, find HTTP Request node
2. Delete HTTP Request node
3. Reconnect to original Execute Workflow node
4. Save workflow
5. Test

**This takes longer (15-30 minutes)** which is why gradual rollout is recommended.

## Emergency Contacts

| Role | Contact | When |
|------|---------|------|
| Dev | [your contact] | Any migration issues |
| N8N Admin | [contact] | Workflow access issues |
| API Admin | [contact] | API/credential issues |

## Revision History

| Version | Date | Change |
|---------|------|--------|
| 1.0 | 2026-01-24 | Initial runbook |
  </action>
  <verify>
File exists at docs/n8n/rollback-runbook.md with at least 60 lines.
Contains step-by-step procedure.
Contains time estimates totaling under 5 minutes.
Contains verification checklist.
  </verify>
  <done>
Complete rollback runbook exists with step-by-step procedure achievable in under 5 minutes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Archive Procedure</name>
  <files>docs/n8n/archive-procedure.md</files>
  <action>
Create sub-workflow archive procedure for after successful migration.

Structure:

# Sub-Workflow Archive Procedure

## Prerequisites

Archive only when:
- [ ] All 11 tools migrated to HTTP Request
- [ ] 100% rollout active for 1+ week
- [ ] Zero errors in production for 1 week
- [ ] Rollback tested and documented

**DO NOT archive prematurely.** Keep sub-workflows available until migration is proven stable.

## Archive vs Delete

| Action | When | Reversibility |
|--------|------|---------------|
| Archive | After 1 week stable | Easy restore |
| Delete | Never during v2.0 | Permanent |

**NEVER delete sub-workflows during migration phase.** Archive only.

## Archive Procedure

### Step 1: Create Deprecated Folder
1. In N8N Workflows list
2. Create folder: "Deprecated - Do Not Use"
3. Or use existing "Archive" folder

### Step 2: Move Sub-Workflows
For each sub-workflow:
1. Open sub-workflow
2. Add "[ARCHIVED]" prefix to name
   - Example: "[ARCHIVED] buscar_slots_disponiveis"
3. Deactivate workflow (toggle off if active)
4. Move to "Deprecated - Do Not Use" folder

### Step 3: Document Archive
Add comment to each archived workflow:
```
ARCHIVED: 2026-XX-XX
REASON: Migrated to HTTP Request in AI Agent workflow
REPLACED BY: /api/agent/[endpoint]
ROLLBACK: See docs/n8n/rollback-runbook.md
```

### Step 4: Verify Main Workflow
1. Open AI Agent workflow
2. Confirm no Execute Workflow nodes reference archived workflows
3. All tools use HTTP Request nodes only

## Sub-Workflow Inventory

| Sub-workflow ID | Name | Status | Archived Date |
|-----------------|------|--------|---------------|
| 8Bke6sYr7r51aeEq | buscar_slots_disponiveis | [ ] Archived | |
| 8Ug0F3KuLov6EeCQ | buscar_agendamentos | [ ] Archived | |
| eEx2enJk3YpreNUm | criar_agendamento | [ ] Archived | |
| 21EHe24mkMmfBhK6 | reagendar_agendamento | [ ] Archived | |
| gE2rpbLVUlnA5yMk | cancelar_agendamento | [ ] Archived | |
| igG6sZsStxiDzNRY | buscar_paciente | [ ] Archived | |
| 4DNyXp5fPPfsFOnR | atualizar_dados_paciente | [ ] Archived | |
| holwGQuksZPsSb19 | status_pre_checkin | [ ] Archived | |
| NUZv1Gt15LKyiiKz | buscar_instrucoes | [ ] Archived | |
| Pc0PyATrZaGefiSJ | processar_documento | [ ] Archived | |
| (inline) | confirmar_presenca | N/A | N/A |

## Restore from Archive

If issues found after archive:
1. Find workflow in "Deprecated - Do Not Use" folder
2. Remove "[ARCHIVED]" prefix from name
3. Reactivate workflow
4. In AI Agent workflow, reconnect Execute Workflow node
5. Follow rollback runbook

## Post-Archive Verification

- [ ] All sub-workflows moved to Deprecated folder
- [ ] All sub-workflows renamed with [ARCHIVED] prefix
- [ ] All sub-workflows deactivated
- [ ] Main workflow has no Execute Workflow references
- [ ] Bot continues working normally for 24 hours
  </action>
  <verify>
File exists at docs/n8n/archive-procedure.md with at least 40 lines.
Contains inventory table with all 11 sub-workflows.
Contains DO NOT DELETE warning.
Contains restore procedure.
  </verify>
  <done>
Complete archive procedure exists with sub-workflow inventory and restore instructions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Backup Directory Documentation</name>
  <files>workflows-backup/README.md</files>
  <action>
Create README for the workflows-backup directory explaining its purpose and contents.

Structure:

# N8N Workflows Backup

## Purpose

This directory contains JSON exports of N8N sub-workflows before migration to HTTP Request nodes (Phase 21).

**These files are the last resort recovery option** if both:
1. Rollback via rollout percentage fails
2. N8N archived workflows are corrupted/lost

## Contents

| File | Sub-workflow ID | Tool Name |
|------|-----------------|-----------|
| buscar-slots.json | 8Bke6sYr7r51aeEq | buscar_slots_disponiveis |
| buscar-agendamentos.json | 8Ug0F3KuLov6EeCQ | buscar_agendamentos |
| criar-agendamento.json | eEx2enJk3YpreNUm | criar_agendamento |
| reagendar-agendamento.json | 21EHe24mkMmfBhK6 | reagendar_agendamento |
| cancelar-agendamento.json | gE2rpbLVUlnA5yMk | cancelar_agendamento |
| buscar-paciente.json | igG6sZsStxiDzNRY | buscar_paciente |
| atualizar-paciente.json | 4DNyXp5fPPfsFOnR | atualizar_dados_paciente |
| status-precheckin.json | holwGQuksZPsSb19 | status_pre_checkin |
| buscar-instrucoes.json | NUZv1Gt15LKyiiKz | buscar_instrucoes |
| processar-documento.json | Pc0PyATrZaGefiSJ | processar_documento |

## How to Export (Before Migration)

Before starting migration, export each sub-workflow:

1. Open sub-workflow in N8N
2. Click menu (three dots) -> Download
3. Save JSON to this directory with name from table above

## How to Restore

If catastrophic failure requires restore:

1. In N8N, go to Workflows
2. Click Import from File
3. Select the JSON file from this directory
4. Rename if needed to remove "(copy)" suffix
5. Update AI Agent workflow to use restored sub-workflow

## Important Notes

- **Do not modify these files** - they are backups
- **Do not delete** - keep indefinitely
- **Update exports** if sub-workflows change before migration
- **Git versioned** - history available via git

## Backup Date

Backup exported: 2026-XX-XX (update when backups are taken)
Exported by: [name]

## Related Documentation

- [Rollback Runbook](../docs/n8n/rollback-runbook.md)
- [Archive Procedure](../docs/n8n/archive-procedure.md)
- [Migration Checklist](../docs/n8n/migration-checklist.md)
  </action>
  <verify>
File exists at workflows-backup/README.md with at least 30 lines.
Contains file inventory table.
Contains restore procedure.
Contains export instructions.
  </verify>
  <done>
Complete backup directory documentation exists with inventory, export, and restore instructions.
  </done>
</task>

</tasks>

<verification>
1. docs/n8n/rollback-runbook.md exists with <5 minute procedure
2. docs/n8n/archive-procedure.md exists with inventory and restore steps
3. workflows-backup/README.md exists with backup documentation
</verification>

<success_criteria>
- Rollback procedure achievable in under 5 minutes
- Archive procedure clearly documents DO NOT DELETE policy
- Backup directory documentation enables export/restore
- N8N-04 and N8N-05 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/21-n8n-integration/21-04-SUMMARY.md`
</output>
