---
phase: 21-n8n-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/n8n/credential-setup.md
  - docs/n8n/api-endpoints.md
autonomous: false
user_setup:
  - service: n8n
    why: "N8N credential creation requires UI access"
    dashboard_config:
      - task: "Create Header Auth credential with API key"
        location: "N8N -> Credentials -> Add Credential -> Header Auth"

must_haves:
  truths:
    - "N8N credential is created with correct Header Auth format"
    - "API key is stored encrypted in N8N credential system"
    - "Documentation exists for credential setup steps"
    - "API endpoint reference exists for all 11 tools"
  artifacts:
    - path: "docs/n8n/credential-setup.md"
      provides: "Step-by-step credential setup guide"
      min_lines: 50
    - path: "docs/n8n/api-endpoints.md"
      provides: "API endpoint reference for N8N HTTP Request configuration"
      min_lines: 100
  key_links:
    - from: "N8N Header Auth credential"
      to: "agents table bcrypt hash"
      via: "Bearer token validation"
      pattern: "Authorization: Bearer"
---

<objective>
Create N8N credential setup documentation and API endpoint reference for HTTP Request node configuration.

Purpose: Enable N8N to authenticate to Next.js Agent APIs using Header Auth credential with Bearer token.
Output: Credential setup guide (docs/n8n/credential-setup.md) and API endpoint reference (docs/n8n/api-endpoints.md)
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-n8n-integration/21-RESEARCH.md
@.planning/phases/17-agent-api-foundation/17-04-SUMMARY.md

# API route patterns
@src/lib/agent/auth.ts
@src/lib/agent/middleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API Endpoints Reference Document</name>
  <files>docs/n8n/api-endpoints.md</files>
  <action>
Create comprehensive API endpoint reference document for N8N HTTP Request node configuration.

Include for each of the 11 tools:
1. **Tool name** (N8N tool name, e.g., buscar_slots_disponiveis)
2. **HTTP Method** (GET, POST, PATCH, DELETE)
3. **Endpoint URL** (e.g., /api/agent/slots)
4. **Query Parameters** (for GET endpoints) with $fromAI expressions
5. **Body Parameters** (for POST/PATCH endpoints) with $fromAI expressions
6. **Expected Response** (success and error formats)
7. **N8N Configuration Snippet** (JSON for node parameters)

Tools to document:
| Tool | Method | Endpoint |
|------|--------|----------|
| buscar_slots_disponiveis | GET | /api/agent/slots |
| buscar_agendamentos | GET | /api/agent/agendamentos |
| criar_agendamento | POST | /api/agent/agendamentos |
| reagendar_agendamento | PATCH | /api/agent/agendamentos/:id |
| cancelar_agendamento | DELETE | /api/agent/agendamentos/:id |
| buscar_paciente | GET | /api/agent/paciente |
| atualizar_dados_paciente | PATCH | /api/agent/paciente/:id |
| confirmar_presenca | POST | /api/agent/agendamentos/:id/confirmar |
| status_pre_checkin | GET | /api/agent/pre-checkin/status |
| buscar_instrucoes | GET | /api/agent/instrucoes |
| processar_documento | POST | /api/agent/documentos/processar |

Use the format from 21-RESEARCH.md for HTTP Request node JSON examples.
Include environment variable pattern: `={{ $env.NEXTJS_API_URL }}/api/agent/...`
  </action>
  <verify>
File exists at docs/n8n/api-endpoints.md with at least 100 lines.
All 11 tools documented with method, endpoint, parameters.
  </verify>
  <done>
Complete API reference exists for all 11 N8N tools with HTTP Request node configuration examples.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Credential Setup Guide</name>
  <files>docs/n8n/credential-setup.md</files>
  <action>
Create step-by-step credential setup guide for N8N.

Structure:
1. **Prerequisites**
   - Agent API key generated using scripts/generate-agent-key.ts
   - Agent record inserted in database with bcrypt hash
   - Next.js app running and accessible from N8N

2. **Create N8N Environment Variable**
   - N8N Settings -> Environment Variables
   - Add NEXTJS_API_URL = https://your-domain.com (or http://localhost:3051 for dev)

3. **Create Header Auth Credential**
   - N8N -> Credentials -> Add Credential
   - Type: Header Auth
   - Name: "Botfy Agent API Key"
   - Header Name: `Authorization`
   - Header Value: `Bearer <api-key-from-script>`
   - Note: Use Header Auth (NOT Bearer Auth) due to known N8N issues

4. **Test Credential**
   - Create test HTTP Request node
   - GET {{ $env.NEXTJS_API_URL }}/api/agent/test
   - Select "Botfy Agent API Key" credential
   - Execute node, expect 200 response

5. **Troubleshooting**
   - 401 errors: Check credential name matches exactly
   - Connection refused: Check NEXTJS_API_URL is correct
   - Timeout: Increase timeout in HTTP Request options

Include screenshots placeholder paths for each step.
Reference 17-04-SUMMARY.md for API key generation instructions.
  </action>
  <verify>
File exists at docs/n8n/credential-setup.md with at least 50 lines.
Contains Header Auth credential setup steps.
Contains troubleshooting section.
  </verify>
  <done>
Complete credential setup guide exists with step-by-step instructions for N8N configuration.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 3: Create N8N Credential</name>
  <action>User creates Header Auth credential in N8N UI</action>
  <instructions>
1. Generate API key (if not already done):
   ```bash
   cd /Users/gilberto/projetos/botfy/botfy-clinicas-n8n
   npx ts-node scripts/generate-agent-key.ts
   ```
   Save the API key output securely.

2. Insert agent record in database (if not already done):
   - Copy the SQL from script output
   - Execute in Supabase SQL Editor
   - Map to existing user (ADMIN or ATENDENTE)

3. Open N8N web interface

4. Go to Settings -> Environment Variables:
   - Add: NEXTJS_API_URL = (your Next.js app URL)

5. Go to Credentials -> Add Credential:
   - Type: Header Auth
   - Name: "Botfy Agent API Key"
   - Header Name: Authorization
   - Header Value: Bearer <paste-api-key>
   - Save

6. Test (optional):
   - Create test workflow with HTTP Request node
   - GET {{ $env.NEXTJS_API_URL }}/api/agent/test
   - Attach credential
   - Execute and verify 200 response

7. When complete, type "credential created" to continue
  </instructions>
  <resume-signal>Type "credential created" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. docs/n8n/api-endpoints.md exists with all 11 tools documented
2. docs/n8n/credential-setup.md exists with setup instructions
3. N8N credential is created and tested (confirmed by user)
</verification>

<success_criteria>
- API endpoint reference covers all 11 tools with HTTP Request configuration
- Credential setup guide provides step-by-step instructions
- N8N has working Header Auth credential for API access
- N8N-01 and N8N-02 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/21-n8n-integration/21-01-SUMMARY.md`
</output>
