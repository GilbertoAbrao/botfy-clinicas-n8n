---
phase: 05-conversation-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/conversations/conversation-thread.tsx
  - src/components/conversations/message-bubble.tsx
autonomous: true

must_haves:
  truths:
    - "User can see WhatsApp-style message bubbles (green for patient, white for clinic)"
    - "User can see message delivery status indicators (✓ sent, ✓✓ delivered, blue ✓✓ read)"
    - "User can distinguish AI messages from human messages with visible badges"
    - "User can see timestamp on each message"
    - "Messages scroll to most recent first"
  artifacts:
    - path: "src/components/conversations/message-bubble.tsx"
      provides: "WhatsApp-style message bubble component"
      min_lines: 50
    - path: "src/components/conversations/conversation-thread.tsx"
      provides: "Enhanced conversation display with new styling"
  key_links:
    - from: "conversation-thread.tsx"
      to: "message-bubble.tsx"
      via: "import and render for each message"
      pattern: "MessageBubble"
---

<objective>
Create WhatsApp-style conversation viewer with message status indicators and AI/Human badges.

Purpose: Transform the basic conversation display into a familiar WhatsApp-style interface that clinic staff already know. Clear visual distinction between AI and human messages helps quickly identify what was said and by whom.

Output: Enhanced ConversationThread component with WhatsApp-style message bubbles, delivery status indicators, and sender badges.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-conversation-monitoring/05-CONTEXT.md

@src/components/conversations/conversation-thread.tsx
@src/lib/api/conversations.ts
@src/components/ui/badge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WhatsApp-style MessageBubble component</name>
  <files>src/components/conversations/message-bubble.tsx</files>
  <action>
Create a new MessageBubble component with WhatsApp-style visual design:

1. **Layout:**
   - Patient messages: aligned LEFT, green background (bg-green-100 dark:bg-green-900/30)
   - Clinic/AI messages: aligned RIGHT, white/gray background (bg-white dark:bg-gray-800)
   - Max-width 80% of container
   - Rounded corners (rounded-lg) with tail on sender side

2. **Content:**
   - Message text with proper line breaks (whitespace-pre-wrap)
   - Timestamp at bottom-right corner (text-xs text-gray-500)
   - Format timestamp in ptBR: "14:30" or "Ontem 14:30"

3. **Sender Badge:**
   - For AI messages: Small purple badge with robot icon "IA"
   - For Human messages: Small blue badge with user icon "Humano"
   - Badge positioned at top-left of bubble

4. **Delivery Status (for clinic messages only):**
   - SENT: Single gray checkmark (✓)
   - DELIVERED: Double gray checkmarks (✓✓)
   - READ: Double blue checkmarks (✓✓)
   - FAILED: Red X icon
   - Status icon at bottom-right, next to timestamp

5. **Props interface:**
```typescript
interface MessageBubbleProps {
  content: string
  sender: 'patient' | 'ai' | 'human' | 'system'
  timestamp: Date | string
  status?: 'sent' | 'delivered' | 'read' | 'failed'
  isCompact?: boolean
}
```

Use Lucide icons for checkmarks (Check, CheckCheck) and status indicators.
Use Tailwind for all styling - no external CSS.
  </action>
  <verify>TypeScript compiles without errors: npx tsc --noEmit</verify>
  <done>MessageBubble component renders WhatsApp-style bubbles with sender badges and delivery status</done>
</task>

<task type="auto">
  <name>Task 2: Enhance ConversationThread to use MessageBubble</name>
  <files>src/components/conversations/conversation-thread.tsx</files>
  <action>
Update the existing ConversationThread component:

1. **Replace existing message rendering** with new MessageBubble component
2. **Map message types:**
   - `type: 'human'` from n8n → sender: 'patient' (the patient is the human sending messages)
   - `type: 'ai'` from n8n → sender: 'ai'
   - `type: 'system'` → sender: 'system' (use subtle gray styling)

3. **Add scroll-to-bottom behavior:**
   - Use useRef and useEffect to scroll to newest message on load
   - Add `scrollBehavior: 'smooth'` for real-time updates

4. **Enhance message ordering:**
   - Messages should be sorted by timestamp ascending (oldest first, newest at bottom)
   - Scroll starts at bottom (most recent visible)

5. **Keep compact mode:**
   - In compact mode, show only last 5 messages with "Ver mais..." link
   - Pass isCompact to MessageBubble for smaller text/spacing

6. **Handle message metadata:**
   - Extract delivery status from `additional_kwargs` if available
   - Default to 'delivered' if no status info

Do NOT change the props interface of ConversationThread - maintain backward compatibility with existing usages in AlertDetail and ConversationHistory.
  </action>
  <verify>
Run dev server and check existing conversation displays in:
- /conversas page
- Alert detail view
- Patient profile conversation history
All should render with new WhatsApp styling.
  </verify>
  <done>ConversationThread renders messages with WhatsApp-style bubbles, proper sender identification, and scroll-to-bottom behavior</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Existing conversation displays still work (backward compatible)
- [ ] Messages show correct sender alignment (patient left, clinic right)
- [ ] AI messages have purple "IA" badge
- [ ] Human messages have blue "Humano" badge
- [ ] Timestamps visible on each message
- [ ] Scroll position starts at bottom (most recent messages visible)
</verification>

<success_criteria>
- All tasks completed
- WhatsApp-style visual design implemented
- Sender badges clearly distinguish AI vs Human
- Existing usages of ConversationThread continue to work
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-conversation-monitoring/05-01-SUMMARY.md`
</output>
