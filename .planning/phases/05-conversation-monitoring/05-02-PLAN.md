---
phase: 05-conversation-monitoring
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/conversations/[sessionId]/memory/route.ts
  - src/lib/api/conversations.ts
  - src/components/conversations/clear-memory-button.tsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Limpar Memória' button on a conversation"
    - "Confirmation dialog appears before clearing"
    - "After confirming, all chat history for that session is deleted"
    - "AI context is reset (n8n_chat_histories cleared for session)"
    - "Action is logged for audit compliance"
  artifacts:
    - path: "src/app/api/conversations/[sessionId]/memory/route.ts"
      provides: "DELETE endpoint for clearing chat memory"
      exports: ["DELETE"]
    - path: "src/components/conversations/clear-memory-button.tsx"
      provides: "Button with confirmation dialog"
      min_lines: 40
  key_links:
    - from: "clear-memory-button.tsx"
      to: "/api/conversations/[sessionId]/memory"
      via: "fetch DELETE request"
      pattern: "fetch.*api/conversations"
    - from: "route.ts DELETE"
      to: "prisma.n8nChatHistory"
      via: "deleteMany where session_id"
      pattern: "deleteMany"
---

<objective>
Implement "Clear Memory" functionality to reset AI context when it enters a loop.

Purpose: When the AI gets confused or enters a repetitive loop, clinic staff need a quick way to reset the conversation context. This deletes the chat history from n8n_chat_histories, forcing the AI to start fresh.

Output: API endpoint for clearing memory + UI button with confirmation dialog.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-conversation-monitoring/05-CONTEXT.md

@prisma/schema.prisma
@src/lib/audit/logger.ts
@src/lib/auth/session.ts
@src/components/ui/alert-dialog.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Clear Memory API endpoint</name>
  <files>src/app/api/conversations/[sessionId]/memory/route.ts</files>
  <action>
Create a new API route to clear chat memory for a conversation session:

1. **DELETE /api/conversations/[sessionId]/memory**
   - Extract sessionId from route params
   - Decode sessionId (it may be URL encoded due to @ and . characters)

2. **Authentication:**
   - Use getCurrentUserWithRole()
   - Require ADMIN or ATENDENTE role
   - Return 401 if not authenticated

3. **Delete chat history:**
```typescript
// Delete all messages for this session from n8n_chat_histories
const result = await prisma.n8nChatHistory.deleteMany({
  where: {
    session_id: decodedSessionId
  }
})
```

4. **Audit logging:**
   - Log the action using logAudit with:
   - action: 'CLEAR_CHAT_MEMORY' (add to AuditAction enum if needed)
   - resource: 'n8n_chat_histories'
   - resourceId: sessionId
   - details: { deletedCount: result.count }

5. **Response:**
   - Return 200 with { success: true, deletedCount: number }
   - Return 404 if no messages found (deletedCount === 0)
   - Return 500 with error message on failure

6. **Error handling:**
   - Wrap in try/catch
   - Log errors to console
   - Return sanitized error messages
  </action>
  <verify>
Test with curl:
curl -X DELETE "http://localhost:3000/api/conversations/test-session-id/memory" -H "Cookie: [auth-cookie]"
Should return 404 (no messages) or 200 (if test messages exist)
  </verify>
  <done>API endpoint deletes chat history and logs the action</done>
</task>

<task type="auto">
  <name>Task 2: Add CLEAR_CHAT_MEMORY to audit actions</name>
  <files>src/lib/audit/logger.ts</files>
  <action>
Add new audit action for clearing chat memory:

1. Add to AuditAction enum:
```typescript
export enum AuditAction {
  // ... existing actions
  CLEAR_CHAT_MEMORY = 'CLEAR_CHAT_MEMORY',
}
```

This ensures the action is properly typed and tracked for compliance.
  </action>
  <verify>TypeScript compiles: npx tsc --noEmit</verify>
  <done>CLEAR_CHAT_MEMORY action available for audit logging</done>
</task>

<task type="auto">
  <name>Task 3: Create ClearMemoryButton component</name>
  <files>src/components/conversations/clear-memory-button.tsx</files>
  <action>
Create a button component with confirmation dialog:

1. **Props:**
```typescript
interface ClearMemoryButtonProps {
  sessionId: string
  onSuccess?: () => void
  variant?: 'default' | 'destructive' | 'outline'
  size?: 'default' | 'sm' | 'lg'
}
```

2. **UI Structure:**
   - Button with Trash2 icon and "Limpar Memória" text
   - Use AlertDialog from shadcn for confirmation
   - Dialog title: "Limpar Memória da IA"
   - Dialog description: "Esta ação irá apagar todo o histórico de conversa da IA para este paciente. A IA esquecerá o contexto anterior e começará do zero. Esta ação não pode ser desfeita."
   - Cancel button: "Cancelar"
   - Confirm button: "Limpar Memória" (destructive variant)

3. **Behavior:**
   - Show loading state during API call (spinner on button)
   - On success: toast.success("Memória da IA limpa com sucesso")
   - On error: toast.error("Erro ao limpar memória: " + error.message)
   - Call onSuccess callback after successful clear
   - Disable button while loading

4. **API call:**
```typescript
const response = await fetch(`/api/conversations/${encodeURIComponent(sessionId)}/memory`, {
  method: 'DELETE',
})
```

Use sonner for toast notifications.
Use Lucide Trash2 icon.
  </action>
  <verify>Component renders without errors in Storybook or dev server</verify>
  <done>ClearMemoryButton shows confirmation dialog and calls API to clear memory</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] API endpoint responds to DELETE requests
- [ ] Audit action is properly typed
- [ ] ClearMemoryButton shows confirmation dialog
- [ ] Toast notifications appear on success/error
</verification>

<success_criteria>
- All tasks completed
- API deletes n8n_chat_histories records by session_id
- Action is audit logged for compliance
- UI has confirmation to prevent accidental clears
- Error handling is robust
</success_criteria>

<output>
After completion, create `.planning/phases/05-conversation-monitoring/05-02-SUMMARY.md`
</output>
