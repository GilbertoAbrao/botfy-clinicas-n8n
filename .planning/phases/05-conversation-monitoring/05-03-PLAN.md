---
phase: 05-conversation-monitoring
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/components/conversations/conversation-card.tsx
  - src/app/conversas/page.tsx
  - src/components/alerts/alert-detail.tsx
  - src/components/patients/conversation-history.tsx
autonomous: false

must_haves:
  truths:
    - "User can see conversation list with expandable cards"
    - "User can expand a card to see full message history without leaving page"
    - "User can access Clear Memory button from expanded card"
    - "User can access conversation from alert detail view"
    - "User can access conversation from patient profile"
    - "Real-time updates show new messages in expanded view"
  artifacts:
    - path: "src/components/conversations/conversation-card.tsx"
      provides: "Expandable conversation card component"
      min_lines: 80
    - path: "src/app/conversas/page.tsx"
      provides: "Updated conversation list with cards"
  key_links:
    - from: "conversation-card.tsx"
      to: "ConversationThread"
      via: "renders thread when expanded"
      pattern: "ConversationThread"
    - from: "conversation-card.tsx"
      to: "ClearMemoryButton"
      via: "renders in card actions"
      pattern: "ClearMemoryButton"
    - from: "alert-detail.tsx"
      to: "conversation-card.tsx or ConversationThread"
      via: "shows conversation in context"
---

<objective>
Create expandable conversation cards and integrate all conversation views across the application.

Purpose: Provide a unified conversation viewing experience - users can see conversations in a list format with expandable cards, and access the same conversation view from alerts and patient profiles. The "Clear Memory" button is accessible from the expanded card view.

Output: Expandable conversation cards on /conversas page, integrated views in alert detail and patient profile.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-conversation-monitoring/05-CONTEXT.md
@.planning/phases/05-conversation-monitoring/05-01-SUMMARY.md
@.planning/phases/05-conversation-monitoring/05-02-SUMMARY.md

@src/app/conversas/page.tsx
@src/components/conversations/conversation-list.tsx
@src/components/conversations/conversation-list-realtime.tsx
@src/components/alerts/alert-detail.tsx
@src/components/patients/conversation-history.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ConversationCard expandable component</name>
  <files>src/components/conversations/conversation-card.tsx</files>
  <action>
Create an expandable card component for conversation list:

1. **Props:**
```typescript
interface ConversationCardProps {
  conversation: {
    sessionId: string
    patient: { id: string; nome: string; telefone: string } | null
    status: 'IA' | 'HUMANO' | 'FINALIZADO'
    lastMessage: string
    lastMessageAt: Date
    messageCount: number
    messages: Message[]
  }
  onMemoryCleared?: () => void
}
```

2. **Collapsed State (default):**
   - Patient name and phone (or "Paciente não identificado")
   - Status badge (purple IA, yellow HUMANO, gray FINALIZADO)
   - Last message preview (truncated to 60 chars)
   - Time since last message (e.g., "há 5 min", "há 2 horas")
   - Message count badge
   - Chevron icon indicating expandable

3. **Expanded State:**
   - Full ConversationThread component with all messages
   - ClearMemoryButton in card header/actions area
   - "Ver perfil do paciente" link (if patient is linked)
   - Close/collapse button

4. **Animation:**
   - Use Collapsible from shadcn/ui for smooth expand/collapse
   - Or use Accordion if multiple cards should auto-close

5. **Styling:**
   - Card with border, rounded corners
   - Hover effect on collapsed card
   - Shadow elevation when expanded
   - Match existing card styles in the app

6. **State management:**
   - Use useState for expanded state
   - Refresh messages on expand if needed
  </action>
  <verify>Component renders and expands/collapses properly</verify>
  <done>ConversationCard shows summary when collapsed, full thread when expanded</done>
</task>

<task type="auto">
  <name>Task 2: Update /conversas page to use ConversationCard</name>
  <files>src/app/conversas/page.tsx</files>
  <action>
Update the conversations page to use the new expandable cards:

1. **Replace or enhance ConversationList:**
   - Map conversations to ConversationCard components
   - Keep existing filters (status, search)
   - Maintain real-time wrapper (ConversationListRealtime)

2. **Layout:**
   - Stack cards vertically with gap
   - Mobile-friendly: cards take full width
   - Desktop: max-width container centered

3. **Data fetching:**
   - Ensure full message array is fetched for each conversation
   - May need to update fetchConversations() to include messages
   - Or lazy-load messages on card expand

4. **Empty state:**
   - Keep existing "Nenhuma conversa encontrada" state

5. **Connection status:**
   - Keep real-time connection indicator from ConversationListRealtime
   - Show live pulse when subscribed

6. **Refresh on memory clear:**
   - Pass callback to ConversationCard that refreshes the list
   - Or use router.refresh() for server-side refetch
  </action>
  <verify>
Visit /conversas and verify:
- Cards display with conversation summaries
- Clicking card expands to show full thread
- Clear Memory button visible in expanded view
- Real-time updates still work
  </verify>
  <done>Conversations page shows expandable cards with WhatsApp-style threads</done>
</task>

<task type="auto">
  <name>Task 3: Enhance alert detail conversation integration</name>
  <files>src/components/alerts/alert-detail.tsx</files>
  <action>
Update AlertDetail to use the enhanced conversation components:

1. **Find the conversation section** (around lines 293-329 based on exploration)

2. **Update to use new components:**
   - If conversation exists (alert.chatSessionId), show ConversationThread with new styling
   - Add ClearMemoryButton next to "Ver conversa completa" link
   - Ensure messages are passed correctly

3. **Keep compact mode:**
   - Use compact prop to show limited messages
   - "Ver conversa completa" links to /conversas with session filter

4. **Ensure real-time still works:**
   - useAlertDetailSubscription should continue to work
   - New messages should appear in the thread

5. **Error handling:**
   - If conversation not found, show appropriate message
   - Handle case where chatSessionId exists but no messages
  </action>
  <verify>
View an alert detail with chatSessionId and verify:
- Conversation shows with WhatsApp styling
- Clear Memory button is accessible
- "Ver conversa completa" link works
  </verify>
  <done>Alert detail shows enhanced conversation view with Clear Memory option</done>
</task>

<task type="auto">
  <name>Task 4: Enhance patient profile conversation integration</name>
  <files>src/components/patients/conversation-history.tsx</files>
  <action>
Update ConversationHistory component in patient profile:

1. **Keep accordion structure** (multiple conversations per patient)

2. **Update message rendering:**
   - Use ConversationThread with new WhatsApp styling inside each accordion item
   - Messages should have proper sender badges and timestamps

3. **Add Clear Memory button:**
   - In each accordion item header or content area
   - Only show if conversation has messages

4. **Navigation:**
   - "Ver no painel" link to /conversas with session filter
   - Keep existing links if any

5. **Handle empty state:**
   - "Nenhuma conversa encontrada para este paciente"
  </action>
  <verify>
View a patient profile with conversation history and verify:
- Conversations show with WhatsApp styling
- Each conversation has Clear Memory button
- Accordion expands to show full thread
  </verify>
  <done>Patient profile shows conversations with enhanced styling and Clear Memory option</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete conversation monitoring system with:
    - WhatsApp-style message bubbles (green/white)
    - AI/Human badges on messages
    - Message delivery status indicators
    - Expandable conversation cards on /conversas
    - Clear Memory button with confirmation
    - Integration in alert detail view
    - Integration in patient profile
  </what-built>
  <how-to-verify>
    1. Run: npm run dev
    2. Visit: http://localhost:3000/conversas
       - Verify cards show conversation summaries
       - Click a card to expand
       - Verify WhatsApp-style message bubbles
       - Verify AI messages have purple "IA" badge
       - Verify human messages have blue "Humano" badge (or patient on left)
       - Find and click "Limpar Memória" button
       - Verify confirmation dialog appears
       - Cancel (don't actually clear)
    3. Visit: http://localhost:3000/dashboard (alert list)
       - Click an alert with conversation
       - Verify conversation shows with new styling
       - Verify Clear Memory button is accessible
    4. Visit: http://localhost:3000/pacientes
       - Open a patient profile
       - Go to "Conversas" tab
       - Verify conversations show with new styling
       - Verify Clear Memory is accessible
    5. Test real-time (if possible):
       - Keep /conversas open
       - Send a test message via WhatsApp
       - Verify new message appears without refresh
  </how-to-verify>
  <resume-signal>Type "approved" if all looks good, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] ConversationCard expands/collapses properly
- [ ] /conversas page shows card list
- [ ] Alert detail shows conversation with new styling
- [ ] Patient profile shows conversation with new styling
- [ ] Clear Memory button accessible from all views
- [ ] Human verification passed
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Human approved visual verification
- Conversation monitoring is accessible from all relevant views
- Clear Memory functionality works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/05-conversation-monitoring/05-03-SUMMARY.md`
</output>
