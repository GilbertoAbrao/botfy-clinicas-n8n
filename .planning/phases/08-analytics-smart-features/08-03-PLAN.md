---
phase: 08-analytics-smart-features
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/app/api/analytics/route.ts
  - src/app/api/analytics/alerts/[id]/priority/route.ts
  - src/app/api/analytics/appointments/[id]/risk/route.ts
  - src/app/api/export/route.ts
autonomous: true

must_haves:
  truths:
    - "Analytics API returns KPIs and patterns"
    - "Alert priority endpoint returns score for specific alert"
    - "Appointment risk endpoint returns no-show prediction"
    - "Export API generates CSV for last 30 days"
  artifacts:
    - path: "src/app/api/analytics/route.ts"
      provides: "Main analytics API"
      exports: ["GET"]
      min_lines: 40
    - path: "src/app/api/analytics/alerts/[id]/priority/route.ts"
      provides: "Alert priority scoring endpoint"
      exports: ["GET"]
    - path: "src/app/api/analytics/appointments/[id]/risk/route.ts"
      provides: "Appointment risk prediction endpoint"
      exports: ["GET"]
    - path: "src/app/api/export/route.ts"
      provides: "CSV export endpoint"
      exports: ["GET"]
      min_lines: 60
  key_links:
    - from: "api/analytics/route.ts"
      to: "lib/analytics/*.ts"
      via: "imports algorithms"
      pattern: "from '@/lib/analytics/"
    - from: "api/export/route.ts"
      to: "prisma"
      via: "data fetching"
      pattern: "prisma\\."
---

<objective>
Create API endpoints that expose analytics algorithms and provide CSV export functionality.

Purpose: APIs enable UI components to fetch analytics data and allow users to export data.
Output: RESTful API endpoints for analytics, predictions, and data export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Analytics algorithms from Plan 08-01 and 08-02
# (Will be created by prior plans - reference patterns)
@src/lib/api/metrics.ts

# API patterns from existing routes
@src/app/api/alertas/route.ts

# Auth patterns
@src/lib/auth/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Main Analytics API</name>
  <files>src/app/api/analytics/route.ts</files>
  <action>
    Create GET endpoint returning comprehensive analytics dashboard data.

    **Response:**
    ```typescript
    {
      kpis: KPIMetrics,
      patterns: Pattern[],
      generatedAt: string // ISO timestamp
    }
    ```

    **Implementation:**
    ```typescript
    import { NextRequest, NextResponse } from 'next/server'
    import { getCurrentUserWithRole } from '@/lib/auth/session'
    import { calculateKPIs } from '@/lib/analytics/kpi-calculator'
    import { detectPatterns } from '@/lib/analytics/pattern-detector'

    export async function GET(req: NextRequest) {
      try {
        // 1. Auth check
        const user = await getCurrentUserWithRole()
        if (!user) {
          return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
        }

        // 2. Parse query params
        const searchParams = req.nextUrl.searchParams
        const periodDays = parseInt(searchParams.get('periodDays') || '30')

        // 3. Fetch analytics in parallel
        const [kpis, patterns] = await Promise.all([
          calculateKPIs({ periodDays }),
          detectPatterns({ lookbackDays: periodDays })
        ])

        return NextResponse.json({
          kpis,
          patterns,
          generatedAt: new Date().toISOString()
        })
      } catch (error) {
        console.error('[Analytics API] Error:', error)
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        )
      }
    }
    ```

    **Query parameters:**
    - periodDays: number (default 30, max 90)
  </action>
  <verify>
    - File exists at src/app/api/analytics/route.ts
    - TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>
    Main analytics endpoint returns KPIs and patterns for configurable period
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Alert Priority and Appointment Risk Endpoints</name>
  <files>src/app/api/analytics/alerts/[id]/priority/route.ts, src/app/api/analytics/appointments/[id]/risk/route.ts</files>
  <action>
    Create dynamic route endpoints for individual alert priority and appointment risk.

    **Alert Priority Endpoint:**
    Path: GET /api/analytics/alerts/[id]/priority

    ```typescript
    // src/app/api/analytics/alerts/[id]/priority/route.ts
    import { NextRequest, NextResponse } from 'next/server'
    import { getCurrentUserWithRole } from '@/lib/auth/session'
    import { calculateAlertPriority } from '@/lib/analytics/priority-scorer'

    export async function GET(
      req: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const { id } = await params

      const user = await getCurrentUserWithRole()
      if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      try {
        const priority = await calculateAlertPriority(id)
        return NextResponse.json(priority)
      } catch (error) {
        console.error('[Alert Priority API] Error:', error)
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        )
      }
    }
    ```

    **Appointment Risk Endpoint:**
    Path: GET /api/analytics/appointments/[id]/risk

    ```typescript
    // src/app/api/analytics/appointments/[id]/risk/route.ts
    import { NextRequest, NextResponse } from 'next/server'
    import { getCurrentUserWithRole } from '@/lib/auth/session'
    import { predictNoShowRisk } from '@/lib/analytics/no-show-predictor'

    export async function GET(
      req: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const { id } = await params

      const user = await getCurrentUserWithRole()
      if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      try {
        const prediction = await predictNoShowRisk(id)
        return NextResponse.json(prediction)
      } catch (error) {
        console.error('[Appointment Risk API] Error:', error)
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        )
      }
    }
    ```

    **Directory structure to create:**
    - src/app/api/analytics/alerts/[id]/priority/route.ts
    - src/app/api/analytics/appointments/[id]/risk/route.ts
  </action>
  <verify>
    - Both files exist at correct paths
    - TypeScript compiles: npx tsc --noEmit
    - Dynamic route params handled correctly
  </verify>
  <done>
    Individual alert priority and appointment risk endpoints created
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CSV Export API</name>
  <files>src/app/api/export/route.ts</files>
  <action>
    Create GET endpoint that generates CSV export of appointment data.

    **Query Parameters:**
    - type: 'appointments' | 'alerts' | 'kpis' (required)
    - startDate: ISO date string (optional, default 30 days ago)
    - endDate: ISO date string (optional, default now)

    **CSV Format for Appointments:**
    ```
    id,patient_name,patient_phone,service,scheduled_at,status,provider,created_at
    uuid,Jo√£o Silva,11999999999,Consulta,2026-01-15T10:00:00,confirmed,Dr. Maria,2026-01-10T14:30:00
    ```

    **Implementation:**
    ```typescript
    import { NextRequest, NextResponse } from 'next/server'
    import { getCurrentUserWithRole } from '@/lib/auth/session'
    import { prisma } from '@/lib/prisma'
    import { logAudit, AuditAction } from '@/lib/audit/logger'
    import { subDays, parseISO } from 'date-fns'

    export async function GET(req: NextRequest) {
      const user = await getCurrentUserWithRole()
      if (!user) {
        return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
      }

      // Only ADMIN can export data
      if (user.role !== 'ADMIN') {
        return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
      }

      const searchParams = req.nextUrl.searchParams
      const type = searchParams.get('type')
      const startDateStr = searchParams.get('startDate')
      const endDateStr = searchParams.get('endDate')

      if (!type || !['appointments', 'alerts', 'kpis'].includes(type)) {
        return NextResponse.json(
          { error: 'Invalid export type' },
          { status: 400 }
        )
      }

      const endDate = endDateStr ? parseISO(endDateStr) : new Date()
      const startDate = startDateStr ? parseISO(startDateStr) : subDays(endDate, 30)

      try {
        let csv: string
        let filename: string

        switch (type) {
          case 'appointments':
            csv = await exportAppointments(startDate, endDate)
            filename = `agendamentos_${formatDateForFilename(startDate)}_${formatDateForFilename(endDate)}.csv`
            break
          case 'alerts':
            csv = await exportAlerts(startDate, endDate)
            filename = `alertas_${formatDateForFilename(startDate)}_${formatDateForFilename(endDate)}.csv`
            break
          case 'kpis':
            csv = await exportKPIs(startDate, endDate)
            filename = `metricas_${formatDateForFilename(startDate)}_${formatDateForFilename(endDate)}.csv`
            break
          default:
            throw new Error('Invalid type')
        }

        // Audit log
        await logAudit({
          userId: user.id,
          action: AuditAction.EXPORT_DATA,
          resource: type,
          details: { startDate, endDate, rowCount: csv.split('\n').length - 1 }
        })

        return new NextResponse(csv, {
          headers: {
            'Content-Type': 'text/csv; charset=utf-8',
            'Content-Disposition': `attachment; filename="${filename}"`,
          },
        })
      } catch (error) {
        console.error('[Export API] Error:', error)
        return NextResponse.json(
          { error: error instanceof Error ? error.message : 'Internal error' },
          { status: 500 }
        )
      }
    }

    // Helper functions for each export type
    async function exportAppointments(startDate: Date, endDate: Date): Promise<string>
    async function exportAlerts(startDate: Date, endDate: Date): Promise<string>
    async function exportKPIs(startDate: Date, endDate: Date): Promise<string>
    function formatDateForFilename(date: Date): string
    function escapeCSV(value: unknown): string
    ```

    **Security notes:**
    - ADMIN role required (HIPAA - data export is sensitive)
    - Audit log the export action
    - Sanitize data (escape commas, quotes in CSV)
  </action>
  <verify>
    - File exists at src/app/api/export/route.ts
    - TypeScript compiles: npx tsc --noEmit
    - ADMIN role check present
    - Audit logging present
  </verify>
  <done>
    CSV export endpoint supports appointments, alerts, and KPIs with ADMIN-only access
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All API files created
- [ ] `npx tsc --noEmit` passes without errors
- [ ] Auth checks in all endpoints
- [ ] ADMIN role check for export endpoint
- [ ] Audit logging for export
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- APIs ready for UI integration
- Export generates valid CSV with proper headers
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-smart-features/08-03-SUMMARY.md`
</output>
