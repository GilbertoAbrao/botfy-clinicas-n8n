---
phase: 08-analytics-smart-features
plan: 05
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/components/alerts/alert-priority-badge.tsx
  - src/components/alerts/alert-list-item.tsx
  - src/components/appointments/no-show-risk-badge.tsx
  - src/components/calendar/appointment-card.tsx
autonomous: true

must_haves:
  truths:
    - "Alert list shows priority score (1-100) badge on each alert"
    - "Appointment views show no-show risk indicator (high/medium/low)"
    - "Priority and risk data loads without blocking main content"
  artifacts:
    - path: "src/components/alerts/alert-priority-badge.tsx"
      provides: "Priority score badge component"
      min_lines: 30
    - path: "src/components/appointments/no-show-risk-badge.tsx"
      provides: "No-show risk indicator component"
      min_lines: 40
  key_links:
    - from: "alert-priority-badge.tsx"
      to: "/api/analytics/alerts/[id]/priority"
      via: "fetch for score"
      pattern: "api/analytics/alerts"
    - from: "no-show-risk-badge.tsx"
      to: "/api/analytics/appointments/[id]/risk"
      via: "fetch for prediction"
      pattern: "api/analytics/appointments"
---

<objective>
Integrate priority scores into alert list and no-show risk into appointment views.

Purpose: Surface analytics insights directly in operational workflows - staff see predictions where they make decisions.
Output: Updated alert and appointment components with inline analytics indicators.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing alert components
@src/components/alerts/alert-list.tsx
@src/components/alerts/alert-card.tsx

# Existing appointment/calendar components
@src/components/calendar/appointment-card.tsx
@src/app/agenda/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Alert Priority Badge Component</name>
  <files>src/components/alerts/alert-priority-badge.tsx</files>
  <action>
    Create component that fetches and displays alert priority score.

    **Design:**
    - Small badge showing score (e.g., "87")
    - Color coded: 80-100 red, 50-79 yellow, 0-49 green
    - Tooltip showing explanation on hover
    - Lazy loading: shows skeleton while fetching

    **Interface:**
    ```typescript
    'use client'

    interface AlertPriorityBadgeProps {
      alertId: string
      className?: string
    }

    export function AlertPriorityBadge({ alertId, className }: AlertPriorityBadgeProps) {
      // useSWR or useState + useEffect to fetch priority
      // Endpoint: GET /api/analytics/alerts/{alertId}/priority
      // Return: { score: number, explanation: string }

      // Loading state: small skeleton pill
      // Error state: null (don't show badge if error)
      // Success: colored badge with score

      // Tooltip using shadcn Tooltip component
      return (
        <Tooltip>
          <TooltipTrigger>
            <Badge className={cn(colorClass, className)}>
              {score}
            </Badge>
          </TooltipTrigger>
          <TooltipContent>
            <p>{explanation}</p>
          </TooltipContent>
        </Tooltip>
      )
    }
    ```

    **Color mapping:**
    - 80-100: bg-red-100 text-red-800 (urgent)
    - 50-79: bg-yellow-100 text-yellow-800 (high attention)
    - 0-49: bg-green-100 text-green-800 (low priority)
  </action>
  <verify>
    - File exists with AlertPriorityBadge export
    - TypeScript compiles: npx tsc --noEmit
    - Uses Tooltip for explanation display
  </verify>
  <done>
    Priority badge fetches and displays score with color coding and tooltip explanation
  </done>
</task>

<task type="auto">
  <name>Task 2: Create No-Show Risk Badge Component</name>
  <files>src/components/appointments/no-show-risk-badge.tsx</files>
  <action>
    Create component that fetches and displays appointment no-show risk.

    **Design:**
    - Badge showing risk level: "Alto", "Médio", "Baixo"
    - Color coded: high=red, medium=yellow, low=green
    - Tooltip showing recommendations on hover
    - Lazy loading with skeleton

    **Interface:**
    ```typescript
    'use client'

    interface NoShowRiskBadgeProps {
      appointmentId: string
      className?: string
    }

    export function NoShowRiskBadge({ appointmentId, className }: NoShowRiskBadgeProps) {
      // Fetch: GET /api/analytics/appointments/{appointmentId}/risk
      // Return: { riskLevel: 'high'|'medium'|'low', recommendations: string[] }

      // Loading: skeleton
      // Error: null (don't block appointment display)
      // Success: colored badge with level text

      const levelText = {
        high: 'Alto',
        medium: 'Médio',
        low: 'Baixo'
      }

      return (
        <Tooltip>
          <TooltipTrigger>
            <Badge className={cn(colorClass, className)}>
              <AlertTriangle className="h-3 w-3 mr-1" />
              {levelText[riskLevel]}
            </Badge>
          </TooltipTrigger>
          <TooltipContent>
            <div className="space-y-1">
              <p className="font-medium">Risco de não comparecimento</p>
              <ul className="text-xs list-disc pl-4">
                {recommendations.map((rec, i) => (
                  <li key={i}>{rec}</li>
                ))}
              </ul>
            </div>
          </TooltipContent>
        </Tooltip>
      )
    }
    ```

    **Color mapping:**
    - high: bg-red-100 text-red-800
    - medium: bg-yellow-100 text-yellow-800
    - low: bg-green-100 text-green-800
  </action>
  <verify>
    - File exists with NoShowRiskBadge export
    - TypeScript compiles: npx tsc --noEmit
    - Shows recommendations in tooltip
  </verify>
  <done>
    Risk badge fetches and displays level with recommendations tooltip
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Badges into Existing Components</name>
  <files>src/components/alerts/alert-list-item.tsx, src/components/calendar/appointment-card.tsx</files>
  <action>
    Update existing components to include the new badges.

    **Alert List Item Update:**
    Find the alert list item component (likely in alert-list.tsx or alert-card.tsx) and add AlertPriorityBadge.

    ```typescript
    // In alert list item rendering
    <div className="flex items-center gap-2">
      <AlertPriorityBadge alertId={alert.id} />
      {/* existing content */}
    </div>
    ```

    Position: After the existing priority indicator (urgent/high/low), showing the numeric score.

    **Appointment Card Update:**
    Find the appointment card component and add NoShowRiskBadge for future appointments only.

    ```typescript
    // In appointment card
    {/* Only show for future appointments */}
    {new Date(appointment.scheduledAt) > new Date() && (
      <NoShowRiskBadge appointmentId={appointment.id} />
    )}
    ```

    Position: Near the status badge, clearly visible.

    **Important:**
    - Don't show risk badge for past appointments
    - Don't show risk badge for cancelled/completed appointments
    - Badge should not block rendering of main content
    - Use Suspense boundaries if available
  </action>
  <verify>
    - Alert list shows priority scores
    - Future appointments show risk badges
    - Past/cancelled appointments don't show risk
    - `npm run build` succeeds
  </verify>
  <done>
    Priority badges visible in alert list, risk badges visible on future appointments
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Both badge components created
- [ ] Alert list displays priority scores
- [ ] Appointment cards display no-show risk for future appointments
- [ ] Tooltips work correctly
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Badges load asynchronously without blocking main content
- Visual hierarchy maintained (badges don't overshadow primary content)
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-smart-features/08-05-SUMMARY.md`
</output>
