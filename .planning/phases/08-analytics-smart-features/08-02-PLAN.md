---
phase: 08-analytics-smart-features
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/analytics/no-show-predictor.ts
autonomous: true

must_haves:
  truths:
    - "Predictor calculates no-show risk for upcoming appointments"
    - "Risk levels are high/medium/low based on patient history"
    - "Batch prediction available for multiple appointments"
  artifacts:
    - path: "src/lib/analytics/no-show-predictor.ts"
      provides: "No-show risk prediction algorithm"
      exports: ["predictNoShowRisk", "NoShowRiskLevel", "NoShowPrediction"]
      min_lines: 80
  key_links:
    - from: "no-show-predictor.ts"
      to: "prisma.appointment + prisma.patient"
      via: "historical data queries"
      pattern: "prisma\\.(appointment|patient)\\."
---

<objective>
Implement no-show risk prediction algorithm based on patient history and appointment patterns.

Purpose: Enable proactive intervention for high-risk appointments before they become no-shows.
Output: Prediction module that returns risk level (high/medium/low) with confidence score.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Patient stats showing no-show calculation
@src/components/patients/patient-stats.tsx

# Schema for understanding data models
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create No-Show Risk Predictor</name>
  <files>src/lib/analytics/no-show-predictor.ts</files>
  <action>
    Create heuristic-based no-show risk prediction algorithm.

    **Risk Factors (weighted):**
    1. Patient's historical no-show rate (weight: 40%)
       - 0% → low risk, >30% → high risk
    2. Time of day (weight: 15%)
       - Early morning and late afternoon higher risk
    3. Day of week (weight: 15%)
       - Mondays and Fridays slightly higher risk
    4. Lead time (weight: 15%)
       - Appointments booked >7 days in advance higher risk
    5. Confirmation status (weight: 15%)
       - Unconfirmed within 24h of appointment → higher risk

    **Risk Levels:**
    - High: score > 60 (red indicator)
    - Medium: score 30-60 (yellow indicator)
    - Low: score < 30 (green indicator)

    **Interface:**
    ```typescript
    export type NoShowRiskLevel = 'high' | 'medium' | 'low'

    export interface RiskFactors {
      historicalNoShowRate: number
      timeOfDayRisk: number
      dayOfWeekRisk: number
      leadTimeRisk: number
      confirmationRisk: number
    }

    export interface NoShowPrediction {
      appointmentId: string
      riskLevel: NoShowRiskLevel
      riskScore: number // 0-100
      factors: RiskFactors
      recommendations: string[]
    }

    // Single prediction
    export async function predictNoShowRisk(
      appointmentId: string
    ): Promise<NoShowPrediction>

    // Batch prediction for efficiency
    export async function predictNoShowRiskBatch(
      appointmentIds: string[]
    ): Promise<NoShowPrediction[]>
    ```

    **Implementation notes:**
    - Fetch patient's appointment history for historical rate
    - Use date-fns to extract hour and day-of-week
    - Calculate lead time from createdAt to scheduledAt
    - Check confirmation status vs 24h threshold
    - Generate recommendations based on risk factors:
      - High: "Ligar para confirmar", "Enviar lembrete extra"
      - Medium: "Enviar lembrete 24h antes"
      - Low: "Fluxo padrão"
    - Batch function should use single query with IN clause for efficiency
  </action>
  <verify>
    - File exists with exported functions
    - TypeScript compiles: npx tsc --noEmit
    - Both single and batch functions exported
  </verify>
  <done>
    No-show predictor returns risk level, score 0-100, factor breakdown, and actionable recommendations
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Prediction Caching Layer</name>
  <files>src/lib/analytics/no-show-predictor.ts</files>
  <action>
    Add in-memory caching to avoid recalculating predictions frequently.

    **Cache Strategy:**
    - Cache predictions by appointmentId
    - TTL: 1 hour (predictions don't change rapidly)
    - Invalidate on appointment status change
    - Max cache size: 1000 entries (LRU eviction)

    **Add to existing file:**
    ```typescript
    // Simple LRU cache
    const predictionCache = new Map<string, {
      prediction: NoShowPrediction
      cachedAt: number
    }>()

    const CACHE_TTL = 60 * 60 * 1000 // 1 hour
    const MAX_CACHE_SIZE = 1000

    function getCachedPrediction(appointmentId: string): NoShowPrediction | null {
      // Check if cached and not expired
    }

    function cachePrediction(appointmentId: string, prediction: NoShowPrediction): void {
      // Add to cache with LRU eviction
    }

    export function invalidatePredictionCache(appointmentId?: string): void {
      // Clear specific or all cached predictions
    }
    ```

    **Integration:**
    - predictNoShowRisk should check cache first
    - Cache miss → calculate → cache result
    - Export invalidatePredictionCache for use when appointments are updated
  </action>
  <verify>
    - Caching functions exist
    - invalidatePredictionCache is exported
    - TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>
    Prediction caching implemented with 1-hour TTL and LRU eviction at 1000 entries
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/lib/analytics/no-show-predictor.ts created
- [ ] `npx tsc --noEmit` passes without errors
- [ ] predictNoShowRisk, predictNoShowRiskBatch, invalidatePredictionCache exported
- [ ] Risk levels correctly mapped to scores
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Single and batch prediction functions work
- Caching layer prevents redundant calculations
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-smart-features/08-02-SUMMARY.md`
</output>
