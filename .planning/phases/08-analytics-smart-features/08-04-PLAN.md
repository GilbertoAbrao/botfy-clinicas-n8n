---
phase: 08-analytics-smart-features
plan: 04
type: execute
wave: 3
depends_on: ["08-03"]
files_modified:
  - src/components/analytics/insights-panel.tsx
  - src/components/analytics/kpi-cards.tsx
  - src/components/analytics/export-button.tsx
  - src/app/admin/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can see detected patterns in Insights panel"
    - "User can see extended KPIs (booking success, no-show rate, resolution time)"
    - "User can export data to CSV from admin area"
    - "Analytics page is accessible from admin navigation"
  artifacts:
    - path: "src/components/analytics/insights-panel.tsx"
      provides: "Pattern insights display"
      min_lines: 60
    - path: "src/components/analytics/kpi-cards.tsx"
      provides: "Extended KPI cards"
      min_lines: 80
    - path: "src/components/analytics/export-button.tsx"
      provides: "CSV export button component"
      min_lines: 40
    - path: "src/app/admin/analytics/page.tsx"
      provides: "Analytics dashboard page"
      min_lines: 50
  key_links:
    - from: "analytics/page.tsx"
      to: "/api/analytics"
      via: "fetch for data"
      pattern: "fetch.*api/analytics"
    - from: "export-button.tsx"
      to: "/api/export"
      via: "download trigger"
      pattern: "api/export"
---

<objective>
Build the analytics dashboard UI with insights panel, KPI cards, and export functionality.

Purpose: Provide visual interface for staff to see patterns, KPIs, and export data.
Output: New analytics page at /admin/analytics with complete dashboard.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing dashboard patterns
@src/components/dashboard/metrics-dashboard.tsx
@src/components/patients/patient-stats.tsx

# Admin layout
@src/app/admin/layout.tsx

# UI components
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Insights Panel Component</name>
  <files>src/components/analytics/insights-panel.tsx</files>
  <action>
    Create component displaying detected patterns from pattern-detector.

    **Design:**
    - Card with "Insights" header
    - List of pattern items with severity badges
    - Each pattern shows: icon, description, count, severity
    - Empty state: "Nenhum padrão detectado"

    **Props Interface:**
    ```typescript
    interface Pattern {
      type: 'time_slot_noshow' | 'provider_failure' | 'alert_type_spike' | 'day_of_week'
      description: string
      count: number
      severity: 'info' | 'warning' | 'critical'
      metadata: Record<string, unknown>
    }

    interface InsightsPanelProps {
      patterns: Pattern[]
      loading?: boolean
    }
    ```

    **Implementation:**
    - Use Card from shadcn/ui
    - Severity colors: info=blue, warning=yellow, critical=red
    - Icons per pattern type:
      - time_slot_noshow: Clock
      - provider_failure: User
      - alert_type_spike: AlertTriangle
      - day_of_week: Calendar
    - Show "Carregando..." skeleton while loading
    - Max 5 patterns shown, with "Ver mais" expansion
  </action>
  <verify>
    - File exists with InsightsPanel export
    - TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>
    Insights panel displays patterns with severity badges, icons, and expandable list
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KPI Cards Component</name>
  <files>src/components/analytics/kpi-cards.tsx</files>
  <action>
    Create component displaying extended KPIs in card grid.

    **KPIs to Display:**
    1. Taxa de Sucesso (booking success rate) - green/yellow/red based on percentage
    2. Taxa de Não Comparecimento (no-show rate) - inverse coloring (lower = better)
    3. Taxa de Cancelamento (cancellation rate)
    4. Tempo Médio de Resolução (avg resolution time in minutes/hours)
    5. Tendência de Confirmação (up/down/stable arrow indicator)

    **Props Interface:**
    ```typescript
    interface KPIMetrics {
      bookingSuccessRate: number
      noShowRate: number
      cancellationRate: number
      avgResolutionTimeMinutes: number | null
      confirmationRateTrend: 'up' | 'down' | 'stable'
      period: { start: Date; end: Date }
    }

    interface KPICardsProps {
      metrics: KPIMetrics | null
      loading?: boolean
    }
    ```

    **Implementation:**
    - Grid layout: 3 columns on desktop, 2 on tablet, 1 on mobile
    - Use Card from shadcn/ui
    - Color coding based on thresholds:
      - Success: >70% green, 50-70% yellow, <50% red
      - No-show: <10% green, 10-20% yellow, >20% red
      - Cancellation: <15% green, 15-25% yellow, >25% red
    - Format resolution time: "45 min" or "2h 30min"
    - Trend arrows: TrendingUp (green), TrendingDown (red), Minus (gray)
    - Period shown in footer: "Período: 01/01 - 31/01/2026"
  </action>
  <verify>
    - File exists with KPICards export
    - TypeScript compiles: npx tsc --noEmit
    - Responsive grid works
  </verify>
  <done>
    KPI cards display 5 metrics with color coding, trends, and period information
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Export Button and Analytics Page</name>
  <files>src/components/analytics/export-button.tsx, src/app/admin/analytics/page.tsx</files>
  <action>
    Create export button component and main analytics page.

    **Export Button:**
    ```typescript
    // src/components/analytics/export-button.tsx
    'use client'

    interface ExportButtonProps {
      type: 'appointments' | 'alerts' | 'kpis'
      label?: string
    }

    export function ExportButton({ type, label }: ExportButtonProps) {
      // State for loading
      // Handle click: fetch /api/export?type=X and trigger download
      // Show loading spinner during download
      // Handle errors with toast
    }
    ```

    **Analytics Page:**
    ```typescript
    // src/app/admin/analytics/page.tsx
    import { getCurrentUserWithRole } from '@/lib/auth/session'
    import { redirect } from 'next/navigation'
    import { AnalyticsDashboard } from './analytics-dashboard'

    export default async function AnalyticsPage() {
      const user = await getCurrentUserWithRole()

      if (!user) {
        redirect('/auth/login')
      }

      // Only ADMIN can view analytics
      if (user.role !== 'ADMIN') {
        redirect('/dashboard')
      }

      return (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h1 className="text-2xl font-bold">Analytics e Métricas</h1>
            <div className="flex gap-2">
              <ExportButton type="appointments" label="Exportar Agendamentos" />
              <ExportButton type="alerts" label="Exportar Alertas" />
            </div>
          </div>

          <AnalyticsDashboard />
        </div>
      )
    }
    ```

    Create client component for data fetching:
    ```typescript
    // src/app/admin/analytics/analytics-dashboard.tsx
    'use client'

    // Fetch from /api/analytics
    // Render KPICards and InsightsPanel
    // Handle loading and error states
    ```

    **Add to admin navigation:**
    Update sidebar to include "Analytics" link (only for ADMIN role)
  </action>
  <verify>
    - Export button triggers download
    - Analytics page accessible at /admin/analytics
    - ADMIN role check in place
    - TypeScript compiles: npx tsc --noEmit
  </verify>
  <done>
    Analytics page with KPIs, insights, and export buttons accessible to ADMIN users
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All component files created
- [ ] Analytics page renders at /admin/analytics
- [ ] ADMIN role check prevents non-admin access
- [ ] Export buttons trigger CSV downloads
- [ ] `npm run build` succeeds
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Analytics dashboard shows KPIs and patterns
- Export functionality works end-to-end
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-smart-features/08-04-SUMMARY.md`
</output>
