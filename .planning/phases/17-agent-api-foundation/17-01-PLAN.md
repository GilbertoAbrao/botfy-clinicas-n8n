---
phase: 17-agent-api-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/agent/types.ts
  - prisma/schema.prisma
  - package.json
autonomous: true

must_haves:
  truths:
    - "AgentContext type exists with agentId, userId, role, correlationId fields"
    - "ApiResponse type exists with success, data, error, details fields"
    - "Agent model exists in Prisma schema with bcrypt hash field"
    - "bcrypt package is installed and types are available"
  artifacts:
    - path: "src/lib/agent/types.ts"
      provides: "Type definitions for agent API infrastructure"
      exports: ["AgentContext", "ApiResponse", "AgentHandler"]
    - path: "prisma/schema.prisma"
      provides: "Agent model for API key storage"
      contains: "model Agent"
  key_links:
    - from: "src/lib/agent/types.ts"
      to: "prisma/schema.prisma"
      via: "Role enum import"
      pattern: "role:\\s+Role"
---

<objective>
Create foundational types and database schema for agent API infrastructure.

Purpose: Establishes the type system and data storage needed by all other Phase 17 components. Types define the contract for agent authentication context and API responses. The Agent model stores bcrypt-hashed API keys with mappings to system users for RBAC.

Output:
- `src/lib/agent/types.ts` with AgentContext, ApiResponse, AgentHandler types
- Agent model added to Prisma schema
- bcrypt package installed
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-agent-api-foundation/17-RESEARCH.md

# Existing files to reference
@prisma/schema.prisma
@src/lib/audit/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install bcrypt dependency</name>
  <files>package.json</files>
  <action>
Install bcrypt for API key hashing:

```bash
npm install bcrypt
npm install --save-dev @types/bcrypt
```

bcrypt is required for:
- Hashing API keys before database storage (never store plaintext)
- Comparing incoming API keys against stored hashes
- Using 12 salt rounds for secure hashing (research recommendation)
  </action>
  <verify>
Run `npm ls bcrypt` and confirm bcrypt is installed.
Run `npx tsc --noEmit` and confirm no type errors.
  </verify>
  <done>bcrypt and @types/bcrypt are listed in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create agent types</name>
  <files>src/lib/agent/types.ts</files>
  <action>
Create `src/lib/agent/types.ts` with the following types:

1. **AgentContext** - Passed to route handlers after authentication:
   ```typescript
   import { Role } from '@prisma/client'

   export interface AgentContext {
     agentId: string        // UUID from agents table
     userId: string         // Mapped system user for RBAC
     role: Role             // Inherited from mapped user (ADMIN or ATENDENTE)
     correlationId: string  // Generated per-request for audit trail linking
   }
   ```

2. **ApiResponse<T>** - Consistent response format for all agent APIs:
   ```typescript
   export interface ApiResponse<T = unknown> {
     success: boolean
     data?: T
     error?: string
     details?: Record<string, unknown>
   }
   ```

3. **AgentHandler** - Type for route handlers wrapped by withAgentAuth():
   ```typescript
   import { NextRequest, NextResponse } from 'next/server'

   export type AgentHandler<T = unknown> = (
     req: NextRequest,
     context: { params?: Record<string, string> },
     agentContext: AgentContext
   ) => Promise<NextResponse<ApiResponse<T>>>
   ```

Include JSDoc comments explaining each type's purpose and usage.
  </action>
  <verify>
Run `npx tsc --noEmit` and confirm no type errors.
Check file exists: `ls src/lib/agent/types.ts`
  </verify>
  <done>types.ts exists with AgentContext, ApiResponse, AgentHandler exports and Role import from Prisma</done>
</task>

<task type="auto">
  <name>Task 3: Add Agent model to Prisma schema</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the Agent model to `prisma/schema.prisma`:

```prisma
// AI Agent API credentials for N8N integration
// API keys are stored as bcrypt hashes, never in plaintext
model Agent {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   // e.g., "Marilia - WhatsApp Agent"
  description String?
  apiKeyHash  String   @map("api_key_hash") // bcrypt hash, NEVER plaintext
  userId      String   @map("user_id")      // Maps to system user for RBAC
  active      Boolean  @default(true)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([active])
  @@map("agents")
}
```

Also update the User model to include the agent relation:
```prisma
model User {
  // ... existing fields ...
  agents Agent[]  // NEW: User can have multiple agents mapped
}
```

After updating schema, run:
```bash
npx prisma generate
npx prisma db push
```

**Important notes:**
- `apiKeyHash` stores bcrypt hash (never the actual API key)
- `userId` links to User for RBAC inheritance
- `active` flag allows disabling agents without deletion
  </action>
  <verify>
Run `npx prisma validate` to check schema is valid.
Run `npx prisma generate` to ensure client generation works.
Check that `import { Agent } from '@prisma/client'` works in a test file.
  </verify>
  <done>Agent model exists in schema.prisma with relation to User, Prisma client generated successfully</done>
</task>

</tasks>

<verification>
1. Run `npm ls bcrypt` - shows bcrypt installed
2. Run `npx tsc --noEmit` - no type errors
3. Run `npx prisma validate` - schema valid
4. Check `src/lib/agent/types.ts` exports AgentContext, ApiResponse, AgentHandler
5. Check Prisma client has Agent type: `grep "Agent" node_modules/.prisma/client/index.d.ts`
</verification>

<success_criteria>
- bcrypt and @types/bcrypt installed in package.json
- src/lib/agent/types.ts exists with all three type exports
- Agent model exists in prisma/schema.prisma with apiKeyHash, userId fields
- User model has agents relation
- Prisma client generates without errors
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-agent-api-foundation/17-01-SUMMARY.md`
</output>
