---
phase: 17-agent-api-foundation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/agent/error-handler.ts
  - src/lib/audit/logger.ts
autonomous: true

must_haves:
  truths:
    - "handleApiError() returns consistent {success, error, details} format"
    - "ZodError is mapped to 400 with field-level validation details"
    - "Known errors are mapped to appropriate HTTP status codes"
    - "logAudit() accepts optional agentId and correlationId parameters"
    - "Agent audit actions are added to AuditAction enum"
  artifacts:
    - path: "src/lib/agent/error-handler.ts"
      provides: "Consistent error handling for agent APIs"
      exports: ["handleApiError", "successResponse"]
    - path: "src/lib/audit/logger.ts"
      provides: "Extended audit logging with agent context"
      contains: "agentId"
  key_links:
    - from: "src/lib/agent/error-handler.ts"
      to: "zod"
      via: "ZodError detection"
      pattern: "ZodError"
    - from: "src/lib/audit/logger.ts"
      to: "prisma"
      via: "auditLog.create"
      pattern: "prisma\\.auditLog\\.create"
---

<objective>
Create error handling utility and extend audit logger for agent API support.

Purpose: Ensures all agent APIs return consistent, parseable error responses that the AI agent can understand. Extends existing HIPAA audit logging to track agent actions with correlation IDs for request chain tracing.

Output:
- `src/lib/agent/error-handler.ts` with handleApiError() and successResponse()
- Extended `src/lib/audit/logger.ts` with agent context support
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-agent-api-foundation/17-RESEARCH.md

# Existing audit logger to extend
@src/lib/audit/logger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create error handler utility</name>
  <files>src/lib/agent/error-handler.ts</files>
  <action>
Create `src/lib/agent/error-handler.ts` with consistent error handling:

```typescript
import { NextResponse } from 'next/server'
import { ZodError } from 'zod'
import type { ApiResponse } from './types'

/**
 * Map of known error messages to HTTP status codes.
 * Add new known errors here as the agent API expands.
 */
const KNOWN_ERROR_STATUS_MAP: Record<string, number> = {
  'Time slot already booked': 409,
  'Patient not found': 404,
  'Service not found': 404,
  'Appointment not found': 404,
  'Provider not found': 404,
  'Invalid date format': 400,
  'Conflict detected': 409,
  'Unauthorized': 401,
  'Forbidden': 403,
}

/**
 * Handles errors from agent API routes, returning consistent ApiResponse format.
 * Automatically detects ZodError for validation failures.
 *
 * @param error - The error to handle
 * @returns NextResponse with appropriate status and ApiResponse body
 */
export function handleApiError(error: unknown): NextResponse<ApiResponse> {
  // Log error for debugging (sanitized - no PHI)
  console.error('[Agent API Error]', error instanceof Error ? error.message : 'Unknown error')

  // Handle Zod validation errors
  if (error instanceof ZodError) {
    return NextResponse.json(
      {
        success: false,
        error: 'Validation failed',
        details: {
          issues: error.issues.map((issue) => ({
            field: issue.path.join('.'),
            message: issue.message,
            code: issue.code,
          })),
        },
      },
      { status: 400 }
    )
  }

  // Handle known errors with specific status codes
  if (error instanceof Error) {
    const status = KNOWN_ERROR_STATUS_MAP[error.message] || 500

    return NextResponse.json(
      {
        success: false,
        error: error.message,
      },
      { status }
    )
  }

  // Unknown error - return generic 500
  return NextResponse.json(
    {
      success: false,
      error: 'Internal server error',
    },
    { status: 500 }
  )
}

/**
 * Creates a successful API response with consistent format.
 *
 * @param data - The data to include in the response
 * @param status - HTTP status code (default: 200)
 * @returns NextResponse with ApiResponse body
 */
export function successResponse<T>(
  data: T,
  status: number = 200
): NextResponse<ApiResponse<T>> {
  return NextResponse.json(
    {
      success: true,
      data,
    },
    { status }
  )
}

/**
 * Creates an error response manually (for non-exception errors).
 *
 * @param message - Error message
 * @param status - HTTP status code
 * @param details - Optional additional details
 * @returns NextResponse with ApiResponse body
 */
export function errorResponse(
  message: string,
  status: number = 400,
  details?: Record<string, unknown>
): NextResponse<ApiResponse> {
  return NextResponse.json(
    {
      success: false,
      error: message,
      ...(details && { details }),
    },
    { status }
  )
}
```

**Key design decisions:**
- ZodError handled specially with field-level details for AI debugging
- Known errors map to appropriate HTTP codes (409 Conflict, 404 Not Found)
- Never expose stack traces or internal details
- Always return `success: false` for errors
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Check file exports: `grep -E "^export" src/lib/agent/error-handler.ts`
  </verify>
  <done>error-handler.ts exists with handleApiError, successResponse, errorResponse exports</done>
</task>

<task type="auto">
  <name>Task 2: Extend audit logger with agent context</name>
  <files>src/lib/audit/logger.ts</files>
  <action>
Extend the existing `src/lib/audit/logger.ts` to support agent context:

1. **Add new agent-specific audit actions** to the AuditAction enum:
   ```typescript
   // Agent API actions (Phase 17+)
   AGENT_SEARCH_SLOTS = 'AGENT_SEARCH_SLOTS',
   AGENT_VIEW_APPOINTMENTS = 'AGENT_VIEW_APPOINTMENTS',
   AGENT_CREATE_APPOINTMENT = 'AGENT_CREATE_APPOINTMENT',
   AGENT_UPDATE_APPOINTMENT = 'AGENT_UPDATE_APPOINTMENT',
   AGENT_CANCEL_APPOINTMENT = 'AGENT_CANCEL_APPOINTMENT',
   AGENT_VIEW_PATIENT = 'AGENT_VIEW_PATIENT',
   AGENT_UPDATE_PATIENT = 'AGENT_UPDATE_PATIENT',
   AGENT_VIEW_INSTRUCTIONS = 'AGENT_VIEW_INSTRUCTIONS',
   AGENT_VIEW_PRE_CHECKIN = 'AGENT_VIEW_PRE_CHECKIN',
   AGENT_CONFIRM_APPOINTMENT = 'AGENT_CONFIRM_APPOINTMENT',
   AGENT_PROCESS_DOCUMENT = 'AGENT_PROCESS_DOCUMENT',
   ```

2. **Extend LogAuditParams interface** with optional agent fields:
   ```typescript
   interface LogAuditParams {
     userId: string
     action: AuditAction
     resource: string
     resourceId?: string
     details?: Record<string, any>
     ipAddress?: string
     userAgent?: string
     agentId?: string         // NEW: Agent identifier
     correlationId?: string   // NEW: Request chain tracking
   }
   ```

3. **Update logAudit function** to include agent context in details:
   ```typescript
   export async function logAudit(params: LogAuditParams): Promise<void> {
     try {
       await prisma.auditLog.create({
         data: {
           userId: params.userId,
           action: params.action,
           resource: params.resource,
           resourceId: params.resourceId,
           details: {
             ...(params.details || {}),
             ...(params.agentId && { agentId: params.agentId }),
             ...(params.correlationId && { correlationId: params.correlationId }),
           },
           ipAddress: params.ipAddress,
           userAgent: params.userAgent,
         },
       })
     } catch (error) {
       console.error('[AUDIT LOG FAILURE]', error)
     }
   }
   ```

**Important:**
- agentId and correlationId go into the `details` JSON field (not new columns)
- This maintains backward compatibility with existing audit queries
- correlationId enables tracing related API calls in a single conversation
  </action>
  <verify>
Run `npx tsc --noEmit` - no type errors.
Check new actions: `grep "AGENT_" src/lib/audit/logger.ts`
Check params include agentId: `grep "agentId" src/lib/audit/logger.ts`
  </verify>
  <done>logger.ts has AGENT_ actions in enum, LogAuditParams includes agentId and correlationId, logAudit stores them in details JSON</done>
</task>

</tasks>

<verification>
1. Run `npx tsc --noEmit` - no TypeScript errors
2. Check error-handler exports: `grep -c "export function" src/lib/agent/error-handler.ts` should be 3
3. Check audit actions: `grep -c "AGENT_" src/lib/audit/logger.ts` should be 11+
4. Verify interface change: `grep "agentId\|correlationId" src/lib/audit/logger.ts` shows both fields
</verification>

<success_criteria>
- src/lib/agent/error-handler.ts exists with handleApiError, successResponse, errorResponse
- handleApiError correctly handles ZodError with field-level details
- KNOWN_ERROR_STATUS_MAP includes common agent API errors
- AuditAction enum has 11 new AGENT_ actions
- LogAuditParams interface has optional agentId and correlationId
- logAudit function stores agentId and correlationId in details JSON
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/17-agent-api-foundation/17-02-SUMMARY.md`
</output>
