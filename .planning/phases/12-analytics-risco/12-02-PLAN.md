---
phase: 12-analytics-risco
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/components/analytics/risk-distribution-chart.tsx
  - src/components/analytics/predicted-vs-actual-chart.tsx
  - src/components/analytics/noshow-patterns-charts.tsx
  - src/app/admin/analytics/risco/page.tsx
  - src/app/admin/analytics/risco/risco-dashboard.tsx
  - src/components/layout/sidebar-nav.tsx
autonomous: true

must_haves:
  truths:
    - "User can see risk score distribution chart"
    - "User can see predicted vs actual correlation chart"
    - "User can see no-show patterns by day, time, and service"
    - "User can access risk analytics from navigation"
  artifacts:
    - path: "src/components/analytics/risk-distribution-chart.tsx"
      provides: "Bar chart showing risk level distribution"
      min_lines: 50
    - path: "src/components/analytics/predicted-vs-actual-chart.tsx"
      provides: "Chart comparing predictions to outcomes"
      min_lines: 50
    - path: "src/components/analytics/noshow-patterns-charts.tsx"
      provides: "Charts for day/time/service patterns"
      min_lines: 80
    - path: "src/app/admin/analytics/risco/page.tsx"
      provides: "Risk analytics page"
      exports: ["default"]
    - path: "src/app/admin/analytics/risco/risco-dashboard.tsx"
      provides: "Client component orchestrating charts"
  key_links:
    - from: "risco-dashboard.tsx"
      to: "/api/analytics/risco"
      via: "fetch in useEffect"
      pattern: "fetch.*api/analytics/risco"
    - from: "risco-dashboard.tsx"
      to: "chart components"
      via: "React imports"
      pattern: "import.*Chart"
    - from: "sidebar-nav.tsx"
      to: "/admin/analytics/risco"
      via: "navigation link"
      pattern: "analytics/risco"
---

<objective>
Create the UI layer for risk analytics: chart components and dashboard page.

Purpose: Visualize no-show risk data so staff can identify patterns and make informed decisions.
Output: New page at `/admin/analytics/risco` with distribution chart, correlation chart, and pattern analysis.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Depends on Plan 12-01 outputs
@.planning/phases/12-analytics-risco/12-01-SUMMARY.md

# Existing analytics UI patterns
@src/app/admin/analytics/analytics-dashboard.tsx
@src/components/analytics/kpi-cards.tsx
@src/components/analytics/insights-panel.tsx

# Existing page pattern
@src/app/admin/analytics/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create risk distribution chart component</name>
  <files>src/components/analytics/risk-distribution-chart.tsx</files>
  <action>
Create a bar chart component showing risk score distribution.

Use recharts library:
```typescript
'use client'

import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Cell } from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'

interface RiskDistributionData {
  riskLevel: string
  count: number
  percentage: number
}

interface RiskDistributionChartProps {
  data: RiskDistributionData[]
  loading?: boolean
}

// Color mapping matching existing risk colors
const RISK_COLORS = {
  'Baixo': '#22c55e',  // green-500
  'Medio': '#eab308',  // yellow-500
  'Alto': '#ef4444',   // red-500
}

export function RiskDistributionChart({ data, loading }: RiskDistributionChartProps) {
  // Loading skeleton
  if (loading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Distribuicao de Risco</CardTitle>
          <CardDescription>Como os pacientes sao classificados por risco de no-show</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="h-[300px] w-full bg-gray-100 animate-pulse rounded" />
        </CardContent>
      </Card>
    )
  }

  // Transform data for display (capitalize labels)
  const chartData = data.map(d => ({
    ...d,
    label: d.riskLevel.charAt(0).toUpperCase() + d.riskLevel.slice(1),
    displayLabel: `${d.riskLevel}: ${d.count} (${d.percentage.toFixed(1)}%)`,
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle>Distribuicao de Risco</CardTitle>
        <CardDescription>
          Como os pacientes sao classificados por risco de no-show
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[300px] w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData} layout="vertical">
              <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
              <XAxis type="number" />
              <YAxis dataKey="label" type="category" width={80} />
              <Tooltip
                formatter={(value: number, name: string) => [value, 'Pacientes']}
                labelFormatter={(label) => `Risco ${label}`}
              />
              <Bar dataKey="count" radius={[0, 4, 4, 0]}>
                {chartData.map((entry, index) => (
                  <Cell
                    key={`cell-${index}`}
                    fill={RISK_COLORS[entry.label as keyof typeof RISK_COLORS] || '#6b7280'}
                  />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
        {/* Legend with percentages */}
        <div className="flex justify-center gap-6 mt-4 text-sm">
          {chartData.map(d => (
            <div key={d.label} className="flex items-center gap-2">
              <div
                className="w-3 h-3 rounded"
                style={{ backgroundColor: RISK_COLORS[d.label as keyof typeof RISK_COLORS] }}
              />
              <span>{d.label}: {d.percentage.toFixed(1)}%</span>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

Key features:
- Horizontal bar chart for easy comparison
- Color-coded bars matching existing risk badge colors (green/yellow/red)
- Loading skeleton state
- Tooltip showing count and percentage
- Legend below chart
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>RiskDistributionChart component renders bar chart with risk levels</done>
</task>

<task type="auto">
  <name>Task 2: Create predicted vs actual and pattern charts</name>
  <files>src/components/analytics/predicted-vs-actual-chart.tsx, src/components/analytics/noshow-patterns-charts.tsx</files>
  <action>
**File 1: src/components/analytics/predicted-vs-actual-chart.tsx**

Create a grouped bar chart comparing predicted risk to actual outcomes:

```typescript
'use client'

import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'

interface PredictedVsActualData {
  predicted: string
  actualNoShow: number
  actualAttended: number
  accuracy: number
}

interface PredictedVsActualChartProps {
  data: PredictedVsActualData[]
  loading?: boolean
}

export function PredictedVsActualChart({ data, loading }: PredictedVsActualChartProps) {
  if (loading) {
    return (
      <Card>
        <CardHeader>
          <CardTitle>Predicao vs Resultado Real</CardTitle>
          <CardDescription>Comparacao entre risco previsto e comportamento real</CardDescription>
        </CardHeader>
        <CardContent>
          <div className="h-[300px] w-full bg-gray-100 animate-pulse rounded" />
        </CardContent>
      </Card>
    )
  }

  const chartData = data.map(d => ({
    ...d,
    label: d.predicted.charAt(0).toUpperCase() + d.predicted.slice(1),
    total: d.actualNoShow + d.actualAttended,
  }))

  return (
    <Card>
      <CardHeader>
        <CardTitle>Predicao vs Resultado Real</CardTitle>
        <CardDescription>
          Comparacao entre o risco previsto pelo sistema e o comportamento real dos pacientes
        </CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[300px] w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={chartData}>
              <CartesianGrid strokeDasharray="3 3" />
              <XAxis dataKey="label" />
              <YAxis />
              <Tooltip />
              <Legend />
              <Bar dataKey="actualNoShow" name="Faltou" fill="#ef4444" stackId="a" />
              <Bar dataKey="actualAttended" name="Compareceu" fill="#22c55e" stackId="a" />
            </BarChart>
          </ResponsiveContainer>
        </div>
        {/* Accuracy summary */}
        <div className="grid grid-cols-3 gap-4 mt-4 text-center text-sm">
          {chartData.map(d => (
            <div key={d.label} className="p-2 bg-gray-50 rounded">
              <div className="font-medium">Risco {d.label}</div>
              <div className="text-gray-500">
                {d.actualNoShow} faltas / {d.total} total
              </div>
              <div className={`font-semibold ${d.accuracy >= 70 ? 'text-green-600' : d.accuracy >= 50 ? 'text-yellow-600' : 'text-red-600'}`}>
                {d.accuracy.toFixed(0)}% precisao
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  )
}
```

**File 2: src/components/analytics/noshow-patterns-charts.tsx**

Create a component with three small bar charts for patterns:

```typescript
'use client'

import { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, Cell } from 'recharts'
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card'

interface PatternData {
  label: string
  noShowRate: number
  total: number
}

interface NoShowPatternsChartsProps {
  byDayOfWeek: { day: string; noShowRate: number; total: number }[]
  byTimeSlot: { slot: string; noShowRate: number; total: number }[]
  byService: { service: string; noShowRate: number; total: number }[]
  loading?: boolean
}

// Color scale for rate (higher = more red)
function getRateColor(rate: number): string {
  if (rate >= 25) return '#ef4444'  // red
  if (rate >= 15) return '#f97316'  // orange
  if (rate >= 10) return '#eab308'  // yellow
  return '#22c55e'  // green
}

function PatternBarChart({ data, title, description }: {
  data: PatternData[]
  title: string
  description: string
}) {
  return (
    <Card>
      <CardHeader className="pb-2">
        <CardTitle className="text-base">{title}</CardTitle>
        <CardDescription className="text-xs">{description}</CardDescription>
      </CardHeader>
      <CardContent>
        <div className="h-[200px] w-full">
          <ResponsiveContainer width="100%" height="100%">
            <BarChart data={data} layout="vertical">
              <XAxis type="number" domain={[0, 'dataMax']} tickFormatter={(v) => `${v}%`} />
              <YAxis dataKey="label" type="category" width={70} tick={{ fontSize: 11 }} />
              <Tooltip
                formatter={(value: number) => [`${value.toFixed(1)}%`, 'Taxa de Falta']}
                labelFormatter={(label) => label}
              />
              <Bar dataKey="noShowRate" radius={[0, 4, 4, 0]}>
                {data.map((entry, index) => (
                  <Cell key={`cell-${index}`} fill={getRateColor(entry.noShowRate)} />
                ))}
              </Bar>
            </BarChart>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}

export function NoShowPatternsCharts({ byDayOfWeek, byTimeSlot, byService, loading }: NoShowPatternsChartsProps) {
  if (loading) {
    return (
      <div className="grid gap-4 md:grid-cols-3">
        {[1, 2, 3].map(i => (
          <Card key={i}>
            <CardHeader className="pb-2">
              <div className="h-4 w-24 bg-gray-200 animate-pulse rounded" />
            </CardHeader>
            <CardContent>
              <div className="h-[200px] w-full bg-gray-100 animate-pulse rounded" />
            </CardContent>
          </Card>
        ))}
      </div>
    )
  }

  return (
    <div className="grid gap-4 md:grid-cols-3">
      <PatternBarChart
        data={byDayOfWeek.map(d => ({ label: d.day, noShowRate: d.noShowRate, total: d.total }))}
        title="Por Dia da Semana"
        description="Taxa de falta por dia"
      />
      <PatternBarChart
        data={byTimeSlot.map(d => ({ label: d.slot, noShowRate: d.noShowRate, total: d.total }))}
        title="Por Horario"
        description="Taxa de falta por periodo"
      />
      <PatternBarChart
        data={byService.slice(0, 6).map(d => ({ label: d.service.substring(0, 15), noShowRate: d.noShowRate, total: d.total }))}
        title="Por Servico"
        description="Taxa de falta por tipo"
      />
    </div>
  )
}
```

Key features:
- Three compact charts in a responsive grid
- Color-coded bars by rate severity
- Portuguese labels
- Limit services to top 6 for readability
- Loading skeleton states
  </action>
  <verify>npx tsc --noEmit passes</verify>
  <done>PredictedVsActualChart and NoShowPatternsCharts components created</done>
</task>

<task type="auto">
  <name>Task 3: Create risk analytics dashboard page</name>
  <files>src/app/admin/analytics/risco/risco-dashboard.tsx, src/app/admin/analytics/risco/page.tsx, src/components/layout/sidebar-nav.tsx</files>
  <action>
**File 1: src/app/admin/analytics/risco/risco-dashboard.tsx**

Create the client component that fetches data and renders charts:

```typescript
'use client'

import { useEffect, useState } from 'react'
import { Card, CardContent } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { AlertCircle, RefreshCw } from 'lucide-react'
import { RiskDistributionChart } from '@/components/analytics/risk-distribution-chart'
import { PredictedVsActualChart } from '@/components/analytics/predicted-vs-actual-chart'
import { NoShowPatternsCharts } from '@/components/analytics/noshow-patterns-charts'

interface RiskAnalyticsResponse {
  distribution: { riskLevel: string; count: number; percentage: number }[]
  predictedVsActual: { predicted: string; actualNoShow: number; actualAttended: number; accuracy: number }[]
  patterns: {
    byDayOfWeek: { day: string; noShowRate: number; total: number }[]
    byTimeSlot: { slot: string; noShowRate: number; total: number }[]
    byService: { service: string; noShowRate: number; total: number }[]
  }
  period: { start: string; end: string }
  totals: { reminders: number; appointments: number }
  generatedAt: string
}

export function RiscoDashboard() {
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [data, setData] = useState<RiskAnalyticsResponse | null>(null)
  const [lastRefreshed, setLastRefreshed] = useState<Date | null>(null)

  const fetchData = async () => {
    setLoading(true)
    setError(null)

    try {
      const response = await fetch('/api/analytics/risco?periodDays=30')

      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ error: 'Falha ao carregar' }))
        throw new Error(errorData.error || `Status ${response.status}`)
      }

      const analyticsData = await response.json() as RiskAnalyticsResponse
      setData(analyticsData)
      setLastRefreshed(new Date())
    } catch (err) {
      console.error('[RiscoDashboard] Error:', err)
      setError(err instanceof Error ? err.message : 'Erro ao carregar analytics')
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    fetchData()
    const interval = setInterval(fetchData, 5 * 60 * 1000)
    return () => clearInterval(interval)
  }, [])

  if (error && !data) {
    return (
      <Card>
        <CardContent className="p-8">
          <div className="flex flex-col items-center justify-center text-center">
            <AlertCircle className="h-12 w-12 text-red-500 mb-4" />
            <h3 className="text-lg font-semibold text-gray-900 mb-2">
              Erro ao carregar analytics de risco
            </h3>
            <p className="text-sm text-gray-500 mb-4">{error}</p>
            <Button onClick={fetchData} variant="outline">
              <RefreshCw className="h-4 w-4 mr-2" />
              Tentar novamente
            </Button>
          </div>
        </CardContent>
      </Card>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header with refresh */}
      <div className="flex items-center justify-between">
        <div>
          <p className="text-sm text-gray-500">
            Periodo: ultimos 30 dias
            {data?.totals && ` â€¢ ${data.totals.reminders} lembretes analisados`}
          </p>
        </div>
        {lastRefreshed && !loading && (
          <Button variant="ghost" size="sm" onClick={fetchData} className="text-gray-500">
            <RefreshCw className="h-4 w-4 mr-1" />
            Atualizar
          </Button>
        )}
      </div>

      {/* Distribution and Prediction charts */}
      <div className="grid gap-6 lg:grid-cols-2">
        <RiskDistributionChart
          data={data?.distribution || []}
          loading={loading}
        />
        <PredictedVsActualChart
          data={data?.predictedVsActual || []}
          loading={loading}
        />
      </div>

      {/* Pattern charts */}
      <section>
        <h2 className="text-lg font-semibold text-gray-900 mb-4">
          Padroes de No-Show
        </h2>
        <NoShowPatternsCharts
          byDayOfWeek={data?.patterns.byDayOfWeek || []}
          byTimeSlot={data?.patterns.byTimeSlot || []}
          byService={data?.patterns.byService || []}
          loading={loading}
        />
      </section>

      {/* Last updated */}
      {lastRefreshed && (
        <div className="text-center">
          <p className="text-xs text-gray-400">
            Ultima atualizacao: {lastRefreshed.toLocaleTimeString('pt-BR')}
          </p>
        </div>
      )}
    </div>
  )
}
```

**File 2: src/app/admin/analytics/risco/page.tsx**

Create the server component page:

```typescript
import { redirect } from 'next/navigation'
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { RiscoDashboard } from './risco-dashboard'
import { TrendingDown } from 'lucide-react'

export const metadata = {
  title: 'Analytics de Risco | Botfy ClinicOps',
  description: 'Analise de risco de no-show e padroes de faltas',
}

export default async function RiscoAnalyticsPage() {
  const user = await getCurrentUserWithRole()

  if (!user) {
    redirect('/auth/login')
  }

  // Only ADMIN can access risk analytics
  if (user.role !== 'ADMIN') {
    redirect('/admin')
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900 flex items-center gap-2">
            <TrendingDown className="h-6 w-6" />
            Analytics de Risco No-Show
          </h1>
          <p className="text-sm text-gray-500 mt-1">
            Analise de distribuicao de risco, precisao de predicoes e padroes de faltas
          </p>
        </div>
      </div>

      <RiscoDashboard />
    </div>
  )
}
```

**File 3: Update src/components/layout/sidebar-nav.tsx**

Add navigation link to risk analytics. Find the existing Analytics link and add a submenu item or add a new link below it:

```typescript
// Find the Analytics entry (around line with BarChart3 icon)
// Add after it or update to include submenu

// Option 1: Add as separate link after Analytics
{
  name: 'Risco No-Show',
  href: '/admin/analytics/risco',
  icon: TrendingDown,
  adminOnly: true,
}

// Import TrendingDown from lucide-react at top of file
```

Place the new link after the existing Analytics link. Use the same adminOnly: true pattern.
  </action>
  <verify>npm run build succeeds and page is accessible at /admin/analytics/risco</verify>
  <done>Risk analytics page accessible from navigation with all charts rendering</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] All component files created
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run build` succeeds
- [ ] Navigation link appears in sidebar for ADMIN users
- [ ] Page loads at /admin/analytics/risco
- [ ] Charts render with loading states
</verification>

<success_criteria>

- Risk distribution chart shows score levels with percentages
- Predicted vs actual chart compares predictions to outcomes
- Pattern charts show day/time/service breakdowns
- Dashboard page integrates all charts
- Navigation link added to sidebar
- All ANLT-01 through ANLT-05 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-risco/12-02-SUMMARY.md`
</output>
