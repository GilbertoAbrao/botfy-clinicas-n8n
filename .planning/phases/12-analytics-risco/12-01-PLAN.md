---
phase: 12-analytics-risco
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/analytics/risk-calculator.ts
  - src/app/api/analytics/risco/route.ts
autonomous: true

must_haves:
  truths:
    - "API returns risk score distribution data"
    - "API returns predicted vs actual correlation data"
    - "API returns no-show patterns by day, time, and service"
  artifacts:
    - path: "src/lib/analytics/risk-calculator.ts"
      provides: "Risk aggregation functions"
      min_lines: 100
      exports: ["calculateRiskDistribution", "calculatePredictedVsActual", "calculateNoShowPatterns"]
    - path: "src/app/api/analytics/risco/route.ts"
      provides: "GET endpoint for risk analytics"
      exports: ["GET"]
  key_links:
    - from: "api/analytics/risco"
      to: "risk-calculator.ts"
      via: "function imports"
      pattern: "import.*risk-calculator"
    - from: "risk-calculator.ts"
      to: "prisma"
      via: "database queries"
      pattern: "prisma\\.(lembreteEnviado|appointment)"
---

<objective>
Create the backend infrastructure for risk analytics: data aggregation calculator and API endpoint.

Purpose: Provide the data layer that charts will consume to visualize no-show risk patterns.
Output: Working API at `/api/analytics/risco` returning structured data for charts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior work context
@.planning/phases/11-lembretes-enviados/11-01-SUMMARY.md

# Existing patterns
@src/lib/analytics/kpi-calculator.ts
@src/app/api/analytics/route.ts
@src/lib/validations/lembrete-enviado.ts

# Data source
@src/app/api/lembretes-enviados/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install recharts library</name>
  <files>package.json</files>
  <action>
Install recharts for chart visualization:

```bash
npm install recharts
```

This is a widely-used React charting library that works well with Next.js and provides:
- ResponsiveContainer for responsive charts
- BarChart, LineChart, PieChart for different visualizations
- Tooltip, Legend components for interactivity

Do NOT install @types/recharts - recharts includes TypeScript types.
  </action>
  <verify>npm ls recharts shows package installed</verify>
  <done>recharts appears in package.json dependencies</done>
</task>

<task type="auto">
  <name>Task 2: Create risk analytics calculator</name>
  <files>src/lib/analytics/risk-calculator.ts</files>
  <action>
Create a new file that aggregates risk data from `lembretes_enviados` joined with `agendamentos`.

Functions to implement:

**1. calculateRiskDistribution(periodDays: number)**
Returns array of { riskLevel: 'baixo'|'medio'|'alto', count: number, percentage: number }
- Query lembretes_enviados with risco_noshow not null
- Group by risk level: baixo (0-39), medio (40-69), alto (70-100)
- Calculate percentages

**2. calculatePredictedVsActual(periodDays: number)**
Returns array of { predicted: 'baixo'|'medio'|'alto', actualNoShow: number, actualAttended: number }
- Join lembretes_enviados with agendamentos
- Filter appointments that have passed (data_hora < now)
- Group by risk level
- For each group, count how many resulted in no_show vs attended (concluida/confirmada)

**3. calculateNoShowPatterns(periodDays: number)**
Returns object with:
- byDayOfWeek: { dayName: string, noShowRate: number, total: number }[]
- byTimeSlot: { timeSlot: string, noShowRate: number, total: number }[]
- byService: { serviceName: string, noShowRate: number, total: number }[]

Query agendamentos where status = 'nao_compareceu' or 'concluida'/'confirmada'
Group by:
- Day of week (use EXTRACT in Prisma raw query or date-fns on results)
- Time slot (morning 6-12, afternoon 12-18, evening 18-22)
- Service type (join with servicos table)

**Interface for response:**
```typescript
export interface RiskAnalyticsData {
  distribution: { riskLevel: string; count: number; percentage: number }[]
  predictedVsActual: { predicted: string; actualNoShow: number; actualAttended: number; accuracy: number }[]
  patterns: {
    byDayOfWeek: { day: string; noShowRate: number; total: number }[]
    byTimeSlot: { slot: string; noShowRate: number; total: number }[]
    byService: { service: string; noShowRate: number; total: number }[]
  }
  period: { start: Date; end: Date }
  totals: { reminders: number; appointments: number }
}
```

Follow existing patterns from `kpi-calculator.ts`:
- Use prisma client from `@/lib/prisma`
- Use date-fns for date manipulation
- Handle empty data gracefully (return zeros, not errors)
- Add JSDoc comments

Day names in Portuguese: Domingo, Segunda, Terca, Quarta, Quinta, Sexta, Sabado
Time slots in Portuguese: Manha (6-12), Tarde (12-18), Noite (18-22)
  </action>
  <verify>npx tsc --noEmit passes with no errors</verify>
  <done>File exports calculateRiskDistribution, calculatePredictedVsActual, calculateNoShowPatterns functions</done>
</task>

<task type="auto">
  <name>Task 3: Create risk analytics API endpoint</name>
  <files>src/app/api/analytics/risco/route.ts</files>
  <action>
Create GET endpoint that returns risk analytics data.

Follow existing patterns from `/api/analytics/route.ts`:
- Authentication check with getCurrentUserWithRole()
- Role check: ADMIN or ATENDENTE (VIEW_REPORTS equivalent)
- Query param: periodDays (default 30, max 90)
- Error handling with try/catch
- Audit logging (optional, follow existing pattern)

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { getCurrentUserWithRole } from '@/lib/auth/session'
import {
  calculateRiskDistribution,
  calculatePredictedVsActual,
  calculateNoShowPatterns,
  type RiskAnalyticsData
} from '@/lib/analytics/risk-calculator'

export async function GET(request: NextRequest) {
  try {
    const user = await getCurrentUserWithRole()
    if (!user) {
      return NextResponse.json({ error: 'Nao autenticado' }, { status: 401 })
    }

    // ADMIN or ATENDENTE can view analytics
    if (!['ADMIN', 'ATENDENTE'].includes(user.role)) {
      return NextResponse.json({ error: 'Sem permissao' }, { status: 403 })
    }

    const { searchParams } = new URL(request.url)
    const periodDays = Math.min(
      parseInt(searchParams.get('periodDays') || '30', 10),
      90
    )

    const [distribution, predictedVsActual, patterns] = await Promise.all([
      calculateRiskDistribution(periodDays),
      calculatePredictedVsActual(periodDays),
      calculateNoShowPatterns(periodDays),
    ])

    const response: RiskAnalyticsData = {
      distribution,
      predictedVsActual,
      patterns,
      period: {
        start: new Date(Date.now() - periodDays * 24 * 60 * 60 * 1000),
        end: new Date(),
      },
      totals: {
        reminders: distribution.reduce((sum, d) => sum + d.count, 0),
        appointments: patterns.byDayOfWeek.reduce((sum, d) => sum + d.total, 0),
      },
      generatedAt: new Date().toISOString(),
    }

    return NextResponse.json(response)
  } catch (error) {
    console.error('Error fetching risk analytics:', error)
    return NextResponse.json(
      { error: 'Erro ao calcular analytics de risco' },
      { status: 500 }
    )
  }
}
```

Ensure the file handles edge cases:
- No data in period: return empty arrays with zeros
- Missing risco_noshow: filter out null values
- Division by zero: check totals before calculating percentages
  </action>
  <verify>curl localhost:3000/api/analytics/risco (with auth) returns JSON with distribution, predictedVsActual, patterns</verify>
  <done>GET /api/analytics/risco returns structured risk analytics data</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm ls recharts` shows recharts installed
- [ ] `npx tsc --noEmit` passes without errors
- [ ] `npm run build` succeeds
- [ ] API endpoint compiles and exports GET function
- [ ] Calculator exports all three functions
</verification>

<success_criteria>

- recharts library installed
- Risk calculator with 3 aggregation functions
- API endpoint returning structured data
- All TypeScript types defined and exported
- No build errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-analytics-risco/12-01-SUMMARY.md`
</output>
