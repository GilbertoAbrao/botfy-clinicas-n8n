---
phase: 25-document-tool-migration
plan: 02
type: execute
wave: 2
depends_on: [25-01]
files_modified:
  - N8N Workflow bPJamJhBcrVCKgBg (via MCP API)
autonomous: true

must_haves:
  truths:
    - "AI Agent uses toolHttpRequest (not toolWorkflow) for processar_documento"
    - "Tool sends JSON body with patientId and imageUrl parameters"
    - "Tool calls POST /api/agent/documentos/processar endpoint"
    - "Tool uses Bearer token authentication"
  artifacts:
    - path: "N8N workflow bPJamJhBcrVCKgBg"
      provides: "processar_documento as toolHttpRequest"
      contains: "toolHttpRequest"
  key_links:
    - from: "N8N processar_documento tool"
      to: "/api/agent/documentos/processar"
      via: "HTTP POST with JSON body"
      pattern: "imageUrl"
---

<objective>
Migrate the `processar_documento` tool from N8N toolWorkflow to toolHttpRequest.

Purpose: Complete the HTTP tools migration by replacing the last toolWorkflow node with a direct HTTP call to the enhanced API.

Output: AI Agent workflow uses toolHttpRequest for document processing, calling the URL-enhanced API from Plan 25-01.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-document-tool-migration/25-RESEARCH.md
@.planning/phases/25-document-tool-migration/25-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove old toolWorkflow node</name>
  <files>N8N Workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use N8N MCP to remove the existing `processar_documento` toolWorkflow node.

First, get the workflow to find the exact node:
```
mcp__n8n__get_workflow({ workflowId: "bPJamJhBcrVCKgBg" })
```

Find the node with:
- Name: `processar_documento`
- Type: `@n8n/n8n-nodes-langchain.toolWorkflow`

Record its position for the new node placement.

Then remove:
```
mcp__n8n__delete_node({
  workflowId: "bPJamJhBcrVCKgBg",
  nodeName: "processar_documento"
})
```

Note: The sub-workflow ID Pc0PyATrZaGefiSJ will be archived in Phase 26.
  </action>
  <verify>
Get workflow and confirm processar_documento toolWorkflow node no longer exists.
  </verify>
  <done>
Old toolWorkflow node removed from AI Agent workflow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add new toolHttpRequest node</name>
  <files>N8N Workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use N8N MCP to add the new toolHttpRequest node for processar_documento.

Node configuration:
```json
{
  "id": "tool-processar-documento-http",
  "name": "processar_documento",
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 1.1,
  "position": [position from removed node],
  "parameters": {
    "name": "processar_documento",
    "toolDescription": "Processa documento enviado pelo paciente (RG, CNH, carteirinha de convenio, guia de autorizacao). Extrai dados automaticamente via OCR/IA. Parametros obrigatorios: patientId (ID do paciente), imageUrl (URL HTTPS da imagem do documento). Retorna campos extraidos, tipo de documento detectado e nivel de confianca.",
    "method": "POST",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/documentos/processar",
    "authentication": "predefinedCredentialType",
    "nodeCredentialType": "httpHeaderAuth",
    "sendBody": true,
    "specifyBody": "json",
    "jsonBody": "={{ JSON.stringify({ patientId: \"{patientId}\", imageUrl: \"{imageUrl}\" }) }}",
    "placeholderDefinitions": {
      "values": [
        {
          "name": "patientId",
          "description": "ID do paciente que enviou o documento (obrigatorio)"
        },
        {
          "name": "imageUrl",
          "description": "URL HTTPS completa da imagem do documento (obrigatorio)"
        }
      ]
    }
  },
  "credentials": {
    "httpHeaderAuth": {
      "id": "5TaXKqsLaosPr7U9",
      "name": "Botfy Agent API"
    }
  }
}
```

Add the node:
```
mcp__n8n__create_node({
  workflowId: "bPJamJhBcrVCKgBg",
  nodeData: { ... above config ... }
})
```

Key differences from toolWorkflow:
- Sends JSON body (not workflow input)
- Uses placeholders {patientId} and {imageUrl} interpolated by AI Agent
- Direct HTTP call to Next.js API
  </action>
  <verify>
Get workflow and confirm processar_documento exists with type toolHttpRequest.
  </verify>
  <done>
New toolHttpRequest node created with correct configuration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Connect node to AI Agent</name>
  <files>N8N Workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Add ai_tool connection from the new processar_documento node to the AI Agent node.

First, identify the AI Agent node name (likely "AI Agent" or similar).

Then create connection:
```
mcp__n8n__create_connection({
  workflowId: "bPJamJhBcrVCKgBg",
  sourceNode: "processar_documento",
  targetNode: "AI Agent",
  sourceOutput: "ai_tool",
  targetInput: "ai_tool"
})
```

The ai_tool connection type allows the AI Agent to invoke this tool during conversations.
  </action>
  <verify>
Get workflow and confirm connection exists from processar_documento to AI Agent with type ai_tool.
  </verify>
  <done>
Tool connected to AI Agent for invocation.
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify migration</name>
  <files>N8N Workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Final verification of the migration:

1. Get full workflow:
```
mcp__n8n__get_workflow({ workflowId: "bPJamJhBcrVCKgBg" })
```

2. Verify processar_documento node:
   - Type is `@n8n/n8n-nodes-langchain.toolHttpRequest` (NOT toolWorkflow)
   - URL contains `/api/agent/documentos/processar`
   - Method is POST
   - JSON body contains patientId and imageUrl placeholders
   - Credentials reference "Botfy Agent API"

3. Verify connection:
   - ai_tool connection exists from processar_documento to AI Agent

4. Activate workflow if it was deactivated during migration:
```
mcp__n8n__activate_workflow({ workflowId: "bPJamJhBcrVCKgBg" })
```

Report final state: tool type, endpoint, parameters, connection status.
  </action>
  <verify>
All checks pass: correct type, endpoint, parameters, credentials, and connection.
  </verify>
  <done>
Migration verified complete. processar_documento now uses toolHttpRequest.
  </done>
</task>

</tasks>

<verification>
- [ ] Old processar_documento toolWorkflow node removed
- [ ] New processar_documento toolHttpRequest node created
- [ ] Node type is `@n8n/n8n-nodes-langchain.toolHttpRequest`
- [ ] Method is POST
- [ ] URL is `={{ $env.AGENT_API_URL }}/api/agent/documentos/processar`
- [ ] JSON body template includes patientId and imageUrl
- [ ] Placeholder definitions for patientId and imageUrl exist
- [ ] httpHeaderAuth credential "Botfy Agent API" configured
- [ ] ai_tool connection to AI Agent established
- [ ] Workflow is active
</verification>

<success_criteria>
1. AI Agent workflow has no toolWorkflow nodes remaining for processar_documento
2. processar_documento is a toolHttpRequest node
3. Tool calls POST /api/agent/documentos/processar with JSON body
4. Tool is connected to AI Agent via ai_tool connection
5. Workflow is active and ready for use
</success_criteria>

<output>
After completion, create `.planning/phases/25-document-tool-migration/25-02-SUMMARY.md`
</output>
