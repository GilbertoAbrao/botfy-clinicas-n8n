# Plan 07-03: User Management

**Phase:** 07-system-configuration
**Plan:** 03
**Wave:** 2 (Parallel with 07-02, 07-04)
**Estimated Scope:** Medium (API + UI)

---

## Objective

Admin interface for managing system users - list, create, edit roles, deactivate. Uses existing User model.

---

## Requirements Covered

- CONF-09: User can view list of system users
- CONF-10: User can create new user account (email, senha, role)
- CONF-11: User can edit user account (email, role)
- CONF-12: User can deactivate user account
- CONF-13: User can assign roles (Admin, Atendente) to users

---

## Tasks

### Task 1: Create Users API Endpoints

Create API routes for user management operations.

**Files:**
- `src/app/api/usuarios/route.ts` - GET (list), POST (create)
- `src/app/api/usuarios/[id]/route.ts` - GET (single), PUT (update), DELETE/PATCH (deactivate)

**Acceptance:**
- GET /api/usuarios returns user list (id, email, role, createdAt, active status)
- POST /api/usuarios creates user via Supabase Auth + users table
- PUT /api/usuarios/[id] updates user role and email
- PATCH /api/usuarios/[id] toggles active status
- All routes require ADMIN role (checkPermission with MANAGE_USERS)
- All routes have audit logging
- Cannot deactivate own account
- Cannot change own role

### Task 2: Add Active Field to User Model

Add ativo field to User model for soft-delete/deactivation.

**Files:**
- `prisma/schema.prisma` - Add ativo Boolean field to User

**Migration:**
```bash
npx prisma migrate dev --name add_user_ativo_field
```

**Acceptance:**
- User model has ativo: Boolean @default(true)
- Migration applied successfully
- Existing users default to ativo = true

### Task 3: Create Zod Validation Schema

Create validation schema for user data.

**Files:**
- `src/lib/validations/user.ts` - userSchema, createUserSchema

**Acceptance:**
- createUserSchema validates: email (email format), password (min 8 chars), role (ADMIN or ATENDENTE)
- updateUserSchema validates: email, role (password optional for updates)
- Export schemas and types

### Task 4: Create Users List Page

Create admin page showing all users with search and filters.

**Files:**
- `src/app/admin/usuarios/page.tsx` - Users list page
- `src/components/users/user-table.tsx` - Table component

**Acceptance:**
- Page at /admin/usuarios shows all users
- Table shows: email, role (badge), status (Ativo/Inativo badge), createdAt
- Filter by role (Todos, Admin, Atendente)
- Filter by status (Todos, Ativos, Inativos)
- Empty state (unlikely but handle)
- Current user row highlighted

### Task 5: Create User Form Modal

Create modal for creating and editing users.

**Files:**
- `src/components/users/user-form-modal.tsx` - Form modal

**Acceptance:**
- Create mode: email, password, password confirmation, role select
- Edit mode: email, role select (no password field - separate flow)
- Password requirements shown (min 8 chars)
- Form validation with error messages
- Role selector with ADMIN and ATENDENTE options
- Warning when creating ADMIN user
- Loading state during save
- Success/error toasts

### Task 6: Add User Actions

Add action buttons for edit, toggle active, and role assignment.

**Files:**
- `src/components/users/user-actions.tsx` - Action dropdown

**Acceptance:**
- Edit button opens edit modal
- Toggle active button (deactivate/reactivate)
- Deactivate requires confirmation
- Cannot deactivate own account (button disabled)
- Cannot change own role (dropdown disabled for self)
- Audit logging for all actions

### Task 7: Update Navigation

Add Usuários link to admin sidebar.

**Files:**
- Relevant navigation component

**Acceptance:**
- "Usuários" link visible in admin navigation
- Link only shows for ADMIN role
- Active state when on /admin/usuarios

---

## Must-Haves (Verification Checklist)

```
[ ] User model has ativo field with default true
[ ] GET /api/usuarios returns user list (ADMIN only)
[ ] POST /api/usuarios creates user via Supabase Auth (ADMIN only)
[ ] PUT /api/usuarios/[id] updates user role/email (ADMIN only)
[ ] PATCH /api/usuarios/[id] toggles ativo status (ADMIN only)
[ ] All API routes have RBAC check (MANAGE_USERS)
[ ] All API routes have audit logging
[ ] Cannot deactivate own account (API validation)
[ ] Cannot change own role (API validation)
[ ] /admin/usuarios page loads user list
[ ] User table shows email, role badge, status badge, createdAt
[ ] Create modal with email, password, role works
[ ] Edit modal with email, role works
[ ] Deactivate button shows confirmation
[ ] npm run build compiles without errors
```

---

## Dependencies

**Requires:**
- Plan 07-01 complete (if adding ativo field requires coordinated migration)
- Phase 1 (Supabase Auth integration)

**Provides:**
- User management for clinic admins
- Role assignment capability

---

## Patterns to Follow

- API routes: Copy pattern from `src/app/api/pacientes/route.ts`
- User creation: Use Supabase Auth admin.createUser() for auth, then upsert users table
- Table component: Copy pattern from `src/components/patients/patient-table.tsx`
- RBAC: Use checkPermission(role, PERMISSIONS.MANAGE_USERS)
- Audit: Add CREATE_USER, UPDATE_USER, DEACTIVATE_USER to AuditAction enum

---

## Notes

- User creation goes through Supabase Auth first, then syncs to users table
- Password resets should use Supabase Auth flow (not custom implementation)
- Deactivated users cannot log in (check in auth flow)
- Cannot delete users (only deactivate) to preserve audit trail
- Self-modification restrictions prevent admin lockout scenarios
