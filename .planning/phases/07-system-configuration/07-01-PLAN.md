# Plan 07-01: Database Schema for Configuration

**Phase:** 07-system-configuration
**Plan:** 01
**Wave:** 1 (Foundation - must complete before other plans)
**Estimated Scope:** Small (schema + migration only)

---

## Objective

Create Prisma models for Service and ClinicSettings to support system configuration features.

---

## Requirements Covered

This plan creates foundation for:
- CONF-01 to CONF-08 (business hours, services)
- CONF-14 (notification preferences)

---

## Tasks

### Task 1: Create Service Model

Add Service model to Prisma schema with fields for nome, duration, price, and active status.

**Files:**
- `prisma/schema.prisma` - Add Service model

**Acceptance:**
- Service model exists with: id, nome, duracao (Int minutes), preco (Decimal), ativo (Boolean), createdAt, updatedAt
- Index on nome for search
- Index on ativo for filtering active services

### Task 2: Create ClinicSettings Model

Add ClinicSettings model for business hours and global settings. Single-row design (one settings record per clinic).

**Files:**
- `prisma/schema.prisma` - Add ClinicSettings model

**Acceptance:**
- ClinicSettings model exists with:
  - id (singleton pattern - always 'default')
  - businessHours (Json) - structure: `{ monday: { open: "09:00", close: "18:00" }, ... }`
  - lunchBreak (Json) - structure: `{ start: "12:00", end: "13:00" }`
  - antecedenciaMinima (Int) - minimum hours before appointment
  - notificationPreferences (Json) - future flexibility
  - updatedAt
- Singleton pattern enforced (id = 'default')

### Task 3: Run Prisma Migration

Generate and apply migration for new models.

**Commands:**
```bash
npx prisma migrate dev --name add_service_and_clinic_settings
npx prisma generate
```

**Acceptance:**
- Migration file created in `prisma/migrations/`
- `npx prisma generate` succeeds
- `npm run build` compiles without errors

### Task 4: Seed Default ClinicSettings

Create seed data for default clinic settings.

**Files:**
- `prisma/seed.ts` - Add default ClinicSettings if not exists

**Acceptance:**
- Default settings created with:
  - Mon-Fri: 09:00-18:00
  - Sat-Sun: closed
  - Lunch: 12:00-13:00
  - antecedenciaMinima: 24 (hours)
- Seed is idempotent (can run multiple times)

---

## Must-Haves (Verification Checklist)

```
[ ] Service model exists in prisma/schema.prisma
[ ] Service has fields: id, nome, duracao, preco, ativo, createdAt, updatedAt
[ ] Service has index on nome and ativo
[ ] ClinicSettings model exists in prisma/schema.prisma
[ ] ClinicSettings has fields: id, businessHours, lunchBreak, antecedenciaMinima, notificationPreferences, updatedAt
[ ] ClinicSettings uses singleton pattern (id = 'default')
[ ] Migration file exists in prisma/migrations/
[ ] npx prisma generate succeeds
[ ] npm run build compiles without errors
[ ] Default ClinicSettings seed exists
```

---

## Dependencies

**Requires:**
- Phase 1 complete (Prisma setup exists)

**Provides:**
- Service model for Plan 07-02 (Services CRUD)
- ClinicSettings model for Plan 07-04 (Business Hours)

**Blocks:**
- Plan 07-02, 07-04 cannot start until this plan completes

---

## Notes

- Service model separate from Appointment.serviceType (string) - this allows structured service management while keeping appointments simple
- ClinicSettings uses Json fields for flexibility - avoids schema changes when adding new hour formats
- Singleton pattern for ClinicSettings - only one settings row needed (no multi-clinic support in v1)
- Decimal for preco to avoid floating-point money issues
