# Plan 07-02: Services CRUD

**Phase:** 07-system-configuration
**Plan:** 02
**Wave:** 2 (Parallel with 07-03, 07-04)
**Estimated Scope:** Medium (API + UI)

---

## Objective

Full CRUD for clinic services - list, create, edit, activate/deactivate, delete. Admin-only access.

---

## Requirements Covered

- CONF-03: User can view list of services offered
- CONF-04: User can create new service (nome, duração, preço, ativo/inativo)
- CONF-05: User can edit existing service
- CONF-06: User can activate/deactivate service
- CONF-07: User can delete service

---

## Tasks

### Task 1: Create Services API Endpoints

Create API routes for services CRUD operations.

**Files:**
- `src/app/api/servicos/route.ts` - GET (list), POST (create)
- `src/app/api/servicos/[id]/route.ts` - GET (single), PUT (update), DELETE

**Acceptance:**
- GET /api/servicos returns paginated list with filters (ativo, q)
- POST /api/servicos creates service with validation
- GET /api/servicos/[id] returns single service
- PUT /api/servicos/[id] updates service
- DELETE /api/servicos/[id] deletes service (or soft-delete if appointments exist)
- All routes require ADMIN role (checkPermission with MANAGE_SYSTEM_CONFIG)
- All routes have audit logging

### Task 2: Create Zod Validation Schema

Create validation schema for service data.

**Files:**
- `src/lib/validations/service.ts` - serviceSchema

**Acceptance:**
- Schema validates: nome (min 2 chars), duracao (5-480 minutes), preco (0+), ativo (boolean)
- Schema handles optional fields correctly
- Export serviceSchema and type ServiceInput

### Task 3: Create Services List Page

Create admin page showing all services with search and filters.

**Files:**
- `src/app/admin/servicos/page.tsx` - Services list page
- `src/components/services/service-table.tsx` - Table component
- `src/components/services/service-search.tsx` - Search/filter component

**Acceptance:**
- Page at /admin/servicos shows all services
- Table shows: nome, duração (formatted), preço (R$ formatted), status badge
- Search by nome
- Filter by ativo status (Todos, Ativos, Inativos)
- Empty state with "Criar Serviço" CTA
- Responsive (table on desktop, cards on mobile)

### Task 4: Create Service Form Modal

Create modal for creating and editing services.

**Files:**
- `src/components/services/service-form-modal.tsx` - Form modal

**Acceptance:**
- Modal with form fields: nome, duracao (number input), preco (currency input), ativo (switch)
- Pre-fills data when editing
- Form validation with error messages
- Loading state during save
- Success/error toasts
- Closes on success

### Task 5: Add Toggle Active and Delete Actions

Add action buttons for activate/deactivate and delete.

**Files:**
- `src/components/services/service-actions.tsx` - Action buttons/dropdown

**Acceptance:**
- Toggle active button (switches ativo status)
- Delete button with confirmation dialog
- Delete shows warning if service has appointments
- Optimistic UI update for toggle
- Audit logging for all actions

### Task 6: Update Navigation

Add Serviços link to admin sidebar.

**Files:**
- `src/components/layout/sidebar.tsx` - Add Serviços link (if exists)
- Or relevant navigation component

**Acceptance:**
- "Serviços" link visible in admin navigation
- Link only shows for ADMIN role
- Active state when on /admin/servicos

---

## Must-Haves (Verification Checklist)

```
[ ] GET /api/servicos returns service list with pagination
[ ] POST /api/servicos creates service (ADMIN only)
[ ] PUT /api/servicos/[id] updates service (ADMIN only)
[ ] DELETE /api/servicos/[id] deletes service (ADMIN only)
[ ] All API routes have RBAC check (MANAGE_SYSTEM_CONFIG)
[ ] All API routes have audit logging
[ ] /admin/servicos page loads service list
[ ] Service table shows nome, duração, preço, status
[ ] Search filters services by nome
[ ] Filter switches between all/active/inactive
[ ] Create modal opens and creates new service
[ ] Edit modal opens with pre-filled data and saves changes
[ ] Toggle active button works with optimistic UI
[ ] Delete button shows confirmation and deletes
[ ] npm run build compiles without errors
```

---

## Dependencies

**Requires:**
- Plan 07-01 complete (Service model exists)
- Phase 1 (auth, RBAC, audit logging)

**Provides:**
- Services management UI for clinic staff
- Service list for appointment booking (future integration)

---

## Patterns to Follow

- API routes: Copy pattern from `src/app/api/pacientes/route.ts`
- Table component: Copy pattern from `src/components/patients/patient-table.tsx`
- Form modal: Copy pattern from existing modals (RescheduleModal)
- RBAC: Use checkPermission(role, PERMISSIONS.MANAGE_SYSTEM_CONFIG)
- Audit: Use logAudit with appropriate action (CREATE_SERVICE, UPDATE_SERVICE, DELETE_SERVICE - add to AuditAction enum)

---

## Notes

- Services are separate from Appointment.serviceType - serviceType is a string for flexibility
- Future enhancement: Link services to providers (which providers offer which services)
- Price stored as Decimal in DB, displayed with R$ formatting
- Duration stored as Int (minutes), displayed as "1h 30min" format
