# Plan 07-04: Business Hours & Notification Preferences

**Phase:** 07-system-configuration
**Plan:** 04
**Wave:** 2 (Parallel with 07-02, 07-03)
**Estimated Scope:** Medium (API + UI)

---

## Objective

Configure clinic business hours, lunch breaks, booking lead time, and notification preferences. Single settings page for all global configuration.

---

## Requirements Covered

- CONF-01: User can configure business hours (days of week, opening/closing times)
- CONF-02: User can configure lunch break hours
- CONF-08: User can configure antecedência mínima for appointments
- CONF-14: User can configure notification preferences

---

## Tasks

### Task 1: Create Settings API Endpoint

Create API route for reading and updating clinic settings.

**Files:**
- `src/app/api/configuracoes/route.ts` - GET (read), PUT (update)

**Acceptance:**
- GET /api/configuracoes returns current ClinicSettings (creates default if not exists)
- PUT /api/configuracoes updates settings with validation
- Requires ADMIN role (checkPermission with MANAGE_SYSTEM_CONFIG)
- Audit logging for all changes
- Returns updated settings after PUT

### Task 2: Create Zod Validation Schema

Create validation schema for settings data.

**Files:**
- `src/lib/validations/clinic-settings.ts` - clinicSettingsSchema

**Acceptance:**
- businessHours schema validates day objects with open/close times (HH:mm format)
- lunchBreak schema validates start/end times
- antecedenciaMinima validates number (1-168 hours = 1 week max)
- notificationPreferences validates boolean flags
- Schema handles partial updates

### Task 3: Create Settings Page Layout

Create admin settings page with tabbed or sectioned layout.

**Files:**
- `src/app/admin/configuracoes/page.tsx` - Settings page

**Acceptance:**
- Page at /admin/configuracoes
- Sections: Horário de Funcionamento, Preferências de Agendamento, Notificações
- Server component that loads current settings
- Clear section headers with descriptions

### Task 4: Create Business Hours Form

Create form for configuring business hours per day.

**Files:**
- `src/components/settings/business-hours-form.tsx` - Business hours form

**Acceptance:**
- Shows all 7 days of week
- Each day has: checkbox (open/closed), open time, close time
- Time inputs with 30-min increments (09:00, 09:30, etc.)
- Disabled times when day is closed
- "Copiar para todos os dias úteis" helper button
- Save button with loading state
- Validation: close time must be after open time

### Task 5: Create Lunch Break Form

Create form for configuring lunch break hours.

**Files:**
- `src/components/settings/lunch-break-form.tsx` - Lunch break form

**Acceptance:**
- Start time and end time inputs
- Optional "Sem horário de almoço" checkbox
- Validation: within business hours, reasonable duration (30min-3h)
- Save button with loading state

### Task 6: Create Booking Settings Form

Create form for antecedência mínima setting.

**Files:**
- `src/components/settings/booking-settings-form.tsx` - Booking settings form

**Acceptance:**
- Number input for antecedência mínima (hours)
- Helper text explaining setting
- Presets: 24h (1 dia), 48h (2 dias), 72h (3 dias)
- Save button with loading state

### Task 7: Create Notification Preferences Form

Create form for notification settings.

**Files:**
- `src/components/settings/notification-preferences-form.tsx` - Notifications form

**Acceptance:**
- Toggle switches for different notification types:
  - Alerta de conversa travada
  - Alerta de no-show
  - Resumo diário por email
- Save button with loading state
- Note: "Notificações são enviadas via N8N workflows"

### Task 8: Update Navigation

Add Configurações link to admin sidebar.

**Files:**
- Relevant navigation component

**Acceptance:**
- "Configurações" link visible in admin navigation
- Link only shows for ADMIN role
- Active state when on /admin/configuracoes

---

## Must-Haves (Verification Checklist)

```
[ ] GET /api/configuracoes returns current settings (creates default if needed)
[ ] PUT /api/configuracoes updates settings (ADMIN only)
[ ] API has RBAC check (MANAGE_SYSTEM_CONFIG)
[ ] API has audit logging
[ ] /admin/configuracoes page loads with current settings
[ ] Business hours form shows all 7 days with open/close times
[ ] Business hours validates close > open
[ ] Lunch break form works with optional "no lunch" option
[ ] Antecedência mínima form accepts hours input
[ ] Notification preferences form has toggle switches
[ ] All forms have save buttons with loading states
[ ] All forms show success toast on save
[ ] npm run build compiles without errors
```

---

## Dependencies

**Requires:**
- Plan 07-01 complete (ClinicSettings model exists)
- Phase 1 (auth, RBAC, audit logging)

**Provides:**
- Business hours configuration for calendar validation
- Booking lead time for appointment scheduling
- Notification preferences for N8N workflow configuration

---

## Patterns to Follow

- API routes: Copy pattern from existing routes with singleton pattern
- Form components: Use shadcn/ui form components with react-hook-form
- Time inputs: Use Select with time options (00:00 to 23:30 in 30-min increments)
- Sections: Use Card components with CardHeader and CardContent
- RBAC: Use checkPermission(role, PERMISSIONS.MANAGE_SYSTEM_CONFIG)
- Audit: Add UPDATE_SETTINGS to AuditAction enum

---

## Notes

- Singleton pattern: ClinicSettings always has id='default'
- Business hours stored as Json for flexibility: `{ monday: { open: "09:00", close: "18:00", closed: false }, ... }`
- Calendar system (Phase 4) should reference these settings for availability
- N8N workflows should query these settings for notification timing
- Changes to business hours show warning if appointments exist outside new hours
