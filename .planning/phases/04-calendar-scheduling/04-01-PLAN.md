---
phase: 04-calendar-scheduling
plan: 01
wave: 1
depends_on: []
subsystem: calendar
tags: [schedule-x, calendar-views, react-calendar, time-zones]

files_modified:
  - package.json
  - src/components/calendar/calendar-view.tsx (create)
  - src/lib/calendar/time-zone-utils.ts (create)
  - src/app/agenda/page.tsx (create)
  - src/hooks/use-calendar-events.ts (create)

autonomous: true

must_haves:
  truths:
    - "Calendar displays appointments in day, week, and month views"
    - "All times displayed in Brazil timezone (America/Sao_Paulo)"
    - "Calendar loads existing appointments from database"
    - "View switching works (day/week/month buttons)"
  artifacts:
    - "src/components/calendar/calendar-view.tsx with Schedule-X integration"
    - "src/app/agenda/page.tsx renders calendar with DashboardLayout"
    - "src/lib/calendar/time-zone-utils.ts has TZDate wrappers"
    - "src/hooks/use-calendar-events.ts fetches appointments with Supabase"
  key_links:
    - "http://localhost:3000/agenda displays calendar component"
    - "Calendar shows existing appointments from agendamentos table"
---

# Phase 4 Plan 1: Calendar Views and Infrastructure

**Build the foundation for appointment scheduling with Schedule-X calendar component, timezone-aware date handling, and basic calendar views (day/week/month)**

<objective>
Set up the calendar infrastructure using Schedule-X library with Brazil timezone support. Create the main calendar page with day/week/month views that displays existing appointments from the database. This establishes the foundation for all subsequent calendar features (CRUD, multi-provider, conflict detection).
</objective>

<execution_context>
**Framework references:**
@~/.claude/get-shit-done/references/principles.md
@~/.claude/get-shit-done/references/plan-format.md

**Research context:**
@.planning/phases/04-calendar-scheduling/04-RESEARCH.md

**Key research findings:**
- Use Schedule-X for modern React calendar (88.5 benchmark, lightweight, accessible)
- Use @date-fns/tz with TZDate for DST-aware time handling
- Brazil timezones: America/Sao_Paulo (UTC-3, DST in summer), America/Manaus (UTC-4, no DST)
- Calendar libraries require explicit view configuration (day/week/month)
</execution_context>

<context>
**Project state:**
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/PROJECT.md

**Prior work:**
- Phase 3 completed patient management with Supabase integration patterns
- Database schema has `agendamentos` table with data_hora (timestamp), paciente_id, servico_id
- View `agendamentos_completos` joins appointments with patient and service data
- Authentication and RBAC established (ADMIN, ATENDENTE roles)

**Requirements addressed:**
- CAL-01: View appointments in calendar format (day/week/month views)
- CAL-04: See time slot availability (foundation for slots in later plans)

**Tech stack:**
- Next.js 15 with App Router
- Supabase PostgreSQL database (existing agendamentos table)
- TypeScript, Tailwind CSS
- NEW: Schedule-X (@schedule-x/react, @schedule-x/calendar)
- NEW: @date-fns/tz for timezone handling
</context>

<tasks>
### Task 1: Install calendar dependencies and setup Schedule-X

Install Schedule-X, date-fns/tz, and supporting libraries:

```bash
npm install @schedule-x/react @schedule-x/calendar @schedule-x/theme-default
npm install @schedule-x/events-service
npm install date-fns @date-fns/tz
```

**Acceptance:**
- All packages in package.json and package-lock.json
- Build succeeds without errors
- No peer dependency warnings

### Task 2: Create timezone utility functions with TZDate

Create `src/lib/calendar/time-zone-utils.ts` with Brazil timezone helpers:

```typescript
import { TZDate } from "@date-fns/tz"
import { format, addHours, isSameDay } from "date-fns"
import { tz } from "@date-fns/tz"

// Clinic timezone (São Paulo - most clinics)
export const CLINIC_TIMEZONE = 'America/Sao_Paulo'

// Create appointment in clinic timezone (DST-aware)
export function createClinicDate(
  year: number,
  month: number,
  day: number,
  hour: number,
  minute: number
): TZDate {
  return new TZDate(year, month, day, hour, minute, 0, CLINIC_TIMEZONE)
}

// Convert database timestamp to TZDate in clinic timezone
export function dbTimestampToTZDate(timestamp: string | Date): TZDate {
  const date = typeof timestamp === 'string' ? new Date(timestamp) : timestamp
  return new TZDate(date, CLINIC_TIMEZONE)
}

// Format appointment time for display in clinic timezone
export function formatAppointmentTime(date: Date | TZDate, formatStr: string = "PPpp"): string {
  return format(date, formatStr, { in: tz(CLINIC_TIMEZONE) })
}

// Check if two dates are same day in clinic timezone (avoids DST bugs)
export function isSameClinicDay(date1: Date, date2: Date): boolean {
  return isSameDay(date1, date2, { in: tz(CLINIC_TIMEZONE) })
}
```

**Research reference:** Pattern 3 from 04-RESEARCH.md (Time Zone Aware Appointments)

**Acceptance:**
- File created with all helper functions
- Functions use TZDate and explicit CLINIC_TIMEZONE
- Export all functions for use in calendar components

### Task 3: Create calendar hook for appointment data

Create `src/hooks/use-calendar-events.ts` to fetch appointments from Supabase:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { createBrowserClient } from '@/lib/supabase/client'
import { dbTimestampToTZDate } from '@/lib/calendar/time-zone-utils'

export interface CalendarEvent {
  id: string
  title: string  // Patient name + service
  start: Date
  end: Date
  patientId: string
  serviceId: string
  status: string
}

export function useCalendarEvents(startDate: Date, endDate: Date) {
  const [events, setEvents] = useState<CalendarEvent[]>([])
  const [loading, setLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)

  useEffect(() => {
    const fetchEvents = async () => {
      setLoading(true)
      setError(null)

      try {
        const supabase = createBrowserClient()

        // Fetch appointments from view with patient and service data
        const { data, error: fetchError } = await supabase
          .from('agendamentos_completos')
          .select('*')
          .gte('data_hora', startDate.toISOString())
          .lte('data_hora', endDate.toISOString())
          .order('data_hora', { ascending: true })

        if (fetchError) throw fetchError

        // Transform to calendar events
        const calendarEvents: CalendarEvent[] = (data || []).map(apt => {
          const start = dbTimestampToTZDate(apt.data_hora)
          const end = new Date(start.getTime() + (apt.servico_duracao_minutos || 60) * 60000)

          return {
            id: apt.id,
            title: `${apt.paciente_nome} - ${apt.servico_nome}`,
            start,
            end,
            patientId: apt.paciente_id,
            serviceId: apt.servico_id,
            status: apt.status,
          }
        })

        setEvents(calendarEvents)
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Failed to fetch appointments')
      } finally {
        setLoading(false)
      }
    }

    fetchEvents()
  }, [startDate, endDate])

  return { events, loading, error, refetch: () => {} }
}
```

**Acceptance:**
- Hook fetches from agendamentos_completos view
- Converts database timestamps to TZDate
- Returns events, loading, error states
- Calculates end time from service duration

### Task 4: Create calendar view component with Schedule-X

Create `src/components/calendar/calendar-view.tsx` with Schedule-X integration:

```typescript
'use client'

import { useEffect, useRef, useState } from 'react'
import { createCalendar } from '@schedule-x/calendar'
import { createEventsServicePlugin } from "@schedule-x/events-service"
import '@schedule-x/theme-default/dist/index.css'
import { useCalendarEvents } from '@/hooks/use-calendar-events'
import { startOfMonth, endOfMonth } from 'date-fns'

type CalendarView = 'day' | 'week' | 'month'

export function CalendarView() {
  const calendarRef = useRef<HTMLDivElement>(null)
  const [currentDate, setCurrentDate] = useState(new Date())
  const [view, setView] = useState<CalendarView>('week')

  // Fetch events for current month (expand range as needed)
  const startDate = startOfMonth(currentDate)
  const endDate = endOfMonth(currentDate)
  const { events, loading } = useCalendarEvents(startDate, endDate)

  useEffect(() => {
    if (!calendarRef.current) return

    // Create calendar instance
    const eventsService = createEventsServicePlugin()

    const calendar = createCalendar({
      selectedDate: currentDate.toISOString().split('T')[0],
      views: [
        { name: 'day', label: 'Dia' },
        { name: 'week', label: 'Semana' },
        { name: 'month', label: 'Mês' }
      ],
      defaultView: view,
      events: events.map(e => ({
        id: e.id,
        title: e.title,
        start: e.start.toISOString(),
        end: e.end.toISOString(),
      })),
      plugins: [eventsService],
      locale: 'pt-BR',
    })

    calendar.render(calendarRef.current)

    return () => {
      // Cleanup on unmount
      if (calendarRef.current) {
        calendarRef.current.innerHTML = ''
      }
    }
  }, [currentDate, view, events])

  if (loading) {
    return <div className="flex items-center justify-center h-96">Carregando agenda...</div>
  }

  return (
    <div className="space-y-4">
      {/* View switcher */}
      <div className="flex gap-2">
        <button
          onClick={() => setView('day')}
          className={`px-4 py-2 rounded ${view === 'day' ? 'bg-purple-500 text-white' : 'bg-gray-200'}`}
        >
          Dia
        </button>
        <button
          onClick={() => setView('week')}
          className={`px-4 py-2 rounded ${view === 'week' ? 'bg-purple-500 text-white' : 'bg-gray-200'}`}
        >
          Semana
        </button>
        <button
          onClick={() => setView('month')}
          className={`px-4 py-2 rounded ${view === 'month' ? 'bg-purple-500 text-white' : 'bg-gray-200'}`}
        >
          Mês
        </button>
      </div>

      {/* Calendar container */}
      <div ref={calendarRef} className="min-h-[600px] bg-white rounded-lg shadow" />
    </div>
  )
}
```

**Research reference:** Pattern 1 from 04-RESEARCH.md (Resource Scheduler with Schedule-X)

**Acceptance:**
- Component renders Schedule-X calendar
- Day/week/month view buttons work
- Loads appointments from useCalendarEvents hook
- Calendar displays in pt-BR locale

### Task 5: Create agenda page with calendar

Create `src/app/agenda/page.tsx` as the main calendar page:

```typescript
import { Suspense } from 'react'
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { redirect } from 'next/navigation'
import { DashboardLayout } from '@/components/layout/dashboard-layout'
import { CalendarView } from '@/components/calendar/calendar-view'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Calendar } from 'lucide-react'

export default async function AgendaPage() {
  // Check authentication
  const user = await getCurrentUserWithRole()

  if (!user) {
    redirect('/auth/login')
  }

  return (
    <DashboardLayout>
      <div className="space-y-6">
        {/* Page header */}
        <div>
          <div className="flex items-center gap-3 mb-2">
            <Calendar className="h-8 w-8 text-purple-500" />
            <h1 className="text-3xl font-bold text-gray-900">Agenda</h1>
          </div>
          <p className="text-gray-600">
            Visualize e gerencie todos os agendamentos da clínica
          </p>
        </div>

        {/* Calendar */}
        <Card>
          <CardHeader>
            <CardTitle>Calendário de Agendamentos</CardTitle>
          </CardHeader>
          <CardContent>
            <Suspense fallback={<div>Carregando agenda...</div>}>
              <CalendarView />
            </Suspense>
          </CardContent>
        </Card>
      </div>
    </DashboardLayout>
  )
}
```

**Acceptance:**
- Page requires authentication
- Uses DashboardLayout for consistent navigation
- Renders CalendarView component
- Page accessible at /agenda route
</tasks>

<verification>
**Manual testing checklist:**

1. Navigate to http://localhost:3000/agenda
   - [ ] Page loads without errors
   - [ ] Calendar displays with day/week/month views
   - [ ] Existing appointments from database appear on calendar
   - [ ] Times display in Brazil timezone (America/Sao_Paulo)

2. View switching
   - [ ] Click "Dia" button → calendar shows day view
   - [ ] Click "Semana" button → calendar shows week view
   - [ ] Click "Mês" button → calendar shows month view

3. Appointment display
   - [ ] Appointments show "Patient Name - Service Name" as title
   - [ ] Times match database data_hora column
   - [ ] Multiple appointments on same day all visible

4. Error handling
   - [ ] Database connection failure shows error message (test by stopping Supabase)

**Automated checks:**
- TypeScript compiles without errors
- All imports resolve correctly
- No console errors in browser

**HIPAA/Security:**
- Authentication required to view calendar
- No PHI exposed in console logs
- Supabase RLS policies apply to agendamentos_completos view
</verification>

<success_criteria>
- [ ] Schedule-X calendar renders on /agenda page
- [ ] Day, week, month views all work correctly
- [ ] Existing appointments from database display on calendar
- [ ] All times use Brazil timezone (America/Sao_Paulo)
- [ ] Calendar loads within 2 seconds on modern connection
- [ ] No TypeScript errors or build warnings
- [ ] Authentication required to access page
</success_criteria>

<output>
**Created files:**
- src/lib/calendar/time-zone-utils.ts - TZDate helpers for Brazil timezone
- src/hooks/use-calendar-events.ts - Fetch appointments from Supabase
- src/components/calendar/calendar-view.tsx - Schedule-X calendar component
- src/app/agenda/page.tsx - Main calendar page

**Modified files:**
- package.json - Added Schedule-X and date-fns/tz dependencies

**Database:**
- None (uses existing agendamentos_completos view)

**Next steps:**
- Plan 02: Appointment CRUD Operations (create, edit, delete)
- Plan 03: Multi-Provider Support and Filtering
</output>
