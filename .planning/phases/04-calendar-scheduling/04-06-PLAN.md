---
phase: 04-calendar-scheduling
plan: 06
wave: 4
depends_on: [04-01, 04-02, 04-05]
subsystem: calendar
tags: [n8n-integration, webhook-sync, timezone-sync, workflow-integration]

files_modified:
  - src/app/api/agendamentos/route.ts (modify)
  - src/app/api/agendamentos/[id]/route.ts (modify)
  - src/lib/calendar/n8n-sync.ts (create)
  - .env.local (document required variables)

autonomous: false

must_haves:
  truths:
    - "Creating appointment in calendar syncs with N8N workflows"
    - "Updating appointment triggers N8N webhook"
    - "Cancelling appointment notifies N8N for reminder cleanup"
    - "All calendar operations use Brazil timezone (America/Sao_Paulo)"
    - "DST transitions handled correctly year-round"
  artifacts:
    - "src/lib/calendar/n8n-sync.ts has webhook trigger functions"
    - "API endpoints call N8N sync after database operations"
    - ".env.local documents N8N webhook URLs"
  key_links:
    - "Create appointment → N8N receives webhook → schedules reminders"
    - "Cancel appointment → N8N receives webhook → cancels reminders"

checkpoints:
  - type: human-verify
    after_task: 1
    prompt: |
      **N8N Integration Configuration Required**

      This plan integrates the calendar with existing N8N workflows for appointment reminders and notifications.

      **Required N8N webhook endpoints:**
      1. Appointment created: `N8N_WEBHOOK_APPOINTMENT_CREATED`
      2. Appointment updated: `N8N_WEBHOOK_APPOINTMENT_UPDATED`
      3. Appointment cancelled: `N8N_WEBHOOK_APPOINTMENT_CANCELLED`
      4. Waitlist notification: `N8N_WEBHOOK_WAITLIST_NOTIFY` (from Plan 05)

      **Questions:**
      1. Do these webhook endpoints already exist in your N8N instance?
      2. Should we create new webhook nodes in N8N workflows? (I can provide webhook payloads)
      3. Are there existing N8N workflows that handle appointment reminders?

      **Options:**
      A) Webhook endpoints exist - provide URLs to continue
      B) Need to create webhooks in N8N first - pause and configure
      C) Skip N8N integration for now - manual testing only

      Please select an option and provide webhook URLs if available.
---

# Phase 4 Plan 6: N8N Integration and Time Zone Sync

**Integrate calendar with N8N workflows for automated reminders, ensure DST-aware time handling, and sync appointment lifecycle events**

<objective>
Connect calendar appointment operations (create, update, cancel) with existing N8N workflows via webhooks. Ensures automated appointment reminders, check-ins, and no-show prevention continue working with manual calendar appointments. Verifies timezone handling is DST-aware across all operations.
</objective>

<execution_context>
**Framework references:**
@~/.claude/get-shit-done/references/principles.md
@~/.claude/get-shit-done/references/checkpoints.md

**Research context:**
@.planning/phases/04-calendar-scheduling/04-RESEARCH.md

**Key research findings:**
- DST bugs appear 2x per year if timezone handling incorrect (Pitfall 1)
- SMS reminders reduce no-shows by 38% (must sync with N8N)
- Webhook integration standard for calendar-workflow sync
</execution_context>

<context>
**Project state:**
@.planning/STATE.md
@.planning/PROJECT.md

**Prior work:**
- Plan 04-01: Timezone utilities with TZDate (CLINIC_TIMEZONE)
- Plan 04-02: Appointment CRUD operations
- Plan 04-05: Waitlist with N8N notification webhook
- Existing system: N8N workflows for Anti No-Show, Pré Check-In, Lembretes

**Requirements addressed:**
- CAL-15: Calendar syncs with N8N workflows
- Implicit: DST-aware time handling
- Implicit: Appointment lifecycle integration with existing automation

**N8N integration points:**
1. Appointment created → trigger reminder scheduling
2. Appointment updated → reschedule reminders
3. Appointment cancelled → cancel reminders, trigger waitlist
4. Waitlist notification → WhatsApp message via Evolution API

**CHECKPOINT:** User must provide N8N webhook URLs before integration
</context>

<tasks>
### Task 1: Document required N8N webhook configuration

**CHECKPOINT: human-verify** - User must provide webhook URLs or configure N8N

Create `.env.local` documentation with required variables:

```bash
# N8N Webhook URLs for Calendar Integration
# Get these from your N8N instance (Settings > Webhooks)

# Triggered when appointment is created manually via calendar
# Payload: { appointmentId, patientId, serviceId, providerId, dataHora, status }
N8N_WEBHOOK_APPOINTMENT_CREATED=https://your-n8n-instance.com/webhook/appointment-created

# Triggered when appointment is updated (time changed, status changed)
# Payload: { appointmentId, changes: { dataHora?, status?, ... } }
N8N_WEBHOOK_APPOINTMENT_UPDATED=https://your-n8n-instance.com/webhook/appointment-updated

# Triggered when appointment is cancelled
# Payload: { appointmentId, patientId, serviceId, providerId, dataHora }
N8N_WEBHOOK_APPOINTMENT_CANCELLED=https://your-n8n-instance.com/webhook/appointment-cancelled

# Triggered when waitlist patient should be notified (from Plan 05)
# Payload: { patientPhone, patientName, availableSlot, serviceName, waitlistId }
N8N_WEBHOOK_WAITLIST_NOTIFY=https://your-n8n-instance.com/webhook/waitlist-notify
```

**N8N Workflow Recommendations:**

Create new webhook nodes in existing workflows or create new workflows:

**1. Appointment Created Webhook:**
- Input: Appointment details
- Actions:
  - Schedule SMS reminder 7 days before (Anti No-Show workflow)
  - Schedule SMS reminder 24 hours before
  - Schedule pre-check-in message 2 hours before
  - Log appointment creation event

**2. Appointment Updated Webhook:**
- Input: Appointment ID + changes
- Actions:
  - Cancel old reminders
  - Schedule new reminders with updated time
  - Notify patient of rescheduling via WhatsApp

**3. Appointment Cancelled Webhook:**
- Input: Appointment details
- Actions:
  - Cancel all scheduled reminders
  - Trigger waitlist notification (calls WAITLIST_NOTIFY webhook internally)
  - Log cancellation event

**Acceptance:**
- User confirms checkpoint with webhook URLs or chooses skip option
- .env.local documented with all webhook variables
- Webhook payload formats specified

### Task 2: Create N8N sync utility functions

Create `src/lib/calendar/n8n-sync.ts`:

```typescript
/**
 * N8N Integration for Calendar Sync
 *
 * Triggers N8N workflows when appointments are created, updated, or cancelled.
 * Ensures automated reminders and notifications continue working for manual appointments.
 */

interface AppointmentWebhookPayload {
  appointmentId: string
  patientId: string
  serviceId: string
  providerId: string
  dataHora: string  // ISO 8601 format
  status: string
  patientName?: string
  serviceName?: string
}

interface AppointmentUpdatePayload {
  appointmentId: string
  changes: {
    dataHora?: string
    status?: string
    providerId?: string
    serviceId?: string
  }
}

/**
 * Trigger N8N webhook when appointment is created
 */
export async function notifyN8NAppointmentCreated(
  payload: AppointmentWebhookPayload
): Promise<void> {
  const webhookUrl = process.env.N8N_WEBHOOK_APPOINTMENT_CREATED

  if (!webhookUrl) {
    console.warn('N8N_WEBHOOK_APPOINTMENT_CREATED not configured, skipping sync')
    return
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })

    if (!response.ok) {
      throw new Error(`N8N webhook failed: ${response.status}`)
    }

    console.log(`N8N: Appointment created notification sent for ${payload.appointmentId}`)
  } catch (error) {
    console.error('Failed to notify N8N of appointment creation:', error)
    // Don't throw - webhook failure shouldn't block appointment creation
  }
}

/**
 * Trigger N8N webhook when appointment is updated
 */
export async function notifyN8NAppointmentUpdated(
  payload: AppointmentUpdatePayload
): Promise<void> {
  const webhookUrl = process.env.N8N_WEBHOOK_APPOINTMENT_UPDATED

  if (!webhookUrl) {
    console.warn('N8N_WEBHOOK_APPOINTMENT_UPDATED not configured, skipping sync')
    return
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })

    if (!response.ok) {
      throw new Error(`N8N webhook failed: ${response.status}`)
    }

    console.log(`N8N: Appointment updated notification sent for ${payload.appointmentId}`)
  } catch (error) {
    console.error('Failed to notify N8N of appointment update:', error)
  }
}

/**
 * Trigger N8N webhook when appointment is cancelled
 */
export async function notifyN8NAppointmentCancelled(
  payload: AppointmentWebhookPayload
): Promise<void> {
  const webhookUrl = process.env.N8N_WEBHOOK_APPOINTMENT_CANCELLED

  if (!webhookUrl) {
    console.warn('N8N_WEBHOOK_APPOINTMENT_CANCELLED not configured, skipping sync')
    return
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    })

    if (!response.ok) {
      throw new Error(`N8N webhook failed: ${response.status}`)
    }

    console.log(`N8N: Appointment cancelled notification sent for ${payload.appointmentId}`)
  } catch (error) {
    console.error('Failed to notify N8N of appointment cancellation:', error)
  }
}
```

**Acceptance:**
- Functions handle missing webhook URLs gracefully (log warning, don't throw)
- Webhook failures don't block appointment operations
- All payloads use ISO 8601 datetime format
- Console logs for debugging

### Task 3: Integrate N8N sync with create appointment API

Modify `src/app/api/agendamentos/route.ts` POST endpoint:

```typescript
import { notifyN8NAppointmentCreated } from '@/lib/calendar/n8n-sync'

export async function POST(req: NextRequest) {
  try {
    // ... existing validation and conflict detection

    // Insert appointment
    const { data, error } = await supabase
      .from('agendamentos')
      .insert({
        paciente_id: validatedData.pacienteId,
        servico_id: validatedData.servicoId,
        provider_id: validatedData.providerId || 'default-provider-id',
        data_hora: validatedData.dataHora,
        observacoes: validatedData.observacoes,
        status: validatedData.status,
        criado_por: user.id,
      })
      .select(`
        *,
        paciente:pacientes(nome),
        servico:servicos(nome)
      `)
      .single()

    if (error) throw error

    // Audit log
    await logAudit({
      userId: user.id,
      action: AuditAction.CREATE_APPOINTMENT,
      resource: 'agendamentos',
      resourceId: data.id,
      details: validatedData,
    })

    // Trigger N8N webhook (async, don't wait)
    notifyN8NAppointmentCreated({
      appointmentId: data.id,
      patientId: data.paciente_id,
      serviceId: data.servico_id,
      providerId: data.provider_id,
      dataHora: data.data_hora,
      status: data.status,
      patientName: data.paciente.nome,
      serviceName: data.servico.nome,
    }).catch(err => console.error('N8N sync failed:', err))

    return NextResponse.json(data, { status: 201 })
  } catch (error) {
    // ... existing error handling
  }
}
```

**Acceptance:**
- N8N webhook called after successful insert
- Webhook runs async (doesn't block response)
- Includes patient and service names in payload
- Failure doesn't affect appointment creation

### Task 4: Integrate N8N sync with update appointment API

Modify `src/app/api/agendamentos/[id]/route.ts` PUT endpoint:

```typescript
import { notifyN8NAppointmentUpdated } from '@/lib/calendar/n8n-sync'

export async function PUT(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // ... existing validation and conflict detection

    const { id } = await params
    const validatedData = updateAppointmentSchema.parse(body)

    // Track what changed for N8N
    const changes: any = {}
    if (validatedData.dataHora) changes.dataHora = validatedData.dataHora
    if (validatedData.status) changes.status = validatedData.status
    if (validatedData.providerId) changes.providerId = validatedData.providerId
    if (validatedData.servicoId) changes.servicoId = validatedData.servicoId

    // Update appointment
    const { data, error } = await supabase
      .from('agendamentos')
      .update(updateData)
      .eq('id', id)
      .select()
      .single()

    if (error) throw error

    // Audit log
    await logAudit({
      userId: user.id,
      action: AuditAction.UPDATE_APPOINTMENT,
      resource: 'agendamentos',
      resourceId: id,
      details: validatedData,
    })

    // Trigger N8N webhook if significant changes (time, status, provider)
    if (Object.keys(changes).length > 0) {
      notifyN8NAppointmentUpdated({
        appointmentId: id,
        changes,
      }).catch(err => console.error('N8N sync failed:', err))
    }

    return NextResponse.json(data)
  } catch (error) {
    // ... existing error handling
  }
}
```

**Acceptance:**
- Webhook only triggered if appointment changed
- Changes object includes updated fields
- Runs async
- Failure doesn't affect update

### Task 5: Integrate N8N sync with delete appointment API

Modify `src/app/api/agendamentos/[id]/route.ts` DELETE endpoint:

```typescript
import { notifyN8NAppointmentCancelled } from '@/lib/calendar/n8n-sync'

export async function DELETE(
  req: NextRequest,
  { params }: { params: Promise<{ id: string }> }
) {
  try {
    // ... existing auth

    const { id } = await params
    const supabase = await createServerClient()

    // Fetch appointment details before deleting
    const { data: appointment } = await supabase
      .from('agendamentos')
      .select(`
        *,
        paciente:pacientes(nome, telefone),
        servico:servicos(nome)
      `)
      .eq('id', id)
      .single()

    // Delete appointment
    const { error } = await supabase
      .from('agendamentos')
      .delete()
      .eq('id', id)

    if (error) throw error

    // Audit log
    await logAudit({
      userId: user.id,
      action: AuditAction.DELETE_APPOINTMENT,
      resource: 'agendamentos',
      resourceId: id,
    })

    // Trigger N8N webhook for cancellation (handles reminder cleanup)
    if (appointment) {
      notifyN8NAppointmentCancelled({
        appointmentId: id,
        patientId: appointment.paciente_id,
        serviceId: appointment.servico_id,
        providerId: appointment.provider_id,
        dataHora: appointment.data_hora,
        status: appointment.status,
        patientName: appointment.paciente.nome,
        serviceName: appointment.servico.nome,
      }).catch(err => console.error('N8N sync failed:', err))

      // Trigger waitlist notification (from Plan 05)
      notifyWaitlist({
        servicoId: appointment.servico_id,
        providerId: appointment.provider_id,
        dataHora: new Date(appointment.data_hora),
      }).catch(err => console.error('Waitlist notification failed:', err))
    }

    return NextResponse.json({ success: true })
  } catch (error) {
    // ... existing error handling
  }
}
```

**Acceptance:**
- Cancellation webhook includes full appointment details
- Both N8N and waitlist notifications triggered
- Both run async
- Failures don't block delete

### Task 6: Verify DST handling with test scenarios

Create test scenarios in comments or test file to verify DST transitions:

```typescript
/**
 * DST Test Scenarios for Brazil (America/Sao_Paulo)
 *
 * DST Start: Usually first Sunday of November (forward 1 hour)
 * DST End: Usually third Sunday of February (backward 1 hour)
 *
 * Test cases:
 *
 * 1. Appointment scheduled during DST transition forward:
 *    - Create appointment for 2:30 AM on DST start day
 *    - Verify time doesn't shift by 1 hour
 *    - Verify reminder scheduled correctly
 *
 * 2. Appointment scheduled during DST transition backward:
 *    - Create appointment for 12:30 AM on DST end day
 *    - Verify time doesn't duplicate or shift
 *    - Verify reminder scheduled correctly
 *
 * 3. Cross-DST appointment update:
 *    - Create appointment in January (no DST)
 *    - Update to November (DST active)
 *    - Verify time stays consistent in clinic timezone
 *
 * 4. ISO 8601 format preservation:
 *    - All webhook payloads use ISO 8601 with timezone
 *    - N8N receives timezone-aware timestamps
 *    - No naive datetime objects
 */
```

Manual testing during actual DST transition dates or using date mocking library.

**Acceptance:**
- All times stored as ISO 8601 with timezone
- TZDate used for all date operations
- No hardcoded UTC offsets
- DST transitions don't cause hour shifts
</tasks>

<verification>
**Manual testing checklist:**

1. N8N webhook - create appointment
   - [ ] Create appointment via calendar
   - [ ] Check N8N execution logs → webhook received
   - [ ] Verify payload includes appointmentId, dataHora, patient/service names
   - [ ] Confirm reminder workflows triggered

2. N8N webhook - update appointment
   - [ ] Update appointment time
   - [ ] Check N8N logs → update webhook received
   - [ ] Verify changes object includes updated fields
   - [ ] Confirm old reminders cancelled, new ones scheduled

3. N8N webhook - cancel appointment
   - [ ] Delete appointment
   - [ ] Check N8N logs → cancellation webhook received
   - [ ] Verify waitlist notification also triggered
   - [ ] Confirm all reminders cancelled

4. Webhook failure resilience
   - [ ] Stop N8N or use invalid webhook URL
   - [ ] Create appointment → succeeds despite webhook failure
   - [ ] Check console logs → warning about webhook failure
   - [ ] Appointment still in database

5. DST handling (use date mocking or wait for DST transition)
   - [ ] Schedule appointment across DST boundary
   - [ ] Verify time doesn't shift by 1 hour
   - [ ] Check stored data_hora in database (ISO 8601 format)
   - [ ] Verify N8N receives correct timezone-aware timestamp

6. Integration with existing N8N workflows
   - [ ] Manual appointment receives same reminders as AI-created appointments
   - [ ] Anti No-Show workflow triggers correctly
   - [ ] Pré Check-In workflow triggers correctly
   - [ ] WhatsApp messages sent via Evolution API

**Automated checks:**
- All datetime values in ISO 8601 format
- No naive datetime objects in code
- Environment variables documented
</verification>

<success_criteria>
- [ ] Creating appointment triggers N8N webhook with full payload
- [ ] Updating appointment triggers N8N webhook with changes
- [ ] Cancelling appointment triggers N8N webhook for cleanup
- [ ] Webhook failures don't block appointment operations
- [ ] All webhooks receive ISO 8601 timezone-aware timestamps
- [ ] DST transitions handled correctly (no hour shifts)
- [ ] Manual appointments integrated with existing N8N workflows
- [ ] Reminders scheduled for manual appointments same as AI appointments
- [ ] .env.local documents all required webhook URLs
</success_criteria>

<output>
**Created files:**
- src/lib/calendar/n8n-sync.ts - N8N webhook integration functions

**Modified files:**
- src/app/api/agendamentos/route.ts - Added N8N sync on create
- src/app/api/agendamentos/[id]/route.ts - Added N8N sync on update and delete
- .env.local - Documented N8N webhook URLs (requires user configuration)

**Configuration required:**
- N8N webhook endpoints must be created or provided by user
- Environment variables must be set with webhook URLs
- N8N workflows should handle new webhook payloads

**Next steps:**
- Phase 4 complete! All calendar and scheduling requirements met
- Next: Phase 5 (Alert Dashboard) or Phase 7 (Settings & Configuration)
</output>
