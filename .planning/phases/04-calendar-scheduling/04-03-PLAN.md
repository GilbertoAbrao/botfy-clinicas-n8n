---
phase: 04-calendar-scheduling
plan: 03
wave: 2
depends_on: [04-01]
subsystem: calendar
tags: [multi-provider, resource-views, filtering, provider-management]

files_modified:
  - src/components/calendar/calendar-view.tsx (modify)
  - src/components/calendar/resource-selector.tsx (create)
  - src/hooks/use-calendar-events.ts (modify)
  - prisma/schema.prisma (modify - add Provider model)

autonomous: false

must_haves:
  truths:
    - "Calendar displays multiple providers in resource lanes"
    - "User can filter calendar by specific provider"
    - "User can filter calendar by service type"
    - "Provider names shown in calendar header"
    - "Appointments grouped by provider/resource"
  artifacts:
    - "src/components/calendar/resource-selector.tsx for provider/service filters"
    - "prisma/schema.prisma has Provider model with relations"
    - "Calendar configured with resource lanes for providers"
  key_links:
    - "Calendar shows all providers side-by-side in resource view"
    - "Filter dropdowns update calendar display in real-time"

checkpoints:
  - type: human-verify
    after_task: 1
    prompt: |
      **Schema Change Review Required**

      This plan adds a `providers` table to support multi-provider scheduling. Please review:

      **New Provider model:**
      - Fields: id, nome, especialidade, cor_calendario, ativo, created_at
      - Relations: appointments (one-to-many)
      - Migration required: Create providers table and add provider_id to agendamentos

      **Questions:**
      1. Do you already have provider/professional data in another table? (If yes, we'll use that instead)
      2. Should we migrate existing appointments to have a default provider?
      3. Any additional provider fields needed? (email, phone, schedule preferences)

      Options:
      A) Proceed with Provider model as designed
      B) Use existing table (specify table name)
      C) Modify Provider model (specify changes)

      Please select an option to continue.
---

# Phase 4 Plan 3: Multi-Provider Support and Filtering

**Enable multi-provider calendar views with resource lanes, provider/service filtering, and appointment grouping by provider**

<objective>
Implement multi-provider scheduling where calendar displays all providers side-by-side in resource lanes (similar to Google Calendar's resource view). Add provider and service filters to narrow calendar display. This addresses requirements CAL-02, CAL-10, CAL-11 and enables multi-practitioner clinic operations.
</objective>

<execution_context>
**Framework references:**
@~/.claude/get-shit-done/references/principles.md
@~/.claude/get-shit-done/references/checkpoints.md

**Research context:**
@.planning/phases/04-calendar-scheduling/04-RESEARCH.md

**Key research findings:**
- Schedule-X supports resource lanes via @sx-premium/resource-scheduler
- Resource configuration: { id, label, colorName } for each provider
- Filtering implemented client-side for performance (re-render calendar with filtered events)
</execution_context>

<context>
**Project state:**
@.planning/STATE.md

**Prior work:**
- Plan 04-01: Calendar views with Schedule-X
- Plan 04-02: Appointment CRUD operations
- Database has `agendamentos` table but NO provider field yet

**Requirements addressed:**
- CAL-02: See all providers' schedules centrally
- CAL-10: Filter calendar by provider
- CAL-11: Filter calendar by service type

**Schema change required:**
- Add `providers` table (id, nome, especialidade, cor_calendario, ativo)
- Add `provider_id` foreign key to `agendamentos` table
- Migration to create provider records and link existing appointments

**CHECKPOINT:** User needs to confirm schema changes before proceeding
</context>

<tasks>
### Task 1: Add Provider model to Prisma schema

**CHECKPOINT: human-verify** - User must review and approve schema changes

Add Provider model to `prisma/schema.prisma`:

```prisma
model Provider {
  id               String   @id @default(uuid())
  nome             String
  especialidade    String?
  cor_calendario   String   @default("#8B5CF6") // Purple default
  ativo            Boolean  @default(true)
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  appointments Appointment[] @relation("ProviderAppointments")

  @@map("providers")
}
```

Modify Appointment model to add provider relation:

```prisma
model Appointment {
  // ... existing fields
  provider_id String?
  provider    Provider? @relation("ProviderAppointments", fields: [provider_id], references: [id])
}
```

Run Prisma migration:
```bash
npx prisma migrate dev --name add_providers_table
npx prisma generate
```

Create Supabase migration to add provider_id column and providers table.

**Acceptance:**
- User confirms schema changes (checkpoint passed)
- Providers table created
- Appointments table has provider_id column
- Prisma types regenerated

### Task 2: Seed initial provider data

Create database seed for default provider:

Execute via Supabase:
```sql
-- Insert default provider
INSERT INTO providers (id, nome, especialidade, cor_calendario, ativo)
VALUES
  ('default-provider-id', 'Profissional Geral', 'Geral', '#8B5CF6', true);

-- Link existing appointments to default provider
UPDATE agendamentos
SET provider_id = 'default-provider-id'
WHERE provider_id IS NULL;
```

**Acceptance:**
- At least one provider exists in database
- Existing appointments linked to default provider
- No appointments have NULL provider_id

### Task 3: Update calendar hook to include provider data

Modify `src/hooks/use-calendar-events.ts` to fetch provider info:

```typescript
export interface CalendarEvent {
  id: string
  title: string
  start: Date
  end: Date
  patientId: string
  serviceId: string
  providerId: string  // NEW
  providerName: string  // NEW
  providerColor: string  // NEW
  status: string
}

// In fetchEvents function:
const { data, error: fetchError } = await supabase
  .from('agendamentos_completos')
  .select(`
    *,
    provider:providers(id, nome, cor_calendario)
  `)
  .gte('data_hora', startDate.toISOString())
  .lte('data_hora', endDate.toISOString())
  .order('data_hora', { ascending: true })

// Transform to calendar events:
const calendarEvents: CalendarEvent[] = (data || []).map(apt => {
  const start = dbTimestampToTZDate(apt.data_hora)
  const end = new Date(start.getTime() + (apt.servico_duracao_minutos || 60) * 60000)

  return {
    id: apt.id,
    title: `${apt.paciente_nome} - ${apt.servico_nome}`,
    start,
    end,
    patientId: apt.paciente_id,
    serviceId: apt.servico_id,
    providerId: apt.provider?.id || '',
    providerName: apt.provider?.nome || 'Sem profissional',
    providerColor: apt.provider?.cor_calendario || '#8B5CF6',
    status: apt.status,
  }
})
```

**Acceptance:**
- Events include provider ID, name, and color
- Query joins providers table
- Events without provider show fallback data

### Task 4: Update calendar view for resource lanes

Modify `src/components/calendar/calendar-view.tsx` to use resource scheduler:

Install premium resource scheduler (if not already installed):
```bash
npm install @sx-premium/resource-scheduler
```

Update calendar configuration:

```typescript
import { createHourlyView, createDailyView, createWeekView, createConfig } from "@sx-premium/resource-scheduler"

// Fetch providers for resource config
const [providers, setProviders] = useState<any[]>([])

useEffect(() => {
  const fetchProviders = async () => {
    const supabase = createBrowserClient()
    const { data } = await supabase
      .from('providers')
      .select('*')
      .eq('ativo', true)
      .order('nome')

    setProviders(data || [])
  }

  fetchProviders()
}, [])

// Create resource config
const resourceConfig = createConfig()
resourceConfig.resize.value = true
resourceConfig.dragAndDrop.value = true

resourceConfig.resources.value = providers.map(p => ({
  id: p.id,
  label: p.nome,
  colorName: p.cor_calendario,
}))

// Create calendar with resource views
const calendar = createCalendar({
  selectedDate: currentDate.toISOString().split('T')[0],
  views: [
    createDailyView(resourceConfig),
    createWeekView(resourceConfig),
    createHourlyView(resourceConfig),
  ],
  defaultView: 'week',
  events: events.map(e => ({
    id: e.id,
    title: e.title,
    start: e.start.toISOString(),
    end: e.end.toISOString(),
    resourceId: e.providerId,  // Map event to provider resource
  })),
  plugins: [eventsService],
  locale: 'pt-BR',
})
```

**Acceptance:**
- Calendar shows providers as resource lanes
- Appointments grouped by provider
- Each provider lane has distinct color
- Drag-and-drop works across provider lanes

### Task 5: Create resource selector component with filters

Create `src/components/calendar/resource-selector.tsx`:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select'
import { Label } from '@/components/ui/label'
import { createBrowserClient } from '@/lib/supabase/client'

interface ResourceSelectorProps {
  selectedProvider: string | null
  selectedService: string | null
  onProviderChange: (providerId: string | null) => void
  onServiceChange: (serviceId: string | null) => void
}

export function ResourceSelector({
  selectedProvider,
  selectedService,
  onProviderChange,
  onServiceChange,
}: ResourceSelectorProps) {
  const [providers, setProviders] = useState<any[]>([])
  const [services, setServices] = useState<any[]>([])

  useEffect(() => {
    const fetchData = async () => {
      const supabase = createBrowserClient()

      const [providersRes, servicesRes] = await Promise.all([
        supabase.from('providers').select('*').eq('ativo', true).order('nome'),
        supabase.from('servicos').select('*').eq('ativo', true).order('nome'),
      ])

      if (providersRes.data) setProviders(providersRes.data)
      if (servicesRes.data) setServices(servicesRes.data)
    }

    fetchData()
  }, [])

  return (
    <div className="flex gap-4">
      {/* Provider filter */}
      <div className="w-64">
        <Label>Filtrar por Profissional</Label>
        <Select
          value={selectedProvider || 'all'}
          onValueChange={(value) => onProviderChange(value === 'all' ? null : value)}
        >
          <SelectTrigger>
            <SelectValue placeholder="Todos os profissionais" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Todos os profissionais</SelectItem>
            {providers.map((p) => (
              <SelectItem key={p.id} value={p.id}>
                {p.nome}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>

      {/* Service filter */}
      <div className="w-64">
        <Label>Filtrar por Serviço</Label>
        <Select
          value={selectedService || 'all'}
          onValueChange={(value) => onServiceChange(value === 'all' ? null : value)}
        >
          <SelectTrigger>
            <SelectValue placeholder="Todos os serviços" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">Todos os serviços</SelectItem>
            {services.map((s) => (
              <SelectItem key={s.id} value={s.id}>
                {s.nome}
              </SelectItem>
            ))}
          </SelectContent>
        </Select>
      </div>
    </div>
  )
}
```

**Acceptance:**
- Component renders provider and service dropdowns
- "Todos" option shows all providers/services
- Selecting specific provider/service triggers callback
- Dropdowns populated from database

### Task 6: Integrate filters with calendar view

Modify `src/components/calendar/calendar-view.tsx` to use filters:

```typescript
const [selectedProvider, setSelectedProvider] = useState<string | null>(null)
const [selectedService, setSelectedService] = useState<string | null>(null)

// Filter events based on selections
const filteredEvents = useMemo(() => {
  return events.filter(event => {
    if (selectedProvider && event.providerId !== selectedProvider) return false
    if (selectedService && event.serviceId !== selectedService) return false
    return true
  })
}, [events, selectedProvider, selectedService])

// Use filteredEvents in calendar config instead of events

// Add ResourceSelector above calendar
return (
  <div className="space-y-4">
    {/* Filters */}
    <ResourceSelector
      selectedProvider={selectedProvider}
      selectedService={selectedService}
      onProviderChange={setSelectedProvider}
      onServiceChange={setSelectedService}
    />

    {/* View switcher */}
    {/* ... existing view buttons */}

    {/* Calendar with filtered events */}
    <div ref={calendarRef} className="min-h-[600px]" />
  </div>
)
```

**Acceptance:**
- Filters appear above calendar
- Selecting provider filters appointments to that provider only
- Selecting service filters appointments to that service only
- Both filters can be active simultaneously
- Calendar updates in real-time when filters change
</tasks>

<verification>
**Manual testing checklist:**

1. Multi-provider display
   - [ ] Calendar shows all active providers as resource lanes
   - [ ] Each provider lane has distinct color
   - [ ] Appointments grouped by provider
   - [ ] Provider names visible in calendar header

2. Provider filtering
   - [ ] Select specific provider → only that provider's appointments shown
   - [ ] Select "Todos os profissionais" → all appointments shown
   - [ ] Filter persists across view changes (day/week/month)

3. Service filtering
   - [ ] Select specific service → only appointments for that service shown
   - [ ] Works independently of provider filter
   - [ ] Combined filters work (both provider AND service)

4. Resource lanes
   - [ ] Drag appointment to different provider lane → updates provider_id
   - [ ] Empty provider lanes visible
   - [ ] Resize appointments works within lanes

5. Database
   - [ ] Providers table exists with correct schema
   - [ ] All appointments have provider_id (no NULLs)
   - [ ] Default provider created during migration

**Automated checks:**
- Prisma schema compiles
- Migration runs without errors
- No TypeScript errors
</verification>

<success_criteria>
- [ ] Calendar displays multiple providers in resource lanes
- [ ] Provider filter narrows calendar to selected provider
- [ ] Service filter narrows calendar to selected service
- [ ] Filters work independently and combined
- [ ] Appointments correctly grouped by provider
- [ ] Database migration completed with providers table
- [ ] No orphaned appointments (all have provider_id)
- [ ] Drag-and-drop works across provider lanes
</success_criteria>

<output>
**Created files:**
- src/components/calendar/resource-selector.tsx - Provider and service filters

**Modified files:**
- prisma/schema.prisma - Added Provider model and provider relation to Appointment
- src/hooks/use-calendar-events.ts - Fetch provider data with appointments
- src/components/calendar/calendar-view.tsx - Resource lanes and filter integration

**Database:**
- Created providers table via Prisma migration
- Added provider_id column to agendamentos table
- Seeded default provider and linked existing appointments

**Next steps:**
- Plan 04: Conflict Detection and Availability (time slot validation, buffer times)
- Plan 05: Waitlist Management (CAL-12, CAL-13, CAL-14)
</output>
