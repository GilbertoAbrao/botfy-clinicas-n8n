---
phase: 15-procedure-instructions
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - src/app/api/procedures/instructions/route.ts
  - src/app/api/procedures/instructions/[id]/route.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "API returns list of instructions with pagination"
    - "API creates new instructions with validation"
    - "API updates existing instructions"
    - "API deactivates instructions (soft delete)"
    - "All endpoints require ADMIN role"
  artifacts:
    - path: "src/app/api/procedures/instructions/route.ts"
      provides: "GET list and POST create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/procedures/instructions/[id]/route.ts"
      provides: "GET one, PUT update, PATCH deactivate endpoints"
      exports: ["GET", "PUT", "PATCH"]
  key_links:
    - from: "src/app/api/procedures/instructions/route.ts"
      to: "prisma.procedureInstruction"
      via: "Prisma client"
      pattern: "prisma\\.procedureInstruction\\."
    - from: "src/app/api/procedures/instructions/[id]/route.ts"
      to: "logAudit"
      via: "audit logging import"
      pattern: "logAudit\\("
---

<objective>
Create API routes for instruction CRUD operations.

Purpose: Provide backend endpoints for listing, creating, updating, and deactivating procedure instructions.
Output: Two API route files with full CRUD functionality, RBAC enforcement, and audit logging.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-procedure-instructions/15-01-SUMMARY.md
@src/app/api/servicos/route.ts
@src/app/api/servicos/[id]/route.ts
@src/lib/validations/instruction.ts
@src/lib/audit/logger.ts
@src/lib/auth/session.ts
@src/lib/rbac/permissions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create list and create endpoints</name>
  <files>src/app/api/procedures/instructions/route.ts</files>
  <action>
Create API route file following the pattern from src/app/api/servicos/route.ts.

**GET /api/procedures/instructions**
Query params:
- q: search string (searches titulo and conteudo, case-insensitive)
- tipo: filter by tipo_instrucao
- ativo: filter by active status ('true' or 'false')
- servicoId: filter by service ID (number or 'null' for general instructions)
- page: page number (default 1)
- limit: items per page (default 20, max 100)

Response: { instructions: [], pagination: { page, limit, total, totalPages } }

Include:
- servicoId in select to return with results
- Order by prioridade ASC, then createdAt DESC
- Join with services to get servico.nome if servicoId exists

**POST /api/procedures/instructions**
Body: InstructionInput schema
- Validate with instructionSchema
- Check for duplicate titulo (case-insensitive) within same servicoId (or null)
- Create record with Prisma
- Return { id, titulo } with status 201

Both endpoints:
- Require authentication (getCurrentUserWithRole)
- Require ADMIN role via PERMISSIONS.MANAGE_SYSTEM_CONFIG
- Log to audit log with appropriate actions
- Handle errors with proper status codes (401, 403, 400, 409, 500)
  </action>
  <verify>
Start dev server and test:
- `curl http://localhost:3051/api/procedures/instructions` returns 401 (not authenticated)
- After auth, returns instructions array with pagination
  </verify>
  <done>GET returns paginated instructions list, POST creates new instruction with validation</done>
</task>

<task type="auto">
  <name>Task 2: Create single item endpoints</name>
  <files>src/app/api/procedures/instructions/[id]/route.ts</files>
  <action>
Create API route file for single instruction operations.

**GET /api/procedures/instructions/[id]**
- Fetch single instruction by ID
- Return 404 if not found
- Include service name if servicoId exists

**PUT /api/procedures/instructions/[id]**
- Update instruction fields
- Validate with instructionSchema
- Check for duplicate titulo if changed (case-insensitive, same servicoId)
- Return updated instruction

**PATCH /api/procedures/instructions/[id]**
- ONLY for deactivation (soft delete per INST-07)
- Accept body: { ativo: false }
- Update ativo field to false
- DO NOT delete the record
- Log DEACTIVATE_INSTRUCTION action
- Return { success: true, id }

All endpoints:
- Require authentication
- Require ADMIN role
- Log to audit with instruction ID
- Handle 404 for non-existent ID
- Parse [id] as integer (instruction IDs are integers, not UUIDs)
  </action>
  <verify>
Test with curl:
- GET /api/procedures/instructions/1 returns instruction or 404
- PUT updates fields
- PATCH with { ativo: false } deactivates without deleting
  </verify>
  <done>GET returns single instruction, PUT updates it, PATCH deactivates it (soft delete)</done>
</task>

</tasks>

<verification>
1. All API routes respond with correct status codes
2. Authentication and authorization enforced (401/403 for unauthorized)
3. Validation errors return 400 with field details
4. Audit logs created for all operations
5. PATCH only allows deactivation, not hard delete
</verification>

<success_criteria>
- GET /api/procedures/instructions returns paginated list with filters
- POST /api/procedures/instructions creates instruction with validation
- GET /api/procedures/instructions/[id] returns single instruction
- PUT /api/procedures/instructions/[id] updates instruction
- PATCH /api/procedures/instructions/[id] deactivates (ativo=false)
- All endpoints enforce ADMIN-only access (INST-09)
- All operations logged to audit table
</success_criteria>

<output>
After completion, create `.planning/phases/15-procedure-instructions/15-02-SUMMARY.md`
</output>
