---
phase: 15-procedure-instructions
plan: 03
type: execute
wave: 3
depends_on: ["15-02"]
files_modified:
  - src/components/instructions/instructions-page-client.tsx
  - src/components/instructions/instruction-table.tsx
  - src/components/instructions/instruction-search.tsx
  - src/components/instructions/instruction-form-modal.tsx
  - src/components/instructions/instruction-type-badge.tsx
  - src/components/instructions/whatsapp-preview.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Instructions display in a sortable, paginated table"
    - "User can search by title and filter by type"
    - "Form modal allows create and edit with validation"
    - "WhatsApp preview shows realistic message format"
    - "Type badges display with icons and colors"
  artifacts:
    - path: "src/components/instructions/instructions-page-client.tsx"
      provides: "Main container orchestrating all components"
      min_lines: 80
    - path: "src/components/instructions/instruction-table.tsx"
      provides: "Table display with columns and actions"
      min_lines: 100
    - path: "src/components/instructions/instruction-form-modal.tsx"
      provides: "Create/edit form with WhatsApp preview"
      min_lines: 150
    - path: "src/components/instructions/whatsapp-preview.tsx"
      provides: "Live preview component with sample data"
      min_lines: 50
  key_links:
    - from: "src/components/instructions/instructions-page-client.tsx"
      to: "/api/procedures/instructions"
      via: "fetch in fetchInstructions"
      pattern: "fetch.*api/procedures/instructions"
    - from: "src/components/instructions/instruction-form-modal.tsx"
      to: "whatsapp-preview.tsx"
      via: "component import and watch"
      pattern: "WhatsAppPreview"
---

<objective>
Create UI components for the instructions management page.

Purpose: Build the user interface for listing, creating, editing, and previewing procedure instructions.
Output: Six component files providing complete CRUD UI with WhatsApp message preview.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/15-procedure-instructions/15-CONTEXT.md
@.planning/phases/15-procedure-instructions/15-02-SUMMARY.md
@src/components/services/services-page-client.tsx
@src/components/services/service-table-client.tsx
@src/components/services/service-form-modal.tsx
@src/components/services/service-search.tsx
@src/lib/validations/instruction.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create instruction type badge and WhatsApp preview components</name>
  <files>
    src/components/instructions/instruction-type-badge.tsx
    src/components/instructions/whatsapp-preview.tsx
  </files>
  <action>
**instruction-type-badge.tsx**
Create a badge component that displays instruction type with icon and color.

Props: { type: InstructionType }

Icon mapping (use lucide-react):
- preparo: Stethoscope (blue)
- jejum: UtensilsCrossed (orange)
- medicamentos: Pill (purple)
- vestuario: Shirt (pink)
- acompanhante: Users (green)
- documentos: FileText (yellow)
- geral: Info (gray)

Use shadcn Badge with variant="outline" and custom background/text colors.
Import INSTRUCTION_TYPE_LABELS from validation schema.

**whatsapp-preview.tsx**
Create live preview component showing how instruction will appear in WhatsApp.

Props: { content: string; title?: string }

Features per CONTEXT.md:
1. Replace template variables with Brazilian sample data:
   - {nome_paciente} -> "Joao Silva"
   - {data_consulta} -> "15/01 as 14h"
   - {servico} -> "Limpeza de Pele"
   - {profissional} -> "Dra. Paula"
   - {clinica} -> "Clinica Estetica"

2. WhatsApp styling:
   - Background: #ECE5DD (chat background)
   - Bubble: #DCF8C6 (outgoing message green)
   - Right-aligned bubble with tail
   - Timestamp "14:30" in bottom right
   - Font: text-sm, text-gray-900

3. Character count with warnings:
   - Show character count below preview
   - Yellow warning at 1000+ chars
   - Red warning at 2000+ chars
   - Use AlertTriangle icon for warnings

Use useMemo for content replacement performance.
  </action>
  <verify>Components render without errors when imported</verify>
  <done>InstructionTypeBadge shows colored badge with icon, WhatsAppPreview shows realistic chat bubble with warnings</done>
</task>

<task type="auto">
  <name>Task 2: Create search and table components</name>
  <files>
    src/components/instructions/instruction-search.tsx
    src/components/instructions/instruction-table.tsx
  </files>
  <action>
**instruction-search.tsx**
Create search and filter bar following service-search.tsx pattern.

Props: { onCreateClick: () => void }

Features:
1. Text search input with 300ms debounce (q param)
2. Type filter dropdown with all 7 types + "Todos" option
3. Active filter dropdown: Todos, Ativos, Inativos
4. "Nova Instrucao" button (Plus icon) calls onCreateClick
5. Update URL params on filter change (useRouter, useSearchParams)

Layout: flex row with gap-4, responsive (stack on mobile)

**instruction-table.tsx**
Create table component following service-table-client.tsx pattern.

Props:
- instructions: Instruction[]
- pagination: { page, limit, total, totalPages }
- searchParams: { q?, tipo?, ativo? }
- onEditClick: (instruction: Instruction) => void
- onRefresh: () => void

Columns (INST-01, INST-02):
1. Titulo - main text
2. Tipo - InstructionTypeBadge component
3. Servico - service name or "Geral" if null
4. Prioridade - number
5. Status - Badge green "Ativo" or gray "Inativo"
6. Acoes - Edit and Deactivate buttons

Features:
- Empty state with FileText icon when no instructions
- Pagination controls (following ServicePagination pattern)
- Edit button opens modal (calls onEditClick)
- Deactivate button with confirmation dialog
  - Uses AlertDialog from shadcn
  - Calls PATCH /api/procedures/instructions/[id] with { ativo: false }
  - Shows success toast
  - Calls onRefresh after success

Responsive: Table on desktop, card layout on mobile (hidden columns, stacked layout)
  </action>
  <verify>Components render table with data and handle empty state</verify>
  <done>Search filters update URL params, table displays instructions with all columns and actions</done>
</task>

<task type="auto">
  <name>Task 3: Create form modal and page client</name>
  <files>
    src/components/instructions/instruction-form-modal.tsx
    src/components/instructions/instructions-page-client.tsx
  </files>
  <action>
**instruction-form-modal.tsx**
Create form modal following service-form-modal.tsx pattern but with WhatsApp preview.

Props:
- isOpen: boolean
- onClose: () => void
- onSuccess: () => void
- instruction?: Instruction | null (if provided, editing mode)

Form fields (INST-04):
1. Titulo - Input text, required
2. Tipo - Select with all 7 types (INST-05)
3. Servico - Select dropdown fetching from /api/servicos
   - Include "Geral (todos os servicos)" option with null value
   - Fetch services on modal open
4. Conteudo - Textarea, required, min 10 chars
5. Prioridade - Number input, 0-100
6. Ativo - Switch toggle

Layout: Two-column on desktop
- Left column: form fields
- Right column: WhatsAppPreview component
  - Pass content and titulo from watch()
  - Updates live as user types (per CONTEXT.md)

Use react-hook-form with zodResolver(instructionSchema)
Reset form on open/close, populate on edit mode
Handle 409 (duplicate titulo) error specifically

**instructions-page-client.tsx**
Create main container component following services-page-client.tsx pattern.

Props: { q?, tipo?, ativo?, page, limit }

State:
- instructions: Instruction[]
- pagination: Pagination
- loading: boolean
- isCreateModalOpen: boolean
- editingInstruction: Instruction | null

Behavior:
- fetchInstructions on mount and when props change
- Pass handlers to child components
- Show loading skeleton while fetching

Render:
1. InstructionSearch (with onCreateClick)
2. InstructionTable (with all props and handlers)
3. InstructionFormModal (with state and handlers)
  </action>
  <verify>Form opens, validates, shows live preview, and submits to API</verify>
  <done>Form modal creates/edits instructions with live WhatsApp preview, page client orchestrates all components</done>
</task>

</tasks>

<verification>
1. All components render without errors
2. TypeScript compiles with no errors
3. Form validation shows errors for invalid input
4. WhatsApp preview updates live as user types
5. Deactivate shows confirmation before action
</verification>

<success_criteria>
- InstructionTypeBadge shows all 7 types with correct icons/colors
- WhatsAppPreview displays realistic bubble with sample data substitution
- Character warnings appear at 1000/2000 chars
- Search filters update URL and trigger refetch
- Table shows all required columns (INST-01)
- Edit and deactivate actions work (INST-06, INST-07)
- Form modal shows all fields (INST-04) with live preview (INST-08)
- Service dropdown includes all services plus "Geral" option
</success_criteria>

<output>
After completion, create `.planning/phases/15-procedure-instructions/15-03-SUMMARY.md`
</output>
