---
phase: 15-procedure-instructions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - prisma/schema.prisma
  - src/lib/validations/instruction.ts
  - src/lib/audit/logger.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Prisma client knows about instrucoes_procedimentos table"
    - "TypeScript knows the shape of instruction data"
    - "Audit logger has instruction-specific actions"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "ProcedureInstruction model"
      contains: "model ProcedureInstruction"
    - path: "src/lib/validations/instruction.ts"
      provides: "Zod schema and types for instructions"
      exports: ["instructionSchema", "InstructionInput", "INSTRUCTION_TYPES", "INSTRUCTION_TYPE_LABELS"]
    - path: "src/lib/audit/logger.ts"
      provides: "Audit actions for instruction CRUD"
      contains: "VIEW_INSTRUCTION"
  key_links:
    - from: "prisma/schema.prisma"
      to: "instrucoes_procedimentos table"
      via: "@@map directive"
      pattern: '@@map\\("instrucoes_procedimentos"\\)'
---

<objective>
Add data layer foundation for procedure instructions CRUD.

Purpose: Enable type-safe database access and validation for the `instrucoes_procedimentos` table that already exists in Supabase.
Output: Prisma model, Zod validation schema, and audit logging actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-procedure-instructions/15-CONTEXT.md
@.planning/phases/15-procedure-instructions/15-RESEARCH.md
@prisma/schema.prisma
@src/lib/validations/service.ts
@src/lib/audit/logger.ts
@database/001_pre_checkin_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Prisma model for instrucoes_procedimentos</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the ProcedureInstruction model to prisma/schema.prisma. The table already exists in the database.

Important considerations:
- Map to existing `instrucoes_procedimentos` table with @@map
- servico_id is nullable (for general instructions not tied to specific service)
- tipo_instrucao is a string enum constrained to 7 values
- EXCLUDE the `embedding` column - pgvector is not supported by Prisma and embeddings are managed by N8N
- Use proper @map for snake_case column names

Model fields:
- id: Int @id @default(autoincrement())
- servicoId: Int? @map("servico_id")
- tipoInstrucao: String @map("tipo_instrucao")
- titulo: String @db.VarChar(200)
- conteudo: String @db.Text
- prioridade: Int @default(0)
- ativo: Boolean @default(true)
- createdAt: DateTime @default(now()) @map("created_at") @db.Timestamptz
- updatedAt: DateTime @updatedAt @map("updated_at") @db.Timestamptz

Add indexes for:
- servicoId
- tipoInstrucao
- ativo

DO NOT use Prisma enum for tipoInstrucao - the database uses CHECK constraint, not an enum type.
  </action>
  <verify>Run `npx prisma generate` - should complete without errors</verify>
  <done>ProcedureInstruction model exists in schema.prisma, Prisma client can be generated</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schema and types</name>
  <files>src/lib/validations/instruction.ts</files>
  <action>
Create a new file with Zod schema and related types/constants for instruction forms.

Include:
1. INSTRUCTION_TYPES constant array with all 7 types: 'preparo', 'jejum', 'medicamentos', 'vestuario', 'acompanhante', 'documentos', 'geral'
2. InstructionType TypeScript type derived from the array
3. INSTRUCTION_TYPE_LABELS record mapping type to Portuguese label (e.g., 'preparo' -> 'Preparo', 'jejum' -> 'Jejum')
4. instructionSchema Zod object with:
   - servicoId: z.number().int().positive().nullable() (optional service link)
   - tipoInstrucao: z.enum(INSTRUCTION_TYPES)
   - titulo: z.string().min(3, 'Titulo deve ter pelo menos 3 caracteres').max(200, 'Titulo muito longo')
   - conteudo: z.string().min(10, 'Conteudo deve ter pelo menos 10 caracteres')
   - prioridade: z.number().int().min(0).max(100).default(0)
   - ativo: z.boolean().default(true)
5. InstructionInput type inferred from schema
6. Instruction type (full record from DB, includes id, createdAt, updatedAt)

Follow the pattern from src/lib/validations/service.ts for consistency.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit src/lib/validations/instruction.ts`</verify>
  <done>instruction.ts exports INSTRUCTION_TYPES, INSTRUCTION_TYPE_LABELS, instructionSchema, InstructionInput, and Instruction types</done>
</task>

<task type="auto">
  <name>Task 3: Add audit actions for instruction management</name>
  <files>src/lib/audit/logger.ts</files>
  <action>
Add new audit actions to the AuditAction enum for instruction CRUD operations.

Add these actions after the existing pre-checkin actions:
- VIEW_INSTRUCTION = 'VIEW_INSTRUCTION'
- CREATE_INSTRUCTION = 'CREATE_INSTRUCTION'
- UPDATE_INSTRUCTION = 'UPDATE_INSTRUCTION'
- DEACTIVATE_INSTRUCTION = 'DEACTIVATE_INSTRUCTION'

Group them with a comment: "// Instruction management"

Note: Use DEACTIVATE_INSTRUCTION (not DELETE) because INST-07 requires soft delete (ativo=false).
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/lib/audit/logger.ts`</verify>
  <done>AuditAction enum includes VIEW_INSTRUCTION, CREATE_INSTRUCTION, UPDATE_INSTRUCTION, DEACTIVATE_INSTRUCTION</done>
</task>

</tasks>

<verification>
1. `npx prisma generate` completes successfully
2. `npx tsc --noEmit` passes for modified files
3. Prisma client has `prisma.procedureInstruction` available
</verification>

<success_criteria>
- ProcedureInstruction model in schema.prisma maps to instrucoes_procedimentos table
- instructionSchema validates all required fields with proper constraints
- INSTRUCTION_TYPES contains all 7 instruction types
- AuditAction enum has all instruction-related actions
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/15-procedure-instructions/15-01-SUMMARY.md`
</output>
