---
phase: 19-write-tools
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/services/appointment-write-service.ts
  - src/app/api/agent/agendamentos/[id]/confirmar/route.ts
autonomous: true

must_haves:
  truths:
    - "AI Agent can confirm appointments via POST /api/agent/agendamentos/:id/confirmar"
    - "Confirmation supports two types: 'confirmado' (patient confirmed) and 'presente' (patient arrived)"
    - "Invalid state transitions are rejected (cannot confirm cancelled appointment)"
    - "'presente' can only be set if appointment is already 'confirmado'"
  artifacts:
    - path: "src/lib/services/appointment-write-service.ts"
      provides: "Confirmation function"
      exports: ["confirmAppointment"]
    - path: "src/app/api/agent/agendamentos/[id]/confirmar/route.ts"
      provides: "POST handler for confirmation"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/agent/agendamentos/[id]/confirmar/route.ts"
      to: "src/lib/services/appointment-write-service.ts"
      via: "import confirmAppointment"
      pattern: "import.*confirmAppointment.*from.*appointment-write-service"
    - from: "src/lib/services/appointment-write-service.ts"
      to: "prisma.appointment"
      via: "status update"
      pattern: "prisma\\.appointment\\.update"
---

<objective>
Implement POST /api/agent/agendamentos/:id/confirmar for appointment attendance confirmation.

Purpose: Enable AI Agent to confirm patient attendance and update appointment status through the confirmation flow. This fulfills WRITE-05 requirement.

Output:
- confirmAppointment function in write service
- New confirmar/route.ts with POST handler
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-write-tools/19-RESEARCH.md

# Phase 17-18 foundations
@src/lib/agent/middleware.ts
@src/lib/agent/error-handler.ts
@src/lib/validations/agent-schemas.ts
@src/lib/audit/logger.ts

# Service file to extend (may be created by 19-01 or 19-02)
@src/lib/services/appointment-write-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add confirmAppointment function to write service</name>
  <files>src/lib/services/appointment-write-service.ts</files>
  <action>
Add confirmAppointment function to appointment write service (create file if needed):

1. Function `confirmAppointment(appointmentId: number, tipo: 'confirmado' | 'presente')`:
   a. Fetch current appointment (prisma.appointment.findUnique)
   b. If not exists, throw Error('Appointment not found')
   c. Validate state transition:
      - Invalid states for any confirmation: 'cancelada', 'faltou', 'realizada'
      - If tipo === 'presente' and current status !== 'confirmado':
        throw Error('Appointment must be confirmed before marking as present')
      - If tipo === 'confirmado' and current status === 'confirmado':
        return appointment unchanged (idempotent)
      - If tipo === 'presente' and current status === 'presente':
        return appointment unchanged (idempotent)
   d. Update status to tipo
   e. Return updated appointment with patient info

State machine reference:
```
agendada -> confirmado -> presente -> realizada
agendada -> cancelada
agendada -> faltou (after appointment time)
confirmado -> cancelada
confirmado -> faltou (after appointment time)
```

No N8N webhook needed for confirmation (N8N doesn't track confirmation status).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/services/appointment-write-service.ts`
Grep for export: `grep "export.*confirmAppointment" src/lib/services/appointment-write-service.ts`
  </verify>
  <done>confirmAppointment function added with state transition validation</done>
</task>

<task type="auto">
  <name>Task 2: Create confirmar/route.ts with POST handler</name>
  <files>src/app/api/agent/agendamentos/[id]/confirmar/route.ts</files>
  <action>
Create new file `src/app/api/agent/agendamentos/[id]/confirmar/route.ts`:

1. Imports:
   - withAgentAuth from '@/lib/agent/middleware'
   - successResponse, handleApiError, errorResponse from '@/lib/agent/error-handler'
   - confirmAppointment from '@/lib/services/appointment-write-service'
   - agentConfirmAppointmentSchema from '@/lib/validations/agent-schemas'
   - logAudit, AuditAction from '@/lib/audit/logger'

2. POST handler (wrapped with withAgentAuth):
   a. Parse appointmentId from params (await context.params, parseInt)
   b. If NaN, return errorResponse('Invalid appointment ID', 400)
   c. Parse body with agentConfirmAppointmentSchema
      - tipo defaults to 'confirmado' if not provided
   d. Call confirmAppointment(appointmentId, input.tipo)
   e. Format response:
      - id, dataHora, tipoConsulta, profissional, status
      - paciente: { id, nome, telefone }
   f. Audit log with AGENT_CONFIRM_APPOINTMENT:
      - Include tipo ('confirmado' or 'presente')
   g. Return successResponse(response)
   h. Error handling:
      - 'Appointment not found' -> errorResponse('Agendamento nao encontrado', 404)
      - 'Appointment must be confirmed...' -> errorResponse(message, 400)
      - 'Cannot confirm appointment with status:...' -> errorResponse(message, 400)

Note: Use nested route structure [id]/confirmar/route.ts
Params in Next.js 15+ are a Promise - use `await context.params`.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Test route:
```bash
curl -X POST http://localhost:3051/api/agent/agendamentos/1/confirmar \
  -H "Authorization: Bearer test" \
  -H "Content-Type: application/json" \
  -d '{"tipo": "confirmado"}'
# Should return 401 (invalid auth)
```
  </verify>
  <done>POST handler created with state machine validation and audit logging</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Test confirmation flow with valid auth:
   - POST with tipo 'confirmado' on 'agendada' -> status becomes 'confirmado'
   - POST with tipo 'confirmado' on 'confirmado' -> no change (idempotent)
   - POST with tipo 'presente' on 'confirmado' -> status becomes 'presente'
   - POST with tipo 'presente' on 'agendada' -> 400 error
   - POST on 'cancelada' -> 400 error
3. Test non-existent appointment returns 404
4. Audit logs contain AGENT_CONFIRM_APPOINTMENT with tipo
</verification>

<success_criteria>
- POST /api/agent/agendamentos/:id/confirmar updates status correctly
- State transitions enforced ('presente' requires 'confirmado' first)
- Invalid state transitions return 400 with descriptive message
- Idempotent (confirming already confirmed returns success)
- Audit log captures confirmation type with agentId
</success_criteria>

<output>
After completion, create `.planning/phases/19-write-tools/19-04-SUMMARY.md`
</output>
