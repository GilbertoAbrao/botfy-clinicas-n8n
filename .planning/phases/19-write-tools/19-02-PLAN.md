---
phase: 19-write-tools
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/services/appointment-write-service.ts
  - src/app/api/agent/agendamentos/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "AI Agent can reschedule appointments via PATCH /api/agent/agendamentos/:id"
    - "AI Agent can cancel appointments via DELETE /api/agent/agendamentos/:id"
    - "Rescheduling validates new time slot availability with conflict checks"
    - "Cancellation requires reason and triggers waitlist notification"
  artifacts:
    - path: "src/lib/services/appointment-write-service.ts"
      provides: "Reschedule and cancel functions"
      exports: ["rescheduleAppointment", "cancelAppointment"]
    - path: "src/app/api/agent/agendamentos/[id]/route.ts"
      provides: "PATCH and DELETE handlers"
      exports: ["PATCH", "DELETE"]
  key_links:
    - from: "src/app/api/agent/agendamentos/[id]/route.ts"
      to: "src/lib/services/appointment-write-service.ts"
      via: "import rescheduleAppointment, cancelAppointment"
      pattern: "import.*rescheduleAppointment.*cancelAppointment.*from.*appointment-write-service"
    - from: "src/lib/services/appointment-write-service.ts"
      to: "src/lib/waitlist/auto-fill.ts"
      via: "import notifyWaitlist"
      pattern: "import.*notifyWaitlist.*from.*auto-fill"
    - from: "src/lib/services/appointment-write-service.ts"
      to: "src/lib/calendar/n8n-sync.ts"
      via: "import notifyN8NAppointmentCancelled"
      pattern: "import.*notifyN8NAppointmentCancelled.*from.*n8n-sync"
---

<objective>
Implement PATCH and DELETE for /api/agent/agendamentos/:id to enable rescheduling and cancellation.

Purpose: Enable AI Agent to modify existing appointments with proper validation, conflict detection for reschedules, and waitlist notification for cancellations. This fulfills WRITE-02 and WRITE-03 requirements.

Output:
- rescheduleAppointment and cancelAppointment functions in write service
- New [id]/route.ts with PATCH and DELETE handlers
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-write-tools/19-RESEARCH.md

# Phase 17-18 foundations
@src/lib/agent/middleware.ts
@src/lib/agent/error-handler.ts
@src/lib/validations/agent-schemas.ts
@src/lib/audit/logger.ts

# Existing utilities
@src/lib/calendar/conflict-detection.ts
@src/lib/calendar/n8n-sync.ts
@src/lib/waitlist/auto-fill.ts

# Service file to extend (created by 19-01, or create if running parallel)
@src/lib/services/appointment-write-service.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rescheduleAppointment and cancelAppointment to write service</name>
  <files>src/lib/services/appointment-write-service.ts</files>
  <action>
Add two new functions to the appointment write service (create file if it doesn't exist):

1. `rescheduleAppointment(appointmentId: number, input: { dataHora?: TZDate, profissional?: string })`:
   - Use Prisma $transaction for atomicity:
     a. Fetch existing appointment (verify exists, not cancelled)
     b. If dataHora changed, check for conflicts:
        - Exclude self from conflict check (using appointment ID)
        - Get existing appointments for new day/provider
        - Call findConflicts with buffer time
        - If conflicts, throw Error('Time slot already booked')
     c. Update appointment with new dataHora/profissional
     d. Return updated appointment with patient info
   - After transaction:
     - Call notifyN8NAppointmentUpdated (fire-and-forget)
   - Handle errors:
     - Appointment not found -> throw Error('Appointment not found')
     - Already cancelled -> throw Error('Cannot reschedule cancelled appointment')

2. `cancelAppointment(appointmentId: number, motivo: string)`:
   a. Fetch appointment with patient info
   b. If not exists, throw Error('Appointment not found')
   c. If already cancelled, return `{ ...appointment, alreadyCancelled: true }` (idempotent)
   d. Update status to 'cancelada', append motivo to observacoes
   e. Call notifyN8NAppointmentCancelled (fire-and-forget)
   f. Call notifyWaitlist with cancelled slot info (fire-and-forget)
   g. Return updated appointment

Import from existing:
- `notifyN8NAppointmentUpdated`, `notifyN8NAppointmentCancelled` from '@/lib/calendar/n8n-sync'
- `notifyWaitlist` from '@/lib/waitlist/auto-fill'
- `findConflicts`, `addBufferTime` from '@/lib/calendar/conflict-detection'
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/services/appointment-write-service.ts`
Grep for exports: `grep -E "export.*(rescheduleAppointment|cancelAppointment)" src/lib/services/appointment-write-service.ts`
  </verify>
  <done>Both rescheduleAppointment and cancelAppointment functions added with transaction safety</done>
</task>

<task type="auto">
  <name>Task 2: Create [id]/route.ts with PATCH and DELETE handlers</name>
  <files>src/app/api/agent/agendamentos/[id]/route.ts</files>
  <action>
Create new file `src/app/api/agent/agendamentos/[id]/route.ts`:

1. Imports:
   - withAgentAuth from '@/lib/agent/middleware'
   - successResponse, handleApiError, errorResponse from '@/lib/agent/error-handler'
   - rescheduleAppointment, cancelAppointment from '@/lib/services/appointment-write-service'
   - agentUpdateAppointmentSchema, agentCancelAppointmentSchema from '@/lib/validations/agent-schemas'
   - logAudit, AuditAction from '@/lib/audit/logger'

2. PATCH handler (wrapped with withAgentAuth):
   a. Parse appointmentId from params (await context.params, then parseInt)
   b. If NaN, return errorResponse('Invalid appointment ID', 400)
   c. Parse body with agentUpdateAppointmentSchema
   d. Call rescheduleAppointment(appointmentId, input)
   e. Format response with id, dataHora, tipoConsulta, profissional, status, paciente
   f. Audit log with AGENT_UPDATE_APPOINTMENT
   g. Return successResponse(response)
   h. Error handling:
      - 'Appointment not found' -> errorResponse('Agendamento nao encontrado', 404)
      - 'Time slot already booked' -> errorResponse('Horario ja ocupado', 409)
      - 'Cannot reschedule cancelled appointment' -> errorResponse(message, 400)

3. DELETE handler (wrapped with withAgentAuth):
   a. Parse appointmentId from params
   b. If NaN, return errorResponse('Invalid appointment ID', 400)
   c. Parse body with agentCancelAppointmentSchema (requires motivo)
   d. Call cancelAppointment(appointmentId, input.motivo)
   e. Audit log with AGENT_CANCEL_APPOINTMENT (include truncated motivo)
   f. Return successResponse with message and status
   g. Error handling:
      - 'Appointment not found' -> errorResponse('Agendamento nao encontrado', 404)

Note: Params in Next.js 15+ are a Promise, so use `await context.params` before accessing.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Test routes exist:
```bash
curl -X PATCH http://localhost:3051/api/agent/agendamentos/1 \
  -H "Authorization: Bearer test" \
  -H "Content-Type: application/json" \
  -d '{"dataHora": "2026-01-26T10:00:00-03:00"}'
# Should return 401 (invalid auth)

curl -X DELETE http://localhost:3051/api/agent/agendamentos/1 \
  -H "Authorization: Bearer test" \
  -H "Content-Type: application/json" \
  -d '{"motivo": "Paciente solicitou cancelamento"}'
# Should return 401 (invalid auth)
```
  </verify>
  <done>PATCH and DELETE handlers created with proper validation and error handling</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Test reschedule with valid auth:
   - PATCH should update dataHora and return updated appointment
   - PATCH to conflicting time should return 409
   - PATCH to non-existent ID should return 404
3. Test cancel with valid auth:
   - DELETE should update status to 'cancelada'
   - DELETE twice should return same response (idempotent)
   - DELETE without motivo should return 400 (validation error)
4. Audit logs contain AGENT_UPDATE_APPOINTMENT and AGENT_CANCEL_APPOINTMENT
5. Waitlist notification called on cancellation (check logs for N8N webhook)
</verification>

<success_criteria>
- PATCH /api/agent/agendamentos/:id reschedules with conflict detection
- DELETE /api/agent/agendamentos/:id cancels with required reason
- Cancelled appointments trigger waitlist notification
- N8N webhooks called on both reschedule and cancel (fire-and-forget)
- Invalid state transitions return appropriate error codes
</success_criteria>

<output>
After completion, create `.planning/phases/19-write-tools/19-02-SUMMARY.md`
</output>
