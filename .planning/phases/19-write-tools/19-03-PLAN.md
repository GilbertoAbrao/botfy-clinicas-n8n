---
phase: 19-write-tools
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/services/patient-write-service.ts
  - src/app/api/agent/paciente/[id]/route.ts
autonomous: true

must_haves:
  truths:
    - "AI Agent can update patient data via PATCH /api/agent/paciente/:id"
    - "Partial updates work (only provided fields are changed)"
    - "Phone number uniqueness is validated on update"
    - "Update is audited with AGENT_UPDATE_PATIENT action"
  artifacts:
    - path: "src/lib/services/patient-write-service.ts"
      provides: "Patient update function"
      exports: ["updatePatient"]
    - path: "src/app/api/agent/paciente/[id]/route.ts"
      provides: "PATCH handler for patient updates"
      exports: ["PATCH"]
  key_links:
    - from: "src/app/api/agent/paciente/[id]/route.ts"
      to: "src/lib/services/patient-write-service.ts"
      via: "import updatePatient"
      pattern: "import.*updatePatient.*from.*patient-write-service"
    - from: "src/lib/services/patient-write-service.ts"
      to: "prisma.patient"
      via: "database query"
      pattern: "prisma\\.patient\\.(findUnique|update)"
---

<objective>
Implement PATCH /api/agent/paciente/:id for partial patient data updates.

Purpose: Enable AI Agent to update patient information (name, phone, email, address) with proper validation and uniqueness checks. This fulfills WRITE-04 requirement.

Output:
- Patient write service with updatePatient function
- New paciente/[id]/route.ts with PATCH handler
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-write-tools/19-RESEARCH.md

# Phase 17-18 foundations
@src/lib/agent/middleware.ts
@src/lib/agent/error-handler.ts
@src/lib/validations/agent-schemas.ts
@src/lib/audit/logger.ts

# Existing patient service (read-only)
@src/lib/services/patient-service.ts

# Prisma schema for Patient model
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create patient write service</name>
  <files>src/lib/services/patient-write-service.ts</files>
  <action>
Create new file `src/lib/services/patient-write-service.ts`:

1. Interface `UpdatePatientInput` matching agentUpdatePatientSchema fields:
   - nome?: string
   - telefone?: string
   - email?: string
   - cpf?: string
   - dataNascimento?: TZDate (from flexible date schema)
   - convenio?: string
   - observacoes?: string

2. Function `updatePatient(patientId: number, input: UpdatePatientInput)`:
   a. Verify patient exists (prisma.patient.findUnique)
   b. If not exists, throw Error('Patient not found')
   c. If telefone provided and different from current:
      - Check uniqueness (prisma.patient.findUnique by telefone)
      - If exists and different ID, throw Error('Phone number already in use by another patient')
   d. Build update data object:
      - Only include fields that are not undefined
      - For dataNascimento, convert TZDate to Date
   e. Update patient (prisma.patient.update)
   f. Return updated patient

Import:
- prisma from '@/lib/prisma'
- TZDate from '@date-fns/tz'
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/services/patient-write-service.ts`
Grep for export: `grep "export.*updatePatient" src/lib/services/patient-write-service.ts`
  </verify>
  <done>Patient write service created with partial update support and uniqueness check</done>
</task>

<task type="auto">
  <name>Task 2: Create paciente/[id]/route.ts with PATCH handler</name>
  <files>src/app/api/agent/paciente/[id]/route.ts</files>
  <action>
Create new file `src/app/api/agent/paciente/[id]/route.ts`:

1. Imports:
   - withAgentAuth from '@/lib/agent/middleware'
   - successResponse, handleApiError, errorResponse from '@/lib/agent/error-handler'
   - updatePatient from '@/lib/services/patient-write-service'
   - agentUpdatePatientSchema from '@/lib/validations/agent-schemas'
   - logAudit, AuditAction from '@/lib/audit/logger'

2. PATCH handler (wrapped with withAgentAuth):
   a. Parse patientId from params (await context.params, parseInt)
   b. If NaN, return errorResponse('Invalid patient ID', 400)
   c. Parse body with agentUpdatePatientSchema
   d. Call updatePatient(patientId, input)
   e. Format response:
      - id, nome, telefone, email, cpf, convenio
      - Mask sensitive fields in response if needed
   f. Audit log with AGENT_UPDATE_PATIENT:
      - Include patientId
      - Include which fields were updated (keys only, not values - PHI protection)
   g. Return successResponse(response)
   h. Error handling:
      - 'Patient not found' -> errorResponse('Paciente nao encontrado', 404)
      - 'Phone number already in use...' -> errorResponse('Telefone ja cadastrado para outro paciente', 409)
      - Zod validation errors -> handled by handleApiError (400)

Note: Params in Next.js 15+ are a Promise, use `await context.params`.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Test route:
```bash
curl -X PATCH http://localhost:3051/api/agent/paciente/1 \
  -H "Authorization: Bearer test" \
  -H "Content-Type: application/json" \
  -d '{"nome": "Maria Silva Atualizado"}'
# Should return 401 (invalid auth)
```
  </verify>
  <done>PATCH handler created with partial update, uniqueness validation, and audit logging</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Test partial update with valid auth:
   - PATCH with only nome should update just nome
   - PATCH with telefone to existing phone should return 409
   - PATCH with empty body should return validation error or no changes
3. Test non-existent patient returns 404
4. Audit logs contain AGENT_UPDATE_PATIENT with field names (not values)
5. Patient telefone uniqueness enforced across updates
</verification>

<success_criteria>
- PATCH /api/agent/paciente/:id updates patient with partial data
- Only provided fields are updated (undefined fields ignored)
- Phone uniqueness validated against other patients
- Audit log captures update with agentId and changed field names
- PHI values not logged (only field names indicating what changed)
</success_criteria>

<output>
After completion, create `.planning/phases/19-write-tools/19-03-SUMMARY.md`
</output>
