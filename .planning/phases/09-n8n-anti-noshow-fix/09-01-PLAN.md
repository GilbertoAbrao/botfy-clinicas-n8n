# Plan 09-01: Fix N8N INSERT to include risco_noshow and mensagem_enviada

**Phase:** 9 - N8N Anti No-Show Fix
**Requirements:** N8N-01, N8N-02
**Status:** Ready

## Objective

Modify the N8N Anti No-Show workflow to persist risk score and message content to the `lembretes_enviados` table. Currently the workflow calculates these values but discards them.

## Context

**Workflow:** Botfy - Anti No-Show (ID: `HTR3ITfFDrK6eP2R`)

**Current Flow:**
1. "Busca Agendamentos 48h" → fetches appointments
2. "Analisa Risco No-Show" → GPT-4.1-mini analyzes patient history
3. "Extrai Score Risco" → extracts `risco_score` from AI response
4. "Prepara Envio WhatsApp" → builds message with `mensagem` and `risco_score`
5. "Envia Lembrete WhatsApp" → sends via Evolution API
6. "Registra Lembrete Enviado" → **INSERT missing risco_score and mensagem**

**Current INSERT Query (node "Registra Lembrete Enviado"):**
```sql
INSERT INTO lembretes_enviados (agendamento_id, telefone, tipo_lembrete, status_resposta, enviado_em)
VALUES (
  {{ $('Busca Agendamentos 48h').item.json.id }},
  '{{ $('Busca Agendamentos 48h').item.json.paciente_telefone }}',
  '{{ $json.tipo_lembrete }}',
  'pendente',
  NOW()
)
RETURNING *;
```

**Data Available:**
- `risco_score`: Available from `$('Extrai Score Risco').item.json.risco_score` (INTEGER 0-100)
- `mensagem`: Available from `$('Prepara Envio WhatsApp').item.json.mensagem` (TEXT)

## Tasks

### Task 1: Add columns to lembretes_enviados table

**Migration SQL:**
```sql
ALTER TABLE lembretes_enviados
ADD COLUMN IF NOT EXISTS risco_noshow INTEGER,
ADD COLUMN IF NOT EXISTS mensagem_enviada TEXT;

COMMENT ON COLUMN lembretes_enviados.risco_noshow IS 'Risk score 0-100 calculated by AI at reminder send time';
COMMENT ON COLUMN lembretes_enviados.mensagem_enviada IS 'Actual message content sent to patient';
```

**Execute via:** Supabase MCP `apply_migration` tool

### Task 2: Update N8N workflow INSERT query

**New INSERT Query:**
```sql
INSERT INTO lembretes_enviados (
  agendamento_id,
  telefone,
  tipo_lembrete,
  status_resposta,
  enviado_em,
  risco_noshow,
  mensagem_enviada
)
VALUES (
  {{ $('Busca Agendamentos 48h').item.json.id }},
  '{{ $('Busca Agendamentos 48h').item.json.paciente_telefone }}',
  '{{ $json.tipo_lembrete }}',
  'pendente',
  NOW(),
  {{ $('Extrai Score Risco').item.json.risco_score }},
  '{{ $('Prepara Envio WhatsApp').item.json.mensagem.replace(/'/g, "''") }}'
)
RETURNING *;
```

**Update via:** N8N MCP `n8n_update_partial_workflow` tool

**Node to update:** "Registra Lembrete Enviado" (Postgres node)

## Success Criteria

- [ ] `lembretes_enviados` table has `risco_noshow` INTEGER column
- [ ] `lembretes_enviados` table has `mensagem_enviada` TEXT column
- [ ] N8N workflow INSERT includes `risco_noshow` with value from Extrai Score Risco
- [ ] N8N workflow INSERT includes `mensagem_enviada` with value from Prepara Envio WhatsApp
- [ ] Workflow can be tested successfully (manual trigger or wait for next scheduled run)

## Verification

After implementation:
1. Check table structure: `SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'lembretes_enviados'`
2. Run workflow test or wait for scheduled execution
3. Verify data: `SELECT risco_noshow, mensagem_enviada FROM lembretes_enviados ORDER BY enviado_em DESC LIMIT 5`

## Notes

- Message escaping: Single quotes in AI-generated messages need escaping (`''`) to avoid SQL injection
- risco_score is INTEGER 0-100 (not nullable in new records, but existing rows will be NULL)
- This is a N8N workflow modification - exception to "no N8N changes" rule per PROJECT.md
