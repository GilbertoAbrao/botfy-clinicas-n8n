---
plan: 24-03
phase: 24-write-tools-migration
title: Migrate cancelar_agendamento
wave: 2
depends_on: [24-01]
files_modified:
  - N8N Workflow bPJamJhBcrVCKgBg (via MCP API)
autonomous: true
---

# Plan 24-03: Migrate cancelar_agendamento

## Objective

Migrate `cancelar_agendamento` tool from `toolWorkflow` to `toolHttpRequest` for direct HTTP access to the appointment cancellation API.

## Context

This tool cancels an existing appointment. It uses DELETE method with a path parameter for the appointment ID and requires a reason (motivo) in the JSON body.

**Current node:** `cancelar_agendamento` at position [-1712, 640]
- Type: `@n8n/n8n-nodes-langchain.toolWorkflow`

**Target endpoint:** `DELETE /api/agent/agendamentos/{agendamentoId}`
- Body: `{ motivo }` (required)
- Auth: Bearer token via httpHeaderAuth credential

## Tasks

<task id="1">
<title>Remove old toolWorkflow node</title>
<action>
Use N8N MCP to remove the existing `cancelar_agendamento` toolWorkflow node:
- Node name: `cancelar_agendamento`
- Position: [-1712, 640]

Operation: removeNode
</action>
<verify>Node no longer exists in workflow</verify>
</task>

<task id="2">
<title>Add new toolHttpRequest node</title>
<action>
Use N8N MCP to add new toolHttpRequest node with:
- ID: `tool-cancelar-agendamento-http`
- Name: `cancelar_agendamento`
- Position: [-1712, 640] (same position)
- Type: `@n8n/n8n-nodes-langchain.toolHttpRequest`
- TypeVersion: 1.1

Parameters:
- name: `cancelar_agendamento`
- toolDescription: "Cancela um agendamento existente. Parametros obrigatorios: agendamentoId (ID do agendamento), motivo (razao do cancelamento, minimo 3 caracteres). SEMPRE peca o motivo do cancelamento ao paciente antes de usar esta ferramenta."
- method: DELETE
- url: `={{ $env.AGENT_API_URL }}/api/agent/agendamentos/{agendamentoId}`
- authentication: predefinedCredentialType
- nodeCredentialType: httpHeaderAuth
- sendBody: json
- specifyBody: json
- jsonBody: `={{ JSON.stringify({ motivo: "{motivo}" }) }}`
- placeholderDefinitions with values for agendamentoId, motivo

Credentials:
- httpHeaderAuth: "Botfy Agent API"
</action>
<verify>Node exists with correct configuration</verify>
</task>

<task id="3">
<title>Connect node to AI Agent</title>
<action>
Add ai_tool connection from new node to AI Agent:
- From: cancelar_agendamento
- To: AI Agent
- Type: ai_tool
</action>
<verify>Connection exists in workflow</verify>
</task>

<task id="4">
<title>Verify migration</title>
<action>
Get workflow structure and verify:
1. Node `cancelar_agendamento` has type `toolHttpRequest`
2. Node has ai_tool connection to AI Agent
3. URL includes path parameter for agendamentoId
4. Method is DELETE
5. Body includes motivo field
</action>
<verify>All checks pass</verify>
</task>

## Verification Criteria

- [ ] Old toolWorkflow node removed
- [ ] New toolHttpRequest node created at correct position
- [ ] Method is DELETE
- [ ] URL includes {agendamentoId} path parameter
- [ ] JSON body includes motivo field
- [ ] Placeholder definitions cover agendamentoId and motivo
- [ ] httpHeaderAuth credential configured
- [ ] ai_tool connection to AI Agent established

## must_haves

1. AI Agent can cancel appointments via toolHttpRequest (not toolWorkflow)
2. Tool calls DELETE /api/agent/agendamentos/{id} endpoint
3. Tool passes agendamentoId in URL path and motivo in body

## Notes

- motivo is required by the API (min 3 characters)
- Tool description emphasizes asking for reason before cancelling
