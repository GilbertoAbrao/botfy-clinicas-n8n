---
plan: 24-04
phase: 24-write-tools-migration
title: Migrate atualizar_dados_paciente
wave: 2
depends_on: [24-01]
files_modified:
  - N8N Workflow bPJamJhBcrVCKgBg (via MCP API)
autonomous: true
---

# Plan 24-04: Migrate atualizar_dados_paciente

## Objective

Migrate `atualizar_dados_paciente` tool from `toolWorkflow` to `toolHttpRequest` for direct HTTP access to the patient update API.

## Context

This tool updates patient contact information. It uses PATCH method with a path parameter for the patient ID and a JSON body with the fields to update.

**Current node:** `atualizar_dados_paciente` at position [-1328, 800]
- Type: `@n8n/n8n-nodes-langchain.toolWorkflow`

**Target endpoint:** `PATCH /api/agent/paciente/{pacienteId}`
- Body: `{ nome, telefone, email, cpf, dataNascimento, convenio }` (all optional)
- Auth: Bearer token via httpHeaderAuth credential

## Tasks

<task id="1">
<title>Remove old toolWorkflow node</title>
<action>
Use N8N MCP to remove the existing `atualizar_dados_paciente` toolWorkflow node:
- Node name: `atualizar_dados_paciente`
- Position: [-1328, 800]

Operation: removeNode
</action>
<verify>Node no longer exists in workflow</verify>
</task>

<task id="2">
<title>Add new toolHttpRequest node</title>
<action>
Use N8N MCP to add new toolHttpRequest node with:
- ID: `tool-atualizar-paciente-http`
- Name: `atualizar_dados_paciente`
- Position: [-1328, 800] (same position)
- Type: `@n8n/n8n-nodes-langchain.toolHttpRequest`
- TypeVersion: 1.1

Parameters:
- name: `atualizar_dados_paciente`
- toolDescription: "Atualiza dados cadastrais de um paciente. Parametros: pacienteId (ID do paciente, obrigatorio). Campos opcionais para atualizar: nome, telefone (com DDD), email, cpf (apenas numeros), dataNascimento (YYYY-MM-DD), convenio. Use buscar_paciente primeiro para obter o ID."
- method: PATCH
- url: `={{ $env.AGENT_API_URL }}/api/agent/paciente/{pacienteId}`
- authentication: predefinedCredentialType
- nodeCredentialType: httpHeaderAuth
- sendBody: json
- specifyBody: json
- jsonBody: `={{ JSON.stringify({ nome: "{nome}", telefone: "{telefone}", email: "{email}" }) }}`
- placeholderDefinitions with values for pacienteId, nome, telefone, email

Credentials:
- httpHeaderAuth: "Botfy Agent API"
</action>
<verify>Node exists with correct configuration</verify>
</task>

<task id="3">
<title>Connect node to AI Agent</title>
<action>
Add ai_tool connection from new node to AI Agent:
- From: atualizar_dados_paciente
- To: AI Agent
- Type: ai_tool
</action>
<verify>Connection exists in workflow</verify>
</task>

<task id="4">
<title>Verify migration</title>
<action>
Get workflow structure and verify:
1. Node `atualizar_dados_paciente` has type `toolHttpRequest`
2. Node has ai_tool connection to AI Agent
3. URL includes path parameter for pacienteId
4. Method is PATCH
</action>
<verify>All checks pass</verify>
</task>

## Verification Criteria

- [ ] Old toolWorkflow node removed
- [ ] New toolHttpRequest node created at correct position
- [ ] Method is PATCH
- [ ] URL includes {pacienteId} path parameter
- [ ] JSON body includes common update fields
- [ ] Placeholder definitions cover key parameters
- [ ] httpHeaderAuth credential configured
- [ ] ai_tool connection to AI Agent established

## must_haves

1. AI Agent can update patient data via toolHttpRequest (not toolWorkflow)
2. Tool calls PATCH /api/agent/paciente/{id} endpoint
3. Tool passes pacienteId in URL path and update fields in body

## Notes

- All body fields are optional per API spec
- Include most common fields: nome, telefone, email
- AI will only provide fields that need updating
