---
plan: 24-02
phase: 24-write-tools-migration
title: Migrate reagendar_agendamento
wave: 2
depends_on: [24-01]
files_modified:
  - N8N Workflow bPJamJhBcrVCKgBg (via MCP API)
autonomous: true
---

# Plan 24-02: Migrate reagendar_agendamento

## Objective

Migrate `reagendar_agendamento` tool from `toolWorkflow` to `toolHttpRequest` for direct HTTP access to the appointment reschedule API.

## Context

This tool allows rescheduling an existing appointment. It uses PATCH method with a path parameter for the appointment ID and a JSON body for the new date/time.

**Current node:** `reagendar_agendamento` at position [-1776, 800]
- Type: `@n8n/n8n-nodes-langchain.toolWorkflow`

**Target endpoint:** `PATCH /api/agent/agendamentos/{agendamentoId}`
- Body: `{ dataHora, profissional }` (at least one required)
- Auth: Bearer token via httpHeaderAuth credential

## Tasks

<task id="1">
<title>Remove old toolWorkflow node</title>
<action>
Use N8N MCP to remove the existing `reagendar_agendamento` toolWorkflow node:
- Node name: `reagendar_agendamento`
- Position: [-1776, 800]

Operation: removeNode
</action>
<verify>Node no longer exists in workflow</verify>
</task>

<task id="2">
<title>Add new toolHttpRequest node</title>
<action>
Use N8N MCP to add new toolHttpRequest node with:
- ID: `tool-reagendar-agendamento-http`
- Name: `reagendar_agendamento`
- Position: [-1776, 800] (same position)
- Type: `@n8n/n8n-nodes-langchain.toolHttpRequest`
- TypeVersion: 1.1

Parameters:
- name: `reagendar_agendamento`
- toolDescription: "Reagenda um agendamento existente para nova data/hora. Parametros: agendamentoId (ID do agendamento, obrigatorio), dataHora (nova data/hora ISO 8601, obrigatorio), profissional (novo profissional, opcional). Use buscar_agendamentos primeiro para obter o ID."
- method: PATCH
- url: `={{ $env.AGENT_API_URL }}/api/agent/agendamentos/{agendamentoId}`
- authentication: predefinedCredentialType
- nodeCredentialType: httpHeaderAuth
- sendBody: json
- specifyBody: json
- jsonBody: `={{ JSON.stringify({ dataHora: "{dataHora}", profissional: "{profissional}" }) }}`
- placeholderDefinitions with values for agendamentoId, dataHora, profissional

Credentials:
- httpHeaderAuth: "Botfy Agent API"
</action>
<verify>Node exists with correct configuration</verify>
</task>

<task id="3">
<title>Connect node to AI Agent</title>
<action>
Add ai_tool connection from new node to AI Agent:
- From: reagendar_agendamento
- To: AI Agent
- Type: ai_tool
</action>
<verify>Connection exists in workflow</verify>
</task>

<task id="4">
<title>Verify migration</title>
<action>
Get workflow structure and verify:
1. Node `reagendar_agendamento` has type `toolHttpRequest`
2. Node has ai_tool connection to AI Agent
3. URL includes path parameter for agendamentoId
4. Method is PATCH
</action>
<verify>All checks pass</verify>
</task>

## Verification Criteria

- [ ] Old toolWorkflow node removed
- [ ] New toolHttpRequest node created at correct position
- [ ] Method is PATCH
- [ ] URL includes {agendamentoId} path parameter
- [ ] JSON body includes dataHora and profissional
- [ ] Placeholder definitions cover all parameters
- [ ] httpHeaderAuth credential configured
- [ ] ai_tool connection to AI Agent established

## must_haves

1. AI Agent can reschedule appointments via toolHttpRequest (not toolWorkflow)
2. Tool calls PATCH /api/agent/agendamentos/{id} endpoint
3. Tool passes agendamentoId in URL path and dataHora in body

## Notes

- Path parameter {agendamentoId} in URL is the key difference from POST
- profissional is optional but included for flexibility
