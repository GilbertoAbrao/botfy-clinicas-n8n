---
plan: 24-01
phase: 24-write-tools-migration
title: Migrate criar_agendamento
wave: 1
depends_on: []
files_modified:
  - N8N Workflow bPJamJhBcrVCKgBg (via MCP API)
autonomous: true
---

# Plan 24-01: Migrate criar_agendamento

## Objective

Migrate `criar_agendamento` tool from `toolWorkflow` to `toolHttpRequest` for direct HTTP access to the appointments creation API.

## Context

This is the first write tool migration and establishes the pattern for POST requests with JSON body. The API endpoint `POST /api/agent/agendamentos` expects a JSON body with patient and appointment details.

**Current node:** `criar_agendamento` at position [-2000, 800]
- Type: `@n8n/n8n-nodes-langchain.toolWorkflow`
- Sub-workflow ID: (to be identified)

**Target endpoint:** `POST /api/agent/agendamentos`
- Body: `{ pacienteId, tipoConsulta, dataHora, profissional, observacoes }`
- Auth: Bearer token via httpHeaderAuth credential

## Tasks

<task id="1">
<title>Remove old toolWorkflow node</title>
<action>
Use N8N MCP to remove the existing `criar_agendamento` toolWorkflow node:
- Node name: `criar_agendamento`
- Position: [-2000, 800]

Operation: removeNode
</action>
<verify>Node no longer exists in workflow</verify>
</task>

<task id="2">
<title>Add new toolHttpRequest node</title>
<action>
Use N8N MCP to add new toolHttpRequest node with:
- ID: `tool-criar-agendamento-http`
- Name: `criar_agendamento`
- Position: [-2000, 800] (same position)
- Type: `@n8n/n8n-nodes-langchain.toolHttpRequest`
- TypeVersion: 1.1

Parameters:
- name: `criar_agendamento`
- toolDescription: "Cria um novo agendamento para um paciente. Use apos confirmar horario disponivel com buscar_slots_disponiveis. Parametros obrigatorios: pacienteId (ID do paciente), tipoConsulta (tipo do agendamento), dataHora (formato ISO 8601 YYYY-MM-DDTHH:mm:ss). Opcionais: profissional (nome), observacoes (notas)."
- method: POST
- url: `={{ $env.AGENT_API_URL }}/api/agent/agendamentos`
- authentication: predefinedCredentialType
- nodeCredentialType: httpHeaderAuth
- sendBody: json
- specifyBody: json
- jsonBody: `={{ JSON.stringify({ pacienteId: {pacienteId}, tipoConsulta: "{tipoConsulta}", dataHora: "{dataHora}", profissional: "{profissional}" }) }}`
- placeholderDefinitions with values for pacienteId, tipoConsulta, dataHora, profissional

Credentials:
- httpHeaderAuth: "Botfy Agent API"
</action>
<verify>Node exists with correct configuration</verify>
</task>

<task id="3">
<title>Connect node to AI Agent</title>
<action>
Add ai_tool connection from new node to AI Agent:
- From: criar_agendamento
- To: AI Agent
- Type: ai_tool
</action>
<verify>Connection exists in workflow</verify>
</task>

<task id="4">
<title>Verify migration</title>
<action>
Get workflow structure and verify:
1. Node `criar_agendamento` has type `toolHttpRequest`
2. Node has ai_tool connection to AI Agent
3. URL pattern is correct for POST /api/agent/agendamentos
</action>
<verify>All checks pass</verify>
</task>

## Verification Criteria

- [ ] Old toolWorkflow node removed
- [ ] New toolHttpRequest node created at correct position
- [ ] Method is POST
- [ ] URL uses AGENT_API_URL environment variable
- [ ] JSON body template includes all required fields
- [ ] Placeholder definitions cover pacienteId, tipoConsulta, dataHora, profissional
- [ ] httpHeaderAuth credential configured
- [ ] ai_tool connection to AI Agent established

## must_haves

1. AI Agent can create new appointments via toolHttpRequest (not toolWorkflow)
2. Tool calls POST /api/agent/agendamentos endpoint
3. Tool passes required body parameters: pacienteId, tipoConsulta, dataHora

## Notes

- JSON body syntax may need adjustment based on how N8N interpolates placeholders
- Test with simple body first, then enhance if needed
- profissional is optional but included in body template
