---
phase: 20-complex-tools
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/lib/document/vision-extractor.ts
  - src/lib/document/storage-service.ts
autonomous: true

must_haves:
  truths:
    - "Vision API extracts structured fields from document images"
    - "Document type is auto-detected from image content"
    - "Extraction returns typed result matching Zod schema"
    - "Files are uploaded to Supabase Storage with unique paths"
  artifacts:
    - path: "src/lib/document/vision-extractor.ts"
      provides: "GPT-4o Vision wrapper for document extraction"
      exports: ["extractDocumentFields"]
    - path: "src/lib/document/storage-service.ts"
      provides: "Supabase Storage operations for patient documents"
      exports: ["uploadPatientDocument", "getDocumentSignedUrl"]
  key_links:
    - from: "src/lib/document/vision-extractor.ts"
      to: "openai"
      via: "OpenAI client with zodResponseFormat"
      pattern: "import.*OpenAI.*from.*openai"
    - from: "src/lib/document/vision-extractor.ts"
      to: "src/lib/validations/document-schemas.ts"
      via: "import BrazilianDocumentSchema"
      pattern: "import.*BrazilianDocumentSchema.*from.*document-schemas"
    - from: "src/lib/document/storage-service.ts"
      to: "@supabase/supabase-js"
      via: "createAdminSupabaseClient"
      pattern: "createAdminSupabaseClient"
---

<objective>
Implement GPT-4o Vision extraction and Supabase Storage upload services.

Purpose: Enable AI-powered document field extraction using OpenAI's structured outputs and secure file storage in Supabase. This implements the core processing logic for CMPLX-02 requirement.

Output:
- Vision extractor service using GPT-4o Vision with Zod schemas
- Storage service for Supabase patient-documents bucket
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-complex-tools/20-RESEARCH.md
@.planning/phases/20-complex-tools/20-01-SUMMARY.md

# Plan 01 artifacts
@src/lib/document/document-types.ts
@src/lib/document/document-validator.ts
@src/lib/validations/document-schemas.ts

# Existing Supabase client
@src/lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Vision extractor service</name>
  <files>src/lib/document/vision-extractor.ts</files>
  <action>
Create new file `src/lib/document/vision-extractor.ts` implementing GPT-4o Vision extraction:

1. **Imports**:
   ```typescript
   import OpenAI from 'openai'
   import { zodResponseFormat } from 'openai/helpers/zod'
   import { BrazilianDocumentSchema } from '@/lib/validations/document-schemas'
   import type { ExtractedDocument } from './document-types'
   ```

2. **Create OpenAI client**:
   ```typescript
   const openai = new OpenAI({
     apiKey: process.env.OPENAI_API_KEY,
   })
   ```

3. **System prompt** — Detailed instructions for Brazilian document extraction:
   ```typescript
   const SYSTEM_PROMPT = `You are a document processing assistant for a Brazilian medical clinic.

Extract structured data from Brazilian identity documents:
- RG (Registro Geral - National ID)
- CPF (Cadastro de Pessoas Físicas - Tax ID)
- CNS (Cartão Nacional de Saúde - Health Card)
- Carteirinha do Convênio (Insurance Card)

IMPORTANT RULES:
1. Extract ONLY what is visible in the image. Do NOT guess or infer missing data.
2. For dates, use YYYY-MM-DD format (e.g., 1985-03-15).
3. For document numbers, extract digits only (remove dots, dashes, slashes).
4. For RG numbers that end in 'X', keep the X (it's a valid check digit).
5. For CNS numbers, they MUST be 15 digits starting with 1, 2, or 7.
6. If you cannot determine the document type, return documentType: "UNKNOWN" with reason.

CONFIDENCE LEVELS:
- high: All required fields clearly visible and readable
- medium: Some fields unclear or low image quality
- low: Poor image quality or missing required fields

NEVER include patient PHI (names, IDs) in your reasoning. Only return the structured data.`
   ```

4. **extractDocumentFields function**:
   ```typescript
   export async function extractDocumentFields(
     imageBase64: string,
     mimeType: string
   ): Promise<ExtractedDocument> {
     const completion = await openai.chat.completions.parse({
       model: 'gpt-4o-2024-08-06',  // Required for structured outputs
       messages: [
         {
           role: 'system',
           content: SYSTEM_PROMPT,
         },
         {
           role: 'user',
           content: [
             {
               type: 'text',
               text: 'Extract all fields from this Brazilian identity document:',
             },
             {
               type: 'image_url',
               image_url: {
                 url: `data:${mimeType};base64,${imageBase64}`,
                 detail: 'high',  // Use high detail for document text
               },
             },
           ],
         },
       ],
       response_format: zodResponseFormat(BrazilianDocumentSchema, 'document_extraction'),
       max_tokens: 1000,  // Sufficient for document fields
     })

     const message = completion.choices[0]?.message

     // Check for refusal (safety filter)
     if (message?.refusal) {
       throw new Error(`Document extraction refused: ${message.refusal}`)
     }

     // Get parsed result
     const extracted = message?.parsed
     if (!extracted) {
       throw new Error('Failed to extract document fields - no parsed response')
     }

     return extracted as ExtractedDocument
   }
   ```

5. **Add error handling for common Vision API issues**:
   - API key missing: Check OPENAI_API_KEY env var exists
   - Image too large: OpenAI has ~20MB limit, but we validate at 5MB
   - Invalid image format: Caught by our validator in Plan 01
   - Rate limiting: Re-throw with clear message

Note: Using `gpt-4o-2024-08-06` model which supports structured outputs.
The `detail: 'high'` parameter ensures better text recognition.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/document/vision-extractor.ts`
Check OpenAI import works: No runtime errors on import.
  </verify>
  <done>Vision extractor created with GPT-4o structured outputs and Brazilian document system prompt</done>
</task>

<task type="auto">
  <name>Task 2: Create Supabase Storage service</name>
  <files>src/lib/document/storage-service.ts</files>
  <action>
Create new file `src/lib/document/storage-service.ts` for patient document storage:

1. **Imports**:
   ```typescript
   import { randomUUID } from 'crypto'
   import { createAdminSupabaseClient } from '@/lib/supabase/server'
   ```

2. **Constants**:
   ```typescript
   const BUCKET_NAME = 'patient-documents'  // Must exist in Supabase Storage
   const SIGNED_URL_EXPIRY = 3600  // 1 hour
   ```

3. **uploadPatientDocument function**:
   ```typescript
   export async function uploadPatientDocument(
     patientId: string | number,
     buffer: Buffer,
     mimeType: string,
     documentType: string,
     originalFilename: string
   ): Promise<string> {
     const supabase = createAdminSupabaseClient()

     // Generate unique filename with timestamp and UUID
     const timestamp = Date.now()
     const uuid = randomUUID()
     const extension = getExtensionFromMime(mimeType)
     const filename = `${patientId}/${documentType}/${timestamp}-${uuid}.${extension}`

     // Upload to Supabase Storage
     const { data, error } = await supabase.storage
       .from(BUCKET_NAME)
       .upload(filename, buffer, {
         contentType: mimeType,
         upsert: false,  // Prevent accidental overwrites
         cacheControl: '3600',  // 1 hour cache
       })

     if (error) {
       console.error('Supabase storage upload failed:', error)
       throw new Error(`Failed to upload document: ${error.message}`)
     }

     // Return storage path (NOT the full URL for security)
     return data.path
   }
   ```

4. **getExtensionFromMime helper**:
   ```typescript
   function getExtensionFromMime(mimeType: string): string {
     const mimeToExt: Record<string, string> = {
       'image/jpeg': 'jpg',
       'image/png': 'png',
       'image/heic': 'heic',
       'application/pdf': 'pdf',
     }
     return mimeToExt[mimeType] || 'bin'
   }
   ```

5. **getDocumentSignedUrl function** (for viewing documents later):
   ```typescript
   export async function getDocumentSignedUrl(storagePath: string): Promise<string> {
     const supabase = createAdminSupabaseClient()

     const { data, error } = await supabase.storage
       .from(BUCKET_NAME)
       .createSignedUrl(storagePath, SIGNED_URL_EXPIRY)

     if (error) {
       console.error('Failed to generate signed URL:', error)
       throw new Error(`Failed to generate signed URL: ${error.message}`)
     }

     return data.signedUrl
   }
   ```

Note: Using admin client to bypass RLS for server-side operations.
The API route will handle authentication; storage access is authorized by the route.
The bucket 'patient-documents' must be created in Supabase dashboard with appropriate RLS policies.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/document/storage-service.ts`
  </verify>
  <done>Storage service created with upload and signed URL functions using Supabase admin client</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Vision extractor imports OpenAI and uses zodResponseFormat
3. Storage service uses createAdminSupabaseClient for bypassing RLS
4. Both services export their main functions
5. Error handling covers common failure modes (API errors, storage errors)
</verification>

<success_criteria>
- Vision extractor calls GPT-4o Vision with structured output schema
- System prompt covers all 4 Brazilian document types
- Document type detection happens in single API call (not separate classification step)
- Storage service uploads to Supabase with unique paths per patient/document type
- Signed URLs can be generated for document viewing
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-complex-tools/20-02-SUMMARY.md`
</output>
