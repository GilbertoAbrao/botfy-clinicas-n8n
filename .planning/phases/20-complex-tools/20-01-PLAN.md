---
phase: 20-complex-tools
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/document/document-types.ts
  - src/lib/document/document-validator.ts
  - src/lib/validations/document-schemas.ts
autonomous: true

must_haves:
  truths:
    - "File uploads are validated by magic bytes, not just MIME type"
    - "Only JPEG, PNG, HEIC, and PDF files are accepted"
    - "File size is limited to 5MB"
    - "Brazilian document schemas define expected extraction fields"
  artifacts:
    - path: "src/lib/document/document-types.ts"
      provides: "Type definitions for document processing"
      exports: ["DocumentType", "ExtractedDocument", "RGDocument", "CPFDocument", "CNSDocument", "InsuranceCardDocument"]
    - path: "src/lib/document/document-validator.ts"
      provides: "File validation with magic byte verification"
      exports: ["validateDocumentUpload", "ALLOWED_MIME_TYPES", "MAX_FILE_SIZE"]
    - path: "src/lib/validations/document-schemas.ts"
      provides: "Zod schemas for Vision API structured outputs"
      exports: ["BrazilianDocumentSchema", "RGSchema", "CPFSchema", "CNSSchema", "InsuranceCardSchema"]
  key_links:
    - from: "src/lib/document/document-validator.ts"
      to: "file-type"
      via: "import fileTypeFromBuffer"
      pattern: "import.*fileTypeFromBuffer.*from.*file-type"
    - from: "src/lib/validations/document-schemas.ts"
      to: "src/lib/document/document-types.ts"
      via: "z.infer for type derivation"
      pattern: "z\\.infer.*DocumentSchema"
---

<objective>
Set up file validation and type definitions for document processing.

Purpose: Enable secure file uploads with OWASP-compliant magic byte validation and define Zod schemas for GPT-4o Vision structured outputs. This is the foundation for CMPLX-01 and CMPLX-02 requirements.

Output:
- Type definitions for all Brazilian document types (RG, CPF, CNS, insurance card)
- File validator with magic byte verification and size limits
- Zod schemas for Vision API structured extraction
- npm dependencies installed (openai, file-type)
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-complex-tools/20-RESEARCH.md

# Existing patterns
@src/lib/agent/types.ts
@src/lib/validations/agent-schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies</name>
  <files>package.json</files>
  <action>
Install required packages for document processing:

```bash
npm install openai file-type
```

- `openai` v4.x — OpenAI Node.js SDK with structured outputs support (zodResponseFormat)
- `file-type` v19.x — Magic byte detection for secure file validation

Note: `@supabase/supabase-js` is already installed (used in Plan 02 for storage).
Note: `sharp` is NOT installed for MVP - add later if HEIC conversion needed.
  </action>
  <verify>
Run: `npm list openai file-type`
Both packages should appear in the dependency tree.
  </verify>
  <done>openai and file-type packages installed</done>
</task>

<task type="auto">
  <name>Task 2: Create document type definitions</name>
  <files>src/lib/document/document-types.ts</files>
  <action>
Create new file `src/lib/document/document-types.ts` with type definitions for document processing:

1. **DocumentType enum** — Discriminator for document types:
   ```typescript
   export type DocumentType = 'RG' | 'CPF' | 'CNS' | 'CARTEIRINHA_CONVENIO' | 'UNKNOWN'
   ```

2. **Base document interface** — Common fields:
   ```typescript
   export interface BaseDocument {
     documentType: DocumentType
     confidence: 'high' | 'medium' | 'low'
     rawText?: string  // Optional: raw OCR text for debugging
   }
   ```

3. **RGDocument** — Brazilian national ID:
   ```typescript
   export interface RGDocument extends BaseDocument {
     documentType: 'RG'
     numeroRG: string        // 8-9 digits, may end in X
     nome: string            // Full name
     dataNascimento: string  // YYYY-MM-DD
     nomePai?: string        // Father's name (optional)
     nomeMae?: string        // Mother's name (optional)
     naturalidade?: string   // Place of birth
     orgaoEmissor?: string   // Issuing authority (e.g., SSP-SP)
     dataEmissao?: string    // Issue date YYYY-MM-DD
   }
   ```

4. **CPFDocument** — Brazilian tax ID:
   ```typescript
   export interface CPFDocument extends BaseDocument {
     documentType: 'CPF'
     numeroCPF: string       // 11 digits (no formatting)
     nome: string
     dataNascimento: string
   }
   ```

5. **CNSDocument** — National health card:
   ```typescript
   export interface CNSDocument extends BaseDocument {
     documentType: 'CNS'
     numeroCNS: string       // 15 digits starting with 1, 2, or 7
     nome: string
   }
   ```

6. **InsuranceCardDocument** — Health insurance card:
   ```typescript
   export interface InsuranceCardDocument extends BaseDocument {
     documentType: 'CARTEIRINHA_CONVENIO'
     numeroCarteirinha: string
     nomeConvenio: string    // Insurance company name
     nomeTitular: string     // Cardholder name
     validadeAte?: string    // Expiration date YYYY-MM-DD
   }
   ```

7. **UnknownDocument** — When type cannot be determined:
   ```typescript
   export interface UnknownDocument extends BaseDocument {
     documentType: 'UNKNOWN'
     reason: string          // Why detection failed
   }
   ```

8. **ExtractedDocument union** — Discriminated union of all types:
   ```typescript
   export type ExtractedDocument =
     | RGDocument
     | CPFDocument
     | CNSDocument
     | InsuranceCardDocument
     | UnknownDocument
   ```

9. **ProcessDocumentResult** — Full processing result:
   ```typescript
   export interface ProcessDocumentResult {
     extracted: ExtractedDocument
     storagePath: string     // Supabase Storage path
     originalFilename: string
     mimeType: string
     fileSize: number
     processedAt: string     // ISO 8601
   }
   ```
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/document/document-types.ts`
  </verify>
  <done>Document type definitions created with all Brazilian document types and processing result interface</done>
</task>

<task type="auto">
  <name>Task 3: Create file validator with magic byte verification</name>
  <files>src/lib/document/document-validator.ts</files>
  <action>
Create new file `src/lib/document/document-validator.ts` implementing secure file validation:

1. **Constants**:
   ```typescript
   export const MAX_FILE_SIZE = 5 * 1024 * 1024  // 5MB
   export const ALLOWED_MIME_TYPES = [
     'image/jpeg',
     'image/png',
     'image/heic',
     'application/pdf',
   ] as const
   ```

2. **validateDocumentUpload(file: File)** — Main validation function:
   a. Check file size <= MAX_FILE_SIZE, throw Error('File size exceeds 5MB limit')
   b. Check file.size > 0, throw Error('File is empty')
   c. Convert to buffer: `Buffer.from(await file.arrayBuffer())`
   d. Detect file type with magic bytes: `const detected = await fileTypeFromBuffer(buffer)`
   e. If !detected, throw Error('Unable to determine file type from content')
   f. If !ALLOWED_MIME_TYPES.includes(detected.mime), throw Error with allowed types message
   g. If file.type provided and !== detected.mime, throw Error('MIME type mismatch: declared X, actual Y. Possible file type spoofing attempt.')
   h. Return { buffer, mimeType: detected.mime, extension: detected.ext }

3. **ValidatedFile interface**:
   ```typescript
   export interface ValidatedFile {
     buffer: Buffer
     mimeType: string
     extension: string
   }
   ```

Import from file-type: `import { fileTypeFromBuffer } from 'file-type'`

Follow OWASP File Upload Cheat Sheet recommendations:
- Validate magic bytes, not just file extension
- Check for MIME type spoofing
- Enforce size limits before reading full content
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/document/document-validator.ts`
  </verify>
  <done>File validator created with magic byte verification, MIME spoofing protection, and size limits</done>
</task>

<task type="auto">
  <name>Task 4: Create Zod schemas for Vision API structured outputs</name>
  <files>src/lib/validations/document-schemas.ts</files>
  <action>
Create new file `src/lib/validations/document-schemas.ts` with Zod schemas for GPT-4o Vision structured outputs:

1. **Import Zod**: `import { z } from 'zod'`

2. **Confidence schema** (reusable):
   ```typescript
   const confidenceSchema = z.enum(['high', 'medium', 'low'])
   ```

3. **RGSchema** — Brazilian national ID:
   ```typescript
   export const RGSchema = z.object({
     documentType: z.literal('RG'),
     numeroRG: z.string().min(8).max(10),  // Allow 8-9 digits + optional X
     nome: z.string().min(1),
     dataNascimento: z.string().regex(/^\d{4}-\d{2}-\d{2}$/, 'Date must be YYYY-MM-DD'),
     nomePai: z.string().optional(),
     nomeMae: z.string().optional(),
     naturalidade: z.string().optional(),
     orgaoEmissor: z.string().optional(),
     dataEmissao: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
     confidence: confidenceSchema,
   })
   ```

4. **CPFSchema** — Brazilian tax ID:
   ```typescript
   export const CPFSchema = z.object({
     documentType: z.literal('CPF'),
     numeroCPF: z.string().regex(/^\d{11}$/, 'CPF must be 11 digits'),
     nome: z.string().min(1),
     dataNascimento: z.string().regex(/^\d{4}-\d{2}-\d{2}$/),
     confidence: confidenceSchema,
   })
   ```

5. **CNSSchema** — National health card:
   ```typescript
   export const CNSSchema = z.object({
     documentType: z.literal('CNS'),
     numeroCNS: z.string().regex(/^[127]\d{14}$/, 'CNS must be 15 digits starting with 1, 2, or 7'),
     nome: z.string().min(1),
     confidence: confidenceSchema,
   })
   ```

6. **InsuranceCardSchema** — Health insurance card:
   ```typescript
   export const InsuranceCardSchema = z.object({
     documentType: z.literal('CARTEIRINHA_CONVENIO'),
     numeroCarteirinha: z.string().min(1),
     nomeConvenio: z.string().min(1),
     nomeTitular: z.string().min(1),
     validadeAte: z.string().regex(/^\d{4}-\d{2}-\d{2}$/).optional(),
     confidence: confidenceSchema,
   })
   ```

7. **UnknownSchema** — When type cannot be determined:
   ```typescript
   export const UnknownSchema = z.object({
     documentType: z.literal('UNKNOWN'),
     reason: z.string().min(1),
     confidence: z.literal('low'),  // Unknown is always low confidence
   })
   ```

8. **BrazilianDocumentSchema** — Discriminated union for Vision API:
   ```typescript
   export const BrazilianDocumentSchema = z.discriminatedUnion('documentType', [
     RGSchema,
     CPFSchema,
     CNSSchema,
     InsuranceCardSchema,
     UnknownSchema,
   ])
   ```

9. **Type exports** — Infer types from schemas:
   ```typescript
   export type BrazilianDocument = z.infer<typeof BrazilianDocumentSchema>
   export type RG = z.infer<typeof RGSchema>
   export type CPF = z.infer<typeof CPFSchema>
   export type CNS = z.infer<typeof CNSSchema>
   export type InsuranceCard = z.infer<typeof InsuranceCardSchema>
   ```

Note: These schemas will be used with `zodResponseFormat()` from openai/helpers/zod in Plan 02.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/lib/validations/document-schemas.ts`
  </verify>
  <done>Zod schemas created for all Brazilian document types with discriminated union for Vision API</done>
</task>

</tasks>

<verification>
1. Dependencies installed: `npm list openai file-type`
2. TypeScript compiles: `npx tsc --noEmit`
3. All exports available:
   - `src/lib/document/document-types.ts` exports DocumentType, ExtractedDocument, ProcessDocumentResult
   - `src/lib/document/document-validator.ts` exports validateDocumentUpload, ALLOWED_MIME_TYPES, MAX_FILE_SIZE
   - `src/lib/validations/document-schemas.ts` exports BrazilianDocumentSchema and individual schemas
4. Validation constants are correct: MAX_FILE_SIZE = 5MB, 4 allowed MIME types
</verification>

<success_criteria>
- openai and file-type packages installed in package.json
- Document type definitions cover all 4 Brazilian document types + UNKNOWN
- File validator uses magic byte verification (not just MIME type)
- Zod schemas define structured output format for GPT-4o Vision API
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-complex-tools/20-01-SUMMARY.md`
</output>
