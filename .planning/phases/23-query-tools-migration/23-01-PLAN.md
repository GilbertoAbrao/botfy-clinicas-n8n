---
phase: 23-query-tools-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true

must_haves:
  truths:
    - "N8N has httpHeaderAuth credential configured for Agent API"
    - "buscar_slots_disponiveis tool calls Next.js API directly via HTTP"
    - "AI Agent can fetch available appointment slots"
  artifacts:
    - type: "n8n-credential"
      name: "Botfy Agent API"
      credential_type: "httpHeaderAuth"
    - type: "n8n-node"
      name: "buscar_slots_disponiveis"
      node_type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
  key_links:
    - from: "buscar_slots_disponiveis node"
      to: "/api/agent/slots"
      via: "HTTP GET with Bearer token"
---

<objective>
Setup N8N httpHeaderAuth credential and migrate buscar_slots_disponiveis tool from toolWorkflow to toolHttpRequest.

Purpose: Establish the authentication credential that all migrated tools will share, then migrate the first query tool as a proof-of-concept.
Output: Working HTTP tool in N8N that fetches appointment slots from Next.js API.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-query-tools-migration/23-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create httpHeaderAuth credential for Agent API</name>
  <files>N8N credential (via MCP)</files>
  <action>
Use the N8N MCP tools to create an httpHeaderAuth credential:

1. First, check if credential already exists:
   - Use `mcp__n8n-mcp__list_credentials` to list existing credentials
   - Look for a credential named "Botfy Agent API" or similar

2. If credential doesn't exist, create it using `mcp__n8n-mcp__create_credential`:
   - name: "Botfy Agent API"
   - type: "httpHeaderAuth"
   - data:
     - name: "Authorization"
     - value: "Bearer {AGENT_API_KEY from environment}"

3. Note the credential ID returned - it will be needed for all tool migrations.

IMPORTANT: The Bearer token value should come from the N8N environment variable or be the same token configured in the Next.js AGENT_API_KEY.
  </action>
  <verify>
Use `mcp__n8n-mcp__list_credentials` to confirm credential exists and has correct type.
  </verify>
  <done>httpHeaderAuth credential "Botfy Agent API" exists in N8N with Authorization header configured.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate buscar_slots_disponiveis to toolHttpRequest</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use N8N MCP tools to replace the buscar_slots_disponiveis toolWorkflow node with a toolHttpRequest node:

1. First, get the current workflow to understand the structure:
   - Use `mcp__n8n-mcp__n8n_get_workflow` with workflowId: "bPJamJhBcrVCKgBg"
   - Find the current buscar_slots_disponiveis node (id: "tool-buscar-slots-workflow")

2. Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the node:
   - Operation: updateNode
   - Node name: "buscar_slots_disponiveis"
   - New node configuration:

```json
{
  "parameters": {
    "name": "buscar_slots_disponiveis",
    "toolDescription": "Busca horarios DISPONIVEIS para agendamento. SEMPRE use antes de oferecer horarios. Parametros: data (YYYY-MM-DD obrigatorio). Retorna slots disponiveis, total disponivel e periodos (manha/tarde).",
    "method": "GET",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/slots?data={data}",
    "authentication": "genericCredentialType",
    "genericAuthType": "httpHeaderAuth",
    "sendHeaders": false,
    "sendQuery": false,
    "sendBody": false,
    "placeholderDefinitions": {
      "values": [
        {
          "name": "data",
          "description": "Data no formato YYYY-MM-DD para buscar horarios disponiveis"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 2,
  "credentials": {
    "httpHeaderAuth": {
      "id": "{CREDENTIAL_ID_FROM_TASK_1}",
      "name": "Botfy Agent API"
    }
  }
}
```

3. Preserve the node's position and ID from the original node.

IMPORTANT:
- Use the credential ID obtained in Task 1
- The AGENT_API_URL environment variable should be set in N8N (e.g., "https://botfy-clinicas.com" or the actual deployment URL)
  </action>
  <verify>
1. Use `mcp__n8n-mcp__n8n_get_workflow` to confirm the node type changed to toolHttpRequest
2. Verify the node has the correct credentials, URL, and placeholder definitions
  </verify>
  <done>buscar_slots_disponiveis node is now type "@n8n/n8n-nodes-langchain.toolHttpRequest" with correct URL pattern and Bearer auth.</done>
</task>

<task type="auto">
  <name>Task 3: Test migrated tool via N8N execution</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Verify the migrated tool works end-to-end:

1. Use `mcp__n8n-mcp__execute_workflow` (if available) or manually trigger via N8N UI
2. Test with a sample request that would trigger the buscar_slots_disponiveis tool
3. Verify the response contains the expected slot data structure:
   - success: true
   - data.date
   - data.slots (array of time strings)
   - data.totalAvailable
   - data.period.morning / data.period.afternoon

If MCP execution not available, document manual test steps:
1. Open N8N UI
2. Navigate to "Botfy - Agendamento" workflow
3. Use test panel to send a message like "Quais horarios disponiveis para amanha?"
4. Verify AI Agent calls the HTTP tool and receives valid response
  </action>
  <verify>
Tool returns valid JSON response with slots data when invoked by AI Agent.
  </verify>
  <done>buscar_slots_disponiveis tool successfully fetches data from /api/agent/slots endpoint via HTTP.</done>
</task>

</tasks>

<verification>
1. N8N has httpHeaderAuth credential configured
2. buscar_slots_disponiveis node type is toolHttpRequest (not toolWorkflow)
3. Node URL points to /api/agent/slots with correct placeholder
4. Bearer token authentication is configured
5. Tool returns valid slot data when invoked
</verification>

<success_criteria>
- Credential "Botfy Agent API" exists in N8N with httpHeaderAuth type
- buscar_slots_disponiveis responds with appointment slot data
- AI Agent can successfully use the tool to check availability
- Sub-workflow 8Bke6sYr7r51aeEq is no longer called
</success_criteria>

<output>
After completion, create `.planning/phases/23-query-tools-migration/23-01-SUMMARY.md`
</output>
