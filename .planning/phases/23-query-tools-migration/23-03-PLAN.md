---
phase: 23-query-tools-migration
plan: 03
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "buscar_paciente tool calls Next.js API directly via HTTP"
    - "AI Agent can lookup patient by phone or CPF"
  artifacts:
    - type: "n8n-node"
      name: "buscar_paciente"
      node_type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
  key_links:
    - from: "buscar_paciente node"
      to: "/api/agent/paciente"
      via: "HTTP GET with Bearer token"
---

<objective>
Migrate buscar_paciente tool from toolWorkflow to toolHttpRequest.

Purpose: Enable AI Agent to lookup patient data via direct HTTP call to Next.js API.
Output: Working HTTP tool that queries patient by phone, CPF, or name.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-query-tools-migration/23-RESEARCH.md
@.planning/phases/23-query-tools-migration/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get credential ID and current node state</name>
  <files>N8N workflow/credentials (via MCP)</files>
  <action>
1. Use `mcp__n8n-mcp__list_credentials` to get "Botfy Agent API" credential ID
2. Use `mcp__n8n-mcp__n8n_get_workflow` with workflowId: "bPJamJhBcrVCKgBg"
3. Find buscar_paciente node (position: -2112, 640)
4. Note current node ID and connections for preservation
  </action>
  <verify>
Credential ID and current node state documented.
  </verify>
  <done>Ready to migrate buscar_paciente node.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate buscar_paciente to toolHttpRequest</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the node:

- Operation: updateNode
- Node name: "buscar_paciente"
- New configuration:

```json
{
  "parameters": {
    "name": "buscar_paciente",
    "toolDescription": "Busca dados de um paciente pelo telefone, CPF ou nome. Retorna dados cadastrais completos e proximos agendamentos. Use para verificar se paciente existe no sistema ou obter informacoes do cadastro. Parametros: telefone (com DDD, ex: 5511999998888) OU cpf (apenas numeros) OU nome (busca parcial).",
    "method": "GET",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/paciente?telefone={telefone}",
    "authentication": "genericCredentialType",
    "genericAuthType": "httpHeaderAuth",
    "sendHeaders": false,
    "sendQuery": false,
    "sendBody": false,
    "placeholderDefinitions": {
      "values": [
        {
          "name": "telefone",
          "description": "Telefone do paciente com DDD (ex: 5511999998888). Pode usar cpf ou nome como alternativa adicionando &cpf={cpf} ou &nome={nome} na URL."
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 2,
  "credentials": {
    "httpHeaderAuth": {
      "id": "{CREDENTIAL_ID}",
      "name": "Botfy Agent API"
    }
  }
}
```

Preserve original position (-2112, 640).

NOTE: The API supports telefone, cpf, or nome parameters. We use telefone as primary since it's most common in conversation context.
  </action>
  <verify>
Use `mcp__n8n-mcp__n8n_get_workflow` to confirm:
- Node type is toolHttpRequest
- Credentials are linked
- URL pattern is correct
  </verify>
  <done>buscar_paciente node migrated to toolHttpRequest.</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration and connections</name>
  <files>N8N workflow (via MCP)</files>
  <action>
Final verification:

1. Get workflow and check buscar_paciente node
2. Verify type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
3. Verify URL contains "/api/agent/paciente"
4. Verify httpHeaderAuth credential is attached
5. Check AI Agent still has tool connection

Document configuration for summary.
  </action>
  <verify>
All configuration verified correct.
  </verify>
  <done>buscar_paciente tool migration complete and verified.</done>
</task>

</tasks>

<verification>
1. buscar_paciente node type is toolHttpRequest
2. Node URL points to /api/agent/paciente with telefone placeholder
3. Bearer token authentication configured
4. Sub-workflow igG6sZsStxiDzNRY is no longer called
</verification>

<success_criteria>
- buscar_paciente tool returns patient data via HTTP
- AI Agent can lookup patient by phone number
- Returns both exact match and partial match results correctly
</success_criteria>

<output>
After completion, create `.planning/phases/23-query-tools-migration/23-03-SUMMARY.md`
</output>
