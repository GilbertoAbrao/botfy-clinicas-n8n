---
phase: 23-query-tools-migration
plan: 05
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "buscar_instrucoes tool calls Next.js API directly via HTTP"
    - "AI Agent can retrieve service instructions"
  artifacts:
    - type: "n8n-node"
      name: "buscar_instrucoes"
      node_type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
  key_links:
    - from: "buscar_instrucoes node"
      to: "/api/agent/instrucoes"
      via: "HTTP GET with Bearer token"
---

<objective>
Migrate buscar_instrucoes tool from toolWorkflow to toolHttpRequest.

Purpose: Enable AI Agent to fetch procedure preparation instructions via direct HTTP call to Next.js API.
Output: Working HTTP tool that queries service instructions by service ID or instruction type.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-query-tools-migration/23-RESEARCH.md
@.planning/phases/23-query-tools-migration/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get credential ID and current node state</name>
  <files>N8N workflow/credentials (via MCP)</files>
  <action>
1. Use `mcp__n8n-mcp__list_credentials` to get "Botfy Agent API" credential ID
2. Use `mcp__n8n-mcp__n8n_get_workflow` with workflowId: "bPJamJhBcrVCKgBg"
3. Find buscar_instrucoes node (id: "94ae13d6-d563-4557-8a98-92a1ab1a7afa", position: -1584, 640)
4. Note current node configuration
  </action>
  <verify>
Credential ID and node state documented.
  </verify>
  <done>Ready to migrate buscar_instrucoes node.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate buscar_instrucoes to toolHttpRequest</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the node:

- Operation: updateNode
- Node name: "buscar_instrucoes"
- New configuration:

```json
{
  "parameters": {
    "name": "buscar_instrucoes",
    "toolDescription": "Busca instrucoes de preparo para procedimentos/consultas. Use quando o paciente perguntar sobre preparo, jejum, medicamentos, cuidados antes ou depois de um procedimento. Parametros: servicoId (opcional, ID do servico) ou tipoInstrucao (opcional: preparo/pos-procedimento/medicamentos/jejum). Sem parametros retorna todas as instrucoes.",
    "method": "GET",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/instrucoes?servicoId={servicoId}",
    "authentication": "genericCredentialType",
    "genericAuthType": "httpHeaderAuth",
    "sendHeaders": false,
    "sendQuery": false,
    "sendBody": false,
    "placeholderDefinitions": {
      "values": [
        {
          "name": "servicoId",
          "description": "ID do servico para filtrar instrucoes especificas. Deixe vazio para buscar todas as instrucoes."
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 2,
  "credentials": {
    "httpHeaderAuth": {
      "id": "{CREDENTIAL_ID}",
      "name": "Botfy Agent API"
    }
  }
}
```

Preserve original position (-1584, 640) and ID if possible.

NOTE: API returns instructions with titulo, conteudo, tipoInstrucao, servicoId, and metadata. The tipoInstrucao filter can be added as &tipoInstrucao={tipo} if needed.
  </action>
  <verify>
Use `mcp__n8n-mcp__n8n_get_workflow` to confirm:
- Node type is toolHttpRequest
- Credentials are linked
- URL points to /api/agent/instrucoes
  </verify>
  <done>buscar_instrucoes node migrated to toolHttpRequest.</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration and complete phase summary</name>
  <files>N8N workflow (via MCP)</files>
  <action>
Final verification for buscar_instrucoes:

1. Get workflow and check buscar_instrucoes node
2. Verify type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
3. Verify URL contains "/api/agent/instrucoes"
4. Verify httpHeaderAuth credential is attached
5. Check AI Agent still has tool connection

Expected response structure from API:
- instrucoes: array of instruction objects
- total: number
- filters: applied filters
- instructionTypes: available types

After verification, prepare phase completion summary:
- All 5 query tools migrated
- Credential created and shared
- Sub-workflows no longer called
  </action>
  <verify>
All configuration verified correct.
  </verify>
  <done>buscar_instrucoes tool migration complete. Phase 23 query tools migration finished.</done>
</task>

</tasks>

<verification>
1. buscar_instrucoes node type is toolHttpRequest
2. Node URL points to /api/agent/instrucoes with servicoId placeholder
3. Bearer token authentication configured
4. Sub-workflow NUZv1Gt15LKyiiKz is no longer called
</verification>

<success_criteria>
- buscar_instrucoes tool returns preparation instructions via HTTP
- AI Agent can fetch instructions by service or type
- Completes Phase 23: All 5 query tools now use toolHttpRequest
</success_criteria>

<output>
After completion, create `.planning/phases/23-query-tools-migration/23-05-SUMMARY.md`
</output>
