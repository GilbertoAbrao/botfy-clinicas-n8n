---
phase: 23-query-tools-migration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "buscar_agendamentos tool calls Next.js API directly via HTTP"
    - "AI Agent can search patient appointments by phone/date"
  artifacts:
    - type: "n8n-node"
      name: "buscar_agendamentos"
      node_type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
  key_links:
    - from: "buscar_agendamentos node"
      to: "/api/agent/agendamentos"
      via: "HTTP GET with Bearer token"
---

<objective>
Migrate buscar_agendamentos tool from toolWorkflow to toolHttpRequest.

Purpose: Enable AI Agent to search existing appointments via direct HTTP call to Next.js API.
Output: Working HTTP tool that queries appointments by patient phone, date range, or status.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-query-tools-migration/23-RESEARCH.md
@.planning/phases/23-query-tools-migration/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get credential ID from Plan 23-01</name>
  <files>N8N credentials (via MCP)</files>
  <action>
Retrieve the httpHeaderAuth credential ID created in Plan 23-01:

1. Use `mcp__n8n-mcp__list_credentials` to list credentials
2. Find "Botfy Agent API" credential
3. Note the credential ID for use in node configuration

If credential not found, check 23-01-SUMMARY.md for the ID or re-run credential creation.
  </action>
  <verify>
Credential ID is available for use in node configuration.
  </verify>
  <done>Credential ID retrieved and ready for node migration.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate buscar_agendamentos to toolHttpRequest</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use N8N MCP tools to replace the buscar_agendamentos toolWorkflow node:

1. Get current workflow state:
   - Use `mcp__n8n-mcp__n8n_get_workflow` with workflowId: "bPJamJhBcrVCKgBg"
   - Find buscar_agendamentos node (currently at position -2256, 640)

2. Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the node:
   - Operation: updateNode
   - Node name: "buscar_agendamentos"
   - New node configuration:

```json
{
  "parameters": {
    "name": "buscar_agendamentos",
    "toolDescription": "Busca agendamentos EXISTENTES do paciente. Use para verificar consultas marcadas, historico de agendamentos, ou confirmar detalhes de uma consulta. Parametros: telefone (opcional), dataInicio e dataFim (opcional, formato YYYY-MM-DD), status (opcional: confirmada/pendente/cancelada).",
    "method": "GET",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/agendamentos?telefone={telefone}",
    "authentication": "genericCredentialType",
    "genericAuthType": "httpHeaderAuth",
    "sendHeaders": false,
    "sendQuery": false,
    "sendBody": false,
    "placeholderDefinitions": {
      "values": [
        {
          "name": "telefone",
          "description": "Telefone do paciente com DDD (ex: 5511999998888) para filtrar agendamentos"
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 2,
  "credentials": {
    "httpHeaderAuth": {
      "id": "{CREDENTIAL_ID}",
      "name": "Botfy Agent API"
    }
  }
}
```

3. Preserve the node's original position (-2256, 640).

NOTE: The API supports many optional parameters (dataInicio, dataFim, status, etc.) but we start with telefone as the primary search parameter - the AI can add more params to the URL if needed.
  </action>
  <verify>
1. Use `mcp__n8n-mcp__n8n_get_workflow` to confirm node type changed
2. Verify credentials are correctly linked
3. Verify URL pattern and placeholder
  </verify>
  <done>buscar_agendamentos node is type "@n8n/n8n-nodes-langchain.toolHttpRequest" with correct configuration.</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration</name>
  <files>N8N workflow (via MCP)</files>
  <action>
Verify the migrated tool configuration is complete:

1. Get workflow and extract buscar_agendamentos node
2. Confirm:
   - type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
   - typeVersion: 2
   - URL contains "/api/agent/agendamentos"
   - Authentication uses httpHeaderAuth
   - Placeholder "telefone" is defined

3. Check that the AI Agent node still has connection to this tool (connections array unchanged)

Document any issues or deviations from expected configuration.
  </action>
  <verify>
Node configuration matches expected toolHttpRequest structure.
  </verify>
  <done>buscar_agendamentos tool migration verified and ready for production use.</done>
</task>

</tasks>

<verification>
1. buscar_agendamentos node type is toolHttpRequest (not toolWorkflow)
2. Node URL points to /api/agent/agendamentos with telefone placeholder
3. Bearer token authentication via httpHeaderAuth credential
4. Sub-workflow 8Ug0F3KuLov6EeCQ is no longer called
</verification>

<success_criteria>
- buscar_agendamentos tool returns appointment data via HTTP
- AI Agent can search appointments by patient phone number
- Tool correctly authenticates with Bearer token
</success_criteria>

<output>
After completion, create `.planning/phases/23-query-tools-migration/23-02-SUMMARY.md`
</output>
