---
phase: 23-query-tools-migration
plan: 04
type: execute
wave: 2
depends_on: ["23-01"]
files_modified: []
autonomous: true

must_haves:
  truths:
    - "status_pre_checkin tool calls Next.js API directly via HTTP"
    - "AI Agent can check pre-checkin status for appointments"
  artifacts:
    - type: "n8n-node"
      name: "status_pre_checkin"
      node_type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
  key_links:
    - from: "status_pre_checkin node"
      to: "/api/agent/pre-checkin/status"
      via: "HTTP GET with Bearer token"
---

<objective>
Migrate status_pre_checkin tool from toolWorkflow to toolHttpRequest.

Purpose: Enable AI Agent to check pre-checkin status via direct HTTP call to Next.js API.
Output: Working HTTP tool that queries pre-checkin status by appointment ID or patient phone.
</objective>

<execution_context>
@/Users/gilberto/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gilberto/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/23-query-tools-migration/23-RESEARCH.md
@.planning/phases/23-query-tools-migration/23-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Get credential ID and current node state</name>
  <files>N8N workflow/credentials (via MCP)</files>
  <action>
1. Use `mcp__n8n-mcp__list_credentials` to get "Botfy Agent API" credential ID
2. Use `mcp__n8n-mcp__n8n_get_workflow` with workflowId: "bPJamJhBcrVCKgBg"
3. Find status_pre_checkin node (id: "5d5f0dcf-7391-4e98-acd1-c76363fdd698", position: -1456, 640)
4. Note current node configuration for reference
  </action>
  <verify>
Credential ID and node state documented.
  </verify>
  <done>Ready to migrate status_pre_checkin node.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate status_pre_checkin to toolHttpRequest</name>
  <files>N8N workflow bPJamJhBcrVCKgBg (via MCP)</files>
  <action>
Use `mcp__n8n-mcp__n8n_update_partial_workflow` to update the node:

- Operation: updateNode
- Node name: "status_pre_checkin"
- New configuration:

```json
{
  "parameters": {
    "name": "status_pre_checkin",
    "toolDescription": "Consulta o status do pre-check-in de um paciente. Retorna se dados foram confirmados, documentos enviados, instrucoes recebidas e lista de pendencias. Use para verificar o que falta antes da consulta. Parametros: agendamentoId (ID do agendamento) OU telefone (telefone do paciente com DDD).",
    "method": "GET",
    "url": "={{ $env.AGENT_API_URL }}/api/agent/pre-checkin/status?telefone={telefone}",
    "authentication": "genericCredentialType",
    "genericAuthType": "httpHeaderAuth",
    "sendHeaders": false,
    "sendQuery": false,
    "sendBody": false,
    "placeholderDefinitions": {
      "values": [
        {
          "name": "telefone",
          "description": "Telefone do paciente com DDD (ex: 5511999998888). Alternativamente pode usar agendamentoId adicionando &agendamentoId={id} na URL."
        }
      ]
    }
  },
  "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
  "typeVersion": 2,
  "credentials": {
    "httpHeaderAuth": {
      "id": "{CREDENTIAL_ID}",
      "name": "Botfy Agent API"
    }
  }
}
```

Preserve original position (-1456, 640) and ID if possible.

NOTE: API accepts agendamentoId, pacienteId, or telefone. Using telefone as primary since AI typically has patient phone from conversation.
  </action>
  <verify>
Use `mcp__n8n-mcp__n8n_get_workflow` to confirm:
- Node type is toolHttpRequest
- Credentials are linked
- URL points to /api/agent/pre-checkin/status
  </verify>
  <done>status_pre_checkin node migrated to toolHttpRequest.</done>
</task>

<task type="auto">
  <name>Task 3: Verify migration and connections</name>
  <files>N8N workflow (via MCP)</files>
  <action>
Final verification:

1. Get workflow and check status_pre_checkin node
2. Verify type: "@n8n/n8n-nodes-langchain.toolHttpRequest"
3. Verify URL contains "/api/agent/pre-checkin/status"
4. Verify httpHeaderAuth credential is attached
5. Check AI Agent still has tool connection

Expected response structure from API:
- exists: boolean
- status: string
- dadosConfirmados: boolean
- documentosEnviados: boolean
- instrucoesEnviadas: boolean
- pendencias: string[]
- appointment: object

Document configuration for summary.
  </action>
  <verify>
All configuration verified correct.
  </verify>
  <done>status_pre_checkin tool migration complete and verified.</done>
</task>

</tasks>

<verification>
1. status_pre_checkin node type is toolHttpRequest
2. Node URL points to /api/agent/pre-checkin/status with telefone placeholder
3. Bearer token authentication configured
4. Sub-workflow holwGQuksZPsSb19 is no longer called
</verification>

<success_criteria>
- status_pre_checkin tool returns pre-checkin status via HTTP
- AI Agent can check what's pending before an appointment
- Tool correctly returns pendencias list for incomplete pre-checkin
</success_criteria>

<output>
After completion, create `.planning/phases/23-query-tools-migration/23-04-SUMMARY.md`
</output>
