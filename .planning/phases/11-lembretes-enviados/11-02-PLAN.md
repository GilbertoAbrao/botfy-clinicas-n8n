# Plan 11-02: Date, Patient, and Status Filters

**Phase:** 11 - Lembretes Enviados
**Requirements:** HIST-02 (date range), HIST-03 (patient filter), HIST-04 (status filter)
**Status:** Not Started

## Objective

Create filter components for the lembretes enviados list: date range picker, patient search/select, and status dropdown.

## Context

**Existing Pattern:** Follow `src/components/config-lembretes/config-lembrete-search.tsx`

**Filters needed:**
1. **Date Range (HIST-02):** Start date and end date pickers
2. **Patient (HIST-03):** Searchable patient dropdown
3. **Status (HIST-04):** Dropdown for status_resposta (pendente/confirmado/cancelado)
4. **Tipo (bonus):** Dropdown for tipo_lembrete (48h/24h/2h)

## Tasks

### Task 1: Create filter component

**File:** `src/components/lembretes-enviados/lembrete-enviado-filters.tsx`

```typescript
'use client';

import { useState } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { Calendar, Filter, Search, X } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover';
import { Calendar as CalendarComponent } from '@/components/ui/calendar';
import { format } from 'date-fns';
import { ptBR } from 'date-fns/locale';
import {
  STATUS_RESPOSTA,
  STATUS_RESPOSTA_LABELS,
  TIPO_LEMBRETE,
  TIPO_LEMBRETE_LABELS,
} from '@/lib/validations/lembrete-enviado';

interface FilterProps {
  onFilterChange: (params: Record<string, string | undefined>) => void;
  currentFilters: {
    status?: string;
    tipo?: string;
    paciente_id?: string;
    data_inicio?: string;
    data_fim?: string;
  };
}

export function LembreteEnviadoFilters({ onFilterChange, currentFilters }: FilterProps) {
  // Date range state
  const [startDate, setStartDate] = useState<Date | undefined>(
    currentFilters.data_inicio ? new Date(currentFilters.data_inicio) : undefined
  );
  const [endDate, setEndDate] = useState<Date | undefined>(
    currentFilters.data_fim ? new Date(currentFilters.data_fim) : undefined
  );

  // Patient search
  const [patientSearch, setPatientSearch] = useState('');
  const [patients, setPatients] = useState<Array<{id: number, nome: string}>>([]);
  const [loadingPatients, setLoadingPatients] = useState(false);

  // Search patients
  const searchPatients = async (query: string) => {
    if (query.length < 2) {
      setPatients([]);
      return;
    }
    setLoadingPatients(true);
    try {
      const res = await fetch(`/api/pacientes?q=${encodeURIComponent(query)}&limit=10`);
      const data = await res.json();
      setPatients(data.pacientes || []);
    } catch {
      setPatients([]);
    } finally {
      setLoadingPatients(false);
    }
  };

  // Apply date filter
  const applyDateFilter = () => {
    onFilterChange({
      ...currentFilters,
      data_inicio: startDate?.toISOString(),
      data_fim: endDate?.toISOString(),
    });
  };

  // Clear all filters
  const clearFilters = () => {
    setStartDate(undefined);
    setEndDate(undefined);
    setPatientSearch('');
    onFilterChange({});
  };

  const hasActiveFilters = Object.values(currentFilters).some(v => v);

  return (
    <div className="bg-white rounded-lg border p-4 space-y-4">
      <div className="flex items-center gap-2">
        <Filter className="h-4 w-4 text-gray-500" />
        <span className="font-medium text-gray-700">Filtros</span>
        {hasActiveFilters && (
          <Button variant="ghost" size="sm" onClick={clearFilters}>
            <X className="h-3 w-3 mr-1" />
            Limpar
          </Button>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {/* Status filter (HIST-04) */}
        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">Status</label>
          <Select
            value={currentFilters.status || 'all'}
            onValueChange={(value) =>
              onFilterChange({
                ...currentFilters,
                status: value === 'all' ? undefined : value,
              })
            }
          >
            <SelectTrigger>
              <SelectValue placeholder="Todos os status" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos os status</SelectItem>
              {STATUS_RESPOSTA.map((status) => (
                <SelectItem key={status} value={status}>
                  {STATUS_RESPOSTA_LABELS[status]}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Tipo filter */}
        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">Tipo</label>
          <Select
            value={currentFilters.tipo || 'all'}
            onValueChange={(value) =>
              onFilterChange({
                ...currentFilters,
                tipo: value === 'all' ? undefined : value,
              })
            }
          >
            <SelectTrigger>
              <SelectValue placeholder="Todos os tipos" />
            </SelectTrigger>
            <SelectContent>
              <SelectItem value="all">Todos os tipos</SelectItem>
              {TIPO_LEMBRETE.map((tipo) => (
                <SelectItem key={tipo} value={tipo}>
                  {TIPO_LEMBRETE_LABELS[tipo]}
                </SelectItem>
              ))}
            </SelectContent>
          </Select>
        </div>

        {/* Date range (HIST-02) */}
        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">Data Inicio</label>
          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" className="w-full justify-start">
                <Calendar className="mr-2 h-4 w-4" />
                {startDate ? format(startDate, 'dd/MM/yyyy', { locale: ptBR }) : 'Selecionar'}
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-auto p-0">
              <CalendarComponent
                mode="single"
                selected={startDate}
                onSelect={(date) => {
                  setStartDate(date);
                  if (date) {
                    onFilterChange({
                      ...currentFilters,
                      data_inicio: date.toISOString(),
                    });
                  }
                }}
                locale={ptBR}
              />
            </PopoverContent>
          </Popover>
        </div>

        <div className="space-y-2">
          <label className="text-sm font-medium text-gray-700">Data Fim</label>
          <Popover>
            <PopoverTrigger asChild>
              <Button variant="outline" className="w-full justify-start">
                <Calendar className="mr-2 h-4 w-4" />
                {endDate ? format(endDate, 'dd/MM/yyyy', { locale: ptBR }) : 'Selecionar'}
              </Button>
            </PopoverTrigger>
            <PopoverContent className="w-auto p-0">
              <CalendarComponent
                mode="single"
                selected={endDate}
                onSelect={(date) => {
                  setEndDate(date);
                  if (date) {
                    onFilterChange({
                      ...currentFilters,
                      data_fim: date.toISOString(),
                    });
                  }
                }}
                locale={ptBR}
              />
            </PopoverContent>
          </Popover>
        </div>
      </div>

      {/* Patient search (HIST-03) - separate row for better UX */}
      <div className="space-y-2">
        <label className="text-sm font-medium text-gray-700">Paciente</label>
        <div className="relative">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400" />
          <Input
            placeholder="Buscar paciente por nome..."
            className="pl-10"
            value={patientSearch}
            onChange={(e) => {
              setPatientSearch(e.target.value);
              searchPatients(e.target.value);
            }}
          />
          {/* Patient dropdown results */}
          {patients.length > 0 && (
            <div className="absolute z-10 w-full mt-1 bg-white border rounded-md shadow-lg max-h-60 overflow-auto">
              {patients.map((patient) => (
                <button
                  key={patient.id}
                  className="w-full px-4 py-2 text-left hover:bg-gray-100"
                  onClick={() => {
                    setPatientSearch(patient.nome);
                    setPatients([]);
                    onFilterChange({
                      ...currentFilters,
                      paciente_id: String(patient.id),
                    });
                  }}
                >
                  {patient.nome}
                </button>
              ))}
            </div>
          )}
          {loadingPatients && (
            <div className="absolute z-10 w-full mt-1 bg-white border rounded-md p-2 text-center text-gray-500">
              Buscando...
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
```

### Task 2: Integrate filters with page client

Update `src/components/lembretes-enviados/lembretes-enviados-page-client.tsx` to:
- Maintain filter state from URL search params
- Pass filter change handler to filters component
- Update URL when filters change (for bookmarkable URLs)
- Refetch data when filters change

### Task 3: Update API route to handle all filter combinations

Ensure the GET route in `src/app/api/lembretes-enviados/route.ts` handles:
- `status` filter - exact match on status_resposta
- `tipo` filter - exact match on tipo_lembrete
- `paciente_id` filter - filter through agendamentos join
- `data_inicio` filter - enviado_em >= value
- `data_fim` filter - enviado_em <= value

### Task 4: Add quick filter presets

Add preset buttons for common filters:
- "Hoje" - today's reminders
- "Esta semana" - last 7 days
- "Pendentes" - status = pendente
- "Alto risco" - risco_noshow >= 70

## Success Criteria

- [ ] Status filter dropdown works (HIST-04)
- [ ] Date range picker filters by enviado_em (HIST-02)
- [ ] Patient search finds and filters by patient (HIST-03)
- [ ] Tipo filter dropdown works
- [ ] Clear filters button resets all filters
- [ ] Filters persist in URL (bookmarkable)
- [ ] Quick filter presets work
- [ ] Combined filters work correctly (AND logic)

## Notes

- Patient search should debounce API calls (300ms)
- Date pickers should use ptBR locale
- Clear individual filter should be possible (X button on each)
- Mobile view should collapse filters into expandable section
