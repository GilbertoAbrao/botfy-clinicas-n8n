# Plan 11-01: Lembretes Enviados List Page with Table

**Phase:** 11 - Lembretes Enviados
**Requirements:** HIST-01 (paginated list), HIST-05 (risco_noshow column)
**Status:** Not Started

## Objective

Create read-only API route and list page showing sent reminders (`lembretes_enviados` table) with pagination.

## Context

**Table:** `lembretes_enviados`

| Column | Type | Description |
|--------|------|-------------|
| id | SERIAL | Primary key |
| agendamento_id | INTEGER FK | Reference to agendamentos.id |
| telefone | VARCHAR(20) | Patient phone number |
| tipo_lembrete | VARCHAR(20) | Type: `48h`, `24h`, `2h` |
| status_resposta | VARCHAR(20) | Status: `pendente`, `confirmado`, `cancelado` |
| evento_id | VARCHAR(100) | External event ID (optional) |
| enviado_em | TIMESTAMP | Send timestamp |
| respondido_em | TIMESTAMP | Response timestamp (optional) |
| risco_noshow | INTEGER | Risk score 0-100 (added Phase 9) |
| mensagem_enviada | TEXT | Message content (added Phase 9) |

**Pattern:** Follow `src/app/api/config-lembretes/route.ts` for read-only listing.

## Tasks

### Task 1: Create validation schema

**File:** `src/lib/validations/lembrete-enviado.ts`

```typescript
import { z } from 'zod';

// Status enum for type safety
export const STATUS_RESPOSTA = ['pendente', 'confirmado', 'cancelado'] as const;
export type StatusResposta = typeof STATUS_RESPOSTA[number];

// Tipo lembrete enum
export const TIPO_LEMBRETE = ['48h', '24h', '2h'] as const;
export type TipoLembrete = typeof TIPO_LEMBRETE[number];

// Labels for display
export const STATUS_RESPOSTA_LABELS: Record<StatusResposta, string> = {
  pendente: 'Pendente',
  confirmado: 'Confirmado',
  cancelado: 'Cancelado',
};

export const TIPO_LEMBRETE_LABELS: Record<TipoLembrete, string> = {
  '48h': '48 horas antes',
  '24h': '24 horas antes',
  '2h': '2 horas antes',
};

// Type for database record
export interface LembreteEnviado {
  id: number;
  agendamento_id: number;
  telefone: string;
  tipo_lembrete: TipoLembrete;
  status_resposta: StatusResposta;
  evento_id: string | null;
  enviado_em: string;
  respondido_em: string | null;
  risco_noshow: number | null;
  mensagem_enviada: string | null;
  // Joined fields (optional)
  paciente_nome?: string;
  servico_nome?: string;
  data_agendamento?: string;
}

// Query params validation
export const lembreteEnviadoQuerySchema = z.object({
  page: z.coerce.number().int().min(1).optional().default(1),
  limit: z.coerce.number().int().min(1).max(100).optional().default(20),
  status: z.enum(STATUS_RESPOSTA).optional(),
  tipo: z.enum(TIPO_LEMBRETE).optional(),
  paciente_id: z.coerce.number().int().positive().optional(),
  data_inicio: z.string().datetime().optional(),
  data_fim: z.string().datetime().optional(),
});

export type LembreteEnviadoQuery = z.infer<typeof lembreteEnviadoQuerySchema>;

// Helper to format risk score as badge color
export function getRiscoColor(risco: number | null): string {
  if (risco === null) return 'gray';
  if (risco >= 70) return 'red';
  if (risco >= 40) return 'yellow';
  return 'green';
}

// Helper to format risk score label
export function getRiscoLabel(risco: number | null): string {
  if (risco === null) return 'N/A';
  if (risco >= 70) return 'Alto';
  if (risco >= 40) return 'Medio';
  return 'Baixo';
}
```

### Task 2: Create GET route for listing

**File:** `src/app/api/lembretes-enviados/route.ts`

**GET:** List sent reminders with optional filters
- Query params: `page`, `limit`, `status`, `tipo`, `paciente_id`, `data_inicio`, `data_fim`
- Auth: require authenticated user
- Permission: `PERMISSIONS.VIEW_REPORTS` (read-only access)
- Join: agendamentos + pacientes for patient name display
- Returns: `{ lembretes: LembreteEnviado[], pagination }`

```typescript
import { NextRequest, NextResponse } from 'next/server';
import { getCurrentUserWithRole } from '@/lib/auth/session';
import { checkPermission, PERMISSIONS } from '@/lib/rbac/permissions';
import { createServerSupabaseClient } from '@/lib/supabase/server';
import { lembreteEnviadoQuerySchema } from '@/lib/validations/lembrete-enviado';

export async function GET(request: NextRequest) {
  try {
    // Authentication
    const user = await getCurrentUserWithRole();
    if (!user) {
      return NextResponse.json({ error: 'Nao autenticado' }, { status: 401 });
    }

    // Authorization - VIEW_REPORTS for read-only
    if (!checkPermission(user.role, PERMISSIONS.VIEW_REPORTS)) {
      return NextResponse.json(
        { error: 'Sem permissao para visualizar lembretes' },
        { status: 403 }
      );
    }

    // Parse and validate query params
    const searchParams = Object.fromEntries(request.nextUrl.searchParams);
    const params = lembreteEnviadoQuerySchema.parse(searchParams);

    const { page, limit, status, tipo, paciente_id, data_inicio, data_fim } = params;
    const offset = (page - 1) * limit;

    const supabase = await createServerSupabaseClient();

    // Build query with joins for patient info
    let query = supabase
      .from('lembretes_enviados')
      .select(`
        *,
        agendamentos!inner (
          id,
          data_hora,
          pacientes!inner (id, nome),
          servicos (nome)
        )
      `, { count: 'exact' });

    // Apply filters
    if (status) {
      query = query.eq('status_resposta', status);
    }
    if (tipo) {
      query = query.eq('tipo_lembrete', tipo);
    }
    if (paciente_id) {
      query = query.eq('agendamentos.paciente_id', paciente_id);
    }
    if (data_inicio) {
      query = query.gte('enviado_em', data_inicio);
    }
    if (data_fim) {
      query = query.lte('enviado_em', data_fim);
    }

    // Order by send date descending, paginate
    query = query
      .order('enviado_em', { ascending: false })
      .range(offset, offset + limit - 1);

    const { data, count, error } = await query;

    if (error) {
      console.error('Error fetching lembretes_enviados:', error);
      return NextResponse.json(
        { error: 'Erro ao buscar lembretes enviados' },
        { status: 500 }
      );
    }

    // Transform data for frontend
    const lembretes = (data || []).map(item => ({
      ...item,
      paciente_nome: item.agendamentos?.pacientes?.nome,
      servico_nome: item.agendamentos?.servicos?.nome,
      data_agendamento: item.agendamentos?.data_hora,
    }));

    const total = count || 0;
    const totalPages = Math.ceil(total / limit);

    return NextResponse.json({
      lembretes,
      pagination: { page, limit, total, totalPages },
    });
  } catch (error) {
    console.error('Error fetching lembretes_enviados:', error);
    return NextResponse.json(
      { error: 'Erro ao buscar lembretes enviados' },
      { status: 500 }
    );
  }
}
```

### Task 3: Create table component

**File:** `src/components/lembretes-enviados/lembrete-enviado-table.tsx`

Columns:
| Column | Description |
|--------|-------------|
| Paciente | Patient name (from join) |
| Telefone | Phone number (masked) |
| Tipo | Reminder type badge (48h/24h/2h) |
| Status | Status badge (pendente/confirmado/cancelado) |
| Risco | Risk score badge with color coding |
| Enviado em | Send timestamp |
| Acoes | View details button |

Features:
- Pagination component (reuse ConfigLembretePagination pattern)
- Empty state with icon
- Mobile-responsive card view
- Row click to open detail modal

### Task 4: Create page client component

**File:** `src/components/lembretes-enviados/lembretes-enviados-page-client.tsx`

State management:
- lembretes list
- pagination
- loading state
- detail modal open/close
- selected lembrete

### Task 5: Create page and navigation

**File:** `src/app/admin/lembretes-enviados/page.tsx`

```typescript
import { Suspense } from 'react';
import Link from 'next/link';
import { ArrowLeft } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Skeleton } from '@/components/ui/skeleton';
import { LembretesEnviadosPageClient } from '@/components/lembretes-enviados';

export default async function LembretesEnviadosPage({ searchParams }: PageProps) {
  const params = await searchParams;
  return (
    <div className="space-y-6">
      <div>
        <Link href="/dashboard">
          <Button variant="ghost" size="sm">
            <ArrowLeft className="mr-2 h-4 w-4" />
            Voltar para Dashboard
          </Button>
        </Link>
      </div>

      <div>
        <h1 className="text-3xl font-bold text-gray-900">
          Lembretes Enviados
        </h1>
        <p className="text-gray-600 mt-1">
          Historico de lembretes enviados aos pacientes
        </p>
      </div>

      <Suspense fallback={<TableSkeleton />}>
        <LembretesEnviadosPageClient {...params} />
      </Suspense>
    </div>
  );
}
```

### Task 6: Add navigation link

Update `src/components/layout/sidebar-menu.tsx` or navigation component to include link to `/admin/lembretes-enviados`.

## Success Criteria

- [ ] Validation schema created with types and helpers
- [ ] GET /api/lembretes-enviados returns paginated list with joins
- [ ] Route requires authentication and VIEW_REPORTS permission
- [ ] Table displays all fields with proper formatting
- [ ] Risk score shown with color-coded badge (HIST-05)
- [ ] Pagination works correctly
- [ ] Empty state displayed when no results
- [ ] Navigation link added to sidebar

## Notes

- This is READ-ONLY - no create/update/delete operations
- Use VIEW_REPORTS permission (not MANAGE_SYSTEM_CONFIG) since this is analytics data
- Phone numbers should be partially masked for privacy (show last 4 digits)
- Timestamps should use ptBR locale formatting
