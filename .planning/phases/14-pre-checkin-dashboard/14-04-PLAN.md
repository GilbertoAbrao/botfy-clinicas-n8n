---
phase: 14-pre-checkin-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/pre-checkin/pre-checkin-detail-modal.tsx
  - src/components/pre-checkin/workflow-timeline.tsx
  - src/components/pre-checkin/send-reminder-dialog.tsx
  - src/app/api/pre-checkin/[id]/route.ts
  - src/app/api/pre-checkin/[id]/send-reminder/route.ts
  - src/lib/pre-checkin/n8n-reminder.ts
autonomous: true

must_haves:
  truths:
    - "Detail modal shows full checklist with dados/docs/instrucoes status"
    - "Timeline shows workflow progression with timestamps"
    - "User can mark pre-checkin as complete or incomplete from modal"
    - "Send reminder shows confirmation dialog before sending"
    - "Rate limit prevents sending reminders more than once per 4 hours"
  artifacts:
    - path: "src/components/pre-checkin/pre-checkin-detail-modal.tsx"
      provides: "Detail modal showing full pre-checkin information"
      exports: ["PreCheckinDetailModal"]
    - path: "src/components/pre-checkin/workflow-timeline.tsx"
      provides: "Timeline component showing workflow steps"
      exports: ["WorkflowTimeline"]
    - path: "src/components/pre-checkin/send-reminder-dialog.tsx"
      provides: "Confirmation dialog for sending reminders"
      exports: ["SendReminderDialog"]
    - path: "src/app/api/pre-checkin/[id]/route.ts"
      provides: "PUT endpoint to update pre-checkin status"
      exports: ["PUT"]
    - path: "src/app/api/pre-checkin/[id]/send-reminder/route.ts"
      provides: "POST endpoint to send reminder via N8N"
      exports: ["POST"]
    - path: "src/lib/pre-checkin/n8n-reminder.ts"
      provides: "N8N webhook integration with rate limiting"
      exports: ["sendPreCheckinReminder", "canSendReminder"]
  key_links:
    - from: "src/app/api/pre-checkin/[id]/send-reminder/route.ts"
      to: "src/lib/pre-checkin/n8n-reminder.ts"
      via: "import sendPreCheckinReminder"
      pattern: "import.*sendPreCheckinReminder"
    - from: "src/lib/pre-checkin/n8n-reminder.ts"
      to: "process.env.N8N_WEBHOOK_PRE_CHECKIN_REMINDER"
      via: "fetch webhook URL"
      pattern: "N8N_WEBHOOK_PRE_CHECKIN_REMINDER"
---

<objective>
Create detail modal with checklist view, workflow timeline, status update actions, and N8N reminder integration.

Purpose: Enable staff to view detailed pre-checkin status, understand workflow progression, and take action (mark complete/incomplete, send reminders).
Output: Detail modal with timeline, API endpoints for updates and reminders, N8N webhook integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-pre-checkin-dashboard/14-CONTEXT.md
@.planning/phases/14-pre-checkin-dashboard/14-RESEARCH.md
@.planning/phases/14-pre-checkin-dashboard/14-01-SUMMARY.md

Reference patterns:
@src/components/lembretes-enviados/lembrete-enviado-detail-modal.tsx
@src/lib/waitlist/auto-fill.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkflowTimeline and SendReminderDialog components</name>
  <files>src/components/pre-checkin/workflow-timeline.tsx, src/components/pre-checkin/send-reminder-dialog.tsx</files>
  <action>
**Create src/components/pre-checkin/workflow-timeline.tsx:**

1. 'use client' directive

2. Imports:
   - cn from @/lib/utils
   - CheckCircle, Clock, XCircle from lucide-react
   - format from date-fns
   - ptBR from date-fns/locale

3. TimelineStep interface:
```typescript
interface TimelineStep {
  label: string
  status: 'completed' | 'current' | 'pending'
  timestamp?: string | null
}
```

4. Props:
```typescript
interface WorkflowTimelineProps {
  steps: TimelineStep[]
}
```

5. Component implementation:
```tsx
export function WorkflowTimeline({ steps }: WorkflowTimelineProps) {
  return (
    <div className="space-y-4 relative">
      {steps.map((step, index) => (
        <div key={index} className="flex items-start gap-3 relative">
          {/* Connector line */}
          {index < steps.length - 1 && (
            <div className="absolute left-[15px] top-8 w-0.5 h-[calc(100%-8px)] bg-gray-200" />
          )}

          {/* Icon */}
          <div className={cn(
            "rounded-full p-1.5 border-2 z-10 bg-white",
            step.status === 'completed' && "bg-green-100 border-green-500",
            step.status === 'current' && "bg-blue-100 border-blue-500",
            step.status === 'pending' && "bg-gray-100 border-gray-300"
          )}>
            {step.status === 'completed' && <CheckCircle className="h-4 w-4 text-green-600" />}
            {step.status === 'current' && <Clock className="h-4 w-4 text-blue-600" />}
            {step.status === 'pending' && <XCircle className="h-4 w-4 text-gray-400" />}
          </div>

          {/* Content */}
          <div className="flex-1 pb-4">
            <p className={cn(
              "font-medium text-sm",
              step.status === 'completed' && "text-green-900",
              step.status === 'current' && "text-blue-900",
              step.status === 'pending' && "text-gray-500"
            )}>
              {step.label}
            </p>
            {step.timestamp && (
              <p className="text-xs text-gray-500 mt-0.5">
                {format(new Date(step.timestamp), "dd/MM/yyyy 'as' HH:mm", { locale: ptBR })}
              </p>
            )}
          </div>
        </div>
      ))}
    </div>
  )
}
```

**Create src/components/pre-checkin/send-reminder-dialog.tsx:**

1. 'use client' directive

2. Imports:
   - AlertDialog components from @/components/ui/alert-dialog
   - Button from @/components/ui/button
   - Loader2 from lucide-react

3. Props:
```typescript
interface SendReminderDialogProps {
  open: boolean
  patientName: string
  loading?: boolean
  disabled?: boolean
  disabledReason?: string
  onConfirm: () => void
  onCancel: () => void
}
```

4. Component:
```tsx
export function SendReminderDialog({
  open,
  patientName,
  loading = false,
  disabled = false,
  disabledReason,
  onConfirm,
  onCancel
}: SendReminderDialogProps) {
  return (
    <AlertDialog open={open} onOpenChange={(open) => !open && onCancel()}>
      <AlertDialogContent>
        <AlertDialogHeader>
          <AlertDialogTitle>Enviar lembrete?</AlertDialogTitle>
          <AlertDialogDescription>
            {disabled ? (
              <span className="text-amber-600">{disabledReason}</span>
            ) : (
              <>
                Deseja enviar lembrete de pre-checkin para{' '}
                <span className="font-semibold">{patientName}</span>?
              </>
            )}
          </AlertDialogDescription>
        </AlertDialogHeader>
        <AlertDialogFooter>
          <AlertDialogCancel disabled={loading}>Cancelar</AlertDialogCancel>
          <AlertDialogAction
            onClick={onConfirm}
            disabled={loading || disabled}
          >
            {loading && <Loader2 className="h-4 w-4 mr-2 animate-spin" />}
            Enviar
          </AlertDialogAction>
        </AlertDialogFooter>
      </AlertDialogContent>
    </AlertDialog>
  )
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Timeline shows workflow steps, dialog shows confirmation before sending</done>
</task>

<task type="auto">
  <name>Task 2: Create N8N reminder integration and API routes</name>
  <files>src/lib/pre-checkin/n8n-reminder.ts, src/app/api/pre-checkin/[id]/route.ts, src/app/api/pre-checkin/[id]/send-reminder/route.ts</files>
  <action>
**Create src/lib/pre-checkin/n8n-reminder.ts:**

1. Imports:
   - differenceInHours from date-fns
   - TZDate from @date-fns/tz
   - createServerSupabaseClient from @/lib/supabase/server

2. canSendReminder function:
```typescript
export async function canSendReminder(preCheckinId: string): Promise<{
  canSend: boolean
  hoursRemaining?: number
}> {
  const supabase = await createServerSupabaseClient()

  const { data, error } = await supabase
    .from('pre_checkin')
    .select('lembrete_enviado_em')
    .eq('id', preCheckinId)
    .single()

  if (error || !data) {
    return { canSend: false }
  }

  if (!data.lembrete_enviado_em) {
    return { canSend: true }
  }

  const now = new TZDate(new Date(), 'America/Sao_Paulo')
  const lastReminder = new TZDate(data.lembrete_enviado_em, 'America/Sao_Paulo')
  const hoursSince = differenceInHours(now, lastReminder)

  if (hoursSince < 4) {
    return {
      canSend: false,
      hoursRemaining: Math.ceil(4 - hoursSince)
    }
  }

  return { canSend: true }
}
```

3. sendPreCheckinReminder function:
```typescript
export async function sendPreCheckinReminder(preCheckinId: string): Promise<{ success: boolean }> {
  const supabase = await createServerSupabaseClient()

  // Check rate limit
  const rateCheck = await canSendReminder(preCheckinId)
  if (!rateCheck.canSend) {
    throw new Error(`Proximo envio disponivel em ${rateCheck.hoursRemaining} horas`)
  }

  // Fetch pre-checkin with related data
  const { data: preCheckin, error: fetchError } = await supabase
    .from('pre_checkin')
    .select(`
      *,
      agendamento:agendamentos!pre_checkin_agendamento_id_fkey(
        id,
        data_hora
      ),
      paciente:pacientes!pre_checkin_paciente_id_fkey(
        id,
        nome,
        telefone
      )
    `)
    .eq('id', preCheckinId)
    .single()

  if (fetchError || !preCheckin) {
    throw new Error('Pre-checkin nao encontrado')
  }

  // Call N8N webhook
  const webhookUrl = process.env.N8N_WEBHOOK_PRE_CHECKIN_REMINDER

  if (!webhookUrl) {
    console.warn('[sendPreCheckinReminder] N8N webhook not configured')
    // Don't throw - allow graceful degradation in dev
    // In production, this should be configured
  } else {
    try {
      const response = await fetch(webhookUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          preCheckinId: preCheckin.id,
          patientPhone: preCheckin.paciente?.telefone,
          patientName: preCheckin.paciente?.nome,
          appointmentDateTime: preCheckin.agendamento?.data_hora,
        }),
      })

      if (!response.ok) {
        throw new Error('Falha ao enviar lembrete via N8N')
      }
    } catch (error) {
      console.error('[sendPreCheckinReminder] Webhook error:', error)
      throw new Error('Erro ao enviar lembrete. Tente novamente.')
    }
  }

  // Update lembrete_enviado_em timestamp
  const { error: updateError } = await supabase
    .from('pre_checkin')
    .update({ lembrete_enviado_em: new Date().toISOString() })
    .eq('id', preCheckinId)

  if (updateError) {
    console.error('[sendPreCheckinReminder] Failed to update timestamp:', updateError)
  }

  return { success: true }
}
```

**Create src/app/api/pre-checkin/[id]/route.ts:**

1. GET handler - fetch single pre-checkin by ID (with related data)

2. PUT handler - update pre-checkin status:
   - Auth/RBAC check
   - Validate status is 'completo' or 'incompleto'
   - Update status and updated_at
   - Audit log: AuditAction.UPDATE_PRE_CHECKIN
   - Return updated record

**Create src/app/api/pre-checkin/[id]/send-reminder/route.ts:**

1. POST handler:
   - Auth/RBAC check
   - Call sendPreCheckinReminder(params.id)
   - Audit log: AuditAction.SEND_PRE_CHECKIN_REMINDER
   - Return { success: true } or error with message
   - Handle rate limit errors gracefully (return 429)
  </action>
  <verify>
Test endpoints:
- `curl -X PUT http://localhost:3051/api/pre-checkin/1 -d '{"status":"completo"}'`
- Check that rate limit error returns 429 status
  </verify>
  <done>PUT updates status, POST sends reminder with rate limiting, N8N webhook called</done>
</task>

<task type="auto">
  <name>Task 3: Create PreCheckinDetailModal component</name>
  <files>src/components/pre-checkin/pre-checkin-detail-modal.tsx</files>
  <action>
Create the detail modal that shows full pre-checkin information:

1. 'use client' directive

2. Imports:
   - Dialog components from @/components/ui/dialog
   - Button from @/components/ui/button
   - Separator from @/components/ui/separator
   - StatusBadge from ./status-badge
   - WorkflowTimeline from ./workflow-timeline
   - SendReminderDialog from ./send-reminder-dialog
   - PreCheckin, calculateProgress from @/lib/validations/pre-checkin
   - format from date-fns, ptBR locale
   - Icons: CheckCircle, XCircle, Loader2, Bell
   - useState from react
   - toast from sonner

3. Props:
```typescript
interface PreCheckinDetailModalProps {
  preCheckin: PreCheckin | null
  isOpen: boolean
  onClose: () => void
  onStatusChange: () => void  // Called after status update to refresh list
}
```

4. Internal state:
   - confirmDialogOpen: boolean
   - loading: boolean (for actions)
   - reminderLoading: boolean
   - canSendReminder: boolean
   - reminderDisabledReason: string | null

5. useEffect to check canSendReminder when modal opens

6. Modal content:
   a) **Header:** Patient name + Status badge
   b) **Info section:**
      - Consulta: formatted date/time
      - Servico: service name
      - Telefone: patient phone
      - Progresso: progress percentage

   c) **Checklist section** (title: "Checklist"):
      - Dados confirmados: CheckCircle (green) or XCircle (gray) + label
      - Documentos enviados: CheckCircle (green) or XCircle (gray) + label
      - Instrucoes enviadas: CheckCircle (green) or XCircle (gray) + label

   d) **Timeline section** (title: "Historico"):
      - Build TimelineStep array from preCheckin:
        - "Criado" -> created_at
        - "Mensagem enviada" -> mensagem_enviada_em (if exists)
        - "Lembrete enviado" -> lembrete_enviado_em (if exists)
        - "Completo" -> updated_at (only if status === 'completo')
      - Determine current/completed/pending status for each step

   e) **Actions section:**
      - "Marcar como Completo" button (if status !== 'completo')
      - "Marcar como Incompleto" button (if status !== 'incompleto')
      - "Enviar Lembrete" button (disabled if rate limited, with tooltip)

7. Action handlers:
   - handleMarkStatus(status): PUT /api/pre-checkin/[id], toast, call onStatusChange
   - handleSendReminder: open confirm dialog, then POST /api/pre-checkin/[id]/send-reminder
   - checkCanSendReminder: call canSendReminder helper

8. Include SendReminderDialog component for confirmation

Layout should be clean with clear sections separated by Separator component.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Modal shows full checklist, timeline, and actions; status updates work; reminder confirmation shown</done>
</task>

</tasks>

<verification>
1. All components compile without TypeScript errors
2. Timeline shows correct step progression
3. Checklist shows checkmarks for completed items
4. Mark complete/incomplete updates database and shows toast
5. Send reminder shows confirmation dialog
6. Rate limit prevents sending within 4 hours (returns 429)
7. Modal closes after successful action
</verification>

<success_criteria>
- PCHK-07: Click row opens detail modal
- PCHK-08: Detail modal shows checklist (dados, docs, instrucoes)
- PCHK-09: Mark complete/incomplete from modal works
- PCHK-10: Send reminder triggers N8N webhook (with confirmation)
- PCHK-12: Timeline shows workflow progression with timestamps
- Rate limit: 1 reminder per 4 hours enforced server-side
- Confirmation modal shown before sending (per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/14-pre-checkin-dashboard/14-04-SUMMARY.md`
</output>
