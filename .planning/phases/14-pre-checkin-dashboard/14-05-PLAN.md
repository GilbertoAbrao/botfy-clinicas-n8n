---
phase: 14-pre-checkin-dashboard
plan: 05
type: execute
wave: 3
depends_on: ["14-01", "14-02", "14-03", "14-04"]
files_modified:
  - src/components/pre-checkin/pre-checkin-dashboard.tsx
  - src/app/admin/pre-checkin/page.tsx
  - src/components/layout/admin-nav.tsx
autonomous: true

must_haves:
  truths:
    - "Dashboard page accessible at /admin/pre-checkin"
    - "Analytics cards display at top of page"
    - "Table/cards show pre-checkin records with filters"
    - "Row click opens detail modal"
    - "All components work together as integrated dashboard"
    - "Navigation includes link to pre-checkin page"
  artifacts:
    - path: "src/components/pre-checkin/pre-checkin-dashboard.tsx"
      provides: "Main dashboard container orchestrating all components"
      exports: ["PreCheckinDashboard"]
    - path: "src/app/admin/pre-checkin/page.tsx"
      provides: "Server component page at /admin/pre-checkin"
      exports: ["default"]
  key_links:
    - from: "src/app/admin/pre-checkin/page.tsx"
      to: "src/components/pre-checkin/pre-checkin-dashboard.tsx"
      via: "import PreCheckinDashboard"
      pattern: "import.*PreCheckinDashboard"
    - from: "src/components/pre-checkin/pre-checkin-dashboard.tsx"
      to: "src/hooks/use-pre-checkin.ts"
      via: "usePreCheckin hook"
      pattern: "usePreCheckin|usePreCheckinAnalytics"
---

<objective>
Integrate all pre-checkin components into a working dashboard page with navigation.

Purpose: Provide a complete, usable dashboard that staff can access to monitor and manage pre-checkins.
Output: Working page at /admin/pre-checkin with full functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-pre-checkin-dashboard/14-CONTEXT.md
@.planning/phases/14-pre-checkin-dashboard/14-RESEARCH.md
@.planning/phases/14-pre-checkin-dashboard/14-01-SUMMARY.md
@.planning/phases/14-pre-checkin-dashboard/14-02-SUMMARY.md
@.planning/phases/14-pre-checkin-dashboard/14-03-SUMMARY.md
@.planning/phases/14-pre-checkin-dashboard/14-04-SUMMARY.md

Reference patterns:
@src/components/agenda/agenda-list-view.tsx
@src/components/lembretes-enviados/lembretes-enviados-page-client.tsx
@src/app/admin/lembretes-enviados/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreCheckinDashboard container component</name>
  <files>src/components/pre-checkin/pre-checkin-dashboard.tsx</files>
  <action>
Create the main dashboard container that orchestrates all components:

1. 'use client' directive

2. Imports:
   - useState from react
   - useSearchParams from next/navigation
   - toast from sonner
   - usePreCheckin, usePreCheckinAnalytics from @/hooks/use-pre-checkin
   - PreCheckinAnalytics from ./pre-checkin-analytics
   - PreCheckinFilters from ./pre-checkin-filters
   - PreCheckinTable from ./pre-checkin-table
   - PreCheckinCards from ./pre-checkin-cards
   - PreCheckinPagination from ./pre-checkin-pagination
   - PreCheckinDetailModal from ./pre-checkin-detail-modal
   - SendReminderDialog from ./send-reminder-dialog
   - Skeleton from @/components/ui/skeleton
   - PreCheckin from @/lib/validations/pre-checkin

3. Component structure:
```tsx
export function PreCheckinDashboard() {
  const searchParams = useSearchParams()

  // Extract filters from URL
  const filters = {
    status: searchParams.get('status') || undefined,
    dateStart: searchParams.get('dateStart') || undefined,
    dateEnd: searchParams.get('dateEnd') || undefined,
    search: searchParams.get('search') || undefined,
    page: parseInt(searchParams.get('page') || '1'),
    limit: parseInt(searchParams.get('limit') || '50'),
  }

  // Fetch data
  const { preCheckins, pagination, loading, error, refetch } = usePreCheckin(filters)
  const { analytics, loading: analyticsLoading } = usePreCheckinAnalytics(
    filters.dateStart,
    filters.dateEnd
  )

  // Modal state
  const [selectedPreCheckin, setSelectedPreCheckin] = useState<PreCheckin | null>(null)
  const [detailModalOpen, setDetailModalOpen] = useState(false)
  const [reminderDialogOpen, setReminderDialogOpen] = useState(false)
  const [reminderTarget, setReminderTarget] = useState<PreCheckin | null>(null)
  const [reminderLoading, setReminderLoading] = useState(false)

  // Handlers
  const handleRowClick = (preCheckin: PreCheckin) => {
    setSelectedPreCheckin(preCheckin)
    setDetailModalOpen(true)
  }

  const handleSendReminderClick = (preCheckin: PreCheckin) => {
    setReminderTarget(preCheckin)
    setReminderDialogOpen(true)
  }

  const handleSendReminder = async () => {
    if (!reminderTarget) return

    setReminderLoading(true)
    try {
      const res = await fetch(`/api/pre-checkin/${reminderTarget.id}/send-reminder`, {
        method: 'POST',
      })

      if (!res.ok) {
        const data = await res.json()
        throw new Error(data.error || 'Erro ao enviar lembrete')
      }

      toast.success('Lembrete enviado!')
      refetch()
    } catch (error) {
      toast.error(error instanceof Error ? error.message : 'Erro ao enviar lembrete')
    } finally {
      setReminderLoading(false)
      setReminderDialogOpen(false)
      setReminderTarget(null)
    }
  }

  const handleModalClose = () => {
    setDetailModalOpen(false)
    setSelectedPreCheckin(null)
  }

  const handleStatusChange = () => {
    refetch()
  }

  return (
    <div className="space-y-6">
      {/* Analytics Cards */}
      <PreCheckinAnalytics
        completionRate={analytics?.completionRate || 0}
        pendingCount={analytics?.pendingCount || 0}
        overdueCount={analytics?.overdueCount || 0}
        loading={analyticsLoading}
      />

      {/* Filters */}
      <PreCheckinFilters />

      {/* Loading state */}
      {loading && (
        <div className="space-y-4">
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-12 w-full" />
          <Skeleton className="h-12 w-full" />
        </div>
      )}

      {/* Error state */}
      {error && (
        <div className="text-red-600 text-center py-8 bg-red-50 rounded-lg border border-red-200">
          {error}
        </div>
      )}

      {/* Data display */}
      {!loading && !error && (
        <>
          {/* Desktop table */}
          <div className="hidden md:block">
            <PreCheckinTable
              data={preCheckins}
              onRowClick={handleRowClick}
              onSendReminder={handleSendReminderClick}
            />
          </div>

          {/* Mobile cards */}
          <div className="md:hidden">
            <PreCheckinCards
              data={preCheckins}
              onRowClick={handleRowClick}
              onSendReminder={handleSendReminderClick}
            />
          </div>

          {/* Pagination */}
          {pagination.totalPages > 1 && (
            <PreCheckinPagination
              currentPage={pagination.page}
              totalPages={pagination.totalPages}
              totalItems={pagination.total}
              itemsPerPage={pagination.limit}
            />
          )}

          {/* Item count */}
          <div className="text-sm text-gray-600 text-center">
            Mostrando {preCheckins.length} de {pagination.total} pre-checkins
          </div>
        </>
      )}

      {/* Detail Modal */}
      <PreCheckinDetailModal
        preCheckin={selectedPreCheckin}
        isOpen={detailModalOpen}
        onClose={handleModalClose}
        onStatusChange={handleStatusChange}
      />

      {/* Send Reminder Dialog */}
      <SendReminderDialog
        open={reminderDialogOpen}
        patientName={reminderTarget?.paciente?.nome || ''}
        loading={reminderLoading}
        onConfirm={handleSendReminder}
        onCancel={() => {
          setReminderDialogOpen(false)
          setReminderTarget(null)
        }}
      />
    </div>
  )
}
```
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>Dashboard component integrates analytics, filters, table/cards, pagination, and modals</done>
</task>

<task type="auto">
  <name>Task 2: Create page and update navigation</name>
  <files>src/app/admin/pre-checkin/page.tsx, src/components/layout/admin-nav.tsx</files>
  <action>
**Create src/app/admin/pre-checkin/page.tsx:**

1. Server component (no 'use client')

2. Imports:
   - getCurrentUserWithRole from @/lib/auth/session
   - redirect from next/navigation
   - PreCheckinDashboard from @/components/pre-checkin/pre-checkin-dashboard

3. Page structure:
```tsx
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { redirect } from 'next/navigation'
import { PreCheckinDashboard } from '@/components/pre-checkin/pre-checkin-dashboard'

export const metadata = {
  title: 'Pre-Checkin | Botfy ClinicOps',
  description: 'Dashboard de gerenciamento de pre-checkins',
}

export default async function PreCheckinPage() {
  const user = await getCurrentUserWithRole()

  if (!user) {
    redirect('/auth/login')
  }

  // RBAC: Only ADMIN and ATENDENTE can access
  if (!['ADMIN', 'ATENDENTE'].includes(user.role)) {
    redirect('/dashboard')
  }

  return (
    <div className="p-6">
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-gray-900">Pre-Checkin</h1>
        <p className="text-gray-600 mt-1">
          Gerencie o status de pre-checkin dos pacientes
        </p>
      </div>

      <PreCheckinDashboard />
    </div>
  )
}
```

**Update src/components/layout/admin-nav.tsx:**

1. Find the navigation items array

2. Add new item for Pre-Checkin:
```typescript
{
  name: 'Pre-Checkin',
  href: '/admin/pre-checkin',
  icon: ClipboardCheck,  // from lucide-react
}
```

3. Position it logically:
   - After "Lembretes Enviados" (related to appointment preparation)
   - Before "Analytics" (if exists)

4. Import ClipboardCheck icon from lucide-react if not already imported

The nav item should appear for ADMIN and ATENDENTE roles (same as other operational pages).
  </action>
  <verify>
1. `npm run build` succeeds
2. Navigate to http://localhost:3051/admin/pre-checkin shows dashboard
3. Navigation link appears in sidebar
  </verify>
  <done>Page renders, navigation link works, RBAC enforced</done>
</task>

<task type="auto">
  <name>Task 3: End-to-end verification and polish</name>
  <files>None (verification only)</files>
  <action>
Perform end-to-end verification of the complete dashboard:

1. **Analytics cards:**
   - Verify completion rate shows percentage
   - Verify pending count shows number
   - Verify overdue count shows number with correct color

2. **Filters:**
   - Test status filter (each status option)
   - Test date range filter (quick presets and custom)
   - Test search by patient name
   - Verify filters update URL params
   - Verify filters reset page to 1

3. **Table/Cards:**
   - Verify all columns display correctly
   - Verify status badges have correct colors
   - Verify progress bars show correct percentage
   - Test responsive: table on desktop, cards on mobile

4. **Detail modal:**
   - Click row to open modal
   - Verify checklist shows checkmarks correctly
   - Verify timeline shows progression
   - Test "Marcar como Completo" action
   - Test "Marcar como Incompleto" action
   - Verify toast notifications appear

5. **Send reminder:**
   - Click "Enviar Lembrete" button
   - Verify confirmation dialog appears
   - Confirm and verify toast appears
   - Try to send again within 4 hours, verify rate limit works

6. **Pagination:**
   - If more than 50 records, verify pagination works
   - Test items per page selector

7. **Error handling:**
   - Verify error states display gracefully
   - Verify loading states show skeletons

If any issues found, fix them in the appropriate component files.
  </action>
  <verify>
All features work end-to-end:
- Dashboard loads without errors
- All filters work
- Detail modal shows full information
- Status updates persist
- Send reminder works (with rate limit)
  </verify>
  <done>Complete dashboard is functional and polished</done>
</task>

</tasks>

<verification>
1. Page accessible at /admin/pre-checkin
2. Navigation link appears in sidebar
3. Analytics cards show metrics
4. Filters work and persist in URL
5. Table shows on desktop, cards on mobile
6. Row click opens detail modal
7. Status updates work from modal
8. Send reminder works with confirmation
9. No console errors
10. Responsive design works
</verification>

<success_criteria>
- PCHK-01: Dashboard page shows all pre-checkin records
- PCHK-02: Table displays all required columns
- PCHK-03: Status badges use correct colors
- PCHK-04-06: All filters work
- PCHK-07: Row click opens detail modal
- PCHK-08: Detail modal shows checklist
- PCHK-09: Mark complete/incomplete works
- PCHK-10: Send reminder triggers webhook
- PCHK-11: Analytics cards show metrics
- PCHK-12: Timeline shows workflow progression
- PCHK-13: Mobile responsive
</success_criteria>

<output>
After completion, create `.planning/phases/14-pre-checkin-dashboard/14-05-SUMMARY.md`
</output>
