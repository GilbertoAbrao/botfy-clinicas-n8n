---
phase: 3
plan: 3
wave: 2
autonomous: true
requirements:
  - PAT-06
  - PAT-07
  - PAT-08
  - PAT-09
must_haves:
  truths:
    - "User can create new patient with required fields (nome, telefone)"
    - "User can edit patient contact information (telefone, email)"
    - "User can edit patient personal data (nome, CPF, data_nascimento, endereco)"
    - "User can edit patient convênio information (convenio, numero_carteirinha)"
    - "CPF uniqueness is enforced (duplicate CPF shows error)"
    - "Form validates required fields before submission"
    - "Form validates CPF format (###.###.###-##)"
    - "Form validates phone format (E.164: +5511987654321)"
    - "Create and update operations are audit logged"
  artifacts:
    - "src/app/pacientes/novo/page.tsx (new patient form page)"
    - "src/app/pacientes/[id]/editar/page.tsx (edit patient form page)"
    - "src/app/api/pacientes/route.ts POST handler (create patient API)"
    - "src/app/api/pacientes/[id]/route.ts PUT handler (update patient API)"
    - "src/components/patients/patient-form.tsx (reusable form component)"
    - "src/lib/validations/patient.ts (Zod schema for patient validation)"
  key_links:
    - "POST /api/pacientes creates new patient and returns ID"
    - "PUT /api/pacientes/[id] updates patient fields"
    - "/pacientes/novo page displays new patient form"
    - "/pacientes/[id]/editar page displays edit form pre-filled with current data"
    - "Form submission redirects to /pacientes/[id] on success"
---

# Plan 03-03: Patient CRUD Operations

## Objective

Implement create and update operations for patient records with form validation and audit logging.

## Execution Context

**Stack:**
- Next.js 16+ App Router with Server Actions
- Zod for form validation
- react-hook-form + @hookform/resolvers/zod for form state
- Prisma for database mutations
- shadcn/ui Form, Input, Select components
- date-fns for date handling

**Patterns:**
- Server Actions for mutations (no client-side API calls)
- Reusable form component for create and edit modes
- Progressive enhancement (works without JS for basic submit)
- Optimistic UI updates with revalidatePath
- Form sections organized by data type (contact, personal, convênio)
- Audit logging for all mutations (CREATE_PATIENT, UPDATE_PATIENT)

**Validation Rules:**
- **Required:** nome, telefone
- **Optional:** email, cpf, dataNascimento, endereco, convenio, numeroCarteirinha
- **CPF:** Unique, format ###.###.###-##, validate checksum digits
- **Phone:** E.164 format (+5511987654321)
- **Email:** Standard email validation
- **Date:** ISO date string, past date only (birth date)

## Context

**Phase 3 Goal:** Enable comprehensive patient data management with search, profiles, history, and document handling.

**This Plan's Scope:** Patient create and update (PAT-06, PAT-07, PAT-08, PAT-09).

**Database Schema:**
```prisma
model Patient {
  id                String    @id @default(uuid())
  nome              String    // Required
  telefone          String    // Required
  email             String?
  cpf               String?   @unique  // Must be unique if provided
  dataNascimento    DateTime?
  endereco          String?
  convenio          String?
  numeroCarteirinha String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([telefone])
  @@index([cpf])
  @@index([nome])
  @@map("patients")
}
```

**Current State:**
- Patient model exists with indexes
- Profile view exists (Plan 2) for redirect after save
- Auth and audit logging configured (Phase 1)

**Form Structure:**
```
PatientForm (reusable)
├── Seção 1: Informações de Contato
│   ├── Nome* (text)
│   ├── Telefone* (tel, formatted)
│   └── Email (email)
├── Seção 2: Dados Pessoais
│   ├── CPF (text, formatted, unique check)
│   ├── Data de Nascimento (date picker)
│   └── Endereço (textarea)
├── Seção 3: Convênio
│   ├── Convênio (select: Unimed, Bradesco, Amil, SulAmérica, Sem Convênio)
│   └── Número da Carteirinha (text, enabled if convênio selected)
└── Actions
    ├── Salvar (primary button)
    └── Cancelar (secondary button, navigate back)
```

## Tasks

### Task 1: Create Patient Validation Schema
**File:** `src/lib/validations/patient.ts`

Define Zod schema for patient form validation:

```typescript
import { z } from 'zod';

// CPF validation with checksum
function isValidCPF(cpf: string): boolean {
  // Remove formatting
  cpf = cpf.replace(/[^\d]/g, '');

  if (cpf.length !== 11) return false;
  if (/^(\d)\1{10}$/.test(cpf)) return false; // All digits same

  // Validate checksum digits (implement algorithm)
  // Return true if valid, false otherwise
}

export const patientSchema = z.object({
  nome: z.string().min(3, 'Nome deve ter pelo menos 3 caracteres'),
  telefone: z.string().regex(/^\+55\d{10,11}$/, 'Telefone inválido (formato: +5511987654321)'),
  email: z.string().email('Email inválido').optional().or(z.literal('')),
  cpf: z.string()
    .regex(/^\d{3}\.\d{3}\.\d{3}-\d{2}$/, 'CPF inválido (formato: 123.456.789-00)')
    .refine(isValidCPF, 'CPF inválido')
    .optional()
    .or(z.literal('')),
  dataNascimento: z.string().optional().or(z.literal('')), // ISO date string
  endereco: z.string().optional().or(z.literal('')),
  convenio: z.string().optional().or(z.literal('')),
  numeroCarteirinha: z.string().optional().or(z.literal(''))
});

export type PatientFormData = z.infer<typeof patientSchema>;
```

**Acceptance:**
- [ ] Schema validates required fields (nome, telefone)
- [ ] Schema validates phone format (E.164)
- [ ] Schema validates email format
- [ ] Schema validates CPF format and checksum
- [ ] Optional fields accept empty strings or undefined
- [ ] TypeScript types generated from schema

### Task 2: Build Reusable Patient Form Component
**File:** `src/components/patients/patient-form.tsx`

Create form component accepting mode ('create' | 'edit') and initialData:

```typescript
interface PatientFormProps {
  mode: 'create' | 'edit';
  initialData?: Patient;
  onSubmit: (data: PatientFormData) => Promise<void>;
  onCancel: () => void;
}
```

Use react-hook-form with Zod resolver. Organize fields into 3 sections with shadcn/ui Separator.

**Form Features:**
- Auto-format CPF as user types (add dots and dash)
- Auto-format phone as user types (+55 11 98765-4321 display)
- Date picker for dataNascimento (shadcn/ui Calendar)
- Convênio select with common options + "Outro" option
- Disable "Número da Carteirinha" if no convênio selected
- Loading state during submission
- Error messages inline below each field

**Acceptance:**
- [ ] Form renders in create mode with empty fields
- [ ] Form renders in edit mode with pre-filled data
- [ ] CPF auto-formats as user types (123.456.789-00)
- [ ] Phone auto-formats as user types (+55 11 98765-4321)
- [ ] Date picker opens calendar for dataNascimento
- [ ] Convênio select shows predefined options
- [ ] Carteirinha field disabled when no convênio selected
- [ ] Validation errors display inline below fields
- [ ] Submit button shows loading spinner during submission
- [ ] Cancel button calls onCancel prop

### Task 3: Create New Patient Page
**File:** `src/app/pacientes/novo/page.tsx`

Page with PatientForm in create mode:
- Page title: "Cadastrar Novo Paciente"
- Breadcrumb: Pacientes > Novo
- Form with empty initialData
- Server Action for form submission
- Redirect to /pacientes/[newId] on success
- Show toast notification on success

**Server Action:**
```typescript
async function createPatient(data: PatientFormData) {
  'use server';

  // Validate session (ADMIN or ATENDENTE only)
  // Validate data with Zod schema
  // Check CPF uniqueness if provided
  // Create patient with Prisma
  // Log audit entry (CREATE_PATIENT)
  // Revalidate /pacientes path
  // Return { success: true, patientId: string } or { success: false, error: string }
}
```

**Acceptance:**
- [ ] Page renders at /pacientes/novo
- [ ] Requires authentication (redirects to /entrar if not logged in)
- [ ] Requires ADMIN or ATENDENTE role (403 if unauthorized)
- [ ] Form displays with empty fields
- [ ] Submit creates new patient in database
- [ ] Duplicate CPF shows validation error "CPF já cadastrado"
- [ ] Success redirects to /pacientes/[newId]
- [ ] Success shows toast: "Paciente cadastrado com sucesso"
- [ ] Logs audit entry (CREATE_PATIENT action)
- [ ] Cancel button navigates back to /pacientes

### Task 4: Create Edit Patient Page
**File:** `src/app/pacientes/[id]/editar/page.tsx`

Page with PatientForm in edit mode:
- Page title: "Editar Paciente - [Nome]"
- Breadcrumb: Pacientes > [Nome] > Editar
- Fetch patient data and pass as initialData
- Server Action for form submission
- Redirect to /pacientes/[id] on success
- Show toast notification on success

**Server Action:**
```typescript
async function updatePatient(id: string, data: PatientFormData) {
  'use server';

  // Validate session (ADMIN or ATENDENTE only)
  // Validate data with Zod schema
  // Check CPF uniqueness if changed (exclude current patient)
  // Update patient with Prisma
  // Log audit entry (UPDATE_PATIENT with details of what changed)
  // Revalidate /pacientes/[id] path
  // Return { success: true } or { success: false, error: string }
}
```

**Acceptance:**
- [ ] Page renders at /pacientes/[id]/editar
- [ ] Requires authentication (redirects to /entrar if not logged in)
- [ ] Requires ADMIN or ATENDENTE role (403 if unauthorized)
- [ ] Form displays with current patient data pre-filled
- [ ] Submit updates patient in database
- [ ] Duplicate CPF (different patient) shows error
- [ ] Same CPF (unchanged) allows update
- [ ] Success redirects to /pacientes/[id]
- [ ] Success shows toast: "Paciente atualizado com sucesso"
- [ ] Logs audit entry (UPDATE_PATIENT with changed fields in details)
- [ ] Cancel button navigates back to /pacientes/[id]

### Task 5: Add Create API Endpoint
**File:** `src/app/api/pacientes/route.ts`

Add POST handler to existing file:

```typescript
export async function POST(req: Request) {
  // Parse and validate request body
  // Check authentication and authorization
  // Validate with Zod schema
  // Check CPF uniqueness
  // Create patient
  // Log audit entry
  // Return 201 with patient ID
}
```

**Acceptance:**
- [ ] POST /api/pacientes creates new patient
- [ ] Returns 201 with patient ID and location header
- [ ] Returns 400 for validation errors (with field-specific messages)
- [ ] Returns 409 for duplicate CPF
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs CREATE_PATIENT audit entry
- [ ] Sets createdAt and updatedAt timestamps

### Task 6: Add Update API Endpoint
**File:** `src/app/api/pacientes/[id]/route.ts`

Add PUT handler to existing file:

```typescript
export async function PUT(req: Request, { params }: { params: { id: string } }) {
  // Parse and validate request body
  // Check authentication and authorization
  // Validate with Zod schema
  // Check patient exists
  // Check CPF uniqueness (exclude current patient)
  // Update patient
  // Log audit entry with changed fields
  // Return 200 with updated patient
}
```

**Acceptance:**
- [ ] PUT /api/pacientes/[id] updates patient
- [ ] Returns 200 with updated patient data
- [ ] Returns 400 for validation errors
- [ ] Returns 404 for non-existent patient
- [ ] Returns 409 for duplicate CPF (different patient)
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs UPDATE_PATIENT audit entry with changed fields in details JSON
- [ ] Updates updatedAt timestamp

### Task 7: Add RLS Policies for Patient Mutations
**File:** Create migration `prisma/migrations/[timestamp]_patient_crud_rls/migration.sql`

Add RLS policies for patient table:

```sql
-- Allow ADMIN and ATENDENTE to insert patients
CREATE POLICY "Users can create patients"
  ON patients FOR INSERT
  TO authenticated
  WITH CHECK (
    auth.jwt() ->> 'role' IN ('ADMIN', 'ATENDENTE')
  );

-- Allow ADMIN and ATENDENTE to update patients
CREATE POLICY "Users can update patients"
  ON patients FOR UPDATE
  TO authenticated
  USING (
    auth.jwt() ->> 'role' IN ('ADMIN', 'ATENDENTE')
  );
```

Apply migration via Supabase MCP or Prisma CLI.

**Acceptance:**
- [ ] ADMIN can create patients
- [ ] ATENDENTE can create patients
- [ ] Unauthenticated users cannot create patients
- [ ] ADMIN can update patients
- [ ] ATENDENTE can update patients
- [ ] Unauthenticated users cannot update patients

## Verification

**Manual Test Scenarios:**

1. **Create New Patient (Happy Path):**
   - Navigate to /pacientes/novo
   - Fill required fields: Nome "Test Patient", Telefone "+5511999999999"
   - Fill optional fields: Email, CPF, Date of Birth, Address, Convênio
   - Click "Salvar"
   - Verify redirect to /pacientes/[newId]
   - Verify toast shows success message
   - Verify patient appears in /pacientes list

2. **Create with Duplicate CPF:**
   - Navigate to /pacientes/novo
   - Enter CPF "123.456.789-00" (João Silva's CPF from seed)
   - Fill other required fields
   - Click "Salvar"
   - Verify error: "CPF já cadastrado"
   - Verify patient not created in database

3. **Create with Invalid CPF:**
   - Enter CPF "111.111.111-11" (invalid checksum)
   - Verify error: "CPF inválido"
   - Enter CPF "12345" (wrong format)
   - Verify error: "CPF inválido (formato: 123.456.789-00)"

4. **Edit Patient (Happy Path):**
   - Navigate to /pacientes/[id]/editar for João Silva
   - Verify form pre-filled with current data
   - Change phone number to "+5511988888888"
   - Change email to "new.email@example.com"
   - Click "Salvar"
   - Verify redirect to /pacientes/[id]
   - Verify profile shows updated data
   - Verify toast shows success message

5. **Edit with CPF Conflict:**
   - Edit João Silva (CPF: 123.456.789-00)
   - Change CPF to Carlos Oliveira's CPF (987.654.321-00)
   - Verify error: "CPF já cadastrado"
   - Change CPF back to original (123.456.789-00)
   - Verify update succeeds (same CPF allowed)

6. **Form Validation:**
   - Leave required field empty (nome), verify error on submit
   - Enter invalid email "notanemail", verify error
   - Enter invalid phone "12345", verify error
   - Verify auto-formatting works (CPF, phone)

7. **Authorization:**
   - Log out, verify /pacientes/novo redirects to /entrar
   - Log in as ATENDENTE, verify access granted
   - Check audit_logs table for CREATE_PATIENT and UPDATE_PATIENT entries

**Automated Tests:**
- API routes create and update patients
- Validation schema rejects invalid data
- Duplicate CPF returns 409
- Form component renders correctly in both modes
- Server Actions return success/error correctly

## Success Criteria

- [ ] User can create new patient with required fields (nome, telefone)
- [ ] User can edit patient contact information
- [ ] User can edit patient personal data
- [ ] User can edit patient convênio information
- [ ] Form validates all fields before submission
- [ ] Duplicate CPF shows clear error message
- [ ] Only authenticated ADMIN/ATENDENTE can create/update
- [ ] All mutations are audit logged
- [ ] Success shows toast notification and redirects appropriately

## Output

**Files Created:**
1. `src/lib/validations/patient.ts` - Zod validation schema
2. `src/components/patients/patient-form.tsx` - Reusable form component
3. `src/app/pacientes/novo/page.tsx` - New patient page
4. `src/app/pacientes/[id]/editar/page.tsx` - Edit patient page
5. `prisma/migrations/[timestamp]_patient_crud_rls/migration.sql` - RLS policies

**Files Modified:**
1. `src/app/api/pacientes/route.ts` - Add POST handler
2. `src/app/api/pacientes/[id]/route.ts` - Add PUT handler

**Database Changes:**
- RLS policies for patient INSERT and UPDATE operations

**Tests:**
- API route unit tests (create, update, validation, auth)
- Form component tests (rendering, validation, submission)
- Integration tests (create → view, edit → view)

**Requirements Completed:**
- PAT-06: User can create new patient record ✓
- PAT-07: User can edit patient contact information ✓
- PAT-08: User can edit patient personal data ✓
- PAT-09: User can edit patient convênio information ✓
