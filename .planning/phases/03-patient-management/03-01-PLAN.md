---
phase: 3
plan: 1
wave: 1
autonomous: true
requirements:
  - PAT-01
  - PAT-02
  - PAT-03
must_haves:
  truths:
    - "Search by nome returns matching patients (case-insensitive partial match)"
    - "Search by telefone returns exact phone match"
    - "Search by CPF returns exact CPF match"
    - "Search returns results in <500ms for typical dataset"
    - "Empty search shows all patients (paginated)"
    - "Search results are paginated (20 per page)"
  artifacts:
    - "src/app/pacientes/page.tsx (patient list page)"
    - "src/app/api/pacientes/route.ts (search API endpoint)"
    - "src/components/patients/patient-search.tsx (search form component)"
    - "src/components/patients/patient-table.tsx (results table component)"
  key_links:
    - "GET /api/pacientes?q=Silva returns patients with 'Silva' in name"
    - "GET /api/pacientes?telefone=+5511987654321 returns exact phone match"
    - "GET /api/pacientes?cpf=123.456.789-00 returns exact CPF match"
    - "/pacientes page shows search form with patient results table"
    - "Clicking patient row navigates to /pacientes/[id]"
---

# Plan 03-01: Patient Search & List

## Objective

Implement patient search functionality with filters and paginated results table.

## Execution Context

**Stack:**
- Next.js 16+ App Router
- React Server Components for initial load
- Prisma for database queries with indexes (nome, telefone, cpf)
- shadcn/ui Table component for results
- Supabase PostgreSQL with RLS (already configured in Phase 1)

**Patterns:**
- Server-side search (no client-side filtering for performance)
- URL query params for search state (shareable URLs)
- Optimistic pagination with `<Suspense>` boundaries
- Audit logging for PHI access (VIEW_PATIENT action)

## Context

**Phase 3 Goal:** Enable comprehensive patient data management with search, profiles, history, and document handling.

**This Plan's Scope:** Search and list functionality (PAT-01, PAT-02, PAT-03).

**Database Schema (already exists):**
```prisma
model Patient {
  id                String    @id @default(uuid())
  nome              String
  telefone          String
  email             String?
  cpf               String?   @unique
  dataNascimento    DateTime?
  endereco          String?
  convenio          String?
  numeroCarteirinha String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([telefone])
  @@index([cpf])
  @@index([nome])
  @@map("patients")
}
```

Indexes on nome, telefone, cpf ensure <500ms search performance.

**Current State:**
- Patient model exists with seed data (3 patients from Phase 2)
- Auth and RBAC configured (Phase 1)
- Audit logging system ready (Phase 1)

**Route Structure:**
- `/pacientes` - Patient list page with search
- `/pacientes/[id]` - Patient profile (Plan 2)
- `/pacientes/novo` - New patient form (Plan 3)

## Tasks

### Task 1: Create Patient List Page Layout
**File:** `src/app/pacientes/page.tsx`

Create the main patient management page with:
- Page header with title "Gerenciamento de Pacientes"
- Search component slot
- Patient table with Suspense boundary
- "Novo Paciente" button (links to `/pacientes/novo`)

Use React Server Component for initial render, loading skeleton during Suspense.

**Acceptance:**
- [ ] Page renders at `/pacientes`
- [ ] Requires authentication (redirects to /entrar if not logged in)
- [ ] Requires ADMIN or ATENDENTE role (403 if unauthorized)
- [ ] Shows loading skeleton while fetching data

### Task 2: Implement Search API Endpoint
**File:** `src/app/api/pacientes/route.ts`

Create GET endpoint supporting query params:
- `q` - General search (searches nome field with ILIKE)
- `telefone` - Exact phone match
- `cpf` - Exact CPF match
- `page` - Page number (default 1)
- `limit` - Items per page (default 20, max 100)

Use Prisma with proper indexes. Log PHI access to audit_logs table.

**Query Logic:**
- If `q` provided: `where: { nome: { contains: q, mode: 'insensitive' } }`
- If `telefone` provided: `where: { telefone: telefone }`
- If `cpf` provided: `where: { cpf: cpf }`
- If multiple params: combine with AND logic
- Always paginate: `skip: (page - 1) * limit, take: limit`

**Response Format:**
```typescript
{
  patients: Patient[],
  pagination: {
    page: number,
    limit: number,
    total: number,
    totalPages: number
  }
}
```

**Acceptance:**
- [ ] GET /api/pacientes returns all patients (paginated, default page 1)
- [ ] GET /api/pacientes?q=Silva returns patients with "Silva" in nome
- [ ] GET /api/pacientes?telefone=+5511987654321 returns exact match
- [ ] GET /api/pacientes?cpf=123.456.789-00 returns exact match
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs VIEW_PATIENT audit entry for each search
- [ ] Response time <500ms for typical dataset (tested with seed data)

### Task 3: Build Patient Search Component
**File:** `src/components/patients/patient-search.tsx`

Client component with search form:
- Search input with label "Buscar paciente"
- Search type selector: "Nome", "Telefone", "CPF"
- Search button
- Clear filters button

Updates URL query params on search (enables shareable URLs).

Use shadcn/ui Input and Select components. Add debouncing (300ms) for name search.

**Acceptance:**
- [ ] Form has search input and type selector
- [ ] Selecting type shows appropriate placeholder and format hint
- [ ] Search updates URL params (?q=Silva or ?telefone=...)
- [ ] Clear button resets form and URL params
- [ ] Nome search debounces 300ms to avoid excessive API calls
- [ ] Telefone and CPF search triggers immediately (exact match)

### Task 4: Build Patient Results Table
**File:** `src/components/patients/patient-table.tsx`

Server component displaying search results:
- Columns: Nome, Telefone, Email, CPF, Convênio, Ações
- Rows are clickable (navigate to `/pacientes/[id]`)
- Actions column: "Ver Perfil" button
- Empty state: "Nenhum paciente encontrado" with "Cadastrar Novo" button

Use shadcn/ui Table component with responsive design (mobile-friendly).

**Acceptance:**
- [ ] Table displays patient data with all columns
- [ ] Clicking row navigates to /pacientes/[id]
- [ ] "Ver Perfil" button navigates to patient detail page
- [ ] Shows empty state when no results
- [ ] Table is responsive (mobile: stacks columns, desktop: full table)
- [ ] CPF and phone are formatted correctly (123.456.789-00, +55 11 98765-4321)

### Task 5: Add Pagination Controls
**File:** Update `src/components/patients/patient-table.tsx`

Add pagination below table:
- Page indicator: "Página 1 de 3"
- Previous/Next buttons
- First/Last page buttons
- Page size selector (20, 50, 100)

Updates URL params on page change. Disables Prev on page 1, Next on last page.

**Acceptance:**
- [ ] Pagination shows current page and total pages
- [ ] Previous button disabled on page 1
- [ ] Next button disabled on last page
- [ ] Clicking Previous/Next updates URL and fetches new page
- [ ] Page size selector changes number of results per page
- [ ] URL params reflect current pagination state (shareable)

## Verification

**Manual Test Scenarios:**

1. **Basic Search:**
   - Navigate to /pacientes
   - See table with 3 seed patients
   - Search "Silva" in nome field
   - Verify matching patients appear
   - Verify response time <500ms

2. **Phone Search:**
   - Select "Telefone" search type
   - Enter "+5511987654321"
   - Verify exact match returns João Silva
   - Verify no results for non-existent phone

3. **CPF Search:**
   - Select "CPF" search type
   - Enter "123.456.789-00"
   - Verify exact match returns correct patient
   - Verify duplicate CPF protection (unique constraint)

4. **Pagination:**
   - If >20 patients exist, verify pagination controls appear
   - Navigate to page 2, verify URL updates
   - Copy URL, paste in new tab, verify page 2 loads

5. **Authorization:**
   - Log out, verify redirect to /entrar
   - Log in as ATENDENTE, verify access granted
   - Check audit_logs table for VIEW_PATIENT entries

**Automated Tests:**
- API route returns paginated results
- Search filters work correctly (nome, telefone, cpf)
- Unauthorized access blocked (401, 403)
- Audit logging records searches

## Success Criteria

- [ ] User can search patients by nome (partial, case-insensitive)
- [ ] User can search patients by telefone (exact match)
- [ ] User can search patients by CPF (exact match)
- [ ] Search returns results in <500ms
- [ ] Results are paginated (20 per page default)
- [ ] Clicking patient navigates to profile page
- [ ] Only authenticated ADMIN/ATENDENTE can access
- [ ] All PHI access is audit logged

## Output

**Files Created:**
1. `src/app/pacientes/page.tsx` - Patient list page with search
2. `src/app/api/pacientes/route.ts` - Search API endpoint
3. `src/components/patients/patient-search.tsx` - Search form component
4. `src/components/patients/patient-table.tsx` - Results table with pagination

**Files Modified:**
- None (new feature, no modifications needed)

**Database Changes:**
- None (Patient model already exists with indexes)

**RLS Policies:**
- None (covered by API route authorization in Phase 1)

**Tests:**
- API route unit tests (search filters, pagination, auth)
- Component tests (search form, table rendering)

**Requirements Completed:**
- PAT-01: User can search patients by name ✓
- PAT-02: User can search patients by phone number ✓
- PAT-03: User can search patients by CPF ✓
