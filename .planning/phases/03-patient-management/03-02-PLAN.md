---
phase: 3
plan: 2
wave: 1
autonomous: true
requirements:
  - PAT-04
  - PAT-05
  - PAT-13
  - PAT-14
must_haves:
  truths:
    - "Patient profile displays all contact information (nome, telefone, email)"
    - "Patient profile displays all personal data (CPF, data_nascimento, endereco)"
    - "Patient profile displays convênio information (convenio, numero_carteirinha)"
    - "Appointment history shows past and upcoming appointments sorted by date"
    - "Conversation history shows messages with timestamps and sender (AI/Human)"
    - "No-show rate is calculated as (no_show_count / total_appointments * 100)"
    - "Profile page returns 404 for non-existent patient ID"
  artifacts:
    - "src/app/pacientes/[id]/page.tsx (patient profile page)"
    - "src/app/api/pacientes/[id]/route.ts (patient detail API)"
    - "src/app/api/pacientes/[id]/appointments/route.ts (appointment history API)"
    - "src/app/api/pacientes/[id]/conversations/route.ts (conversation history API)"
    - "src/components/patients/patient-header.tsx (profile header component)"
    - "src/components/patients/contact-info-section.tsx (contact info card)"
    - "src/components/patients/appointment-history.tsx (appointment list)"
    - "src/components/patients/conversation-history.tsx (conversation thread)"
    - "src/components/patients/patient-stats.tsx (no-show rate and metrics)"
  key_links:
    - "GET /api/pacientes/[id] returns patient with all fields"
    - "GET /api/pacientes/[id]/appointments returns sorted appointment history"
    - "GET /api/pacientes/[id]/conversations returns conversation threads"
    - "/pacientes/[id] page displays comprehensive patient profile"
    - "Profile shows 'Editar' button linking to /pacientes/[id]/editar"
---

# Plan 03-02: Patient Profile View

## Objective

Build comprehensive patient profile page displaying contact information, appointment history, conversation threads, and attendance metrics.

## Execution Context

**Stack:**
- Next.js 16+ App Router with React Server Components
- Prisma with relations (patient.appointments, patient.conversations)
- shadcn/ui Card, Badge, Table components
- Date formatting with date-fns
- Supabase PostgreSQL with RLS

**Patterns:**
- Server Components for data fetching (no client-side state)
- Parallel data loading with Promise.all()
- Suspense boundaries for progressive rendering
- Tab interface for organized sections (using shadcn/ui Tabs)
- Audit logging for PHI access (VIEW_PATIENT, VIEW_APPOINTMENT, VIEW_CONVERSATION)

## Context

**Phase 3 Goal:** Enable comprehensive patient data management with search, profiles, history, and document handling.

**This Plan's Scope:** Patient profile viewing (PAT-04, PAT-05, PAT-13, PAT-14).

**Database Relations:**
```prisma
model Patient {
  id                String         @id @default(uuid())
  nome              String
  telefone          String
  email             String?
  cpf               String?
  dataNascimento    DateTime?
  endereco          String?
  convenio          String?
  numeroCarteirinha String?

  appointments      Appointment[]   // Has many appointments
  conversations     Conversation[]  // Has many conversations
  alerts            Alert[]         // Has many alerts
}

model Appointment {
  id          String            @id @default(uuid())
  patientId   String
  serviceType String
  scheduledAt DateTime
  duration    Int
  status      AppointmentStatus // confirmed, tentative, no_show, cancelled, completed
  confirmedAt DateTime?
  notes       String?

  patient     Patient @relation(fields: [patientId], references: [id])
}

model Conversation {
  id            String             @id @default(uuid())
  patientId     String
  whatsappId    String
  status        ConversationStatus // IA, HUMANO, FINALIZADO
  messages      Json[]             // [{timestamp, sender, content}, ...]
  lastMessageAt DateTime

  patient       Patient @relation(fields: [patientId], references: [id])
}
```

**Current State:**
- Patient model exists with seed data (3 patients)
- Appointment model exists with 5 appointments (2 confirmed, 2 tentative, 1 no_show)
- Conversation model exists with 3 conversations (IA, HUMANO, FINALIZADO)
- Auth and audit logging configured (Phase 1)

**Profile Page Structure:**
```
/pacientes/[id]
├── Header (nome, telefone, badges for convenio)
├── Tabs
│   ├── Visão Geral (contact info + stats)
│   ├── Agendamentos (appointment history)
│   └── Conversas (conversation threads)
└── Actions (Editar button, future: Upload Documento)
```

## Tasks

### Task 1: Create Patient Profile Page
**File:** `src/app/pacientes/[id]/page.tsx`

Create dynamic route page with:
- Server Component for data fetching
- Patient header with name and quick stats
- Tab navigation (Visão Geral, Agendamentos, Conversas)
- "Editar Paciente" button (links to `/pacientes/[id]/editar`)
- 404 handling for non-existent patient ID

Fetch patient with relations: `prisma.patient.findUnique({ where: { id }, include: { appointments: true, conversations: true } })`

**Acceptance:**
- [ ] Page renders at /pacientes/[validId]
- [ ] Returns 404 for non-existent ID
- [ ] Requires authentication (redirects to /entrar if not logged in)
- [ ] Requires ADMIN or ATENDENTE role (403 if unauthorized)
- [ ] Shows loading skeleton during data fetch
- [ ] Logs audit entry (VIEW_PATIENT action)

### Task 2: Build Patient Profile Header
**File:** `src/components/patients/patient-header.tsx`

Display patient name and key identifiers:
- Large heading with patient nome
- Badges: Convênio name (if exists), "Sem Convênio" (if null)
- Secondary info: Telefone, Email (if exists)
- "Editar" button (primary action)

Use shadcn/ui Badge for tags, Button for action.

**Acceptance:**
- [ ] Header displays patient nome as h1
- [ ] Shows telefone and email (or "Não informado" if null)
- [ ] Shows convênio badge if convenio field is not null
- [ ] Shows "Sem Convênio" badge if convenio is null
- [ ] "Editar" button links to /pacientes/[id]/editar
- [ ] Mobile responsive (stack elements vertically on small screens)

### Task 3: Build Contact Info Section
**File:** `src/components/patients/contact-info-section.tsx`

Display all patient information in organized cards:

**Card 1: Informações de Contato**
- Telefone (formatted: +55 11 98765-4321)
- Email (or "Não informado")

**Card 2: Dados Pessoais**
- CPF (formatted: 123.456.789-00, or "Não informado")
- Data de Nascimento (formatted: 15/03/1985, or "Não informado")
- Endereço (or "Não informado")

**Card 3: Convênio**
- Convênio name (or "Sem convênio")
- Número da Carteirinha (or "Não informado")

Use shadcn/ui Card component with proper spacing.

**Acceptance:**
- [ ] All three cards display in grid layout (2 columns on desktop, 1 on mobile)
- [ ] Fields show "Não informado" for null values
- [ ] CPF formatted correctly with dots and dash
- [ ] Phone formatted with country code and grouping
- [ ] Date formatted as DD/MM/YYYY
- [ ] Cards have proper spacing and visual hierarchy

### Task 4: Build Patient Stats Component
**File:** `src/components/patients/patient-stats.tsx`

Calculate and display attendance metrics:
- Total de Agendamentos (count all appointments)
- Agendamentos Confirmados (status = confirmed)
- Não Comparecimentos (status = no_show)
- Taxa de Não Comparecimento (no_show / total * 100, formatted as percentage)

Display as stat cards with icons (using lucide-react).

**No-Show Rate Calculation:**
```typescript
const totalAppointments = patient.appointments.length;
const noShowCount = patient.appointments.filter(a => a.status === 'no_show').length;
const noShowRate = totalAppointments > 0 ? (noShowCount / totalAppointments * 100).toFixed(1) : '0.0';
```

**Acceptance:**
- [ ] Stats display in 4-column grid (1 column on mobile)
- [ ] Total appointments count is accurate
- [ ] Confirmed appointments count matches status = 'confirmed'
- [ ] No-show count matches status = 'no_show'
- [ ] No-show rate calculated correctly (percentage with 1 decimal)
- [ ] Shows "0.0%" if no appointments exist
- [ ] Icons match each stat type (Calendar, CheckCircle, XCircle, TrendingDown)

### Task 5: Build Appointment History Component
**File:** `src/components/patients/appointment-history.tsx`

Display appointment timeline:
- Sort by scheduledAt descending (most recent first)
- Show: Service type, Date/Time, Status badge, Duration
- Status badges with colors:
  - confirmed: green
  - tentative: yellow
  - no_show: red
  - cancelled: gray
  - completed: blue
- Empty state: "Nenhum agendamento encontrado"

Use shadcn/ui Table or custom Timeline component.

**Acceptance:**
- [ ] Appointments sorted by scheduledAt (newest first)
- [ ] Each row shows serviceType, scheduledAt, duration, status
- [ ] Status displayed as colored badge
- [ ] Date formatted as "15/03/2026 às 14:00"
- [ ] Duration shown as "60 minutos"
- [ ] Empty state displays when no appointments
- [ ] Past appointments visually distinguished from upcoming (opacity or divider)

### Task 6: Build Conversation History Component
**File:** `src/components/patients/conversation-history.tsx`

Display WhatsApp conversation threads:
- List conversations sorted by lastMessageAt descending
- Each conversation card shows:
  - Status badge (IA, HUMANO, FINALIZADO)
  - Last message timestamp (relative: "há 2 horas", "ontem")
  - Message count
  - Expandable to show full message thread
- Message thread displays:
  - Sender label (Paciente, IA, Atendente Humano)
  - Message content
  - Timestamp
- Empty state: "Nenhuma conversa registrada"

Use shadcn/ui Accordion for expandable threads.

**Message Format (from Json field):**
```typescript
interface Message {
  timestamp: string; // ISO date string
  sender: 'patient' | 'ai' | 'human';
  content: string;
}
```

**Acceptance:**
- [ ] Conversations sorted by lastMessageAt (most recent first)
- [ ] Each conversation shows status badge, last message time, message count
- [ ] Clicking conversation expands to show full thread
- [ ] Messages display sender, content, and timestamp
- [ ] AI messages labeled as "IA", human as "Atendente Humano", patient as "Paciente"
- [ ] Timestamps formatted as relative ("há 3 horas") for recent, absolute for old
- [ ] Empty state displays when no conversations
- [ ] Long messages truncated with "..." and expand on click

### Task 7: Create Patient Detail API Endpoint
**File:** `src/app/api/pacientes/[id]/route.ts`

Create GET endpoint returning patient with relations:

```typescript
export async function GET(req: Request, { params }: { params: { id: string } }) {
  // Auth check
  // Fetch patient with appointments and conversations
  const patient = await prisma.patient.findUnique({
    where: { id: params.id },
    include: {
      appointments: {
        orderBy: { scheduledAt: 'desc' }
      },
      conversations: {
        orderBy: { lastMessageAt: 'desc' }
      }
    }
  });

  // Return 404 if not found
  // Log audit entry (VIEW_PATIENT, VIEW_APPOINTMENT, VIEW_CONVERSATION)
  // Return patient JSON
}
```

**Acceptance:**
- [ ] GET /api/pacientes/[id] returns patient with appointments and conversations
- [ ] Returns 404 for non-existent ID
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Appointments sorted by scheduledAt descending
- [ ] Conversations sorted by lastMessageAt descending
- [ ] Logs 3 audit entries (VIEW_PATIENT, VIEW_APPOINTMENT, VIEW_CONVERSATION)
- [ ] Response time <500ms for typical dataset

## Verification

**Manual Test Scenarios:**

1. **View Patient Profile:**
   - Navigate to /pacientes/[id] for João Silva
   - Verify header shows name, phone, email
   - Verify convênio badge displays "Unimed"
   - Verify all contact info fields populated correctly

2. **Check Stats:**
   - Verify total appointments count (should be 2 for João Silva from seed)
   - Verify no-show rate calculated correctly
   - If no appointments, verify shows "0" for all stats

3. **View Appointment History:**
   - Navigate to Agendamentos tab
   - Verify appointments sorted by date (newest first)
   - Verify status badges colored correctly
   - Verify past vs upcoming appointments distinguished

4. **View Conversation History:**
   - Navigate to Conversas tab
   - Verify conversations sorted by last message time
   - Expand conversation, verify messages display correctly
   - Verify sender labels (Paciente, IA, Atendente Humano)

5. **Authorization:**
   - Log out, verify redirect to /entrar
   - Log in as ATENDENTE, verify access granted
   - Navigate to /pacientes/invalid-uuid, verify 404 page

6. **Audit Logging:**
   - View profile
   - Check audit_logs table for VIEW_PATIENT, VIEW_APPOINTMENT, VIEW_CONVERSATION entries

**Automated Tests:**
- API route returns patient with relations
- 404 for non-existent patient
- No-show rate calculated correctly
- Unauthorized access blocked (401, 403)
- Audit logging records profile views

## Success Criteria

- [ ] User can view patient profile with all contact information
- [ ] User can view patient appointment history (past and upcoming)
- [ ] User can view patient conversation history
- [ ] Patient profile shows no-show rate and attendance patterns
- [ ] Profile page handles null fields gracefully ("Não informado")
- [ ] Only authenticated ADMIN/ATENDENTE can access
- [ ] All PHI access is audit logged
- [ ] Profile page returns 404 for non-existent patient

## Output

**Files Created:**
1. `src/app/pacientes/[id]/page.tsx` - Patient profile page
2. `src/app/api/pacientes/[id]/route.ts` - Patient detail API
3. `src/components/patients/patient-header.tsx` - Profile header
4. `src/components/patients/contact-info-section.tsx` - Contact info cards
5. `src/components/patients/patient-stats.tsx` - Attendance metrics
6. `src/components/patients/appointment-history.tsx` - Appointment timeline
7. `src/components/patients/conversation-history.tsx` - Conversation threads

**Files Modified:**
- None (new feature, no modifications needed)

**Database Changes:**
- None (using existing relations)

**RLS Policies:**
- None (covered by API route authorization)

**Tests:**
- API route unit tests (fetch with relations, 404, auth)
- Component tests (profile sections, stats calculation)

**Requirements Completed:**
- PAT-04: User can view patient profile with contact information ✓
- PAT-05: User can view patient appointment history (past and upcoming) ✓
- PAT-13: Patient profile shows conversation history with clinic ✓
- PAT-14: Patient profile shows no-show rate and attendance patterns ✓
