---
phase: 3
plan: 4
wave: 2
autonomous: true
requirements:
  - PAT-10
  - PAT-11
  - PAT-12
must_haves:
  truths:
    - "User can view list of documents for a patient"
    - "User can upload PDF, JPG, PNG documents (max 10MB)"
    - "User can download documents"
    - "User can delete documents (with confirmation)"
    - "Documents are stored in Supabase Storage with unique paths"
    - "Document metadata stored in database (filename, type, size, uploadedBy, uploadedAt)"
    - "Only authenticated ADMIN/ATENDENTE can upload/delete documents"
    - "Document access is audit logged (VIEW_DOCUMENT, UPLOAD_DOCUMENT, DELETE_DOCUMENT)"
  artifacts:
    - "src/components/patients/document-section.tsx (document list and upload UI)"
    - "src/app/api/pacientes/[id]/documents/route.ts (list and upload API)"
    - "src/app/api/pacientes/[id]/documents/[docId]/route.ts (download and delete API)"
    - "prisma/schema.prisma PatientDocument model"
    - "prisma/migrations/[timestamp]_add_patient_documents/migration.sql"
  key_links:
    - "GET /api/pacientes/[id]/documents returns document list"
    - "POST /api/pacientes/[id]/documents uploads file to Supabase Storage"
    - "GET /api/pacientes/[id]/documents/[docId] returns signed download URL"
    - "DELETE /api/pacientes/[id]/documents/[docId] deletes file and metadata"
    - "Patient profile page shows document section with upload button"
---

# Plan 03-04: Document Management

## Objective

Implement document upload, viewing, and deletion for patient records using Supabase Storage.

## Execution Context

**Stack:**
- Supabase Storage for file storage
- Prisma for document metadata
- Next.js 16+ App Router with Server Actions
- react-dropzone for file upload UI
- Zod for file validation
- shadcn/ui Table, Button, Dialog components

**Patterns:**
- Supabase Storage buckets with RLS policies
- Document metadata in PostgreSQL (PatientDocument model)
- Signed URLs for secure downloads (short-lived, 1 hour expiry)
- Optimistic UI updates for upload progress
- Confirmation dialog before delete
- Audit logging for all document operations

**File Upload Constraints:**
- Allowed types: PDF, JPG, JPEG, PNG
- Max size: 10MB per file
- Storage path: `patient-documents/{patientId}/{uuid}-{filename}`
- Bucket name: `patient-documents`

## Context

**Phase 3 Goal:** Enable comprehensive patient data management with search, profiles, history, and document handling.

**This Plan's Scope:** Document upload, viewing, deletion (PAT-10, PAT-11, PAT-12).

**Supabase Storage Structure:**
```
Bucket: patient-documents
├── {patientId-1}/
│   ├── {uuid1}-consent-form.pdf
│   ├── {uuid2}-id-document.jpg
│   └── {uuid3}-lab-results.pdf
├── {patientId-2}/
│   └── {uuid4}-prescription.pdf
└── ...
```

**Database Schema (new model):**
```prisma
model PatientDocument {
  id          String   @id @default(uuid())
  patientId   String   @map("patient_id") @db.Uuid
  filename    String   // Original filename
  fileType    String   @map("file_type") // MIME type
  fileSize    Int      @map("file_size") // Bytes
  storagePath String   @map("storage_path") // Path in Supabase Storage
  uploadedBy  String   @map("uploaded_by") @db.Uuid
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([uploadedAt])
  @@map("patient_documents")
}
```

**Current State:**
- Patient model exists (Phase 2)
- Profile page exists with document section placeholder (Plan 2)
- Auth and audit logging configured (Phase 1)
- Supabase client configured in Phase 1

## Tasks

### Task 1: Create Supabase Storage Bucket
**Setup in Supabase Dashboard or via MCP:**

Create bucket `patient-documents` with:
- Public: false (requires authentication)
- File size limit: 10MB
- Allowed MIME types: application/pdf, image/jpeg, image/png

Add RLS policies:
```sql
-- Allow authenticated ADMIN/ATENDENTE to upload
CREATE POLICY "Users can upload patient documents"
  ON storage.objects FOR INSERT
  TO authenticated
  WITH CHECK (
    bucket_id = 'patient-documents' AND
    auth.jwt() ->> 'role' IN ('ADMIN', 'ATENDENTE')
  );

-- Allow authenticated ADMIN/ATENDENTE to read
CREATE POLICY "Users can view patient documents"
  ON storage.objects FOR SELECT
  TO authenticated
  USING (
    bucket_id = 'patient-documents' AND
    auth.jwt() ->> 'role' IN ('ADMIN', 'ATENDENTE')
  );

-- Allow authenticated ADMIN/ATENDENTE to delete
CREATE POLICY "Users can delete patient documents"
  ON storage.objects FOR DELETE
  TO authenticated
  USING (
    bucket_id = 'patient-documents' AND
    auth.jwt() ->> 'role' IN ('ADMIN', 'ATENDENTE')
  );
```

**Acceptance:**
- [ ] Bucket `patient-documents` exists in Supabase
- [ ] Bucket is private (not publicly accessible)
- [ ] File size limit set to 10MB
- [ ] RLS policies allow ADMIN/ATENDENTE to upload, read, delete
- [ ] Unauthenticated users cannot access bucket

### Task 2: Add PatientDocument Model to Schema
**File:** `prisma/schema.prisma`

Add PatientDocument model and relation to Patient:

```prisma
model PatientDocument {
  id          String   @id @default(uuid()) @db.Uuid
  patientId   String   @map("patient_id") @db.Uuid
  filename    String
  fileType    String   @map("file_type")
  fileSize    Int      @map("file_size")
  storagePath String   @map("storage_path")
  uploadedBy  String   @map("uploaded_by") @db.Uuid
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  uploader    User     @relation(fields: [uploadedBy], references: [id])

  @@index([patientId])
  @@index([uploadedAt])
  @@map("patient_documents")
}

model Patient {
  // ... existing fields
  documents   PatientDocument[]
}

model User {
  // ... existing fields
  uploadedDocuments PatientDocument[]
}
```

Create migration and apply:
```bash
npx prisma migrate dev --name add_patient_documents
```

Use Supabase MCP if Prisma CLI hangs.

**Acceptance:**
- [ ] PatientDocument model added to schema
- [ ] Migration created and applied to database
- [ ] Relation to Patient established (onDelete: Cascade)
- [ ] Relation to User established (uploader)
- [ ] Indexes created on patientId and uploadedAt

### Task 3: Build Document Section Component
**File:** `src/components/patients/document-section.tsx`

Display document list with upload functionality:

**UI Structure:**
```
Document Section
├── Header
│   ├── Title: "Documentos" + document count badge
│   └── Upload button (opens dialog)
├── Document Table
│   ├── Columns: Nome do Arquivo, Tipo, Tamanho, Enviado Por, Data, Ações
│   ├── Rows: Each document with download and delete buttons
│   └── Empty state: "Nenhum documento anexado"
└── Upload Dialog
    ├── File dropzone (drag & drop or click to browse)
    ├── File preview (filename, size, type)
    ├── Upload button (disabled until file selected)
    └── Cancel button
```

Use react-dropzone for file selection, shadcn/ui Dialog for upload modal.

**Acceptance:**
- [ ] Section displays document count in badge
- [ ] Table shows all documents for patient
- [ ] Each row has download and delete buttons
- [ ] Empty state displays when no documents
- [ ] Upload button opens dialog
- [ ] Dialog allows drag-and-drop or file browser selection
- [ ] Only accepts PDF, JPG, PNG files (< 10MB)
- [ ] Shows file preview before upload
- [ ] Upload button disabled until valid file selected
- [ ] Progress indicator during upload

### Task 4: Implement Document List API
**File:** `src/app/api/pacientes/[id]/documents/route.ts`

Create GET endpoint returning document list:

```typescript
export async function GET(req: Request, { params }: { params: { id: string } }) {
  // Check authentication and authorization
  // Fetch documents for patient
  const documents = await prisma.patientDocument.findMany({
    where: { patientId: params.id },
    include: { uploader: { select: { name: true } } },
    orderBy: { uploadedAt: 'desc' }
  });

  // Log audit entry (VIEW_DOCUMENT)
  // Return documents array
}
```

**Acceptance:**
- [ ] GET /api/pacientes/[id]/documents returns document list
- [ ] Documents sorted by uploadedAt descending (newest first)
- [ ] Includes uploader name for display
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs VIEW_DOCUMENT audit entry
- [ ] Returns empty array if no documents

### Task 5: Implement Document Upload API
**File:** `src/app/api/pacientes/[id]/documents/route.ts`

Add POST handler for file upload:

```typescript
export async function POST(req: Request, { params }: { params: { id: string } }) {
  // Check authentication and authorization
  // Parse multipart form data (file + metadata)
  // Validate file type (PDF, JPG, PNG)
  // Validate file size (< 10MB)

  // Generate unique storage path
  const fileExt = file.name.split('.').pop();
  const uniqueId = crypto.randomUUID();
  const storagePath = `${params.id}/${uniqueId}-${file.name}`;

  // Upload to Supabase Storage
  const { error: uploadError } = await supabase.storage
    .from('patient-documents')
    .upload(storagePath, file);

  if (uploadError) {
    // Handle error
  }

  // Create document metadata in database
  const document = await prisma.patientDocument.create({
    data: {
      patientId: params.id,
      filename: file.name,
      fileType: file.type,
      fileSize: file.size,
      storagePath: storagePath,
      uploadedBy: session.user.id
    }
  });

  // Log audit entry (UPLOAD_DOCUMENT)
  // Return document metadata
}
```

**Acceptance:**
- [ ] POST /api/pacientes/[id]/documents uploads file to Supabase Storage
- [ ] Creates metadata record in patient_documents table
- [ ] Returns 400 for invalid file type (not PDF/JPG/PNG)
- [ ] Returns 400 for file size > 10MB
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Storage path includes patient ID and unique identifier
- [ ] Logs UPLOAD_DOCUMENT audit entry with filename
- [ ] Returns 201 with document metadata on success

### Task 6: Implement Document Download API
**File:** `src/app/api/pacientes/[id]/documents/[docId]/route.ts`

Create GET endpoint returning signed download URL:

```typescript
export async function GET(req: Request, { params }: { params: { id: string, docId: string } }) {
  // Check authentication and authorization
  // Fetch document metadata
  const document = await prisma.patientDocument.findUnique({
    where: { id: params.docId }
  });

  if (!document || document.patientId !== params.id) {
    return NextResponse.json({ error: 'Not found' }, { status: 404 });
  }

  // Generate signed URL (1 hour expiry)
  const { data: signedUrl, error } = await supabase.storage
    .from('patient-documents')
    .createSignedUrl(document.storagePath, 3600);

  if (error) {
    // Handle error
  }

  // Log audit entry (VIEW_DOCUMENT)
  // Return signed URL
}
```

**Acceptance:**
- [ ] GET /api/pacientes/[id]/documents/[docId] returns signed download URL
- [ ] Signed URL expires after 1 hour
- [ ] Returns 404 if document not found
- [ ] Returns 404 if document belongs to different patient (security)
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs VIEW_DOCUMENT audit entry
- [ ] Client can download file using signed URL

### Task 7: Implement Document Delete API
**File:** `src/app/api/pacientes/[id]/documents/[docId]/route.ts`

Add DELETE handler:

```typescript
export async function DELETE(req: Request, { params }: { params: { id: string, docId: string } }) {
  // Check authentication and authorization
  // Fetch document metadata
  const document = await prisma.patientDocument.findUnique({
    where: { id: params.docId }
  });

  if (!document || document.patientId !== params.id) {
    return NextResponse.json({ error: 'Not found' }, { status: 404 });
  }

  // Delete from Supabase Storage
  const { error: deleteError } = await supabase.storage
    .from('patient-documents')
    .remove([document.storagePath]);

  if (deleteError) {
    // Handle error
  }

  // Delete metadata from database
  await prisma.patientDocument.delete({
    where: { id: params.docId }
  });

  // Log audit entry (DELETE_DOCUMENT)
  // Return 204 No Content
}
```

**Acceptance:**
- [ ] DELETE /api/pacientes/[id]/documents/[docId] deletes file from storage
- [ ] Deletes metadata from database
- [ ] Returns 404 if document not found
- [ ] Returns 404 if document belongs to different patient (security)
- [ ] Returns 401 if not authenticated
- [ ] Returns 403 if not ADMIN or ATENDENTE
- [ ] Logs DELETE_DOCUMENT audit entry with filename
- [ ] Returns 204 No Content on success

### Task 8: Add Document Section to Patient Profile
**File:** Update `src/app/pacientes/[id]/page.tsx`

Add document section to profile page:
- Add "Documentos" tab in tab navigation
- Include DocumentSection component in tab panel
- Pass patient ID as prop

**Acceptance:**
- [ ] Document tab appears in patient profile
- [ ] Clicking tab shows document list
- [ ] Upload button functional
- [ ] Download buttons functional
- [ ] Delete buttons functional (shows confirmation dialog)
- [ ] Section updates after upload/delete without page refresh

### Task 9: Add File Validation
**File:** `src/lib/validations/document.ts`

Create validation helpers:

```typescript
const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB
const ALLOWED_TYPES = ['application/pdf', 'image/jpeg', 'image/png'];

export function validateFile(file: File): { valid: boolean; error?: string } {
  if (!ALLOWED_TYPES.includes(file.type)) {
    return { valid: false, error: 'Tipo de arquivo não permitido. Use PDF, JPG ou PNG.' };
  }

  if (file.size > MAX_FILE_SIZE) {
    return { valid: false, error: 'Arquivo muito grande. Máximo: 10MB.' };
  }

  return { valid: true };
}

export function formatFileSize(bytes: number): string {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
}
```

**Acceptance:**
- [ ] validateFile rejects files > 10MB
- [ ] validateFile rejects non-PDF/JPG/PNG files
- [ ] formatFileSize returns human-readable size (KB, MB)
- [ ] Validation runs on client before upload
- [ ] Validation runs on server during upload

## Verification

**Manual Test Scenarios:**

1. **Upload Document (Happy Path):**
   - Navigate to /pacientes/[id]
   - Click "Documentos" tab
   - Click "Upload Documento" button
   - Drag and drop a PDF file (< 10MB)
   - Verify file preview shows filename and size
   - Click "Enviar"
   - Verify upload progress indicator
   - Verify document appears in list after upload
   - Verify toast shows success message

2. **Upload Invalid File:**
   - Attempt to upload .txt file
   - Verify error: "Tipo de arquivo não permitido"
   - Attempt to upload 15MB PDF
   - Verify error: "Arquivo muito grande. Máximo: 10MB"

3. **Download Document:**
   - Click "Download" button on document row
   - Verify file downloads correctly
   - Verify filename matches original

4. **Delete Document:**
   - Click "Delete" button on document row
   - Verify confirmation dialog: "Tem certeza que deseja excluir este documento?"
   - Click "Confirmar"
   - Verify document removed from list
   - Verify toast shows success message
   - Verify file removed from Supabase Storage

5. **View Document List:**
   - Create patient with 3 documents
   - Navigate to patient profile
   - Verify document count badge shows "3"
   - Verify table displays all 3 documents
   - Verify columns: filename, type, size, uploader name, date

6. **Authorization:**
   - Log out, verify cannot access documents
   - Log in as ATENDENTE, verify can upload/view/delete
   - Check audit_logs table for VIEW_DOCUMENT, UPLOAD_DOCUMENT, DELETE_DOCUMENT entries

7. **Empty State:**
   - Navigate to patient with no documents
   - Verify empty state: "Nenhum documento anexado"
   - Verify "Anexar Primeiro Documento" button present

**Automated Tests:**
- File validation (type, size)
- Upload API creates file and metadata
- Download API returns signed URL
- Delete API removes file and metadata
- Unauthorized access blocked (401, 403)
- Audit logging records all operations

## Success Criteria

- [ ] User can view list of patient documents
- [ ] User can upload PDF, JPG, PNG files (max 10MB)
- [ ] User can download documents via signed URLs
- [ ] User can delete documents with confirmation
- [ ] Documents stored securely in Supabase Storage
- [ ] Document metadata tracked in database
- [ ] Only authenticated ADMIN/ATENDENTE can manage documents
- [ ] All document operations are audit logged

## Output

**Files Created:**
1. `src/components/patients/document-section.tsx` - Document list and upload UI
2. `src/app/api/pacientes/[id]/documents/route.ts` - List and upload API
3. `src/app/api/pacientes/[id]/documents/[docId]/route.ts` - Download and delete API
4. `src/lib/validations/document.ts` - File validation helpers
5. `prisma/migrations/[timestamp]_add_patient_documents/migration.sql` - PatientDocument model

**Files Modified:**
1. `prisma/schema.prisma` - Add PatientDocument model and relations
2. `src/app/pacientes/[id]/page.tsx` - Add document tab

**Database Changes:**
- PatientDocument model (table: patient_documents)
- Relations: PatientDocument -> Patient, PatientDocument -> User
- Indexes on patientId and uploadedAt

**Supabase Storage:**
- Bucket: `patient-documents` (private, 10MB limit)
- RLS policies for upload, read, delete

**Tests:**
- API route unit tests (upload, download, delete, auth)
- File validation tests
- Component tests (upload UI, document table)

**Requirements Completed:**
- PAT-10: User can view patient documents ✓
- PAT-11: User can upload documents for patient ✓
- PAT-12: User can delete patient documents ✓
