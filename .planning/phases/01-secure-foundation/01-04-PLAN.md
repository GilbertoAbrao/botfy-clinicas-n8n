---
phase: 01-secure-foundation
plan: 04
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - prisma/schema.prisma
  - src/lib/rbac/permissions.ts
  - src/lib/rbac/middleware.ts
  - src/app/(dashboard)/admin/users/page.tsx
  - src/lib/auth/session.ts
autonomous: true

must_haves:
  truths:
    - "System knows if user is Admin or Atendente"
    - "Admin can access all features"
    - "Atendente cannot access user management"
    - "Role is stored in database"
    - "getCurrentUser returns role information"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "User model with role field"
      contains: "role"
    - path: "src/lib/rbac/permissions.ts"
      provides: "RBAC permission definitions"
      exports: ["checkPermission", "PERMISSIONS"]
    - path: "src/lib/rbac/middleware.ts"
      provides: "RBAC middleware for route protection"
      exports: ["requireRole"]
    - path: "src/lib/auth/session.ts"
      provides: "Session with role information"
      exports: ["getCurrentUserWithRole"]
  key_links:
    - from: "src/lib/auth/session.ts"
      to: "prisma.user.findUnique"
      via: "Database query for role"
      pattern: "findUnique.*role"
    - from: "src/lib/rbac/permissions.ts"
      to: "user.role"
      via: "Permission check based on role"
      pattern: "role.*===.*admin"
---

<objective>
Implement Role-Based Access Control (RBAC) with Admin and Atendente roles. Admins have full access, Atendentes have limited access (no user management, no audit logs).

Purpose: Satisfy AUTH-05, AUTH-11, AUTH-12 requirements. Establish permission system for future feature authorization.
Output: Working RBAC with database role storage, permission checking utilities, and protected admin routes.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-secure-foundation/01-01-SUMMARY.md
@.planning/phases/01-secure-foundation/01-02-SUMMARY.md
@.planning/research/PITFALLS.md

**Requirements covered:**
- AUTH-05: System enforces role-based access control (Admin vs Atendente permissions) ✓
- AUTH-11: Atendente role can view and update alerts, patients, appointments ✓
- AUTH-12: Admin role has full access to all features including user management and audit logs ✓

**Role definitions:**
- **Admin**: Full access (user management, audit logs, all features)
- **Atendente**: Limited access (alerts, patients, appointments, conversations - NO user management, NO audit logs)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Prisma schema with role field and create migration</name>
  <files>prisma/schema.prisma, prisma/migrations/</files>
  <action>
Update `prisma/schema.prisma` User model:
```prisma
model User {
  id        String   @id @default(uuid()) @db.Uuid
  email     String   @unique
  role      Role     @default(ATENDENTE)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

enum Role {
  ADMIN
  ATENDENTE
}
```

Changes:
- `role` field now uses enum type (not string) for type safety
- Default role is ATENDENTE (principle of least privilege)
- Enum ensures only valid roles (ADMIN or ATENDENTE) in database

Generate Prisma Client:
```bash
npx prisma generate
```

**IMPORTANT:** Do NOT run `npx prisma db push` yet. The existing Supabase database may already have a users table. We need to carefully check and reconcile schema before pushing changes.

If users table does NOT exist in Supabase:
```bash
npx prisma db push
```

If users table DOES exist:
1. Create a migration: `npx prisma migrate dev --name add_role_to_users`
2. This will add `role` column without dropping existing data

Safety first: Inspect existing database schema before modifying. Use Supabase Dashboard → Table Editor to check if `users` table exists and what columns it has.
  </action>
  <verify>
```bash
npx prisma generate
```
Prisma Client generates with Role enum. No errors.

```bash
npm run build
```
Build succeeds with updated Prisma types.
  </verify>
  <done>
Prisma schema updated with Role enum. Prisma Client regenerated with role types. Build succeeds. (Database migration pending user confirmation of existing schema.)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RBAC permission system with utilities</name>
  <files>src/lib/rbac/permissions.ts, src/lib/rbac/middleware.ts</files>
  <action>
**1. Create `src/lib/rbac/permissions.ts`:**
```typescript
import { Role } from '@prisma/client'

export const PERMISSIONS = {
  // Admin-only permissions
  MANAGE_USERS: 'MANAGE_USERS',
  VIEW_AUDIT_LOGS: 'VIEW_AUDIT_LOGS',
  MANAGE_SYSTEM_CONFIG: 'MANAGE_SYSTEM_CONFIG',

  // Shared permissions (Admin + Atendente)
  VIEW_ALERTS: 'VIEW_ALERTS',
  MANAGE_ALERTS: 'MANAGE_ALERTS',
  VIEW_PATIENTS: 'VIEW_PATIENTS',
  MANAGE_PATIENTS: 'MANAGE_PATIENTS',
  VIEW_APPOINTMENTS: 'VIEW_APPOINTMENTS',
  MANAGE_APPOINTMENTS: 'MANAGE_APPOINTMENTS',
  VIEW_CONVERSATIONS: 'VIEW_CONVERSATIONS',
  MANAGE_CONVERSATIONS: 'MANAGE_CONVERSATIONS',
} as const

export type Permission = typeof PERMISSIONS[keyof typeof PERMISSIONS]

const ROLE_PERMISSIONS: Record<Role, Permission[]> = {
  ADMIN: [
    // Admin has ALL permissions
    PERMISSIONS.MANAGE_USERS,
    PERMISSIONS.VIEW_AUDIT_LOGS,
    PERMISSIONS.MANAGE_SYSTEM_CONFIG,
    PERMISSIONS.VIEW_ALERTS,
    PERMISSIONS.MANAGE_ALERTS,
    PERMISSIONS.VIEW_PATIENTS,
    PERMISSIONS.MANAGE_PATIENTS,
    PERMISSIONS.VIEW_APPOINTMENTS,
    PERMISSIONS.MANAGE_APPOINTMENTS,
    PERMISSIONS.VIEW_CONVERSATIONS,
    PERMISSIONS.MANAGE_CONVERSATIONS,
  ],
  ATENDENTE: [
    // Atendente has limited permissions (no user mgmt, no audit logs)
    PERMISSIONS.VIEW_ALERTS,
    PERMISSIONS.MANAGE_ALERTS,
    PERMISSIONS.VIEW_PATIENTS,
    PERMISSIONS.MANAGE_PATIENTS,
    PERMISSIONS.VIEW_APPOINTMENTS,
    PERMISSIONS.MANAGE_APPOINTMENTS,
    PERMISSIONS.VIEW_CONVERSATIONS,
    PERMISSIONS.MANAGE_CONVERSATIONS,
  ],
}

export function checkPermission(role: Role, permission: Permission): boolean {
  return ROLE_PERMISSIONS[role].includes(permission)
}

export function requirePermission(role: Role, permission: Permission) {
  if (!checkPermission(role, permission)) {
    throw new Error('Unauthorized: Insufficient permissions')
  }
}
```

This defines:
- All system permissions (constants)
- Role → Permission mapping
- Utility functions for permission checks

**2. Create `src/lib/rbac/middleware.ts`:**
```typescript
import { Role } from '@prisma/client'
import { redirect } from 'next/navigation'

export function requireRole(userRole: Role | null | undefined, allowedRoles: Role[]) {
  if (!userRole || !allowedRoles.includes(userRole)) {
    redirect('/dashboard') // Redirect to safe page if unauthorized
  }
}
```

This middleware helper redirects users without required role. Used in Server Components for route protection.
  </action>
  <verify>
```bash
npm run build
```
Build succeeds. TypeScript imports Role enum from Prisma. No errors.
  </verify>
  <done>
RBAC permission system created with role-based permission mapping. Permission check utilities created. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update session utilities to include role</name>
  <files>src/lib/auth/session.ts</files>
  <action>
Add to `src/lib/auth/session.ts`:
```typescript
import { prisma } from '@/lib/prisma' // Will create this in next task

export const getCurrentUserWithRole = cache(async () => {
  const user = await getCurrentUser()

  if (!user) {
    return null
  }

  // Fetch user from database to get role
  const dbUser = await prisma.user.findUnique({
    where: { id: user.id },
    select: { id: true, email: true, role: true },
  })

  if (!dbUser) {
    return null
  }

  return dbUser
})
```

This extends `getCurrentUser()` to fetch role from database. Used when authorization checks need role information.

**Also create `src/lib/prisma.ts` for Prisma Client singleton:**
```typescript
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma =
  globalForPrisma.prisma ??
  new PrismaClient({
    log: process.env.NODE_ENV === 'development' ? ['query', 'error', 'warn'] : ['error'],
  })

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma
```

Singleton pattern prevents multiple Prisma Client instances in development (Next.js hot reload issue).
  </action>
  <verify>
```bash
npm run build
```
Build succeeds. TypeScript resolves Prisma imports correctly.
  </verify>
  <done>
Session utility updated to include role. Prisma Client singleton created. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 4: Create admin-only page to demonstrate RBAC</name>
  <files>src/app/(dashboard)/admin/layout.tsx, src/app/(dashboard)/admin/users/page.tsx</files>
  <action>
**1. Create `src/app/(dashboard)/admin/layout.tsx`:**
```typescript
import { redirect } from 'next/navigation'
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { requireRole } from '@/lib/rbac/middleware'
import { Role } from '@prisma/client'

export default async function AdminLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const user = await getCurrentUserWithRole()

  if (!user) {
    redirect('/login')
  }

  // RBAC: Only Admins can access /admin routes
  requireRole(user.role, [Role.ADMIN])

  return <>{children}</>
}
```

This layout protects ALL /admin routes. Only Admin role can access. Atendentes are redirected to /dashboard.

**2. Create `src/app/(dashboard)/admin/users/page.tsx`:**
```typescript
import { getCurrentUserWithRole } from '@/lib/auth/session'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export default async function UsersPage() {
  const user = await getCurrentUserWithRole()

  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Gerenciar Usuários</h1>
      <Card>
        <CardHeader>
          <CardTitle>Usuários do Sistema</CardTitle>
          <CardDescription>
            Você está logado como: {user?.email} (Role: {user?.role})
          </CardDescription>
        </CardHeader>
        <CardContent>
          <p className="text-sm text-gray-600">
            Esta página só é acessível por usuários com role ADMIN.
          </p>
          <p className="text-sm text-gray-600 mt-2">
            User management UI será implementado em Phase 7 (System Configuration).
          </p>
        </CardContent>
      </Card>
    </div>
  )
}
```

Placeholder page demonstrating RBAC. Real user management features will be built in Phase 7.

**3. Add link to admin page in dashboard layout (only for admins):**

Update `src/app/(dashboard)/layout.tsx`:
```typescript
const user = await getCurrentUser()
const userWithRole = await getCurrentUserWithRole() // Add this

// In the header, add navigation
{userWithRole?.role === 'ADMIN' && (
  <Link href="/admin/users">
    <Button variant="ghost" size="sm">Admin</Button>
  </Link>
)}
```

This conditionally shows Admin link only to admin users.
  </action>
  <verify>
```bash
npm run dev
```

Test RBAC:
1. Log in as ATENDENTE user (if exists)
   - Visit /admin/users
   - Should redirect to /dashboard (no access)
   - Should NOT see "Admin" button in header

2. Log in as ADMIN user (create in Supabase Dashboard with role=ADMIN)
   - Visit /admin/users
   - Should see "Gerenciar Usuários" page
   - Should see "Admin" button in header

```bash
npm run build
```
Build succeeds.
  </verify>
  <done>
Admin layout created with RBAC check. Admin users page placeholder created. Dashboard layout shows admin link only for admins. Build succeeds.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Prisma schema has Role enum and role field
- [ ] Prisma Client generated with Role types
- [ ] src/lib/rbac/permissions.ts defines all permissions
- [ ] src/lib/rbac/middleware.ts provides requireRole
- [ ] src/lib/auth/session.ts has getCurrentUserWithRole
- [ ] src/lib/prisma.ts singleton created
- [ ] src/app/(dashboard)/admin/layout.tsx protects admin routes
- [ ] src/app/(dashboard)/admin/users/page.tsx accessible only by admins
- [ ] Build succeeds
</verification>

<success_criteria>
- All tasks completed
- Role enum defined in Prisma (ADMIN, ATENDENTE)
- RBAC permission system created with role mappings
- Session utilities include role information
- Admin routes protected with requireRole middleware
- Admin users page demonstrates RBAC (only ADMIN can access)
- Dashboard shows admin link only for admin users
- Build succeeds
- Requirements AUTH-05, AUTH-11, AUTH-12 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-secure-foundation/01-04-SUMMARY.md`

**Note for user:** To test RBAC:
1. Create test users in Supabase Dashboard → Authentication → Users
2. Update role in Database → users table (set role='ADMIN' or role='ATENDENTE')
3. Log in and test /admin/users access
</output>
