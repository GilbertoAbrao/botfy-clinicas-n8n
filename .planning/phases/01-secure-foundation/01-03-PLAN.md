---
phase: 01-secure-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01", "01-02"]
files_modified:
  - src/app/(auth)/login/page.tsx
  - src/app/(auth)/layout.tsx
  - src/app/(dashboard)/layout.tsx
  - src/app/(dashboard)/page.tsx
  - src/lib/auth/actions.ts
  - src/lib/auth/session.ts
autonomous: false

must_haves:
  truths:
    - "User can reach login page"
    - "User can enter email and password"
    - "Valid credentials grant access to dashboard"
    - "Invalid credentials show error message"
    - "User can log out"
    - "Session persists across browser refresh"
  artifacts:
    - path: "src/app/(auth)/login/page.tsx"
      provides: "Login page with form"
      min_lines: 50
    - path: "src/lib/auth/actions.ts"
      provides: "Server Actions for login/logout"
      exports: ["signIn", "signOut"]
    - path: "src/lib/auth/session.ts"
      provides: "Session management utilities"
      exports: ["getCurrentUser"]
    - path: "src/app/(dashboard)/layout.tsx"
      provides: "Protected dashboard layout"
      min_lines: 20
  key_links:
    - from: "src/app/(auth)/login/page.tsx"
      to: "src/lib/auth/actions.ts"
      via: "Server Action form submission"
      pattern: "action.*signIn"
    - from: "src/lib/auth/actions.ts"
      to: "supabase.auth.signInWithPassword"
      via: "Supabase Auth API call"
      pattern: "signInWithPassword"
    - from: "src/app/(dashboard)/layout.tsx"
      to: "src/lib/auth/session.ts"
      via: "Session check on render"
      pattern: "getCurrentUser"
---

<objective>
Implement authentication UI and logic with Supabase Auth. Users can sign in with email/password, sessions persist, and protected routes redirect unauthenticated users.

Purpose: Deliver working authentication flow (AUTH-01, AUTH-02, AUTH-03, AUTH-04) with clean UX using shadcn/ui components.
Output: Login page, auth Server Actions, session management, protected dashboard layout with redirection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-secure-foundation/01-01-SUMMARY.md
@.planning/phases/01-secure-foundation/01-02-SUMMARY.md
@.planning/research/PITFALLS.md

**Requirements covered:**
- AUTH-01: User can sign up with email and password (deferred - admin creates accounts)
- AUTH-02: User can log in with email and password ✓
- AUTH-03: User can log out ✓
- AUTH-04: User session persists across browser refresh ✓
- UX-04: System displays clear error messages when operations fail ✓
- UX-05: System provides loading indicators for async operations ✓

**Critical pattern from CVE-2025-29927:**
- Authorization checks in EVERY route/action, not just middleware
- Middleware refreshes sessions only
- Route-level checks enforce access control
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create authentication Server Actions (login, logout, session)</name>
  <files>src/lib/auth/actions.ts, src/lib/auth/session.ts</files>
  <action>
**1. Create `src/lib/auth/session.ts`:**
```typescript
import { createServerSupabaseClient } from '@/lib/supabase/server'
import { cache } from 'react'

export const getCurrentUser = cache(async () => {
  const supabase = await createServerSupabaseClient()
  const {
    data: { user },
    error,
  } = await supabase.auth.getUser()

  if (error || !user) {
    return null
  }

  return user
})
```

`cache()` prevents duplicate auth calls in same request (React 19 feature). Used in Server Components and Server Actions.

**2. Create `src/lib/auth/actions.ts`:**
```typescript
'use server'

import { createServerSupabaseClient } from '@/lib/supabase/server'
import { revalidatePath } from 'next/cache'
import { redirect } from 'next/navigation'

export async function signIn(formData: FormData) {
  const email = formData.get('email') as string
  const password = formData.get('password') as string

  if (!email || !password) {
    return { error: 'Email e senha são obrigatórios' }
  }

  const supabase = await createServerSupabaseClient()

  const { error } = await supabase.auth.signInWithPassword({
    email,
    password,
  })

  if (error) {
    return { error: 'Credenciais inválidas' }
  }

  revalidatePath('/', 'layout')
  redirect('/dashboard')
}

export async function signOut() {
  const supabase = await createServerSupabaseClient()
  await supabase.auth.signOut()
  revalidatePath('/', 'layout')
  redirect('/login')
}
```

These are Server Actions - called from Client Components but execute on server. Supabase handles session cookies automatically.

IMPORTANT: These actions use `createServerSupabaseClient()` (per-request factory from Plan 02), not browser client. This ensures SSR compatibility.
  </action>
  <verify>
```bash
npm run build
```
Build succeeds. No TypeScript errors. src/lib/auth/actions.ts and src/lib/auth/session.ts exist.
  </verify>
  <done>
Auth Server Actions created (signIn, signOut). Session utility created (getCurrentUser with React cache). Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page with form using shadcn/ui</name>
  <files>src/app/(auth)/login/page.tsx, src/app/(auth)/layout.tsx</files>
  <action>
**1. Create Route Group structure:**

Route Groups organize routes without affecting URL paths:
```
src/app/
├── (auth)/         # Public auth routes
│   ├── login/
│   │   └── page.tsx
│   └── layout.tsx
└── (dashboard)/    # Protected dashboard routes
    ├── page.tsx
    └── layout.tsx
```

**2. Create `src/app/(auth)/layout.tsx`:**
```typescript
import type { Metadata } from 'next'

export const metadata: Metadata = {
  title: 'Login - Botfy ClinicOps',
}

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50">
      {children}
    </div>
  )
}
```

Centered layout for login page.

**3. Create `src/app/(auth)/login/page.tsx`:**
```typescript
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Label } from '@/components/ui/label'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import { signIn } from '@/lib/auth/actions'

export default function LoginPage() {
  return (
    <Card className="w-full max-w-md">
      <CardHeader>
        <CardTitle>Botfy ClinicOps</CardTitle>
        <CardDescription>
          Entre com suas credenciais para acessar o console administrativo
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form action={signIn} className="space-y-4">
          <div className="space-y-2">
            <Label htmlFor="email">Email</Label>
            <Input
              id="email"
              name="email"
              type="email"
              placeholder="seu@email.com"
              required
            />
          </div>
          <div className="space-y-2">
            <Label htmlFor="password">Senha</Label>
            <Input
              id="password"
              name="password"
              type="password"
              required
            />
          </div>
          <Button type="submit" className="w-full">
            Entrar
          </Button>
        </form>
      </CardContent>
    </Card>
  )
}
```

Uses native HTML form with Server Action (`action={signIn}`). No client-side state needed for basic flow. Progressive enhancement - works without JavaScript.

**Error handling:** Will add toast notifications in next task for user feedback.
  </action>
  <verify>
```bash
npm run dev
```
Visit http://localhost:3000/login
- Page loads without errors
- Form renders with email/password fields
- Button displays "Entrar"
- shadcn/ui Card, Input, Button components render correctly

```bash
npm run build
```
Build succeeds.
  </verify>
  <done>
Login page created with shadcn/ui components. Auth layout created with centered design. Form uses Server Action for submission. Dev server and build succeed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create protected dashboard layout with session check</name>
  <files>src/app/(dashboard)/layout.tsx, src/app/(dashboard)/page.tsx</files>
  <action>
**1. Create `src/app/(dashboard)/layout.tsx`:**
```typescript
import { redirect } from 'next/navigation'
import { getCurrentUser } from '@/lib/auth/session'
import { signOut } from '@/lib/auth/actions'
import { Button } from '@/components/ui/button'

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode
}) {
  const user = await getCurrentUser()

  if (!user) {
    redirect('/login')
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
          <h1 className="text-xl font-semibold">Botfy ClinicOps</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">{user.email}</span>
            <form action={signOut}>
              <Button variant="outline" size="sm">
                Sair
              </Button>
            </form>
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {children}
      </main>
    </div>
  )
}
```

This Server Component:
- Checks session via `getCurrentUser()`
- Redirects to /login if no session
- Shows email and logout button if authenticated

**CRITICAL:** This implements route-level authorization check, not just middleware (CVE-2025-29927 mitigation). Every protected route group has this pattern.

**2. Create `src/app/(dashboard)/page.tsx`:**
```typescript
export default function DashboardPage() {
  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Dashboard</h1>
      <p className="text-gray-600">
        Bem-vindo ao console administrativo Botfy ClinicOps.
      </p>
    </div>
  )
}
```

Placeholder dashboard page. Will be replaced with actual dashboard in Phase 2.
  </action>
  <verify>
```bash
npm run dev
```

Test flow:
1. Visit http://localhost:3000/dashboard (not logged in)
   - Should redirect to /login
2. Enter valid credentials on /login (if user has created test account)
   - Should redirect to /dashboard
   - Should see email and "Sair" button
3. Click "Sair"
   - Should redirect to /login

```bash
npm run build
```
Build succeeds.
  </verify>
  <done>
Protected dashboard layout created with session check and redirection. Dashboard page placeholder created. Logout button functional. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete authentication flow (login, session persistence, protected routes, logout)</what-built>
  <how-to-verify>
**Prerequisites:** User must have created a test account in Supabase Dashboard:
1. Go to Supabase Dashboard → Authentication → Users
2. Click "Add user" → Email
3. Create test user: email=test@botfy.ai, password=Test123456!
4. Confirm user is created

**Test authentication flow:**
1. Run: npm run dev
2. Visit: http://localhost:3000/dashboard
   - ✓ Redirects to /login (not logged in)
3. Visit: http://localhost:3000/login
   - ✓ Login form displays with Botfy branding
   - ✓ Email and password fields visible
4. Enter INVALID credentials: test@wrong.com / wrongpass
   - ✓ Form submits
   - ✓ Stays on /login (TODO: error message - will add toast in Phase 2)
5. Enter VALID credentials: test@botfy.ai / Test123456!
   - ✓ Form submits
   - ✓ Redirects to /dashboard
   - ✓ Shows "test@botfy.ai" in header
   - ✓ Shows "Sair" button
6. Refresh page (Cmd+R or Ctrl+R)
   - ✓ Still on /dashboard (session persists)
   - ✓ Still shows email (AUTH-04 verified)
7. Click "Sair" button
   - ✓ Redirects to /login
   - ✓ Session cleared
8. Visit http://localhost:3000/dashboard again
   - ✓ Redirects to /login (protection works)

**Requirements verified:**
- AUTH-02: User can log in with email and password ✓
- AUTH-03: User can log out ✓
- AUTH-04: User session persists across browser refresh ✓
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] src/lib/auth/actions.ts (signIn, signOut)
- [ ] src/lib/auth/session.ts (getCurrentUser)
- [ ] src/app/(auth)/login/page.tsx (login form)
- [ ] src/app/(dashboard)/layout.tsx (protected layout with session check)
- [ ] Build succeeds
- [ ] Human verification passed (login flow works end-to-end)
</verification>

<success_criteria>
- All tasks completed
- Server Actions for authentication created
- Login page renders with shadcn/ui components
- Protected dashboard layout checks session on every request
- Unauthenticated users redirected to /login
- Session persists across refresh
- Logout clears session and redirects
- Human verified: Full auth flow works correctly
- Requirements AUTH-02, AUTH-03, AUTH-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-secure-foundation/01-03-SUMMARY.md`
</output>
