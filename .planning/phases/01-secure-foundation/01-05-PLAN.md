---
phase: 01-secure-foundation
plan: 05
type: execute
wave: 3
depends_on: ["01-03", "01-04"]
files_modified:
  - prisma/schema.prisma
  - src/lib/audit/logger.ts
  - src/lib/security/rls-policies.sql
  - src/app/(dashboard)/admin/audit-logs/page.tsx
  - src/lib/auth/session.ts
  - src/components/ui/error-boundary.tsx
  - src/lib/utils/error-handler.ts
autonomous: true

must_haves:
  truths:
    - "All PHI access is logged"
    - "Audit logs include who, what, when information"
    - "Audit logs are stored for 6+ years (HIPAA requirement)"
    - "Admin can view audit logs"
    - "System shows clear error messages on failures"
    - "Inactive users are logged out after 30 minutes"
    - "RLS policies are enabled on sensitive tables"
  artifacts:
    - path: "prisma/schema.prisma"
      provides: "AuditLog model for HIPAA compliance"
      contains: "model AuditLog"
    - path: "src/lib/audit/logger.ts"
      provides: "Audit logging utilities"
      exports: ["logAudit", "AuditAction"]
    - path: "src/lib/security/rls-policies.sql"
      provides: "Row Level Security policies"
      contains: "CREATE POLICY"
    - path: "src/app/(dashboard)/admin/audit-logs/page.tsx"
      provides: "Audit log viewer for admins"
      min_lines: 50
    - path: "src/components/ui/error-boundary.tsx"
      provides: "Error boundary component"
      exports: ["ErrorBoundary"]
  key_links:
    - from: "src/lib/audit/logger.ts"
      to: "prisma.auditLog.create"
      via: "Database insert"
      pattern: "auditLog\\.create"
    - from: "src/app/(dashboard)/admin/audit-logs/page.tsx"
      to: "src/lib/rbac/middleware.ts"
      via: "Admin-only access"
      pattern: "requireRole.*ADMIN"
---

<objective>
Implement HIPAA audit logging (6-year retention), Row Level Security policies, session timeout, and comprehensive error handling. Complete Phase 1 security hardening.

Purpose: Satisfy AUTH-06, AUTH-07, AUTH-08, AUTH-09, AUTH-10, UX-04, UX-06, UX-07 requirements. Ensure healthcare compliance and production-grade error handling.
Output: Full audit logging system, RLS policies on patient data, session management, and user-friendly error boundaries.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-secure-foundation/01-03-SUMMARY.md
@.planning/phases/01-secure-foundation/01-04-SUMMARY.md
@.planning/research/PITFALLS.md

**Requirements covered:**
- AUTH-06: System logs all PHI access for HIPAA compliance (6-year retention) ✓
- AUTH-07: System encrypts all patient data at rest ✓ (Supabase encryption by default)
- AUTH-08: System uses secure authentication (HTTPS, secure cookies) ✓
- AUTH-09: Admin can view audit logs (who accessed what, when) ✓
- AUTH-10: System automatically logs out inactive users after timeout ✓
- UX-04: System displays clear error messages when operations fail ✓
- UX-06: System provides success confirmations for important actions ✓
- UX-07: System handles network errors gracefully with retry options ✓

**Critical compliance:**
- HIPAA requires audit logs with 6-year retention
- Must log: WHO (user), WHAT (action), WHEN (timestamp), WHERE (resource), WHY (result)
- Audit logs cannot be deleted by non-admin users
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit log schema and logging utilities</name>
  <files>prisma/schema.prisma, src/lib/audit/logger.ts, src/lib/audit/actions.ts</files>
  <action>
**1. Add AuditLog model to `prisma/schema.prisma`:**
```prisma
model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  action     String   // "VIEW_PATIENT", "UPDATE_APPOINTMENT", "DELETE_RECORD"
  resource   String   // "patients", "appointments", "chats"
  resourceId String?  @map("resource_id") // ID of the accessed resource
  details    Json?    // Additional context (what changed, etc.)
  ipAddress  String?  @map("ip_address")
  userAgent  String?  @map("user_agent")
  createdAt  DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([createdAt])
  @@index([resource])
  @@map("audit_logs")
}
```

Indexes on userId, createdAt, and resource for efficient audit log queries.

**2. Create `src/lib/audit/logger.ts`:**
```typescript
import { prisma } from '@/lib/prisma'

export enum AuditAction {
  // Patient PHI access
  VIEW_PATIENT = 'VIEW_PATIENT',
  CREATE_PATIENT = 'CREATE_PATIENT',
  UPDATE_PATIENT = 'UPDATE_PATIENT',
  DELETE_PATIENT = 'DELETE_PATIENT',

  // Appointment access
  VIEW_APPOINTMENT = 'VIEW_APPOINTMENT',
  CREATE_APPOINTMENT = 'CREATE_APPOINTMENT',
  UPDATE_APPOINTMENT = 'UPDATE_APPOINTMENT',
  DELETE_APPOINTMENT = 'DELETE_APPOINTMENT',

  // Conversation access (PHI)
  VIEW_CONVERSATION = 'VIEW_CONVERSATION',
  UPDATE_CONVERSATION = 'UPDATE_CONVERSATION',

  // Alert management
  VIEW_ALERT = 'VIEW_ALERT',
  UPDATE_ALERT_STATUS = 'UPDATE_ALERT_STATUS',

  // System admin actions
  VIEW_AUDIT_LOGS = 'VIEW_AUDIT_LOGS',
  CREATE_USER = 'CREATE_USER',
  UPDATE_USER = 'UPDATE_USER',
  DELETE_USER = 'DELETE_USER',
}

interface LogAuditParams {
  userId: string
  action: AuditAction
  resource: string
  resourceId?: string
  details?: Record<string, any>
  ipAddress?: string
  userAgent?: string
}

export async function logAudit(params: LogAuditParams): Promise<void> {
  try {
    await prisma.auditLog.create({
      data: {
        userId: params.userId,
        action: params.action,
        resource: params.resource,
        resourceId: params.resourceId,
        details: params.details,
        ipAddress: params.ipAddress,
        userAgent: params.userAgent,
      },
    })
  } catch (error) {
    // CRITICAL: Audit logging failure should NOT break the application
    // Log to external monitoring (DataDog, Sentry) in production
    console.error('[AUDIT LOG FAILURE]', error)
  }
}
```

Audit logging is fire-and-forget - failures should not block user actions.

**3. Create `src/lib/audit/actions.ts`:**
```typescript
'use server'

import { getCurrentUserWithRole } from '@/lib/auth/session'
import { requireRole } from '@/lib/rbac/middleware'
import { Role } from '@prisma/client'
import { prisma } from '@/lib/prisma'
import { logAudit, AuditAction } from './logger'

export async function getAuditLogs(page: number = 1, limit: number = 50) {
  const user = await getCurrentUserWithRole()

  if (!user) {
    throw new Error('Unauthorized')
  }

  // Only admins can view audit logs (AUTH-09)
  requireRole(user.role, [Role.ADMIN])

  // Log the audit log access (meta-logging)
  await logAudit({
    userId: user.id,
    action: AuditAction.VIEW_AUDIT_LOGS,
    resource: 'audit_logs',
  })

  const [logs, total] = await Promise.all([
    prisma.auditLog.findMany({
      take: limit,
      skip: (page - 1) * limit,
      orderBy: { createdAt: 'desc' },
      include: {
        // Join with users table to show email (will add relation in next step)
      },
    }),
    prisma.auditLog.count(),
  ])

  return {
    logs,
    total,
    page,
    totalPages: Math.ceil(total / limit),
  }
}
```

Server Action for fetching audit logs. Admin-only access.

**4. Update Prisma schema to add User relation:**
```prisma
model AuditLog {
  // ... existing fields
  user      User     @relation(fields: [userId], references: [id])
}

model User {
  // ... existing fields
  auditLogs AuditLog[]
}
```

Generates Prisma migration and Client:
```bash
npx prisma generate
```

If database is ready:
```bash
npx prisma db push
# or
npx prisma migrate dev --name add_audit_logs
```
  </action>
  <verify>
```bash
npx prisma generate
```
Prisma Client generates with AuditLog model. No errors.

```bash
npm run build
```
Build succeeds.
  </verify>
  <done>
AuditLog model created with 6-year HIPAA-compliant retention. Audit logging utilities created (logAudit, AuditAction enum). Server Actions for fetching audit logs. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create audit log viewer page for admins</name>
  <files>src/app/(dashboard)/admin/audit-logs/page.tsx</files>
  <action>
Install shadcn/ui Table component:
```bash
npx shadcn@latest add table
```

Create `src/app/(dashboard)/admin/audit-logs/page.tsx`:
```typescript
import { getAuditLogs } from '@/lib/audit/actions'
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'

export default async function AuditLogsPage() {
  const { logs, total, page, totalPages } = await getAuditLogs()

  return (
    <div>
      <h1 className="text-2xl font-bold mb-4">Audit Logs</h1>
      <Card>
        <CardHeader>
          <CardTitle>Logs de Acesso a Dados Protegidos (PHI)</CardTitle>
          <CardDescription>
            Registro de todos os acessos a informações de pacientes conforme exigido pela HIPAA.
            Retenção: 6 anos. Total de registros: {total}
          </CardDescription>
        </CardHeader>
        <CardContent>
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Data/Hora</TableHead>
                <TableHead>Usuário</TableHead>
                <TableHead>Ação</TableHead>
                <TableHead>Recurso</TableHead>
                <TableHead>IP</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {logs.map((log) => (
                <TableRow key={log.id}>
                  <TableCell>{new Date(log.createdAt).toLocaleString('pt-BR')}</TableCell>
                  <TableCell>{log.userId}</TableCell>
                  <TableCell><code className="text-xs">{log.action}</code></TableCell>
                  <TableCell>
                    {log.resource}
                    {log.resourceId && ` (${log.resourceId.slice(0, 8)}...)`}
                  </TableCell>
                  <TableCell className="text-xs text-gray-500">{log.ipAddress || '-'}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
          {logs.length === 0 && (
            <p className="text-center text-gray-500 py-8">Nenhum log de auditoria encontrado.</p>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
```

Admin-only page showing all PHI access logs. Pagination will be added in Phase 2 when building data tables.

Add link to audit logs in dashboard layout (admin only):
```typescript
// In src/app/(dashboard)/layout.tsx
{userWithRole?.role === 'ADMIN' && (
  <>
    <Link href="/admin/users"><Button variant="ghost" size="sm">Usuários</Button></Link>
    <Link href="/admin/audit-logs"><Button variant="ghost" size="sm">Audit Logs</Button></Link>
  </>
)}
```
  </action>
  <verify>
```bash
npm run dev
```
Visit /admin/audit-logs (as admin):
- Page loads without errors
- Shows "Nenhum log de auditoria encontrado" (empty state)
- Table headers render correctly

```bash
npm run build
```
Build succeeds.
  </verify>
  <done>
Audit log viewer page created. Admin-only access enforced. Table displays logs with timestamp, user, action, resource, IP. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement RLS policies for patient data tables</name>
  <files>src/lib/security/rls-policies.sql</files>
  <action>
Create `src/lib/security/rls-policies.sql`:
```sql
-- Row Level Security policies for Botfy ClinicOps
-- IMPORTANT: These policies MUST be applied to Supabase database manually
-- Go to Supabase Dashboard → SQL Editor → New Query → Paste this SQL

-- Enable RLS on sensitive tables
ALTER TABLE pacientes ENABLE ROW LEVEL SECURITY;
ALTER TABLE agendamentos ENABLE ROW LEVEL SECURITY;
ALTER TABLE chats ENABLE ROW LEVEL SECURITY;
ALTER TABLE n8n_chat_histories ENABLE ROW LEVEL SECURITY;
ALTER TABLE pre_checkin ENABLE ROW LEVEL SECURITY;

-- Pacientes (Patient Data) - Only authenticated users can access
CREATE POLICY "Authenticated users can view patients"
  ON pacientes
  FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can insert patients"
  ON pacientes
  FOR INSERT
  WITH CHECK (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can update patients"
  ON pacientes
  FOR UPDATE
  USING (auth.role() = 'authenticated');

-- DO NOT allow DELETE on patients (soft delete only)
-- Patient records should NEVER be deleted for HIPAA compliance

-- Agendamentos (Appointments) - Authenticated access
CREATE POLICY "Authenticated users can view appointments"
  ON agendamentos
  FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can manage appointments"
  ON agendamentos
  FOR ALL
  USING (auth.role() = 'authenticated');

-- Chats - Authenticated access
CREATE POLICY "Authenticated users can view chats"
  ON chats
  FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can manage chats"
  ON chats
  FOR ALL
  USING (auth.role() = 'authenticated');

-- N8N Chat Histories - Authenticated access
CREATE POLICY "Authenticated users can view chat histories"
  ON n8n_chat_histories
  FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can manage chat histories"
  ON n8n_chat_histories
  FOR ALL
  USING (auth.role() = 'authenticated');

-- Pre Check-in - Authenticated access
CREATE POLICY "Authenticated users can view pre checkin"
  ON pre_checkin
  FOR SELECT
  USING (auth.role() = 'authenticated');

CREATE POLICY "Authenticated users can manage pre checkin"
  ON pre_checkin
  FOR ALL
  USING (auth.role() = 'authenticated');

-- Performance optimization: Use IN/ANY instead of subqueries
-- (from Pitfall 2 research)
-- Example for future patient-specific filtering:
-- WHERE patient_id IN (SELECT id FROM allowed_patients WHERE user_id = auth.uid())
```

These policies:
1. Enable RLS on all PHI tables (pacientes, agendamentos, chats)
2. Require authentication for ALL access (no anonymous access)
3. Use simple auth.role() checks for performance (avoid complex subqueries)
4. DO NOT allow DELETE on patients (HIPAA compliance)

**IMPORTANT:** These policies must be applied manually via Supabase SQL Editor. Cannot be automated in code.

Create a README for the user:
```markdown
# RLS Policies - Manual Setup Required

Apply these policies in Supabase Dashboard:

1. Go to https://supabase.com/dashboard/project/gkweofpjwzsvlvnvfbom
2. Navigate to SQL Editor
3. Click "New Query"
4. Copy contents of `src/lib/security/rls-policies.sql`
5. Paste and run the query
6. Verify: All tables should show "RLS enabled" in Table Editor

**Why manual?**
- Supabase requires database admin access for RLS
- Cannot be done via Prisma or application code
- Must be done once during initial setup
```
  </action>
  <verify>
File created: src/lib/security/rls-policies.sql

```bash
cat src/lib/security/rls-policies.sql
```
SQL file contains all RLS policies.
  </verify>
  <done>
RLS policies SQL file created with policies for all PHI tables (pacientes, agendamentos, chats, n8n_chat_histories, pre_checkin). User instructions provided for manual application in Supabase.
  </done>
</task>

<task type="auto">
  <name>Task 4: Implement session timeout (AUTH-10) and error handling (UX-04, UX-06, UX-07)</name>
  <files>src/lib/auth/session.ts, src/components/ui/error-boundary.tsx, src/components/ui/toast.tsx, src/lib/utils/error-handler.ts</files>
  <action>
**1. Add session timeout to middleware:**

Update `src/lib/supabase/middleware.ts`:
```typescript
// After getting user in updateSession()
if (user) {
  // Check last activity timestamp
  const lastActivity = request.cookies.get('last_activity')?.value
  const now = Date.now()
  const THIRTY_MINUTES = 30 * 60 * 1000 // 30 minutes in ms

  if (lastActivity && now - parseInt(lastActivity) > THIRTY_MINUTES) {
    // Session expired - force logout
    await supabase.auth.signOut()
    return NextResponse.redirect(new URL('/login', request.url))
  }

  // Update last activity timestamp
  supabaseResponse.cookies.set('last_activity', now.toString(), {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
    maxAge: THIRTY_MINUTES / 1000,
  })
}
```

This automatically logs out users after 30 minutes of inactivity (AUTH-10).

**2. Install toast component (already done in Plan 01, verify):**
```bash
npx shadcn@latest add toast
npx shadcn@latest add sonner
```

Sonner provides better toast UX than default shadcn toast.

**3. Create error boundary:**

Create `src/components/ui/error-boundary.tsx`:
```typescript
'use client'

import { useEffect } from 'react'
import { Button } from './button'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './card'

export function ErrorBoundary({
  error,
  reset,
}: {
  error: Error & { digest?: string }
  reset: () => void
}) {
  useEffect(() => {
    // Log to monitoring service (Sentry, DataDog, etc.)
    console.error('Application error:', error)
  }, [error])

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-4">
      <Card className="max-w-md w-full">
        <CardHeader>
          <CardTitle>Algo deu errado</CardTitle>
          <CardDescription>
            Ocorreu um erro inesperado. Tente novamente ou entre em contato com o suporte.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {process.env.NODE_ENV === 'development' && (
            <div className="bg-red-50 border border-red-200 rounded p-3">
              <p className="text-sm text-red-800 font-mono">{error.message}</p>
            </div>
          )}
          <Button onClick={reset} className="w-full">
            Tentar Novamente
          </Button>
        </CardContent>
      </Card>
    </div>
  )
}
```

Add to layouts:
```typescript
// In src/app/(dashboard)/layout.tsx
import { ErrorBoundary } from '@/components/ui/error-boundary'

// Wrap children
<ErrorBoundary>
  {children}
</ErrorBoundary>
```

**4. Create error handler utilities:**

Create `src/lib/utils/error-handler.ts`:
```typescript
export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500
  ) {
    super(message)
    this.name = 'AppError'
  }
}

export function handleApiError(error: unknown): AppError {
  if (error instanceof AppError) {
    return error
  }

  if (error instanceof Error) {
    return new AppError(error.message, 'INTERNAL_ERROR', 500)
  }

  return new AppError('Erro desconhecido', 'UNKNOWN_ERROR', 500)
}

export function getUserFriendlyMessage(error: AppError): string {
  const messages: Record<string, string> = {
    UNAUTHORIZED: 'Você não tem permissão para acessar este recurso.',
    NOT_FOUND: 'Recurso não encontrado.',
    VALIDATION_ERROR: 'Dados inválidos. Verifique os campos e tente novamente.',
    NETWORK_ERROR: 'Erro de conexão. Verifique sua internet e tente novamente.',
    INTERNAL_ERROR: 'Erro interno. Tente novamente mais tarde.',
  }

  return messages[error.code] || error.message
}
```

This provides standardized error handling across the application (UX-04, UX-07).
  </action>
  <verify>
```bash
npm run build
```
Build succeeds. No TypeScript errors.

Test session timeout:
1. Log in
2. Wait 30 minutes (or temporarily change timeout to 1 minute for testing)
3. Try to navigate
4. Should redirect to /login

Test error handling:
1. Throw an error in a Server Component
2. Should see error boundary with user-friendly message
  </verify>
  <done>
Session timeout implemented (30 minutes inactivity). Error boundary created with user-friendly messages. Error handler utilities created. Toast component ready for success/error notifications. Build succeeds.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] AuditLog model in Prisma schema
- [ ] Audit logging utilities created (logAudit, AuditAction)
- [ ] Audit log viewer page for admins
- [ ] RLS policies SQL file created
- [ ] Session timeout implemented (30 minutes)
- [ ] Error boundary component created
- [ ] Error handler utilities created
- [ ] Build succeeds
</verification>

<success_criteria>
- All tasks completed
- HIPAA-compliant audit logging system operational
- All PHI access logged with 6-year retention
- Admin can view audit logs via /admin/audit-logs
- RLS policies SQL ready for manual application
- Session timeout enforces 30-minute inactivity logout
- Error boundary provides user-friendly error messages
- Error handling utilities standardize error responses
- Build succeeds
- Requirements AUTH-06, AUTH-07, AUTH-08, AUTH-09, AUTH-10, UX-04, UX-06, UX-07 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-secure-foundation/01-05-SUMMARY.md`

**User action required:** After this plan executes:
1. Apply RLS policies manually in Supabase SQL Editor (see src/lib/security/rls-policies.sql)
2. Verify RLS is enabled on all PHI tables (pacientes, agendamentos, chats, etc.)
3. Test audit logging by accessing patient data and checking /admin/audit-logs
</output>
