# Research Summary: v1.2 Agenda List View + Pre-Checkin Management

**Project:** Botfy ClinicOps - Console Administrativo
**Milestone:** v1.2
**Researched:** 2026-01-21
**Confidence:** HIGH

## Executive Summary

Adding list view to agenda and pre-checkin management UI to the existing healthcare admin console. All database tables already exist (`pre_checkin`, `documentos_paciente`, `instrucoes_procedimentos`). The features integrate seamlessly with the established Next.js + Supabase architecture.

**Key insight:** This is primarily a UI layer over existing data. N8N handles the pre-checkin workflow; the console provides visibility and management capabilities.

## Recommended Stack

### Already Have (Don't Add)
- Next.js 15 + React 19 + TypeScript 5 + Tailwind 4 + shadcn/ui
- Supabase (PostgreSQL + Auth + Realtime + Storage) with @supabase/ssr
- Schedule-X v2.36.0 for calendar views
- TZDate for DST-aware timezone handling
- react-hook-form v7.71.1 + Zod for forms
- react-dropzone for file uploads
- recharts for analytics

### Recommended Additions

| Library | Version | Size | Priority | Rationale |
|---------|---------|------|----------|-----------|
| @tanstack/react-table | 8.x | ~35KB | CRITICAL | Advanced filtering, sorting, pagination for list views |
| react-pdf (optional) | 9.x | ~50KB | MEDIUM | PDF document preview - can defer to v1.3 |

**Total new bundle:** ~25KB gzipped

### Don't Add
- AG Grid (paid, overkill)
- Tremor (already have shadcn + recharts)
- TanStack Query (Next.js SSR handles caching)
- Markdown editors (textarea sufficient for MVP)

## Expected Features

### Agenda List View

**Table Stakes:**
- Toggle calendar/list in page header (sync to URL `?view=list`)
- Columns: Date/Time, Patient, Service, Provider, Status, Duration, Actions
- Filters: date range (presets + custom), provider, service, status
- Sort by any column
- Quick actions per row: Edit, Confirm, Cancel, Send reminder
- Search by patient name/phone
- No-show risk badge (reuse existing component)
- Pagination (50 rows/page)

**Differentiators:**
- Bulk actions (select multiple, confirm all)
- Color-coded rows by risk level
- Export to CSV

**Anti-Features:**
- Real-time list updates (causes memory leaks - use manual refresh)
- Complex AND/OR filter logic
- Drag-drop in list view (use calendar for that)

### Pre-Checkin Dashboard

**Table Stakes:**
- Table: Patient, Appointment date, Service, Status, Progress indicators, Actions
- Status flow: Pendente → Em Andamento → Completo/Incompleto
- Filters: status, date range, patient search
- Actions: Mark complete, Send reminder, View details
- Show pending items checklist (dados, documentos, instrucoes)
- Mobile-responsive card layout

**Differentiators:**
- Analytics cards (completion rate, pending count)
- Timeline showing workflow progress
- Link to alert dashboard (pre_checkins_pendentes type)

**Anti-Features:**
- Direct patient data editing (link to patient profile instead)
- Auto-cancel appointments (require manual action)
- SMS from dashboard (use N8N webhooks)

### Procedure Instructions CRUD

**Table Stakes:**
- List with search by procedure name
- CRUD form: procedure dropdown, instructions textarea, type categorization
- Soft delete (ativo=false)
- ADMIN-only access

**Anti-Features:**
- Rich text editor (textarea sufficient, adds complexity)
- AI-generated instructions (medical content requires review)

### Document Management

**Table Stakes:**
- List by patient with type, status, upload date
- Status workflow: Pendente → Aprovado/Rejeitado
- Reject with reason (required)
- Preview modal (iframe for PDF, img for images)
- Download original file

**Anti-Features:**
- AI document validation (OCR handled by N8N)
- e-Signature capture (out of scope)
- EHR integration (massive scope)

## Architecture

### Files to Modify
- `src/app/agenda/page.tsx` - Add view toggle
- `src/components/layout/sidebar-nav.tsx` - Add navigation items

### New Components
- `src/components/calendar/agenda-list-view.tsx` - List table
- `src/components/calendar/agenda-view-toggle.tsx` - Toggle button
- `src/components/pre-checkin/pre-checkin-list.tsx` - Dashboard table
- `src/components/pre-checkin/pre-checkin-detail.tsx` - Detail modal
- `src/components/procedures/procedure-instructions-list.tsx` - CRUD table
- `src/components/documents/patient-documents-manager.tsx` - Document list

### New API Routes
- `GET/POST /api/pre-checkin` - List and create
- `GET/PUT/DELETE /api/pre-checkin/[id]` - CRUD
- `POST /api/pre-checkin/[id]/send-reminder` - Trigger N8N webhook
- `GET/POST /api/procedures/instructions` - CRUD
- `GET /api/patient-documents` - List with filters
- `POST /api/patient-documents/[id]/approve` - Approve document
- `POST /api/patient-documents/[id]/reject` - Reject with reason

### New Pages
- `/admin/pre-checkin/page.tsx` - Dashboard
- `/admin/pre-checkin/instrucoes/page.tsx` - Instructions CRUD
- `/admin/pre-checkin/documentos/page.tsx` - Documents management

## Critical Pitfalls

### 1. List View State Management
- **Risk:** Filter state lost on view toggle or refresh
- **Prevention:** Persist to URL query params, not just client state

### 2. Pre-Checkin Status Sync
- **Risk:** Console shows stale status, N8N has updated it
- **Prevention:** N8N webhooks must notify console of status changes; design for eventual consistency

### 3. HIPAA Compliance in List View
- **Risk:** Full CPF/phone visible, documents cached in browser
- **Prevention:** Mask sensitive data, set Cache-Control headers, audit log all access

### 4. Timezone DST Issues
- **Risk:** Pre-checkins trigger at wrong time during DST transitions
- **Prevention:** Always use TZDate and `createClinicDate()` helper, never raw `new Date()`

### 5. Realtime Subscription Memory Leaks
- **Risk:** Browser tab freezes after 1+ hour on list view
- **Prevention:** Unsubscribe on unmount, batch updates, subscribe only to visible items

### 6. Document Upload Race Conditions
- **Risk:** Duplicate documents for same pre-checkin
- **Prevention:** Database UNIQUE constraint on (pre_checkin_id, tipo_documento)

## Suggested Build Order

| Phase | Feature | Complexity | Dependencies |
|-------|---------|------------|--------------|
| 13 | Agenda List View | MEDIUM | None - extends existing calendar |
| 14 | Pre-Checkin Dashboard | MEDIUM | Tables exist, needs API routes |
| 15 | Procedure Instructions CRUD | LOW | Simple CRUD, ADMIN only |
| 16 | Document Management | MEDIUM | Supabase Storage integration |

**Estimated effort:** 12-16 hours total

## Integration Points

- **Authentication:** Use existing `getCurrentUserWithRole()`
- **RBAC:** ADMIN for writes, ADMIN/ATENDENTE for reads
- **Audit Logging:** Use existing `logAudit()` with new actions
- **Supabase:** Use existing client factories
- **N8N Webhooks:** Fire-and-forget pattern (don't block UI)
- **Components:** Reuse shadcn/ui Table, Dialog, Form patterns

## Implications for Roadmap

1. **Phase 13 (Agenda List View)** - Foundation, no new dependencies
2. **Phase 14 (Pre-Checkin Dashboard)** - Needs API routes, reuses table patterns
3. **Phase 15 (Procedure Instructions)** - Simple CRUD, low risk
4. **Phase 16 (Document Management)** - Most complex, defer react-pdf decision

All phases continue existing patterns. No architectural changes required.

---
*Research completed: 2026-01-21*
*Ready for requirements: yes*
