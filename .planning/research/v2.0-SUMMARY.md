# Research Summary: v2.0 Agent API Migration

**Milestone:** v2.0 Agent API Migration
**Synthesized:** 2026-01-24
**Overall Confidence:** HIGH

## Executive Summary

The v2.0 milestone migrates 11 N8N AI Agent tools from sub-workflows (9-15 nodes each) to Next.js API routes with an optional MCP Server wrapper. This represents a fundamental architectural shift from implicit tool calling to explicit, type-safe APIs that enable better error handling, code review, testing, and maintainability.

**Recommended Approach:** Dual-track architecture where N8N agents call Next.js REST APIs directly via HTTP Request nodes (replacing Execute Workflow nodes), while a standalone MCP Server wraps these same APIs for future Claude Desktop integration. This maximizes code reuse through a shared service layer while maintaining backward compatibility during migration.

**Key Technical Decision:** Use `@modelcontextprotocol/sdk` v1.25.3 for MCP server, Next.js 16 API Routes for endpoints, API key authentication via Bearer tokens, and Zod schemas for validation. No additional HTTP frameworks, databases, or complex infrastructure - lean and focused on the migration scope.

**Critical Success Factors:** Implement idempotency for write operations, establish consistent error response formats before first API, maintain N8N sub-workflows as fallback during gradual rollout, and extend audit logging to track agent tool calls for HIPAA compliance.

## Key Decisions

### Stack Decisions

| Decision | Rationale | Alternative Rejected |
|----------|-----------|---------------------|
| **Next.js 16 API Routes** | Already in use, serverless-friendly, sufficient for tool APIs | Express/Fastify (adds deployment complexity) |
| **@modelcontextprotocol/sdk v1.25.3** | Official TypeScript SDK, stable v1.x, stdio + HTTP transports | Python/Java SDKs (language boundary) |
| **API Key Authentication** | Simple, N8N-compatible, stateless | JWT/OAuth (premature complexity) |
| **Standalone MCP Server** | Independent lifecycle, flexible deployment, easier testing | Integrated Next.js route (tight coupling) |
| **Service Layer Extraction** | Enables reuse between Console UI and Agent APIs | Duplicate logic (maintenance nightmare) |
| **Zod-first Validation** | Type safety, auto-generated schemas, existing pattern | Manual validation (error-prone) |

### Architecture Decisions

| Decision | Rationale | Trade-off |
|----------|-----------|-----------|
| **Dual-track (REST + MCP)** | N8N calls REST, Claude Desktop uses MCP, same backend | Two protocols to maintain (but MCP wraps REST) |
| **Gradual Migration** | Keep sub-workflows as fallback, A/B test, rollback option | Longer transition period (safer) |
| **Agent User Mapping** | Each agent links to system user for RBAC/audit | Requires `agents` table (minor schema change) |
| **High-level Workflow Tools** | `criar_agendamento` creates patient + appointment in one call | Larger API surface (better agent UX) |

## Stack Additions

### New Dependencies

```json
{
  "@modelcontextprotocol/sdk": "^1.25.3"
}
```

**Why minimal?** Existing stack already has:
- Next.js 16.1.2 (API Routes)
- Zod 4.3.5 (validation, required by MCP SDK)
- Supabase client (database access)
- TypeScript 5 (type safety)

### New Infrastructure Components

| Component | Purpose | Deployment |
|-----------|---------|------------|
| `src/app/api/agent/*` | REST endpoints for AI agent tools | Next.js serverless functions |
| `src/lib/agent/auth.ts` | API key authentication | Next.js middleware |
| `src/lib/services/*` | Business logic extracted from routes | Shared library |
| `mcp-server/` | Standalone MCP server wrapper | Separate Node.js process |
| `agents` table | API key storage and agent metadata | Supabase migration |

### Environment Variables

```bash
# New variables for v2.0
N8N_API_KEY=<bcrypt-hashed-key>          # Agent authentication
NEXT_PUBLIC_APP_URL=http://localhost:3051 # For MCP server
```

## Architecture Overview

### Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                   N8N AI Agent (Marília)                         │
│  AI Agent Node → HTTP Request → Authorization: Bearer <key>     │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼ (HTTP POST)
┌─────────────────────────────────────────────────────────────────┐
│              Next.js API Routes (/api/agent/*)                   │
│  1. Auth (API key → agentUserId)                                │
│  2. Authorization (RBAC for agents)                             │
│  3. Validation (Zod schema)                                     │
│  4. Business Logic (service layer)                              │
│  5. Database (Supabase with RLS)                                │
│  6. Audit Log (agent actions)                                   │
│  7. Response (structured JSON)                                  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Service Layer (NEW)                           │
│  - Extracted from existing API routes                           │
│  - Reused by Console UI + Agent APIs                            │
│  - Business logic (conflict detection, availability calc)       │
│  - Supabase queries (RLS-aware)                                 │
└─────────────────────────────────────────────────────────────────┘
```

**Optional Future Enhancement:**
```
┌─────────────────────────────────────────────────────────────────┐
│                    MCP Server (stdio)                            │
│  Wraps /api/agent/* endpoints for Claude Desktop               │
│  - Tool discovery                                               │
│  - Schema introspection                                         │
│  - Standard MCP protocol                                        │
└─────────────────────────────────────────────────────────────────┘
```

### Directory Structure

```
src/
├── app/
│   └── api/
│       ├── agent/                      # NEW: Agent tool endpoints
│       │   ├── slots/route.ts          # GET /api/agent/slots
│       │   ├── appointments/route.ts   # POST /api/agent/appointments
│       │   ├── patients/route.ts       # GET/POST /api/agent/patients
│       │   └── [other tools]/
│       └── [existing routes]/
│
├── lib/
│   ├── agent/                          # NEW: Agent-specific utilities
│   │   ├── auth.ts                     # API key authentication
│   │   ├── middleware.ts               # withAgentAuth() wrapper
│   │   └── audit.ts                    # Agent audit logging
│   ├── services/                       # NEW: Business logic layer
│   │   ├── appointments.ts             # Extracted from routes
│   │   ├── patients.ts
│   │   ├── slots.ts
│   │   └── pre-checkin.ts
│   └── [existing libs reused]/
│
└── mcp-server/                         # NEW: Optional MCP wrapper
    ├── index.ts                        # MCP server entry point
    ├── tools.ts                        # Tool definitions
    └── package.json                    # Separate deployment
```

### Component Boundaries

| Component | Responsibility | Does NOT |
|-----------|---------------|----------|
| **API Routes** | Auth, validation, orchestration | Business logic (delegates to services) |
| **Service Layer** | Business logic, database queries | Auth, HTTP concerns |
| **Agent Auth** | API key validation, user mapping | Authorization (uses RBAC) |
| **MCP Server** | Protocol translation, tool discovery | Business logic (proxies to APIs) |
| **N8N Workflows** | AI orchestration, conversation flow | Data manipulation (calls APIs) |

## Migration Strategy

### Recommended Phases

**Phase 17: Foundation (Week 1)**
- Create `agents` table with API key storage
- Implement `lib/agent/auth.ts` and middleware
- Extract service layer from existing routes
- Establish error response standards
- Extend audit logger for agent context

**Why first?** All subsequent tools depend on auth and service infrastructure. No API can be migrated without this foundation.

**Phase 18: Simple Tools - Read Operations (Week 2)**
- Migrate `buscar_slots_disponiveis` (9 nodes → 1 API route)
- Migrate `buscar_paciente` (5 nodes → 1 API route)
- Migrate `buscar_agendamentos` (4 nodes → 1 API route)
- Test with N8N HTTP Request nodes

**Why these?** Read-only operations are safest to start. No risk of data corruption. Easy rollback.

**Phase 19: Core Tools - Write Operations (Week 3-4)**
- Migrate `criar_agendamento` (15 nodes → 1 API route)
  - Implement idempotency
  - Add conflict detection
  - Trigger N8N webhooks
- Migrate `reagendar_agendamento` (4 nodes → 1 API route)
- Migrate `cancelar_agendamento` (4 nodes → 1 API route)
- Migrate `atualizar_dados_paciente` (9 nodes → 1 API route)
- Migrate `confirmar_presenca` (1 node → 1 API route)

**Why this order?** Build on read operations. Implement critical write patterns (idempotency, audit) early.

**Phase 20: Complex Tools (Week 5)**
- Migrate `status_pre_checkin` (8 nodes → 1 API route)
- Migrate `buscar_instrucoes` (6 nodes → 1 API route, requires embeddings)
- Migrate `processar_documento` (13 nodes → 1 API route, requires file handling)

**Why last?** These require additional infrastructure (pgvector, file uploads). Can be deferred if needed.

**Phase 21: N8N Integration (Week 6)**
- Update main AI Agent workflow to use HTTP Request nodes
- Configure N8N credentials for API key
- Gradual rollout (10% → 50% → 100%)
- Monitor error rates and latency
- Archive (don't delete) old sub-workflows

**Why gradual?** Production system with real patients. Rollback capability essential.

**Phase 22: MCP Server (Optional, Week 7+)**
- Build standalone MCP server
- Register all 11 tools
- Test with Claude Desktop
- Document usage

**Why optional?** N8N integration is primary goal. MCP enables future Claude Desktop usage but not MVP blocker.

### Migration Order Rationale

| Tool | Complexity | Dependencies | Order |
|------|------------|--------------|-------|
| `buscar_slots_disponiveis` | LOW | Calendar availability calculator (existing) | 1 |
| `buscar_paciente` | LOW | Patient search (existing) | 2 |
| `buscar_agendamentos` | LOW | Appointment queries (existing) | 3 |
| `criar_agendamento` | HIGH | Patient CRUD, conflict detection, idempotency | 4 |
| `reagendar_agendamento` | MEDIUM | Appointment CRUD, conflict detection | 5 |
| `cancelar_agendamento` | MEDIUM | Appointment CRUD, waitlist notification | 6 |
| `atualizar_dados_paciente` | MEDIUM | Patient CRUD, validation | 7 |
| `confirmar_presenca` | LOW | Status update only | 8 |
| `status_pre_checkin` | HIGH | Multi-table joins, status aggregation | 9 |
| `buscar_instrucoes` | HIGH | Vector search, embeddings | 10 |
| `processar_documento` | HIGH | File upload, OCR, storage | 11 |

### Rollback Plan

Each phase has a rollback strategy:

1. **API route fails:** N8N continues using sub-workflow (still active)
2. **N8N integration breaks:** Revert N8N workflow to previous version
3. **Performance issues:** Gradual rollout enables quick percentage reduction
4. **Data integrity issues:** Idempotency prevents duplicates, audit log tracks changes

## Critical Pitfalls

### Top 5 Migration Risks

**1. API Key Exposure in N8N Logs**
- **Risk:** API keys visible in N8N execution logs
- **Prevention:** Use N8N Credentials system with `{{$credentials.botfy_api_key}}`
- **Detection:** API keys visible in workflow JSON or execution details
- **Mitigation:** Rotate keys immediately, implement 90-day rotation policy

**2. Inconsistent Error Response Formats**
- **Risk:** Different APIs return different error structures, confusing AI agent
- **Prevention:** Single `handleApiError()` utility, TypeScript response types
- **Detection:** AI agent can't parse error messages consistently
- **Mitigation:** Refactor all routes to use shared error handler

**3. N8N Timeout → Duplicate Records**
- **Risk:** N8N times out (5s), retries, API completes first request → duplicate
- **Prevention:** Implement idempotency keys, set N8N timeout to 30s
- **Detection:** Duplicate appointments created during high load
- **Mitigation:** Dedup via idempotency cache lookup

**4. Breaking N8N Workflows During Migration**
- **Risk:** Delete sub-workflow before N8N updated → production outage
- **Prevention:** Gradual rollout, keep sub-workflows as fallback
- **Detection:** "Workflow not found" errors in N8N logs
- **Mitigation:** Rollback N8N to previous workflow version

**5. Missing Agent Audit Logs**
- **Risk:** Agent tool calls not logged → HIPAA compliance gap
- **Prevention:** Extend audit logger for agent context, log all tool calls
- **Detection:** Audit logs missing during agent activity periods
- **Mitigation:** Backfill logs from N8N execution history if possible

### Pitfall Prevention Checklist

- [ ] API keys stored in N8N Credentials (never hardcoded)
- [ ] All routes use shared `ApiResponse<T>` types
- [ ] Idempotency implemented for all write operations
- [ ] N8N HTTP Request timeout set to 30000ms
- [ ] Sub-workflows archived (not deleted) during migration
- [ ] Zod schemas accept multiple date formats
- [ ] Agent audit logging includes correlation IDs
- [ ] MCP server has error handlers and heartbeat
- [ ] Migration protocol documented with rollback steps
- [ ] Load testing completed before production rollout

## Success Criteria Indicators

### Technical Success Metrics

| Metric | Target | How to Measure |
|--------|--------|----------------|
| **API Response Time** | p95 < 500ms | Next.js API logs, OpenTelemetry |
| **N8N Tool Call Success Rate** | >99.5% | N8N execution logs, error rate dashboard |
| **Error Response Consistency** | 100% | All routes return `ApiResponse<T>` format |
| **Idempotency Effectiveness** | Zero duplicates | Database query for duplicate appointments |
| **Migration Completion** | 11/11 tools migrated | Sub-workflows archived, HTTP Request nodes active |
| **Audit Log Coverage** | 100% of agent calls logged | Audit table query for agent actions |

### Operational Success Metrics

| Metric | Target | How to Measure |
|--------|--------|----------------|
| **Zero Production Outages** | 0 incidents | N8N workflow execution success rate |
| **Gradual Rollout** | 10% → 50% → 100% over 1 week | N8N workflow version traffic split |
| **Rollback Capability** | <5 minutes to revert | Test rollback procedure in staging |
| **Code Review Coverage** | 100% of API routes | GitHub PR reviews before merge |
| **Test Coverage** | >80% for service layer | Jest coverage report |

### User Experience Success Metrics

| Metric | Target | How to Measure |
|--------|--------|----------------|
| **Agent Response Quality** | No increase in error messages to patients | WhatsApp conversation analysis |
| **Booking Success Rate** | Maintain current rate (>95%) | Agendamentos created vs attempted |
| **Error Clarity** | AI can parse and explain all errors | Manual testing of error scenarios |

### Smoke Tests

Run these after each tool migration:

1. **Authentication:** N8N HTTP Request with valid API key → 200
2. **Authorization:** Request without API key → 401
3. **Validation:** Invalid input (bad date format) → 400 with clear error
4. **Success Path:** Valid request → 200 with structured response
5. **Idempotency:** Duplicate request → Same result, no duplicate records
6. **Audit:** Tool call logged with agentId and correlation ID
7. **Rollback:** Revert N8N to sub-workflow → Still works

## Phase Recommendations

### Suggested Phase Structure

Based on combined research, here's the recommended phase breakdown for .planning/ROADMAP.md:

```markdown
## Phase 17: Foundation (Agent API Infrastructure)
**Duration:** 1 week
**Deliverables:**
- `agents` table with API key storage
- `lib/agent/auth.ts` and middleware
- Service layer extraction (appointments, patients, slots)
- Shared error response types
- Agent audit logging extension

**Critical path:** All subsequent phases depend on this foundation.
**Research needed:** None (well-documented patterns)

## Phase 18: Simple Tools (Read Operations)
**Duration:** 1 week
**Deliverables:**
- `GET /api/agent/slots` (buscar_slots_disponiveis)
- `GET /api/agent/patients/:id` (buscar_paciente)
- `GET /api/agent/appointments` (buscar_agendamentos)
- N8N HTTP Request node testing

**Critical path:** Validates API architecture before complex tools.
**Research needed:** None (standard REST patterns)

## Phase 19: Core Tools (Write Operations)
**Duration:** 2 weeks
**Deliverables:**
- `POST /api/agent/appointments` (criar_agendamento) with idempotency
- `PUT /api/agent/appointments/:id` (reagendar_agendamento)
- `DELETE /api/agent/appointments/:id` (cancelar_agendamento)
- `PUT /api/agent/patients/:id` (atualizar_dados_paciente)
- `POST /api/agent/appointments/:id/confirm` (confirmar_presenca)

**Critical path:** Implements critical write patterns.
**Research needed:** Minor (idempotency implementation details)

## Phase 20: Complex Tools (Special Cases)
**Duration:** 1 week
**Deliverables:**
- `GET /api/agent/pre-checkin/status` (status_pre_checkin)
- `POST /api/agent/instructions/search` (buscar_instrucoes)
- `POST /api/agent/documents` (processar_documento)

**Critical path:** Requires embeddings and file handling infrastructure.
**Research needed:** Minor (pgvector queries, file upload patterns)

## Phase 21: N8N Integration (Production Migration)
**Duration:** 1 week
**Deliverables:**
- N8N workflow updated to HTTP Request nodes
- N8N credentials configured
- Gradual rollout (10% → 100%)
- Sub-workflows archived
- Migration runbook

**Critical path:** Production cutover, requires monitoring.
**Research needed:** None (standard deployment procedures)

## Phase 22: MCP Server (Optional Enhancement)
**Duration:** 1 week (optional)
**Deliverables:**
- Standalone MCP server implementation
- 11 tools registered
- Claude Desktop integration
- Usage documentation

**Critical path:** Optional for N8N, required for Claude Desktop.
**Research needed:** None (MCP SDK well-documented)
```

### Research Flags

| Phase | Needs Deep Research? | Reason |
|-------|---------------------|--------|
| Phase 17 | **No** | Standard patterns, well-documented in research |
| Phase 18 | **No** | Simple REST APIs, existing service layer |
| Phase 19 | **No** | Idempotency patterns documented, standard practice |
| Phase 20 | **Maybe** | Vector search if pgvector not already used |
| Phase 21 | **No** | N8N HTTP Request well-documented |
| Phase 22 | **No** | MCP SDK official documentation comprehensive |

**Recommendation:** Proceed with planning. No blocking research gaps identified.

## Confidence Assessment

| Area | Confidence | Source Quality | Notes |
|------|------------|----------------|-------|
| **Stack (MCP SDK, Next.js APIs)** | **HIGH** | Official docs, npm package, GitHub examples | v1.25.3 is stable, production-ready |
| **Features (Tool Design)** | **HIGH** | MCP specification, AI agent best practices | Clear patterns for tool interfaces |
| **Architecture (Service Layer)** | **HIGH** | Existing codebase analysis, Next.js patterns | Builds on established project structure |
| **Pitfalls (Migration Risks)** | **HIGH** | N8N docs, Stripe idempotency, production experience | Common patterns well-documented |
| **Migration Strategy** | **HIGH** | Industry best practices, gradual rollout patterns | Conservative approach reduces risk |
| **Performance Targets** | **MEDIUM** | Estimated based on similar workloads | Needs load testing validation |
| **MCP Server Reliability** | **MEDIUM** | MCP is new (2025), limited production data | stdio transport simpler than HTTP |
| **Timeline Estimates** | **MEDIUM** | Based on complexity, team capacity unknown | Adjust based on team size |

### Gaps to Address During Planning

1. **Load Testing:** Performance targets are estimates. Run load tests on API routes to validate <500ms p95 target.
2. **Team Capacity:** Timeline assumes 1 developer full-time. Adjust phases based on actual team size.
3. **Vector Search:** If `buscar_instrucoes` is critical and pgvector not yet implemented, may need additional research.
4. **MCP Production Monitoring:** Limited production data for MCP servers. Plan for monitoring and alerting from day one.

### Validation Checkpoints

Before proceeding to roadmap creation:

- [x] All 4 research files reviewed
- [x] Key technologies identified and justified
- [x] Architecture decisions clear and documented
- [x] Migration order has clear rationale
- [x] Critical pitfalls identified with prevention strategies
- [x] Success metrics defined and measurable
- [x] Phase dependencies mapped
- [x] Research gaps assessed (none blocking)

## Sources

**All sources are aggregated from the 4 research files:**

### High-Confidence Sources (Official Documentation)
- Model Context Protocol TypeScript SDK (GitHub)
- @modelcontextprotocol/sdk npm package
- Next.js 16 API Routes documentation
- N8N HTTP Request node documentation
- Supabase SSR documentation
- Zod validation library

### Medium-High Confidence (Industry Best Practices)
- MCP Server design guides (Block, Anthropic)
- AI Agent best practices (n8n, Anthropic)
- API versioning strategies
- Idempotency patterns (Stripe)
- Error handling patterns (Next.js ecosystem)

### Domain-Specific (Healthcare AI)
- AI appointment scheduling patterns
- Clinical scheduling with Agentic AI
- HIPAA compliance for AI systems

**Total sources reviewed:** 40+ across all research files
**Research date:** 2026-01-24
**Confidence level:** HIGH for all critical decisions

---

## Ready for Roadmap Creation

This research summary provides the foundation for detailed roadmap planning. Key takeaways:

1. **Clear technical direction:** Next.js APIs + MCP Server, minimal dependencies
2. **Phased migration strategy:** Foundation → Simple → Complex → Integration → Optional MCP
3. **Risk mitigation:** Gradual rollout, idempotency, audit logging, rollback capability
4. **Success criteria:** Measurable metrics for technical, operational, and UX success
5. **No blocking gaps:** All research complete, ready to proceed

**Next step:** gsd-roadmapper agent can use this summary to create detailed phase plans in .planning/ROADMAP.md with specific tasks, acceptance criteria, and technical specifications.
